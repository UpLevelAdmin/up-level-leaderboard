function doGet(e) {
  try {
    var isJson = e && e.parameter && e.parameter.type === 'json';
    var sheetType = e && e.parameter && e.parameter.sheet || 'consignment'; // 'consignment' ‡∏´‡∏£‡∏∑‡∏≠ 'shop'
    
    // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô shop sheet ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà
    if (sheetType === 'shop') {
      return doGetShopCards(e);
    }
    
    var spreadsheetId = '1t-3GcjlaV2YL3aSKe-EG34xPiolaWodxK8smyqjDE_E';
    var spreadsheet = SpreadsheetApp.openById(spreadsheetId);
    
    var targetSheet = spreadsheet.getSheetByName('‡∏ù‡∏≤‡∏Å‡∏Ç‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πå‡∏î');
    if (!targetSheet) {
      targetSheet = spreadsheet.getSheetByName('Sheet1');
    }
    if (!targetSheet) {
      var allSheets = spreadsheet.getSheets();
      if (allSheets.length > 0) {
        targetSheet = allSheets[0];
      }
    }
    
    if (!targetSheet) {
      if (isJson) {
        return ContentService.createTextOutput(JSON.stringify({
          error: "‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ä‡∏µ‡∏ó‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•",
          cards: []
        })).setMimeType(ContentService.MimeType.JSON);
      }
      return HtmlService.createHtmlOutput("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ä‡∏µ‡∏ó‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•");
    }
    
    // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏°‡∏≤‡πÉ‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß (‡πÄ‡∏£‡πá‡∏ß‡∏Å‡∏ß‡πà‡∏≤‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á‡∏ó‡∏µ‡∏•‡∏∞‡πÅ‡∏ñ‡∏ß)
    var data = targetSheet.getDataRange().getValues();
    
    if (data.length <= 1) {
      if (isJson) {
        return ContentService.createTextOutput(JSON.stringify({
          error: "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•",
          cards: []
        })).setMimeType(ContentService.MimeType.JSON);
      }
      return HtmlService.createHtmlOutput("‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•");
    }
    
    var headers = data[0];
    var cards = [];
    
    // ‡∏™‡∏£‡πâ‡∏≤‡∏á colIndex ‡πÅ‡∏ö‡∏ö‡πÄ‡∏£‡πá‡∏ß (‡πÉ‡∏ä‡πâ index ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á)
    var colIndex = {};
    var headerCount = headers.length;
    for (var h = 0; h < headerCount; h++) {
      colIndex[headers[h]] = h;
    }
    
    // Cache column indices ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
    var idxDate = colIndex['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ù‡∏≤‡∏Å'];
    var idxConsignor = colIndex['‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏ù‡∏≤‡∏Å‡∏Ç‡∏≤‡∏¢'];
    var idxPhone = colIndex['‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£'];
    var idxSlot = colIndex['‡∏ä‡πà‡∏≠‡∏á‡πÉ‡∏ô‡πÅ‡∏ü‡πâ‡∏°'];
    var idxCardName = colIndex['‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡πå‡∏î'];
    var idxPrice = colIndex['‡∏£‡∏≤‡∏Ñ‡∏≤‡∏õ‡πâ‡∏≤‡∏¢'];
    var idxActualPrice = colIndex['‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Ç‡∏≤‡∏¢‡∏à‡∏£‡∏¥‡∏á'];
    var idxStatus = colIndex['‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞'];
    var idxSaleDate = colIndex['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏¢/‡∏Ñ‡∏∑‡∏ô'];
    var idxRefund = colIndex['‡∏¢‡∏≠‡∏î‡∏Ñ‡∏∑‡∏ô‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ (90%)'];
    var idxNotes = colIndex['‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏'];
    var idxProductId = colIndex['‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤'];
    var idxImageLink = colIndex['‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏†‡∏≤‡∏û‡∏Å‡∏≤‡∏£‡πå‡∏î'];
    
    // Cache folder ‡πÅ‡∏•‡∏∞ files ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡∏¥‡∏î folder ‡∏ã‡πâ‡∏≥ (‡πÄ‡∏£‡πá‡∏ß‡∏Ç‡∏∂‡πâ‡∏ô‡∏°‡∏≤‡∏Å!)
    var driveFolderId = '1ZVmhWN_5eMshclIzvjBlcyDwGUJW4A11';
    var folder = null;
    var fileMap = {}; // Cache files ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ã‡πâ‡∏≥
    try {
      folder = DriveApp.getFolderById(driveFolderId);
      // ‡∏î‡∏∂‡∏á‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏à‡∏≤‡∏Å folder ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß (‡πÄ‡∏£‡πá‡∏ß‡∏Å‡∏ß‡πà‡∏≤‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ó‡∏µ‡∏•‡∏∞‡πÑ‡∏ü‡∏•‡πå)
      var allFiles = folder.getFiles();
      while (allFiles.hasNext()) {
        var file = allFiles.next();
        var fileName = file.getName();
        fileMap[fileName] = {
          id: file.getId(),
          file: file
        };
      }
    } catch (e) {
      // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏Å‡∏¥‡∏î error ‡πÉ‡∏´‡πâ‡∏Ç‡πâ‡∏≤‡∏°‡πÑ‡∏õ (‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏™‡∏î‡∏á error)
    }
    
    // ‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÅ‡∏ö‡∏ö batch (‡πÄ‡∏£‡πá‡∏ß‡∏Å‡∏ß‡πà‡∏≤‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏ó‡∏µ‡∏•‡∏∞‡πÅ‡∏ñ‡∏ß)
    var rowCount = data.length;
    var cardImage, imageLink, imageLinkStr, idMatch, cardName, status;
    var statusCounts = {};
    var totalProcessed = 0;
    var skippedNoName = 0;
    var skippedRows = [];
    
    for (var i = 1; i < rowCount; i++) {
      var row = data[i];
      
      // ‡∏≠‡πà‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏î‡∏¢‡πÉ‡∏ä‡πâ index ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á (‡πÄ‡∏£‡πá‡∏ß‡∏Å‡∏ß‡πà‡∏≤)
      cardName = row[idxCardName];
      // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà (‡∏£‡∏ß‡∏°‡∏ñ‡∏∂‡∏á whitespace)
      if (!cardName || String(cardName).trim() === '') {
        skippedNoName++;
        // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏Ç‡πâ‡∏≤‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠ debug
        if (skippedRows.length < 5) { // ‡πÄ‡∏Å‡πá‡∏ö‡πÅ‡∏Ñ‡πà 5 ‡πÅ‡∏ñ‡∏ß‡πÅ‡∏£‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ log ‡∏¢‡∏≤‡∏ß‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ
          skippedRows.push({
            row: i + 1,
            cardName: cardName,
            productId: row[idxProductId] || '',
            status: row[idxStatus] || ''
          });
        }
        continue; // ‡∏Ç‡πâ‡∏≤‡∏°‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡πå‡∏î
      }
      
      status = String(row[idxStatus] || '‡∏¢‡∏±‡∏á‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà').trim();
      statusCounts[status] = (statusCounts[status] || 0) + 1;
      totalProcessed++;
      
      // ‡πÅ‡∏™‡∏î‡∏á‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏ó‡∏∏‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ (‡πÑ‡∏°‡πà‡∏Å‡∏£‡∏≠‡∏á)
      
      // ‡∏≠‡πà‡∏≤‡∏ô‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏à‡∏≤‡∏Å Column G ‡πÅ‡∏ö‡∏ö‡πÄ‡∏£‡πá‡∏ß
      cardImage = '';
      if (idxImageLink !== undefined) {
        imageLink = row[idxImageLink];
        if (imageLink) {
          imageLinkStr = String(imageLink);
          if (imageLinkStr.indexOf('http') !== -1) {
            if (imageLinkStr.indexOf('thumbnail?id=') !== -1) {
              cardImage = imageLinkStr;
            } else {
              idMatch = imageLinkStr.match(/id=([a-zA-Z0-9_-]+)/);
              if (idMatch && idMatch[1]) {
                cardImage = 'https://drive.google.com/thumbnail?id=' + idMatch[1] + '&sz=w1000';
              } else {
                cardImage = imageLinkStr;
              }
            }
          }
        }
      }
      
      // ‡∏î‡∏∂‡∏á‡∏£‡∏π‡∏õ‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å Drive ‡πÇ‡∏î‡∏¢‡πÉ‡∏ä‡πâ productId - ‡πÉ‡∏ä‡πâ fileMap ‡∏ó‡∏µ‡πà cache ‡πÑ‡∏ß‡πâ‡πÅ‡∏•‡πâ‡∏ß (‡πÄ‡∏£‡πá‡∏ß‡∏°‡∏≤‡∏Å!)
      var cardBackImage = '';
      var productId = String(row[idxProductId] || '').trim();
      if (productId && fileMap) {
        var backFileName = productId + ' ‡∏´‡∏•‡∏±‡∏á.jpg';
        var cachedFile = fileMap[backFileName];
        if (cachedFile) {
          try {
            // ‡∏•‡∏î‡∏Å‡∏≤‡∏£ setSharing (‡πÑ‡∏°‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡∏ñ‡πâ‡∏≤‡πÑ‡∏ü‡∏•‡πå share ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß) - ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡πÄ‡∏£‡πá‡∏ß‡∏Ç‡∏∂‡πâ‡∏ô‡∏°‡∏≤‡∏Å
            // ‡∏ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ setSharing ‡πÉ‡∏´‡πâ uncomment ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ
            // cachedFile.file.setSharing(DriveApp.Access.ANYONE_WITH_LINK, DriveApp.Permission.VIEW);
            var backFileId = cachedFile.id;
            cardBackImage = 'https://drive.google.com/thumbnail?id=' + backFileId + '&sz=w1000';
          } catch (e) {
            // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏Å‡∏¥‡∏î error ‡πÉ‡∏´‡πâ‡∏Ç‡πâ‡∏≤‡∏°‡πÑ‡∏õ (‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏™‡∏î‡∏á error)
          }
        }
      }
      
      // ‡∏™‡∏£‡πâ‡∏≤‡∏á object ‡πÅ‡∏ö‡∏ö‡πÄ‡∏£‡πá‡∏ß (‡πÉ‡∏ä‡πâ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡πÑ‡∏ß‡πâ‡πÅ‡∏•‡πâ‡∏ß)
      cards.push({
        depositDate: row[idxDate] || '',
        consignorName: row[idxConsignor] || '',
        phone: row[idxPhone] || '',
        folderSlot: row[idxSlot] || '',
        cardName: cardName,
        cardImage: cardImage,
        cardBackImage: cardBackImage,
        productId: productId,
        listedPrice: row[idxPrice] || '',
        actualPrice: row[idxActualPrice] || '',
        status: status,
        saleDate: row[idxSaleDate] || '',
        refundAmount: row[idxRefund] || '',
        notes: row[idxNotes] || ''
      });
    }
    
    if (isJson) {
      var debugInfo = [];
      debugInfo.push('üìä ‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: ' + totalProcessed + ' ‡∏Å‡∏≤‡∏£‡πå‡∏î');
      debugInfo.push('‚è≠Ô∏è ‡∏Ç‡πâ‡∏≤‡∏° (‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ä‡∏∑‡πà‡∏≠): ' + skippedNoName + ' ‡πÅ‡∏ñ‡∏ß');
      debugInfo.push('‚úÖ ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å: ' + cards.length + ' ‡∏Å‡∏≤‡∏£‡πå‡∏î');
      debugInfo.push('üìã ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ' + JSON.stringify(statusCounts));
      if (skippedRows.length > 0) {
        debugInfo.push('üîç ‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏Ç‡πâ‡∏≤‡∏° (‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á): ' + JSON.stringify(skippedRows));
      }
      
      return ContentService.createTextOutput(JSON.stringify({
        cards: cards,
        total: cards.length,
        debug: debugInfo
      })).setMimeType(ContentService.MimeType.JSON);
    }
    
    var html = '<html><body><h2>‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏ù‡∏≤‡∏Å‡∏Ç‡∏≤‡∏¢</h2><ul>';
    cards.forEach(function(card) {
      html += '<li>' + card.cardName + ' - ' + card.listedPrice + ' ‡∏ö‡∏≤‡∏ó</li>';
    });
    html += '</ul></body></html>';
    return HtmlService.createHtmlOutput(html);
    
  } catch (error) {
    var errorMsg = '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.toString();
    
    if (e && e.parameter && e.parameter.type === 'json') {
      return ContentService.createTextOutput(JSON.stringify({
        error: errorMsg,
        cards: []
      })).setMimeType(ContentService.MimeType.JSON);
    }
    
    return HtmlService.createHtmlOutput(errorMsg);
  }
}

/**
 * ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å sheet "‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏£‡πâ‡∏≤‡∏ô" ‡πÇ‡∏î‡∏¢‡πÄ‡∏â‡∏û‡∏≤‡∏∞
 * ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏ú‡πà‡∏≤‡∏ô: doGet?type=json&sheet=shop
 */
function doGetShopCards(e) {
  try {
    var isJson = e && e.parameter && e.parameter.type === 'json';
    
    // Debug: ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• debug
    var debugInfo = [];
    debugInfo.push('üîç ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏≥‡∏á‡∏≤‡∏ô doGetShopCards');
    debugInfo.push('üìã Parameter: ' + JSON.stringify(e ? e.parameter : 'no parameter'));
    debugInfo.push('üìã isJson: ' + isJson);
    
    // ‡πÉ‡∏ä‡πâ getActiveSpreadsheet() ‡πÄ‡∏û‡∏£‡∏≤‡∏∞ Apps Script ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô Spreadsheet ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô
    var spreadsheet;
    try {
      debugInfo.push('üîç ‡πÉ‡∏ä‡πâ SpreadsheetApp.getActiveSpreadsheet()...');
      spreadsheet = SpreadsheetApp.getActiveSpreadsheet();
      if (!spreadsheet) {
        debugInfo.push('‚ùå ‡πÑ‡∏°‡πà‡∏°‡∏µ Active Spreadsheet');
        if (isJson) {
          return ContentService.createTextOutput(JSON.stringify({
            error: "‡πÑ‡∏°‡πà‡∏û‡∏ö Spreadsheet",
            cards: [],
            debug: debugInfo,
            suggestion: "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ Apps Script ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô Spreadsheet ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á"
          })).setMimeType(ContentService.MimeType.JSON);
        }
        return HtmlService.createHtmlOutput("‡πÑ‡∏°‡πà‡∏û‡∏ö Spreadsheet<br><br>Debug:<br>" + debugInfo.join("<br>"));
      }
      debugInfo.push('‚úÖ ‡πÉ‡∏ä‡πâ Active Spreadsheet ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
      debugInfo.push('üìã Spreadsheet Name: ' + spreadsheet.getName());
    } catch (activeError) {
      debugInfo.push('‚ùå Error ‡πÉ‡∏ä‡πâ Active Spreadsheet: ' + activeError.toString());
      
      if (isJson) {
        return ContentService.createTextOutput(JSON.stringify({
          error: "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á Spreadsheet ‡πÑ‡∏î‡πâ: " + activeError.toString(),
          cards: [],
          debug: debugInfo,
          suggestion: "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ Apps Script ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô Spreadsheet ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á"
        })).setMimeType(ContentService.MimeType.JSON);
      }
      return HtmlService.createHtmlOutput("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á Spreadsheet ‡πÑ‡∏î‡πâ<br><br>Debug:<br>" + debugInfo.join("<br>"));
    }
    
    if (!spreadsheet) {
      debugInfo.push('‚ùå Spreadsheet ‡πÄ‡∏õ‡πá‡∏ô null');
      if (isJson) {
        return ContentService.createTextOutput(JSON.stringify({
          error: "‡πÑ‡∏°‡πà‡∏û‡∏ö Spreadsheet",
          cards: [],
          debug: debugInfo
        })).setMimeType(ContentService.MimeType.JSON);
      }
      return HtmlService.createHtmlOutput("‡πÑ‡∏°‡πà‡∏û‡∏ö Spreadsheet<br><br>Debug:<br>" + debugInfo.join("<br>"));
    }
    
    debugInfo.push('üîç ‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡∏´‡∏≤ sheet "‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏£‡πâ‡∏≤‡∏ô"...');
    var targetSheet = spreadsheet.getSheetByName('‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏£‡πâ‡∏≤‡∏ô');
    
    if (!targetSheet) {
      debugInfo.push('‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö sheet "‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏£‡πâ‡∏≤‡∏ô"');
      // ‡∏•‡∏≠‡∏á‡∏´‡∏≤ sheet ‡∏≠‡∏∑‡πà‡∏ô‡πÜ
      var allSheets = spreadsheet.getSheets();
      debugInfo.push('üìã ‡∏û‡∏ö sheets ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: ' + allSheets.length + ' sheets');
      for (var s = 0; s < allSheets.length && s < 5; s++) {
        debugInfo.push('  - Sheet ' + (s + 1) + ': ' + allSheets[s].getName());
      }
      
      if (isJson) {
        return ContentService.createTextOutput(JSON.stringify({
          error: "‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ä‡∏µ‡∏ó '‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏£‡πâ‡∏≤‡∏ô'",
          cards: [],
          debug: debugInfo
        })).setMimeType(ContentService.MimeType.JSON);
      }
      return HtmlService.createHtmlOutput("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ä‡∏µ‡∏ó '‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏£‡πâ‡∏≤‡∏ô'<br><br>Debug:<br>" + debugInfo.join("<br>"));
    }
    
    debugInfo.push('‚úÖ ‡∏û‡∏ö sheet "‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏£‡πâ‡∏≤‡∏ô"');
    
    debugInfo.push('üîç ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å sheet...');
    var data = targetSheet.getDataRange().getValues();
    debugInfo.push('üìã ‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: ' + data.length + ' ‡πÅ‡∏ñ‡∏ß');
    
    if (data.length <= 1) {
      debugInfo.push('‚ùå ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡∏°‡∏µ‡πÅ‡∏Ñ‡πà header ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏•‡∏¢)');
      if (isJson) {
        return ContentService.createTextOutput(JSON.stringify({
          error: "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•",
          cards: [],
          debug: debugInfo
        })).setMimeType(ContentService.MimeType.JSON);
      }
      return HtmlService.createHtmlOutput("‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•<br><br>Debug:<br>" + debugInfo.join("<br>"));
    }
    
    var headers = data[0];
    var cards = [];
    
    // ‡∏™‡∏£‡πâ‡∏≤‡∏á colIndex
    var colIndex = {};
    for (var h = 0; h < headers.length; h++) {
      colIndex[headers[h]] = h;
    }
    
    // Column indices ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö sheet "‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏£‡πâ‡∏≤‡∏ô"
    var idxDate = colIndex['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏•‡∏á'] !== undefined ? colIndex['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏•‡∏á'] : -1;
    var idxSlot = colIndex['‡∏ä‡πà‡∏≠‡∏á‡πÉ‡∏ô‡πÅ‡∏ü‡πâ‡∏°'] !== undefined ? colIndex['‡∏ä‡πà‡∏≠‡∏á‡πÉ‡∏ô‡πÅ‡∏ü‡πâ‡∏°'] : -1;
    var idxCardName = colIndex['‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡πå‡∏î'] !== undefined ? colIndex['‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡πå‡∏î'] : -1;
    var idxImageLink = colIndex['‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏†‡∏≤‡∏û‡∏Å‡∏≤‡∏£‡πå‡∏î'] !== undefined ? colIndex['‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏†‡∏≤‡∏û‡∏Å‡∏≤‡∏£‡πå‡∏î'] : -1;
    var idxPrice = colIndex['‡∏£‡∏≤‡∏Ñ‡∏≤‡∏õ‡πâ‡∏≤‡∏¢'] !== undefined ? colIndex['‡∏£‡∏≤‡∏Ñ‡∏≤‡∏õ‡πâ‡∏≤‡∏¢'] : -1;
    var idxActualPrice = colIndex['‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Ç‡∏≤‡∏¢‡∏à‡∏£‡∏¥‡∏á'] !== undefined ? colIndex['‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Ç‡∏≤‡∏¢‡∏à‡∏£‡∏¥‡∏á'] : -1;
    var idxStatus = colIndex['‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞'] !== undefined ? colIndex['‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞'] : -1;
    var idxSaleDate = colIndex['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏¢'] !== undefined ? colIndex['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏¢'] : -1;
    var idxNotes = colIndex['‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏'] !== undefined ? colIndex['‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏'] : -1;
    var idxProductId = colIndex['‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤'] !== undefined ? colIndex['‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤'] : -1;
    
    // Cache folder ‡πÅ‡∏•‡∏∞ files
    var driveFolderId = '1ZVmhWN_5eMshclIzvjBlcyDwGUJW4A11';
    var folder = null;
    var fileMap = {};
    try {
      folder = DriveApp.getFolderById(driveFolderId);
      var allFiles = folder.getFiles();
      while (allFiles.hasNext()) {
        var file = allFiles.next();
        var fileName = file.getName();
        fileMap[fileName] = {
          id: file.getId(),
          file: file
        };
      }
    } catch (e) {
      // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏Å‡∏¥‡∏î error ‡πÉ‡∏´‡πâ‡∏Ç‡πâ‡∏≤‡∏°‡πÑ‡∏õ
    }
    
    // ‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
    for (var i = 1; i < data.length; i++) {
      var row = data[i];
      
      var cardName = idxCardName >= 0 ? row[idxCardName] : '';
      if (!cardName || String(cardName).trim() === '') {
        continue;
      }
      
      // ‡∏≠‡πà‡∏≤‡∏ô‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏à‡∏≤‡∏Å Column E (‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏†‡∏≤‡∏û‡∏Å‡∏≤‡∏£‡πå‡∏î)
      var cardImage = '';
      if (idxImageLink >= 0) {
        var imageLink = row[idxImageLink];
        if (imageLink) {
          var imageLinkStr = String(imageLink);
          if (imageLinkStr.indexOf('http') !== -1) {
            if (imageLinkStr.indexOf('thumbnail?id=') !== -1) {
              cardImage = imageLinkStr;
            } else {
              var idMatch = imageLinkStr.match(/id=([a-zA-Z0-9_-]+)/);
              if (idMatch && idMatch[1]) {
                cardImage = 'https://drive.google.com/thumbnail?id=' + idMatch[1] + '&sz=w1000';
              } else {
                cardImage = imageLinkStr;
              }
            }
          }
        }
      }
      
      // ‡∏î‡∏∂‡∏á‡∏£‡∏π‡∏õ‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å Drive
      var cardBackImage = '';
      var productId = idxProductId >= 0 ? String(row[idxProductId] || '').trim() : '';
      if (productId && fileMap) {
        // ‡∏•‡∏≠‡∏á‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå‡∏´‡∏•‡∏≤‡∏¢‡πÅ‡∏ö‡∏ö
        var backFileName1 = productId + ' ‡∏´‡∏•‡∏±‡∏á.jpg';
        var backFileName2 = productId + '‡∏´‡∏•‡∏±‡∏á.jpg';
        var backFileName3 = productId + ' ‡∏´‡∏•‡∏±‡∏á.jpg';
        var backFileName4 = productId + '‡∏´‡∏•‡∏±‡∏á.jpg';
        var cachedFile = fileMap[backFileName1] || fileMap[backFileName2] || fileMap[backFileName3] || fileMap[backFileName4];
        
        if (!cachedFile) {
          // ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÅ‡∏ö‡∏ö fuzzy
          for (var fileName in fileMap) {
            if (fileName.indexOf(productId) !== -1 && 
                (fileName.indexOf('‡∏´‡∏•‡∏±‡∏á') !== -1 || fileName.indexOf('‡∏´‡∏•‡∏±‡∏á') !== -1) && 
                (fileName.indexOf('.jpg') !== -1 || fileName.indexOf('.JPG') !== -1)) {
              cachedFile = fileMap[fileName];
              break;
            }
          }
        }
        
        if (cachedFile) {
          try {
            var backFileId = cachedFile.id;
            cardBackImage = 'https://drive.google.com/thumbnail?id=' + backFileId + '&sz=w1000';
          } catch (e) {}
        }
      }
      
      var status = idxStatus >= 0 ? String(row[idxStatus] || '‡∏¢‡∏±‡∏á‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà').trim() : '‡∏¢‡∏±‡∏á‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà';
      
      cards.push({
        postedDate: idxDate >= 0 ? row[idxDate] : '',
        folderSlot: idxSlot >= 0 ? row[idxSlot] : '',
        cardName: cardName,
        cardImage: cardImage,
        cardBackImage: cardBackImage,
        productId: productId,
        listedPrice: idxPrice >= 0 ? row[idxPrice] : '',
        actualPrice: idxActualPrice >= 0 ? row[idxActualPrice] : '',
        status: status,
        saleDate: idxSaleDate >= 0 ? row[idxSaleDate] : '',
        notes: idxNotes >= 0 ? row[idxNotes] : ''
      });
    }
    
    debugInfo.push('‚úÖ ‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡πÄ‡∏™‡∏£‡πá‡∏à: ' + cards.length + ' ‡∏Å‡∏≤‡∏£‡πå‡∏î');
    
    if (isJson) {
      return ContentService.createTextOutput(JSON.stringify({
        cards: cards,
        total: cards.length,
        debug: debugInfo
      })).setMimeType(ContentService.MimeType.JSON);
    }
    
    var html = '<html><body><h2>‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏£‡πâ‡∏≤‡∏ô</h2><ul>';
    cards.forEach(function(card) {
      html += '<li>' + card.cardName + ' - ' + card.listedPrice + ' ‡∏ö‡∏≤‡∏ó</li>';
    });
    html += '</ul></body></html>';
    return HtmlService.createHtmlOutput(html);
    
  } catch (error) {
    var errorMsg = '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.toString();
    var debugInfo = [];
    debugInfo.push('‚ùå Error ‡πÉ‡∏ô doGetShopCards (catch block)');
    debugInfo.push('üìã Error Type: ' + typeof error);
    debugInfo.push('üìã Error Message: ' + (error.message || error.toString()));
    debugInfo.push('üìã Error Stack: ' + (error.stack || 'no stack'));
    debugInfo.push('üìã Error Name: ' + (error.name || 'no name'));
    
    if (e && e.parameter && e.parameter.type === 'json') {
      return ContentService.createTextOutput(JSON.stringify({
        error: errorMsg,
        cards: [],
        debug: debugInfo
      })).setMimeType(ContentService.MimeType.JSON);
    }
    
    return HtmlService.createHtmlOutput(errorMsg + "<br><br>Debug:<br>" + debugInfo.join("<br>"));
  }
}

function linkImagesFromDrive() {
  var sheetName = '‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏£‡πâ‡∏≤‡∏ô';
  var driveFolderId = '1ZVmhWN_5eMshclIzvjBlcyDwGUJW4A11';
  var productIdCol = 10; // Column K = index 10 (A=0, B=1, C=2, D=3, E=4, F=5, G=6, H=7, I=8, J=9, K=10)
  var imageLinkCol = 4; // Column E = index 4 (A=0, B=1, C=2, D=3, E=4)
  
  try {
    // ‡πÉ‡∏ä‡πâ active spreadsheet ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô (‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö trigger)
    var spreadsheet = SpreadsheetApp.getActiveSpreadsheet();
    if (!spreadsheet) {
      return; // ‡πÑ‡∏°‡πà‡πÅ‡∏™‡∏î‡∏á alert
    }
    
    var sheet = spreadsheet.getSheetByName(sheetName);
    if (!sheet) {
      return; // ‡πÑ‡∏°‡πà‡πÅ‡∏™‡∏î‡∏á alert
    }
    
    var folder = DriveApp.getFolderById(driveFolderId);
    var files = folder.getFiles();
    var fileMap = {};
    var fileList = []; // ‡πÄ‡∏Å‡πá‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠ debug
    var fileCount = 0;
    
    // ‡∏™‡∏£‡πâ‡∏≤‡∏á fileMap ‡πÅ‡∏•‡∏∞‡πÄ‡∏Å‡πá‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
    while (files.hasNext()) {
      var file = files.next();
      var fileName = file.getName();
      fileMap[fileName] = file;
      fileList.push(fileName);
      fileCount++;
    }
    
    var data = sheet.getDataRange().getValues();
    var updatedCount = 0;
    var notFoundCount = 0;
    var skippedCount = 0;
    
    for (var i = 1; i < data.length; i++) {
      var productId = String(data[i][productIdCol] || '').trim();
      if (!productId) {
        skippedCount++;
        continue;
      }
      
      // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
      var existingLink = String(data[i][imageLinkCol] || '').trim();
      var hasValidLink = false;
      if (existingLink) {
        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á (‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ https://drive.google.com/thumbnail?id= ‡πÅ‡∏•‡∏∞ file ID)
        if (existingLink.indexOf('https://drive.google.com/thumbnail?id=') !== -1) {
          var idMatch = existingLink.match(/id=([a-zA-Z0-9_-]+)/);
          if (idMatch && idMatch[1] && idMatch[1].length > 10) {
            hasValidLink = true;
          }
        }
      }
      
      // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏´‡πâ‡∏Ç‡πâ‡∏≤‡∏°
      if (hasValidLink) {
        skippedCount++;
        continue;
      }
      
      // ‡∏•‡∏≠‡∏á‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå‡∏´‡∏•‡∏≤‡∏¢‡πÅ‡∏ö‡∏ö (‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏°‡∏µ space ‡∏´‡∏£‡∏∑‡∏≠ character ‡∏û‡∏¥‡πÄ‡∏®‡∏© ‡∏´‡∏£‡∏∑‡∏≠‡∏™‡∏∞‡∏Å‡∏î‡∏ú‡∏¥‡∏î)
      var frontFileName1 = productId + ' ‡∏´‡∏ô‡πâ‡∏≤.jpg';  // ‡∏°‡∏µ space, ‡∏™‡∏∞‡∏Å‡∏î‡∏ñ‡∏π‡∏Å
      var frontFileName2 = productId + '‡∏´‡∏ô‡πâ‡∏≤.jpg';   // ‡πÑ‡∏°‡πà‡∏°‡∏µ space, ‡∏™‡∏∞‡∏Å‡∏î‡∏ñ‡∏π‡∏Å
      var frontFileName3 = productId + ' ‡∏´‡∏ô‡∏±‡∏≤.jpg';   // ‡∏°‡∏µ space, ‡∏™‡∏∞‡∏Å‡∏î‡∏ú‡∏¥‡∏î (‡∏´‡∏ô‡∏±‡∏≤)
      var frontFileName4 = productId + '‡∏´‡∏ô‡∏±‡∏≤.jpg';    // ‡πÑ‡∏°‡πà‡∏°‡∏µ space, ‡∏™‡∏∞‡∏Å‡∏î‡∏ú‡∏¥‡∏î (‡∏´‡∏ô‡∏±‡∏≤)
      var frontFile = fileMap[frontFileName1] || fileMap[frontFileName2] || fileMap[frontFileName3] || fileMap[frontFileName4];
      
      // ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏ö ‡∏•‡∏≠‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÅ‡∏ö‡∏ö fuzzy (‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà‡∏°‡∏µ productId ‡πÅ‡∏•‡∏∞‡∏Ñ‡∏≥‡∏ß‡πà‡∏≤ "‡∏´‡∏ô‡πâ‡∏≤" ‡∏´‡∏£‡∏∑‡∏≠ "‡∏´‡∏ô‡∏±‡∏≤")
      if (!frontFile) {
        for (var fileName in fileMap) {
          // ‡∏´‡∏≤‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà‡∏°‡∏µ productId ‡πÅ‡∏•‡∏∞‡∏°‡∏µ‡∏Ñ‡∏≥‡∏ß‡πà‡∏≤ "‡∏´‡∏ô‡πâ‡∏≤" ‡∏´‡∏£‡∏∑‡∏≠ "‡∏´‡∏ô‡∏±‡∏≤" ‡πÅ‡∏•‡∏∞‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏ü‡∏•‡πå .jpg
          if (fileName.indexOf(productId) !== -1 && 
              (fileName.indexOf('‡∏´‡∏ô‡πâ‡∏≤') !== -1 || fileName.indexOf('‡∏´‡∏ô‡∏±‡∏≤') !== -1) && 
              (fileName.indexOf('.jpg') !== -1 || fileName.indexOf('.JPG') !== -1)) {
            frontFile = fileMap[fileName];
            break;
          }
        }
      }
      
      if (frontFile) {
        try {
          frontFile.setSharing(DriveApp.Access.ANYONE_WITH_LINK, DriveApp.Permission.VIEW);
        } catch (e) {
          // ‡∏ñ‡πâ‡∏≤ setSharing ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏Å‡πá‡∏Ç‡πâ‡∏≤‡∏°‡πÑ‡∏õ (‡∏≠‡∏≤‡∏à share ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß)
        }
        
        var fileId = frontFile.getId();
        // ‡πÉ‡∏ä‡πâ thumbnail URL ‡πÅ‡∏ó‡∏ô ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏à‡∏∞‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏î‡πâ‡πÄ‡∏£‡πá‡∏ß‡∏Å‡∏ß‡πà‡∏≤‡πÅ‡∏•‡∏∞‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÅ‡∏ä‡∏£‡πå
        var imageUrl = 'https://drive.google.com/thumbnail?id=' + fileId + '&sz=w1000';
        sheet.getRange(i + 1, imageLinkCol + 1).setValue(imageUrl);
        updatedCount++;
      } else {
        notFoundCount++;
      }
    }
    
    // ‡πÑ‡∏°‡πà‡πÅ‡∏™‡∏î‡∏á alert ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÄ‡∏™‡∏µ‡∏¢‡πÄ‡∏ß‡∏•‡∏≤
  } catch (error) {
    // ‡πÑ‡∏°‡πà‡πÅ‡∏™‡∏î‡∏á error ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÄ‡∏™‡∏µ‡∏¢‡πÄ‡∏ß‡∏•‡∏≤
    // ‡πÅ‡∏ï‡πà‡∏ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ debug ‡πÉ‡∏´‡πâ uncomment ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ
    // Logger.log('Error in linkImagesFromDrive: ' + error.toString());
  }
}

/**
 * ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
 * ‡∏£‡∏±‡∏ô‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå
 */
function testLinkImages() {
  var sheetName = '‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏£‡πâ‡∏≤‡∏ô';
  var driveFolderId = '1ZVmhWN_5eMshclIzvjBlcyDwGUJW4A11';
  var productIdCol = 10;
  var imageLinkCol = 4;
  
  try {
    // ‡πÉ‡∏ä‡πâ active spreadsheet ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô (‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö trigger)
    var spreadsheet = SpreadsheetApp.getActiveSpreadsheet();
    if (!spreadsheet) {
      SpreadsheetApp.getUi().alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏õ‡∏¥‡∏î‡πÑ‡∏ü‡∏•‡πå Google Sheets ‡∏Å‡πà‡∏≠‡∏ô');
      return;
    }
    
    var sheet = spreadsheet.getSheetByName(sheetName);
    if (!sheet) {
      Logger.log('‡πÑ‡∏°‡πà‡∏û‡∏ö sheet: ' + sheetName);
      SpreadsheetApp.getUi().alert('‡πÑ‡∏°‡πà‡∏û‡∏ö sheet: ' + sheetName);
      return;
    }
    
    var folder = DriveApp.getFolderById(driveFolderId);
    var files = folder.getFiles();
    var fileMap = {};
    var fileList = []; // ‡πÄ‡∏Å‡πá‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠ debug
    var fileCount = 0;
    
    while (files.hasNext()) {
      var file = files.next();
      var fileName = file.getName();
      fileMap[fileName] = file;
      fileList.push(fileName);
      fileCount++;
    }
    
    Logger.log('‡∏û‡∏ö‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: ' + fileCount + ' ‡πÑ‡∏ü‡∏•‡πå');
    Logger.log('‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏ô Drive: ' + fileList.join(', '));
    
    var data = sheet.getDataRange().getValues();
    Logger.log('‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: ' + (data.length - 1) + ' ‡πÅ‡∏ñ‡∏ß');
    
    var updatedCount = 0;
    var notFoundCount = 0;
    var skippedCount = 0;
    var notFoundIds = [];
    var notFoundDetails = [];
    
    for (var i = 1; i < data.length; i++) {
      var productId = String(data[i][productIdCol] || '').trim();
      if (!productId) {
        skippedCount++;
        continue;
      }
      
      var existingLink = String(data[i][imageLinkCol] || '').trim();
      var hasValidLink = false;
      if (existingLink) {
        if (existingLink.indexOf('https://drive.google.com/thumbnail?id=') !== -1) {
          var idMatch = existingLink.match(/id=([a-zA-Z0-9_-]+)/);
          if (idMatch && idMatch[1] && idMatch[1].length > 10) {
            hasValidLink = true;
          }
        }
      }
      
      if (hasValidLink) {
        skippedCount++;
        continue;
      }
      
      var frontFileName1 = productId + ' ‡∏´‡∏ô‡πâ‡∏≤.jpg';  // ‡∏°‡∏µ space, ‡∏™‡∏∞‡∏Å‡∏î‡∏ñ‡∏π‡∏Å
      var frontFileName2 = productId + '‡∏´‡∏ô‡πâ‡∏≤.jpg';   // ‡πÑ‡∏°‡πà‡∏°‡∏µ space, ‡∏™‡∏∞‡∏Å‡∏î‡∏ñ‡∏π‡∏Å
      var frontFileName3 = productId + ' ‡∏´‡∏ô‡∏±‡∏≤.jpg';   // ‡∏°‡∏µ space, ‡∏™‡∏∞‡∏Å‡∏î‡∏ú‡∏¥‡∏î (‡∏´‡∏ô‡∏±‡∏≤)
      var frontFileName4 = productId + '‡∏´‡∏ô‡∏±‡∏≤.jpg';    // ‡πÑ‡∏°‡πà‡∏°‡∏µ space, ‡∏™‡∏∞‡∏Å‡∏î‡∏ú‡∏¥‡∏î (‡∏´‡∏ô‡∏±‡∏≤)
      var frontFile = fileMap[frontFileName1] || fileMap[frontFileName2] || fileMap[frontFileName3] || fileMap[frontFileName4];
      var foundFileName = '';
      
      if (frontFile) {
        // ‡πÉ‡∏ä‡πâ‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö key ‡πÉ‡∏ô fileMap
        if (fileMap[frontFileName1]) {
          foundFileName = frontFileName1;
        } else if (fileMap[frontFileName2]) {
          foundFileName = frontFileName2;
        } else if (fileMap[frontFileName3]) {
          foundFileName = frontFileName3;
        } else if (fileMap[frontFileName4]) {
          foundFileName = frontFileName4;
        }
      } else {
        // ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏ö ‡∏•‡∏≠‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÅ‡∏ö‡∏ö fuzzy (‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà‡∏°‡∏µ productId ‡πÅ‡∏•‡∏∞‡∏Ñ‡∏≥‡∏ß‡πà‡∏≤ "‡∏´‡∏ô‡πâ‡∏≤" ‡∏´‡∏£‡∏∑‡∏≠ "‡∏´‡∏ô‡∏±‡∏≤")
        for (var fileName in fileMap) {
          // ‡∏´‡∏≤‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà‡∏°‡∏µ productId ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏ä‡∏∑‡πà‡∏≠ ‡πÅ‡∏•‡∏∞‡∏°‡∏µ‡∏Ñ‡∏≥‡∏ß‡πà‡∏≤ "‡∏´‡∏ô‡πâ‡∏≤" ‡∏´‡∏£‡∏∑‡∏≠ "‡∏´‡∏ô‡∏±‡∏≤" ‡πÅ‡∏•‡∏∞‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏ü‡∏•‡πå .jpg
          if (fileName.indexOf(productId) !== -1 && 
              (fileName.indexOf('‡∏´‡∏ô‡πâ‡∏≤') !== -1 || fileName.indexOf('‡∏´‡∏ô‡∏±‡∏≤') !== -1) && 
              (fileName.indexOf('.jpg') !== -1 || fileName.indexOf('.JPG') !== -1)) {
            frontFile = fileMap[fileName];
            foundFileName = fileName;
            break;
          }
        }
      }
      
      if (frontFile) {
        try {
          frontFile.setSharing(DriveApp.Access.ANYONE_WITH_LINK, DriveApp.Permission.VIEW);
        } catch (e) {}
        
        var fileId = frontFile.getId();
        var imageUrl = 'https://drive.google.com/thumbnail?id=' + fileId + '&sz=w1000';
        sheet.getRange(i + 1, imageLinkCol + 1).setValue(imageUrl);
        updatedCount++;
        Logger.log('‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡πÅ‡∏ñ‡∏ß ' + (i + 1) + ': ' + productId + ' -> ' + foundFileName);
      } else {
        notFoundCount++;
        notFoundIds.push(productId);
        var searchPatterns = '‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤: "' + frontFileName1 + '" ‡∏´‡∏£‡∏∑‡∏≠ "' + frontFileName2 + '"';
        notFoundDetails.push(productId + ' (' + searchPatterns + ')');
        Logger.log('‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÑ‡∏ü‡∏•‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö: ' + productId + ' - ' + searchPatterns);
      }
    }
    
    var message = '‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô!\n';
    message += '‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó: ' + updatedCount + ' ‡πÅ‡∏ñ‡∏ß\n';
    message += '‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÑ‡∏ü‡∏•‡πå: ' + notFoundCount + ' ‡πÅ‡∏ñ‡∏ß\n';
    message += '‡∏Ç‡πâ‡∏≤‡∏° (‡∏°‡∏µ‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÅ‡∏•‡πâ‡∏ß/‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏´‡∏±‡∏™): ' + skippedCount + ' ‡πÅ‡∏ñ‡∏ß\n';
    message += '‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏ô Drive: ' + fileCount + ' ‡πÑ‡∏ü‡∏•‡πå';
    
    if (notFoundIds.length > 0 && notFoundIds.length <= 10) {
      message += '\n\n‡∏£‡∏´‡∏±‡∏™‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏û‡∏ö:\n' + notFoundIds.join(', ');
      message += '\n\n‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î:\n' + notFoundDetails.join('\n');
      
      // ‡πÅ‡∏™‡∏î‡∏á‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ö‡∏£‡∏´‡∏±‡∏™‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏û‡∏ö
      message += '\n\n‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á‡πÉ‡∏ô Drive:';
      for (var n = 0; n < notFoundIds.length; n++) {
        var searchId = notFoundIds[n];
        var relatedFiles = [];
        for (var f = 0; f < fileList.length; f++) {
          if (fileList[f].indexOf(searchId) !== -1) {
            relatedFiles.push(fileList[f]);
          }
        }
        if (relatedFiles.length > 0) {
          message += '\n' + searchId + ': ' + relatedFiles.join(', ');
        } else {
          message += '\n' + searchId + ': ‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á';
        }
      }
    }
    
    // ‡πÅ‡∏™‡∏î‡∏á‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô Drive (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 30 ‡πÑ‡∏ü‡∏•‡πå)
    if (fileList.length > 0 && fileList.length <= 30) {
      message += '\n\n‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô Drive (' + fileList.length + ' ‡πÑ‡∏ü‡∏•‡πå):\n' + fileList.join('\n');
      Logger.log('\n‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô Drive:\n' + fileList.join('\n'));
    } else if (fileList.length > 30) {
      message += '\n\n‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô Drive: ' + fileList.length + ' ‡πÑ‡∏ü‡∏•‡πå (‡∏î‡∏π‡πÉ‡∏ô Logger)';
      Logger.log('\n‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô Drive:\n' + fileList.join('\n'));
    }
    
    Logger.log(message);
    SpreadsheetApp.getUi().alert(message);
  } catch (error) {
    var errorMsg = 'Error: ' + error.toString();
    Logger.log(errorMsg);
    SpreadsheetApp.getUi().alert(errorMsg);
  }
}

function updateImageColumn() {
  var sheetName = '‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏£‡πâ‡∏≤‡∏ô';
  var imageLinkCol = 4; // Column E
  var imageCol = 3; // Column D
  
  try {
    // ‡πÉ‡∏ä‡πâ active spreadsheet ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô (‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö trigger)
    var spreadsheet = SpreadsheetApp.getActiveSpreadsheet();
    if (!spreadsheet) {
      return;
    }
    
    var sheet = spreadsheet.getSheetByName(sheetName);
    if (!sheet) {
      return;
    }
    var data = sheet.getDataRange().getValues();
    var updatedCount = 0;
    
    for (var i = 1; i < data.length; i++) {
      var imageUrl = String(data[i][imageLinkCol] || '').trim();
      if (imageUrl && imageUrl.indexOf('http') !== -1) {
        sheet.getRange(i + 1, imageCol + 1).setValue('=IMAGE("' + imageUrl + '")');
        updatedCount++;
      }
    }
    
    // ‡πÑ‡∏°‡πà‡πÅ‡∏™‡∏î‡∏á alert ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÄ‡∏™‡∏µ‡∏¢‡πÄ‡∏ß‡∏•‡∏≤
  } catch (error) {
    // ‡πÑ‡∏°‡πà‡πÅ‡∏™‡∏î‡∏á error ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÄ‡∏™‡∏µ‡∏¢‡πÄ‡∏ß‡∏•‡∏≤
  }
}

/**
 * ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏õ‡∏∏‡πà‡∏°‡πÉ‡∏ô Google Sheets
 * ‡∏£‡∏±‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏õ‡∏∏‡πà‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó URL ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û
 */
function createButton() {
  try {
    // ‡πÉ‡∏ä‡πâ active spreadsheet ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô (‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö trigger)
    var spreadsheet = SpreadsheetApp.getActiveSpreadsheet();
    if (!spreadsheet) {
      SpreadsheetApp.getUi().alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏õ‡∏¥‡∏î‡πÑ‡∏ü‡∏•‡πå Google Sheets ‡∏Å‡πà‡∏≠‡∏ô');
      return;
    }
    
    var sheet = spreadsheet.getSheetByName('‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏£‡πâ‡∏≤‡∏ô');
    
    if (!sheet) {
      var allSheets = spreadsheet.getSheets();
      if (allSheets.length > 0) {
        sheet = allSheets[0];
      }
    }
    
    if (!sheet) {
      SpreadsheetApp.getUi().alert('‡πÑ‡∏°‡πà‡∏û‡∏ö sheet');
      return;
    }
    
    // ‡∏•‡∏ö‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏Å‡πà‡∏≤ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
    var drawings = sheet.getDrawings();
    drawings.forEach(function(drawing) {
      var note = drawing.getOnClick();
      if (note && note.indexOf('linkImagesFromDrive') !== -1) {
        drawing.remove();
      }
    });
    
    // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏õ‡∏∏‡πà‡∏°‡πÉ‡∏´‡∏°‡πà
    var range = sheet.getRange('O1'); // ‡∏ß‡∏≤‡∏á‡∏õ‡∏∏‡πà‡∏°‡∏ó‡∏µ‡πà Column O ‡πÅ‡∏ñ‡∏ß 1
    var button = sheet.newImage()
      .setUrl('https://www.gstatic.com/images/icons/material/system/1x/add_circle_outline_black_24dp.png')
      .setAnchorCell(range)
      .setWidth(100)
      .setHeight(30)
      .assignScript('linkImagesFromDrive');
    
    // ‡∏´‡∏£‡∏∑‡∏≠‡πÉ‡∏ä‡πâ‡∏ß‡∏¥‡∏ò‡∏µ‡∏™‡∏£‡πâ‡∏≤‡∏á shape ‡πÅ‡∏ó‡∏ô
    var buttonRange = sheet.getRange('O1');
    buttonRange.setValue('üîÑ ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó URL ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û');
    buttonRange.setBackground('#4285f4');
    buttonRange.setFontColor('#ffffff');
    buttonRange.setFontWeight('bold');
    buttonRange.setFontSize(11);
    buttonRange.setHorizontalAlignment('center');
    
    SpreadsheetApp.getUi().alert('‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß!\n\n‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡πÄ‡∏ã‡∏•‡∏•‡πå O1 ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏±‡∏ô‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô linkImagesFromDrive()');
  } catch (error) {
    SpreadsheetApp.getUi().alert('Error: ' + error.toString());
  }
}

/**
 * ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏°‡∏ô‡∏π‡πÉ‡∏ô Google Sheets
 * ‡∏£‡∏±‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏°‡∏ô‡∏π "‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏£‡πâ‡∏≤‡∏ô" ‡πÉ‡∏ô‡πÅ‡∏ñ‡∏ö‡πÄ‡∏°‡∏ô‡∏π
 * ‡πÅ‡∏•‡∏∞‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏†‡∏≤‡∏û‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡πÑ‡∏ü‡∏•‡πå
 */
function onOpen() {
  var ui = SpreadsheetApp.getUi();
  ui.createMenu('üÉè ‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏£‡πâ‡∏≤‡∏ô')
    .addItem('üîÑ ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó URL ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û', 'linkImagesFromDrive')
    .addItem('üñºÔ∏è ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó Column D ‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏π‡∏õ', 'updateImageColumn')
    .addSeparator()
    .addItem('‚úÇÔ∏è ‡∏Ñ‡∏£‡∏≠‡∏õ‡∏£‡∏π‡∏õ‡πÉ‡∏ô Drive', 'cropImageFromDrive')
    .addSeparator()
    .addItem('üß™ ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó (‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå)', 'testLinkImages')
    .addToUi();
  
  // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏†‡∏≤‡∏û‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡πÑ‡∏ü‡∏•‡πå (‡πÉ‡∏ä‡πâ installable trigger ‡πÅ‡∏ó‡∏ô)
  // ‡πÑ‡∏°‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ‡πÄ‡∏û‡∏£‡∏≤‡∏∞ simple trigger ‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏à‡∏≥‡∏Å‡∏±‡∏î
}

/**
 * Trigger function ‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç sheet
 * ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏†‡∏≤‡∏û‡∏Å‡∏≤‡∏£‡πå‡∏î‡πÉ‡∏ô Column E ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
 * ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: Simple trigger ‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏à‡∏≥‡∏Å‡∏±‡∏î ‡∏Ñ‡∏ß‡∏£‡πÉ‡∏ä‡πâ installable trigger ‡πÅ‡∏ó‡∏ô
 */
function onEdit(e) {
  try {
    var sheet = e.source.getActiveSheet();
    var sheetName = sheet.getName();
    
    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô sheet "‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏£‡πâ‡∏≤‡∏ô" ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
    if (sheetName === '‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏£‡πâ‡∏≤‡∏ô') {
      // ‡πÉ‡∏ä‡πâ installable trigger ‡πÅ‡∏ó‡∏ô simple trigger
      // Simple trigger ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÉ‡∏ä‡πâ openById ‡πÑ‡∏î‡πâ
    }
  } catch (error) {
    // ‡πÑ‡∏°‡πà‡πÅ‡∏™‡∏î‡∏á error ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÄ‡∏™‡∏µ‡∏¢‡πÄ‡∏ß‡∏•‡∏≤
  }
}

/**
 * Installable trigger function ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏†‡∏≤‡∏û‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
 * ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ trigger ‡πÇ‡∏î‡∏¢‡πÑ‡∏õ‡∏ó‡∏µ‡πà: Triggers > Add Trigger > onEditInstallable
 * Event type: On edit
 * Event source: From spreadsheet
 */
function onEditInstallable(e) {
  try {
    var sheet = e.source.getActiveSheet();
    var sheetName = sheet.getName();
    
    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô sheet "‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏£‡πâ‡∏≤‡∏ô" ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
    if (sheetName === '‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏£‡πâ‡∏≤‡∏ô') {
      // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏†‡∏≤‡∏û‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
      linkImagesFromDrive();
    }
  } catch (error) {
    // ‡πÑ‡∏°‡πà‡πÅ‡∏™‡∏î‡∏á error ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÄ‡∏™‡∏µ‡∏¢‡πÄ‡∏ß‡∏•‡∏≤
  }
}

/**
 * Installable trigger function ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏†‡∏≤‡∏û‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡πÑ‡∏ü‡∏•‡πå
 * ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ trigger ‡πÇ‡∏î‡∏¢‡πÑ‡∏õ‡∏ó‡∏µ‡πà: Triggers > Add Trigger > onOpenInstallable
 * Event type: On open
 * Event source: From spreadsheet
 */
function onOpenInstallable(e) {
  try {
    // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏†‡∏≤‡∏û‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡πÑ‡∏ü‡∏•‡πå
    linkImagesFromDrive();
  } catch (error) {
    // ‡πÑ‡∏°‡πà‡πÅ‡∏™‡∏î‡∏á error ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÄ‡∏™‡∏µ‡∏¢‡πÄ‡∏ß‡∏•‡∏≤
  }
}

/**
 * ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏£‡∏≠‡∏õ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÉ‡∏ô Google Drive
 * ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏π‡∏õ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô Drive folder ‡πÉ‡∏´‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏£‡∏≠‡∏õ
 */
function cropImageFromDrive() {
  try {
    var driveFolderId = '1ZVmhWN_5eMshclIzvjBlcyDwGUJW4A11';
    var folder = DriveApp.getFolderById(driveFolderId);
    var files = folder.getFiles();
    
    var imageFiles = [];
    var fileCount = 0;
    
    // ‡∏î‡∏∂‡∏á‡∏£‡∏π‡∏õ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏à‡∏≤‡∏Å folder
    while (files.hasNext() && fileCount < 100) { // ‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏ó‡∏µ‡πà 100 ‡∏£‡∏π‡∏õ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏ä‡πâ‡∏≤‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ
      var file = files.next();
      var mimeType = file.getMimeType();
      
      if (mimeType.startsWith('image/')) {
        var fileId = file.getId();
        var fileName = file.getName();
        var thumbnailUrl = 'https://drive.google.com/thumbnail?id=' + fileId + '&sz=w200';
        
        imageFiles.push({
          id: fileId,
          name: fileName,
          thumbnail: thumbnailUrl
        });
        fileCount++;
      }
    }
    
    if (imageFiles.length === 0) {
      SpreadsheetApp.getUi().alert('‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÉ‡∏ô Drive folder');
      return;
    }
    
    // ‡∏™‡∏£‡πâ‡∏≤‡∏á HTML ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏π‡∏õ
    var html = '<!DOCTYPE html><html><head>';
    html += '<meta charset="UTF-8">';
    html += '<style>';
    html += 'body { font-family: Arial, sans-serif; padding: 20px; background: #f5f5f5; margin: 0; }';
    html += 'h2 { color: #333; margin-bottom: 20px; }';
    html += '.image-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; margin-bottom: 20px; max-height: 600px; overflow-y: auto; padding: 10px; }';
    html += '.image-item { background: white; border-radius: 8px; padding: 15px; transition: all 0.2s; border: 3px solid transparent; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }';
    html += '.image-item.selected { border-color: #34a853; background: #e8f5e9; box-shadow: 0 4px 12px rgba(52,168,83,0.3); }';
    html += '.image-thumbnail { width: 100%; max-height: 400px; object-fit: contain; border-radius: 4px; margin-bottom: 10px; display: block; }';
    html += '.image-name { font-size: 14px; color: #666; text-align: center; font-weight: 500; word-break: break-word; margin-bottom: 10px; }';
    html += '.select-btn { width: 100%; padding: 12px; font-size: 16px; font-weight: bold; border: none; border-radius: 6px; cursor: pointer; background: #4285f4; color: white; transition: all 0.2s; }';
    html += '.select-btn:hover { background: #357ae8; transform: scale(1.02); }';
    html += '.select-btn.selected { background: #34a853; }';
    html += '.select-btn.selected:hover { background: #2d8f47; }';
    html += '.crop-buttons { display: none; margin-top: 20px; padding: 20px; background: white; border-radius: 8px; border-top: 3px solid #ddd; }';
    html += '.crop-buttons.show { display: block; }';
    html += '.crop-buttons h3 { margin-top: 0; color: #333; }';
    html += '.crop-btn { padding: 15px 30px; margin: 8px; font-size: 16px; border: none; border-radius: 6px; cursor: pointer; background: #4285f4; color: white; font-weight: bold; min-width: 200px; }';
    html += '.crop-btn:hover { opacity: 0.9; transform: scale(1.05); }';
    html += '.crop-btn.top { background: #ea4335; }';
    html += '.crop-btn.top:hover { background: #d33b2c; }';
    html += '.crop-btn.bottom { background: #fbbc04; }';
    html += '.crop-btn.bottom:hover { background: #f9ab00; }';
    html += '.selected-info { margin-top: 15px; padding: 15px; background: #e3f2fd; border-radius: 6px; color: #1976d2; font-weight: bold; font-size: 16px; }';
    html += '</style>';
    html += '</head><body>';
    html += '<h2>‚úÇÔ∏è ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Ñ‡∏£‡∏≠‡∏õ (‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ)</h2>';
    html += '<div class="image-grid" id="imageGrid">';
    
    // ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏π‡∏õ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î - ‡πÉ‡∏ä‡πâ‡∏£‡∏π‡∏õ‡∏Ç‡∏ô‡∏≤‡∏î‡πÉ‡∏´‡∏ç‡πà‡πÅ‡∏ó‡∏ô thumbnail
    for (var i = 0; i < imageFiles.length; i++) {
      var file = imageFiles[i];
      // ‡πÉ‡∏ä‡πâ‡∏£‡∏π‡∏õ‡∏Ç‡∏ô‡∏≤‡∏î‡πÉ‡∏´‡∏ç‡πà w800 ‡πÅ‡∏ó‡∏ô w200
      var largeImageUrl = 'https://drive.google.com/thumbnail?id=' + file.id + '&sz=w800';
      html += '<div class="image-item" id="item-' + i + '" data-file-id="' + file.id + '" data-file-name="' + file.name.replace(/"/g, '&quot;') + '">';
      html += '<img src="' + largeImageUrl + '" class="image-thumbnail" alt="' + file.name.replace(/"/g, '&quot;') + '" loading="lazy">';
      html += '<div class="image-name">' + file.name + '</div>';
      html += '<button class="select-btn" id="btn-' + i + '" data-index="' + i + '">‚úì ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡∏ô‡∏µ‡πâ</button>';
      html += '</div>';
    }
    
    html += '</div>';
    html += '<div class="selected-info" id="selectedInfo" style="display:none;"></div>';
    html += '<div class="crop-buttons" id="cropButtons">';
    html += '<h3>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏Å‡∏≤‡∏£‡∏Ñ‡∏£‡∏≠‡∏õ:</h3>';
    html += '<button class="crop-btn top" data-position="top" onclick="cropImage(\'top\')">‚¨ÜÔ∏è ‡∏ö‡∏ô (‡πÄ‡∏ß‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡πÄ‡∏¢‡∏≠‡∏∞)</button>';
    html += '<button class="crop-btn" data-position="center" onclick="cropImage(\'center\')">‚û°Ô∏è ‡∏Å‡∏•‡∏≤‡∏á (‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥)</button>';
    html += '<button class="crop-btn bottom" data-position="bottom" onclick="cropImage(\'bottom\')">‚¨áÔ∏è ‡∏•‡πà‡∏≤‡∏á (‡πÄ‡∏ß‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô‡πÄ‡∏¢‡∏≠‡∏∞)</button>';
    html += '</div>';
    
    html += '<script>';
    html += 'var selectedFileId = null;';
    html += 'var selectedFileName = null;';
    html += '';
    html += 'function selectImageByIndex(index) {';
    html += '  try {';
    html += '    var clickedItem = document.getElementById("item-" + index);';
    html += '    if (!clickedItem) {';
    html += '      alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏π‡∏õ‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å");';
    html += '      return;';
    html += '    }';
    html += '    ';
    html += '    var fileId = clickedItem.getAttribute("data-file-id");';
    html += '    var fileName = clickedItem.getAttribute("data-file-name");';
    html += '    ';
    html += '    if (!fileId) {';
    html += '      alert("‡πÑ‡∏°‡πà‡∏û‡∏ö File ID");';
    html += '      return;';
    html += '    }';
    html += '    ';
    html += '    // ‡∏•‡∏ö selected class ‡∏à‡∏≤‡∏Å‡∏ó‡∏∏‡∏Å element';
    html += '    var allItems = document.querySelectorAll(".image-item");';
    html += '    var allButtons = document.querySelectorAll(".select-btn");';
    html += '    for (var i = 0; i < allItems.length; i++) {';
    html += '      allItems[i].classList.remove("selected");';
    html += '    }';
    html += '    for (var i = 0; i < allButtons.length; i++) {';
    html += '      allButtons[i].classList.remove("selected");';
    html += '      allButtons[i].textContent = "‚úì ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡∏ô‡∏µ‡πâ";';
    html += '    }';
    html += '    ';
    html += '    // ‡πÄ‡∏û‡∏¥‡πà‡∏° selected class ‡πÉ‡∏´‡πâ element ‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å';
    html += '    clickedItem.classList.add("selected");';
    html += '    var clickedBtn = document.getElementById("btn-" + index);';
    html += '    if (clickedBtn) {';
    html += '      clickedBtn.classList.add("selected");';
    html += '      clickedBtn.textContent = "‚úì ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß";';
    html += '    }';
    html += '    ';
    html += '    selectedFileId = fileId;';
    html += '    selectedFileName = fileName;';
    html += '    ';
    html += '    var infoDiv = document.getElementById("selectedInfo");';
    html += '    if (infoDiv) {';
    html += '      infoDiv.style.display = "block";';
    html += '      infoDiv.textContent = "‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ: " + fileName;';
    html += '    }';
    html += '    ';
    html += '    var cropDiv = document.getElementById("cropButtons");';
    html += '    if (cropDiv) {';
    html += '      cropDiv.classList.add("show");';
    html += '      setTimeout(function() {';
    html += '        cropDiv.scrollIntoView({ behavior: "smooth", block: "nearest" });';
    html += '      }, 100);';
    html += '    }';
    html += '  } catch (e) {';
    html += '    alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + e.message);';
    html += '    console.error(e);';
    html += '  }';
    html += '}';
    html += '';
    html += '// ‡πÉ‡∏ä‡πâ addEventListener ‡πÅ‡∏ó‡∏ô onclick ‡πÄ‡∏û‡∏£‡∏≤‡∏∞ onclick ‡πÑ‡∏°‡πà‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÉ‡∏ô Google Apps Script';
    html += 'function setupButtons() {';
    html += '  var selectButtons = document.querySelectorAll(".select-btn");';
    html += '  alert("‡∏û‡∏ö‡∏õ‡∏∏‡πà‡∏°: " + selectButtons.length + " ‡∏õ‡∏∏‡πà‡∏°");';
    html += '  for (var i = 0; i < selectButtons.length; i++) {';
    html += '    selectButtons[i].addEventListener("click", function(e) {';
    html += '      e.preventDefault();';
    html += '      e.stopPropagation();';
    html += '      alert("‡∏Ñ‡∏•‡∏¥‡∏Å‡∏õ‡∏∏‡πà‡∏°‡πÅ‡∏•‡πâ‡∏ß");';
    html += '      var index = this.getAttribute("data-index");';
    html += '      alert("index: " + index);';
    html += '      if (index !== null && index !== undefined) {';
    html += '        selectImageByIndex(parseInt(index));';
    html += '      } else {';
    html += '        alert("‡πÑ‡∏°‡πà‡∏û‡∏ö index");';
    html += '      }';
    html += '    }, true);';
    html += '  }';
    html += '}';
    html += '';
    html += '// ‡∏•‡∏≠‡∏á‡∏ó‡∏±‡πâ‡∏á DOMContentLoaded ‡πÅ‡∏•‡∏∞ window.onload';
    html += 'if (document.readyState === "loading") {';
    html += '  document.addEventListener("DOMContentLoaded", setupButtons);';
    html += '} else {';
    html += '  setupButtons();';
    html += '}';
    html += 'window.onload = setupButtons;';
    html += '';
    html += 'function cropImage(position) {';
  html += '  if (!selectedFileId) {';
  html += '    alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡∏Å‡πà‡∏≠‡∏ô");';
  html += '    return;';
  html += '  }';
  html += '  var positionText = position === "top" ? "‚¨ÜÔ∏è ‡∏ö‡∏ô" : position === "bottom" ? "‚¨áÔ∏è ‡∏•‡πà‡∏≤‡∏á" : "‚û°Ô∏è ‡∏Å‡∏•‡∏≤‡∏á";';
  html += '  if (confirm("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡∏£‡∏≠‡∏õ‡∏£‡∏π‡∏õ: " + selectedFileName + "\\n‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á: " + positionText + "\\n\\n‚ö†Ô∏è ‡∏Å‡∏≤‡∏£‡∏Ñ‡∏£‡∏≠‡∏õ‡∏à‡∏∞‡∏ó‡∏±‡∏ö‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏î‡∏¥‡∏°!")) {';
  html += '    var btn = document.querySelector(\'[data-position="\' + position + \'"]\');';
  html += '    if (btn) {';
  html += '      btn.disabled = true;';
  html += '      var originalText = btn.textContent;';
  html += '      btn.textContent = "‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡∏£‡∏≠‡∏õ...";';
  html += '    }';
  html += '    google.script.run.withSuccessHandler(function(result) {';
  html += '      if (btn) {';
  html += '        btn.disabled = false;';
  html += '        btn.textContent = originalText;';
  html += '      }';
  html += '      if (result && result.success) {';
  html += '        alert("‚úÖ ‡∏Ñ‡∏£‡∏≠‡∏õ‡∏£‡∏π‡∏õ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!\\n\\n‡πÑ‡∏ü‡∏•‡πå: " + result.fileName + "\\n‡∏Ç‡∏ô‡∏≤‡∏î‡πÉ‡∏´‡∏°‡πà: " + result.newSize.width + " x " + result.newSize.height + "px");';
  html += '        google.script.host.close();';
  html += '      } else {';
  html += '        alert("‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + (result ? result.error : "‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏"));';
  html += '      }';
  html += '    }).withFailureHandler(function(error) {';
  html += '      if (btn) {';
  html += '        btn.disabled = false;';
  html += '        btn.textContent = originalText;';
  html += '      }';
  html += '      alert("‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + (error ? error.message : "‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏"));';
  html += '    }).cropImageWithPosition(selectedFileId, position);';
  html += '  }';
  html += '}';
  html += '</script>';
    html += '</body></html>';
    
    var htmlOutput = HtmlService.createHtmlOutput(html)
      .setWidth(900)
      .setHeight(700);
    
    SpreadsheetApp.getUi().showModalDialog(htmlOutput, '‚úÇÔ∏è ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Ñ‡∏£‡∏≠‡∏õ');
    
  } catch (error) {
    SpreadsheetApp.getUi().alert('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.toString());
    Logger.log('Error in cropImageFromDrive: ' + error.toString());
  }
}

/**
 * ‡∏î‡∏∂‡∏á File ID ‡∏à‡∏≤‡∏Å input (URL ‡∏´‡∏£‡∏∑‡∏≠ File ID ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á)
 * @param {string} input - URL ‡∏´‡∏£‡∏∑‡∏≠ File ID
 * @return {string} File ID
 */
function extractFileIdFromInput(input) {
  // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô URL ‡πÉ‡∏´‡πâ‡∏î‡∏∂‡∏á File ID
  if (input.indexOf('drive.google.com') !== -1 || input.indexOf('googleusercontent.com') !== -1) {
    // ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ï‡πà‡∏≤‡∏á‡πÜ ‡∏Ç‡∏≠‡∏á Google Drive URL
    var patterns = [
      /\/d\/([a-zA-Z0-9_-]+)/,  // lh3.googleusercontent.com/d/FILE_ID ‡∏´‡∏£‡∏∑‡∏≠ drive.google.com/file/d/FILE_ID
      /id=([a-zA-Z0-9_-]+)/,     // drive.google.com/thumbnail?id=FILE_ID
      /\/uc\?id=([a-zA-Z0-9_-]+)/,   // drive.google.com/uc?id=FILE_ID
    ];
    
    for (var i = 0; i < patterns.length; i++) {
      var match = input.match(patterns[i]);
      if (match && match[1]) {
        return match[1];
      }
    }
  }
  
  // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà URL ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡πÉ‡∏™‡πà‡∏°‡∏≤‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á (‡∏ô‡πà‡∏≤‡∏à‡∏∞‡πÄ‡∏õ‡πá‡∏ô File ID)
  // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô File ID ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á (‡∏¢‡∏≤‡∏ß‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì 33 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£)
  if (input.length > 10 && /^[a-zA-Z0-9_-]+$/.test(input)) {
    return input;
  }
  
  return null;
}

/**
 * ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏£‡∏≠‡∏õ‡∏£‡∏π‡∏õ‡∏à‡∏£‡∏¥‡∏á‡πÜ
 * @param {string} fileId - Google Drive File ID
 * @param {string} cropPosition - 'top', 'center', ‡∏´‡∏£‡∏∑‡∏≠ 'bottom'
 * @return {Object} ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏Å‡∏≤‡∏£‡∏Ñ‡∏£‡∏≠‡∏õ {success: boolean, fileName: string, newSize: {width, height}, error: string}
 */
function cropImageWithPosition(fileId, cropPosition) {
  try {
    // ‡πÄ‡∏õ‡∏¥‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏à‡∏≤‡∏Å Drive
    var file = DriveApp.getFileById(fileId);
    
    if (!file) {
      return {
        success: false,
        error: '‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏ô Drive'
      };
    }
    
    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏ü‡∏•‡πå‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
    var mimeType = file.getMimeType();
    if (!mimeType.startsWith('image/')) {
      return {
        success: false,
        error: '‡πÑ‡∏ü‡∏•‡πå‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û'
      };
    }
    
    // ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ
    var blob = file.getBlob();
    var image = ImagesService.newImage(blob);
    
    // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ç‡∏ô‡∏≤‡∏î‡πÉ‡∏´‡∏°‡πà‡∏ï‡∏≤‡∏° aspect ratio 2.5:3.5
    var originalWidth = image.getWidth();
    var originalHeight = image.getHeight();
    var originalAspectRatio = originalWidth / originalHeight;
    var targetAspectRatio = 2.5 / 3.5; // ‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡πå‡∏î Pokemon
    
    var newWidth, newHeight, cropX, cropY;
    
    if (originalAspectRatio > targetAspectRatio) {
      // ‡∏£‡∏π‡∏õ‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡∏Å‡∏ß‡πà‡∏≤ ‚Üí ‡∏ï‡πâ‡∏≠‡∏á‡∏Ñ‡∏£‡∏≠‡∏õ‡∏î‡πâ‡∏≤‡∏ô‡∏Ç‡πâ‡∏≤‡∏á
      newHeight = originalHeight;
      newWidth = Math.round(originalHeight * targetAspectRatio);
      cropX = Math.round((originalWidth - newWidth) / 2);
      cropY = 0;
    } else {
      // ‡∏£‡∏π‡∏õ‡∏™‡∏π‡∏á‡∏Å‡∏ß‡πà‡∏≤ ‚Üí ‡∏ï‡πâ‡∏≠‡∏á‡∏Ñ‡∏£‡∏≠‡∏õ‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô/‡∏•‡πà‡∏≤‡∏á
      newWidth = originalWidth;
      newHeight = Math.round(originalWidth / targetAspectRatio);
      cropX = 0;
      
      // ‡∏õ‡∏£‡∏±‡∏ö cropY ‡∏ï‡∏≤‡∏° cropPosition
      if (cropPosition === 'top') {
        cropY = 0; // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏à‡∏≤‡∏Å‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô
      } else if (cropPosition === 'bottom') {
        cropY = originalHeight - newHeight; // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏à‡∏≤‡∏Å‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á
      } else {
        cropY = Math.round((originalHeight - newHeight) / 2); // center
      }
    }
    
    // ‡∏Ñ‡∏£‡∏≠‡∏õ‡∏£‡∏π‡∏õ
    var croppedImage = image.crop(cropX, cropY, newWidth, newHeight);
    
    // ‡πÅ‡∏õ‡∏•‡∏á‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô blob
    var croppedBlob = croppedImage.getBlob();
    
    // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏î‡∏¥‡∏°
    file.setContent(croppedBlob);
    
    // ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå
    return {
      success: true,
      fileName: file.getName(),
      originalSize: {
        width: originalWidth,
        height: originalHeight
      },
      newSize: {
        width: newWidth,
        height: newHeight
      },
      cropPosition: cropPosition,
      cropOffset: {
        x: cropX,
        y: cropY
      }
    };
    
  } catch (error) {
    Logger.log('Error cropping image: ' + error.toString());
    return {
      success: false,
      error: error.toString()
    };
  }
}
