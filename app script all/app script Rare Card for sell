function doGet(e) {
  try {
    var isJson = e && e.parameter && e.parameter.type === 'json';
    var sheetType = e && e.parameter && e.parameter.sheet || 'consignment'; // 'consignment' ‡∏´‡∏£‡∏∑‡∏≠ 'shop'
    
    // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô shop sheet ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà
    if (sheetType === 'shop') {
      return doGetShopCards(e);
    }
    
    var spreadsheetId = '1t-3GcjlaV2YL3aSKe-EG34xPiolaWodxK8smyqjDE_E';
    var spreadsheet = SpreadsheetApp.openById(spreadsheetId);
    
    var targetSheet = spreadsheet.getSheetByName('‡∏ù‡∏≤‡∏Å‡∏Ç‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πå‡∏î');
    if (!targetSheet) {
      targetSheet = spreadsheet.getSheetByName('Sheet1');
    }
    if (!targetSheet) {
      var allSheets = spreadsheet.getSheets();
      if (allSheets.length > 0) {
        targetSheet = allSheets[0];
      }
    }
    
    if (!targetSheet) {
      if (isJson) {
        return ContentService.createTextOutput(JSON.stringify({
          error: "‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ä‡∏µ‡∏ó‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•",
          cards: []
        })).setMimeType(ContentService.MimeType.JSON);
      }
      return HtmlService.createHtmlOutput("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ä‡∏µ‡∏ó‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•");
    }
    
    // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏°‡∏≤‡πÉ‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß (‡πÄ‡∏£‡πá‡∏ß‡∏Å‡∏ß‡πà‡∏≤‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á‡∏ó‡∏µ‡∏•‡∏∞‡πÅ‡∏ñ‡∏ß)
    var data = targetSheet.getDataRange().getValues();
    
    if (data.length <= 1) {
      if (isJson) {
        return ContentService.createTextOutput(JSON.stringify({
          error: "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•",
          cards: []
        })).setMimeType(ContentService.MimeType.JSON);
      }
      return HtmlService.createHtmlOutput("‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•");
    }
    
    var headers = data[0];
    var cards = [];
    
    // ‡∏™‡∏£‡πâ‡∏≤‡∏á colIndex ‡πÅ‡∏ö‡∏ö‡πÄ‡∏£‡πá‡∏ß (‡πÉ‡∏ä‡πâ index ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á)
    var colIndex = {};
    var headerCount = headers.length;
    for (var h = 0; h < headerCount; h++) {
      colIndex[headers[h]] = h;
    }
    
    // Cache column indices ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
    var idxDate = colIndex['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ù‡∏≤‡∏Å'];
    var idxConsignor = colIndex['‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏ù‡∏≤‡∏Å‡∏Ç‡∏≤‡∏¢'];
    var idxPhone = colIndex['‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£'];
    var idxSlot = colIndex['‡∏ä‡πà‡∏≠‡∏á‡πÉ‡∏ô‡πÅ‡∏ü‡πâ‡∏°'];
    var idxCardName = colIndex['‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡πå‡∏î'];
    var idxPrice = colIndex['‡∏£‡∏≤‡∏Ñ‡∏≤‡∏õ‡πâ‡∏≤‡∏¢'];
    var idxActualPrice = colIndex['‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Ç‡∏≤‡∏¢‡∏à‡∏£‡∏¥‡∏á'];
    var idxStatus = colIndex['‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞'];
    var idxSaleDate = colIndex['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏¢/‡∏Ñ‡∏∑‡∏ô'];
    var idxRefund = colIndex['‡∏¢‡∏≠‡∏î‡∏Ñ‡∏∑‡∏ô‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ (90%)'];
    var idxNotes = colIndex['‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏'];
    var idxProductId = colIndex['‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤'];
    var idxImageLink = colIndex['‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏†‡∏≤‡∏û‡∏Å‡∏≤‡∏£‡πå‡∏î'];
    
    // Cache folder ‡πÅ‡∏•‡∏∞ files ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡∏¥‡∏î folder ‡∏ã‡πâ‡∏≥ (‡πÄ‡∏£‡πá‡∏ß‡∏Ç‡∏∂‡πâ‡∏ô‡∏°‡∏≤‡∏Å!)
    var driveFolderId = '1ZVmhWN_5eMshclIzvjBlcyDwGUJW4A11';
    var folder = null;
    var fileMap = {}; // Cache files ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ã‡πâ‡∏≥
    try {
      folder = DriveApp.getFolderById(driveFolderId);
      // ‡∏î‡∏∂‡∏á‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏à‡∏≤‡∏Å folder ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß (‡πÄ‡∏£‡πá‡∏ß‡∏Å‡∏ß‡πà‡∏≤‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ó‡∏µ‡∏•‡∏∞‡πÑ‡∏ü‡∏•‡πå)
      var allFiles = folder.getFiles();
      while (allFiles.hasNext()) {
        var file = allFiles.next();
        var fileName = file.getName();
        fileMap[fileName] = {
          id: file.getId(),
          file: file
        };
      }
    } catch (e) {
      // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏Å‡∏¥‡∏î error ‡πÉ‡∏´‡πâ‡∏Ç‡πâ‡∏≤‡∏°‡πÑ‡∏õ (‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏™‡∏î‡∏á error)
    }
    
    // ‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÅ‡∏ö‡∏ö batch (‡πÄ‡∏£‡πá‡∏ß‡∏Å‡∏ß‡πà‡∏≤‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏ó‡∏µ‡∏•‡∏∞‡πÅ‡∏ñ‡∏ß)
    var rowCount = data.length;
    var cardImage, imageLink, imageLinkStr, idMatch, cardName, status;
    var statusCounts = {};
    var totalProcessed = 0;
    var skippedNoName = 0;
    var skippedRows = [];
    
    for (var i = 1; i < rowCount; i++) {
      var row = data[i];
      
      // ‡∏≠‡πà‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏î‡∏¢‡πÉ‡∏ä‡πâ index ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á (‡πÄ‡∏£‡πá‡∏ß‡∏Å‡∏ß‡πà‡∏≤)
      cardName = row[idxCardName];
      // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà (‡∏£‡∏ß‡∏°‡∏ñ‡∏∂‡∏á whitespace)
      if (!cardName || String(cardName).trim() === '') {
        skippedNoName++;
        // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏Ç‡πâ‡∏≤‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠ debug
        if (skippedRows.length < 5) { // ‡πÄ‡∏Å‡πá‡∏ö‡πÅ‡∏Ñ‡πà 5 ‡πÅ‡∏ñ‡∏ß‡πÅ‡∏£‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ log ‡∏¢‡∏≤‡∏ß‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ
          skippedRows.push({
            row: i + 1,
            cardName: cardName,
            productId: row[idxProductId] || '',
            status: row[idxStatus] || ''
          });
        }
        continue; // ‡∏Ç‡πâ‡∏≤‡∏°‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡πå‡∏î
      }
      
      status = String(row[idxStatus] || '‡∏¢‡∏±‡∏á‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà').trim();
      statusCounts[status] = (statusCounts[status] || 0) + 1;
      totalProcessed++;
      
      // ‡πÅ‡∏™‡∏î‡∏á‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏ó‡∏∏‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ (‡πÑ‡∏°‡πà‡∏Å‡∏£‡∏≠‡∏á)
      
      // ‡∏≠‡πà‡∏≤‡∏ô‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏à‡∏≤‡∏Å Column G ‡πÅ‡∏ö‡∏ö‡πÄ‡∏£‡πá‡∏ß
      cardImage = '';
      if (idxImageLink !== undefined) {
        imageLink = row[idxImageLink];
        if (imageLink) {
          imageLinkStr = String(imageLink);
          if (imageLinkStr.indexOf('http') !== -1) {
            if (imageLinkStr.indexOf('thumbnail?id=') !== -1) {
              cardImage = imageLinkStr;
            } else {
              idMatch = imageLinkStr.match(/id=([a-zA-Z0-9_-]+)/);
              if (idMatch && idMatch[1]) {
                cardImage = 'https://drive.google.com/thumbnail?id=' + idMatch[1] + '&sz=w1000';
              } else {
                cardImage = imageLinkStr;
              }
            }
          }
        }
      }
      
      // ‡∏î‡∏∂‡∏á‡∏£‡∏π‡∏õ‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å Drive ‡πÇ‡∏î‡∏¢‡πÉ‡∏ä‡πâ productId - ‡πÉ‡∏ä‡πâ fileMap ‡∏ó‡∏µ‡πà cache ‡πÑ‡∏ß‡πâ‡πÅ‡∏•‡πâ‡∏ß (‡πÄ‡∏£‡πá‡∏ß‡∏°‡∏≤‡∏Å!)
      var cardBackImage = '';
      var productId = String(row[idxProductId] || '').trim();
      if (productId && fileMap) {
        var backFileName = productId + ' ‡∏´‡∏•‡∏±‡∏á.jpg';
        var cachedFile = fileMap[backFileName];
        if (cachedFile) {
          try {
            // ‡∏•‡∏î‡∏Å‡∏≤‡∏£ setSharing (‡πÑ‡∏°‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡∏ñ‡πâ‡∏≤‡πÑ‡∏ü‡∏•‡πå share ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß) - ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡πÄ‡∏£‡πá‡∏ß‡∏Ç‡∏∂‡πâ‡∏ô‡∏°‡∏≤‡∏Å
            // ‡∏ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ setSharing ‡πÉ‡∏´‡πâ uncomment ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ
            // cachedFile.file.setSharing(DriveApp.Access.ANYONE_WITH_LINK, DriveApp.Permission.VIEW);
            var backFileId = cachedFile.id;
            cardBackImage = 'https://drive.google.com/thumbnail?id=' + backFileId + '&sz=w1000';
          } catch (e) {
            // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏Å‡∏¥‡∏î error ‡πÉ‡∏´‡πâ‡∏Ç‡πâ‡∏≤‡∏°‡πÑ‡∏õ (‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏™‡∏î‡∏á error)
          }
        }
      }
      
      // ‡∏™‡∏£‡πâ‡∏≤‡∏á object ‡πÅ‡∏ö‡∏ö‡πÄ‡∏£‡πá‡∏ß (‡πÉ‡∏ä‡πâ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡πÑ‡∏ß‡πâ‡πÅ‡∏•‡πâ‡∏ß)
      cards.push({
        depositDate: row[idxDate] || '',
        consignorName: row[idxConsignor] || '',
        phone: row[idxPhone] || '',
        folderSlot: row[idxSlot] || '',
        cardName: cardName,
        cardImage: cardImage,
        cardBackImage: cardBackImage,
        productId: productId,
        listedPrice: row[idxPrice] || '',
        actualPrice: row[idxActualPrice] || '',
        status: status,
        saleDate: row[idxSaleDate] || '',
        refundAmount: row[idxRefund] || '',
        notes: row[idxNotes] || ''
      });
    }
    
    if (isJson) {
      var debugInfo = [];
      debugInfo.push('üìä ‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: ' + totalProcessed + ' ‡∏Å‡∏≤‡∏£‡πå‡∏î');
      debugInfo.push('‚è≠Ô∏è ‡∏Ç‡πâ‡∏≤‡∏° (‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ä‡∏∑‡πà‡∏≠): ' + skippedNoName + ' ‡πÅ‡∏ñ‡∏ß');
      debugInfo.push('‚úÖ ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å: ' + cards.length + ' ‡∏Å‡∏≤‡∏£‡πå‡∏î');
      debugInfo.push('üìã ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ' + JSON.stringify(statusCounts));
      if (skippedRows.length > 0) {
        debugInfo.push('üîç ‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏Ç‡πâ‡∏≤‡∏° (‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á): ' + JSON.stringify(skippedRows));
      }
      
      return ContentService.createTextOutput(JSON.stringify({
        cards: cards,
        total: cards.length,
        debug: debugInfo
      })).setMimeType(ContentService.MimeType.JSON);
    }
    
    var html = '<html><body><h2>‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏ù‡∏≤‡∏Å‡∏Ç‡∏≤‡∏¢</h2><ul>';
    cards.forEach(function(card) {
      html += '<li>' + card.cardName + ' - ' + card.listedPrice + ' ‡∏ö‡∏≤‡∏ó</li>';
    });
    html += '</ul></body></html>';
    return HtmlService.createHtmlOutput(html);
    
  } catch (error) {
    var errorMsg = '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.toString();
    
    if (e && e.parameter && e.parameter.type === 'json') {
      return ContentService.createTextOutput(JSON.stringify({
        error: errorMsg,
        cards: []
      })).setMimeType(ContentService.MimeType.JSON);
    }
    
    return HtmlService.createHtmlOutput(errorMsg);
  }
}

/**
 * ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å sheet "‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏£‡πâ‡∏≤‡∏ô" ‡πÇ‡∏î‡∏¢‡πÄ‡∏â‡∏û‡∏≤‡∏∞
 * ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏ú‡πà‡∏≤‡∏ô: doGet?type=json&sheet=shop
 */
function doGetShopCards(e) {
  try {
    var isJson = e && e.parameter && e.parameter.type === 'json';
    
    // Debug: ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• debug
    var debugInfo = [];
    debugInfo.push('üîç ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏≥‡∏á‡∏≤‡∏ô doGetShopCards');
    debugInfo.push('üìã Parameter: ' + JSON.stringify(e ? e.parameter : 'no parameter'));
    debugInfo.push('üìã isJson: ' + isJson);
    
    // ‡πÉ‡∏ä‡πâ getActiveSpreadsheet() ‡πÄ‡∏û‡∏£‡∏≤‡∏∞ Apps Script ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô Spreadsheet ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô
    var spreadsheet;
    try {
      debugInfo.push('üîç ‡πÉ‡∏ä‡πâ SpreadsheetApp.getActiveSpreadsheet()...');
      spreadsheet = SpreadsheetApp.getActiveSpreadsheet();
      if (!spreadsheet) {
        debugInfo.push('‚ùå ‡πÑ‡∏°‡πà‡∏°‡∏µ Active Spreadsheet');
        if (isJson) {
          return ContentService.createTextOutput(JSON.stringify({
            error: "‡πÑ‡∏°‡πà‡∏û‡∏ö Spreadsheet",
            cards: [],
            debug: debugInfo,
            suggestion: "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ Apps Script ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô Spreadsheet ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á"
          })).setMimeType(ContentService.MimeType.JSON);
        }
        return HtmlService.createHtmlOutput("‡πÑ‡∏°‡πà‡∏û‡∏ö Spreadsheet<br><br>Debug:<br>" + debugInfo.join("<br>"));
      }
      debugInfo.push('‚úÖ ‡πÉ‡∏ä‡πâ Active Spreadsheet ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
      debugInfo.push('üìã Spreadsheet Name: ' + spreadsheet.getName());
    } catch (activeError) {
      debugInfo.push('‚ùå Error ‡πÉ‡∏ä‡πâ Active Spreadsheet: ' + activeError.toString());
      
      if (isJson) {
        return ContentService.createTextOutput(JSON.stringify({
          error: "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á Spreadsheet ‡πÑ‡∏î‡πâ: " + activeError.toString(),
          cards: [],
          debug: debugInfo,
          suggestion: "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ Apps Script ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô Spreadsheet ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á"
        })).setMimeType(ContentService.MimeType.JSON);
      }
      return HtmlService.createHtmlOutput("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á Spreadsheet ‡πÑ‡∏î‡πâ<br><br>Debug:<br>" + debugInfo.join("<br>"));
    }
    
    if (!spreadsheet) {
      debugInfo.push('‚ùå Spreadsheet ‡πÄ‡∏õ‡πá‡∏ô null');
      if (isJson) {
        return ContentService.createTextOutput(JSON.stringify({
          error: "‡πÑ‡∏°‡πà‡∏û‡∏ö Spreadsheet",
          cards: [],
          debug: debugInfo
        })).setMimeType(ContentService.MimeType.JSON);
      }
      return HtmlService.createHtmlOutput("‡πÑ‡∏°‡πà‡∏û‡∏ö Spreadsheet<br><br>Debug:<br>" + debugInfo.join("<br>"));
    }
    
    debugInfo.push('üîç ‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡∏´‡∏≤ sheet "‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏£‡πâ‡∏≤‡∏ô"...');
    var targetSheet = spreadsheet.getSheetByName('‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏£‡πâ‡∏≤‡∏ô');
    
    if (!targetSheet) {
      debugInfo.push('‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö sheet "‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏£‡πâ‡∏≤‡∏ô"');
      // ‡∏•‡∏≠‡∏á‡∏´‡∏≤ sheet ‡∏≠‡∏∑‡πà‡∏ô‡πÜ
      var allSheets = spreadsheet.getSheets();
      debugInfo.push('üìã ‡∏û‡∏ö sheets ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: ' + allSheets.length + ' sheets');
      for (var s = 0; s < allSheets.length && s < 5; s++) {
        debugInfo.push('  - Sheet ' + (s + 1) + ': ' + allSheets[s].getName());
      }
      
      if (isJson) {
        return ContentService.createTextOutput(JSON.stringify({
          error: "‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ä‡∏µ‡∏ó '‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏£‡πâ‡∏≤‡∏ô'",
          cards: [],
          debug: debugInfo
        })).setMimeType(ContentService.MimeType.JSON);
      }
      return HtmlService.createHtmlOutput("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ä‡∏µ‡∏ó '‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏£‡πâ‡∏≤‡∏ô'<br><br>Debug:<br>" + debugInfo.join("<br>"));
    }
    
    debugInfo.push('‚úÖ ‡∏û‡∏ö sheet "‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏£‡πâ‡∏≤‡∏ô"');
    
    debugInfo.push('üîç ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å sheet...');
    var data = targetSheet.getDataRange().getValues();
    debugInfo.push('üìã ‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: ' + data.length + ' ‡πÅ‡∏ñ‡∏ß');
    
    if (data.length <= 1) {
      debugInfo.push('‚ùå ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡∏°‡∏µ‡πÅ‡∏Ñ‡πà header ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏•‡∏¢)');
      if (isJson) {
        return ContentService.createTextOutput(JSON.stringify({
          error: "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•",
          cards: [],
          debug: debugInfo
        })).setMimeType(ContentService.MimeType.JSON);
      }
      return HtmlService.createHtmlOutput("‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•<br><br>Debug:<br>" + debugInfo.join("<br>"));
    }
    
    var headers = data[0];
    var cards = [];
    
    // ‡∏™‡∏£‡πâ‡∏≤‡∏á colIndex
    var colIndex = {};
    for (var h = 0; h < headers.length; h++) {
      colIndex[headers[h]] = h;
    }
    
    // Column indices ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö sheet "‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏£‡πâ‡∏≤‡∏ô"
    var idxDate = colIndex['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏•‡∏á'] !== undefined ? colIndex['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏•‡∏á'] : -1;
    var idxSlot = colIndex['‡∏ä‡πà‡∏≠‡∏á‡πÉ‡∏ô‡πÅ‡∏ü‡πâ‡∏°'] !== undefined ? colIndex['‡∏ä‡πà‡∏≠‡∏á‡πÉ‡∏ô‡πÅ‡∏ü‡πâ‡∏°'] : -1;
    var idxCardName = colIndex['‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡πå‡∏î'] !== undefined ? colIndex['‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡πå‡∏î'] : -1;
    var idxImageLink = colIndex['‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏†‡∏≤‡∏û‡∏Å‡∏≤‡∏£‡πå‡∏î'] !== undefined ? colIndex['‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏†‡∏≤‡∏û‡∏Å‡∏≤‡∏£‡πå‡∏î'] : -1;
    var idxPrice = colIndex['‡∏£‡∏≤‡∏Ñ‡∏≤‡∏õ‡πâ‡∏≤‡∏¢'] !== undefined ? colIndex['‡∏£‡∏≤‡∏Ñ‡∏≤‡∏õ‡πâ‡∏≤‡∏¢'] : -1;
    var idxActualPrice = colIndex['‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Ç‡∏≤‡∏¢‡∏à‡∏£‡∏¥‡∏á'] !== undefined ? colIndex['‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Ç‡∏≤‡∏¢‡∏à‡∏£‡∏¥‡∏á'] : -1;
    var idxStatus = colIndex['‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞'] !== undefined ? colIndex['‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞'] : -1;
    var idxSaleDate = colIndex['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏¢'] !== undefined ? colIndex['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏¢'] : -1;
    var idxNotes = colIndex['‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏'] !== undefined ? colIndex['‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏'] : -1;
    var idxProductId = colIndex['‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤'] !== undefined ? colIndex['‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤'] : -1;
    
    // Cache folder ‡πÅ‡∏•‡∏∞ files
    var driveFolderId = '1ZVmhWN_5eMshclIzvjBlcyDwGUJW4A11';
    var folder = null;
    var fileMap = {};
    try {
      folder = DriveApp.getFolderById(driveFolderId);
      var allFiles = folder.getFiles();
      while (allFiles.hasNext()) {
        var file = allFiles.next();
        var fileName = file.getName();
        fileMap[fileName] = {
          id: file.getId(),
          file: file
        };
      }
    } catch (e) {
      // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏Å‡∏¥‡∏î error ‡πÉ‡∏´‡πâ‡∏Ç‡πâ‡∏≤‡∏°‡πÑ‡∏õ
    }
    
    // ‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
    for (var i = 1; i < data.length; i++) {
      var row = data[i];
      
      var cardName = idxCardName >= 0 ? row[idxCardName] : '';
      if (!cardName || String(cardName).trim() === '') {
        continue;
      }
      
      // ‡∏≠‡πà‡∏≤‡∏ô‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏à‡∏≤‡∏Å Column E (‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏†‡∏≤‡∏û‡∏Å‡∏≤‡∏£‡πå‡∏î)
      var cardImage = '';
      if (idxImageLink >= 0) {
        var imageLink = row[idxImageLink];
        if (imageLink) {
          var imageLinkStr = String(imageLink);
          if (imageLinkStr.indexOf('http') !== -1) {
            if (imageLinkStr.indexOf('thumbnail?id=') !== -1) {
              cardImage = imageLinkStr;
            } else {
              var idMatch = imageLinkStr.match(/id=([a-zA-Z0-9_-]+)/);
              if (idMatch && idMatch[1]) {
                cardImage = 'https://drive.google.com/thumbnail?id=' + idMatch[1] + '&sz=w1000';
              } else {
                cardImage = imageLinkStr;
              }
            }
          }
        }
      }
      
      // ‡∏î‡∏∂‡∏á‡∏£‡∏π‡∏õ‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å Drive
      var cardBackImage = '';
      var productId = idxProductId >= 0 ? String(row[idxProductId] || '').trim() : '';
      if (productId && fileMap) {
        // ‡∏•‡∏≠‡∏á‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå‡∏´‡∏•‡∏≤‡∏¢‡πÅ‡∏ö‡∏ö
        var backFileName1 = productId + ' ‡∏´‡∏•‡∏±‡∏á.jpg';
        var backFileName2 = productId + '‡∏´‡∏•‡∏±‡∏á.jpg';
        var backFileName3 = productId + ' ‡∏´‡∏•‡∏±‡∏á.jpg';
        var backFileName4 = productId + '‡∏´‡∏•‡∏±‡∏á.jpg';
        var cachedFile = fileMap[backFileName1] || fileMap[backFileName2] || fileMap[backFileName3] || fileMap[backFileName4];
        
        if (!cachedFile) {
          // ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÅ‡∏ö‡∏ö fuzzy
          for (var fileName in fileMap) {
            if (fileName.indexOf(productId) !== -1 && 
                (fileName.indexOf('‡∏´‡∏•‡∏±‡∏á') !== -1 || fileName.indexOf('‡∏´‡∏•‡∏±‡∏á') !== -1) && 
                (fileName.indexOf('.jpg') !== -1 || fileName.indexOf('.JPG') !== -1)) {
              cachedFile = fileMap[fileName];
              break;
            }
          }
        }
        
        if (cachedFile) {
          try {
            var backFileId = cachedFile.id;
            cardBackImage = 'https://drive.google.com/thumbnail?id=' + backFileId + '&sz=w1000';
          } catch (e) {}
        }
      }
      
      var status = idxStatus >= 0 ? String(row[idxStatus] || '‡∏¢‡∏±‡∏á‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà').trim() : '‡∏¢‡∏±‡∏á‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà';
      
      cards.push({
        postedDate: idxDate >= 0 ? row[idxDate] : '',
        folderSlot: idxSlot >= 0 ? row[idxSlot] : '',
        cardName: cardName,
        cardImage: cardImage,
        cardBackImage: cardBackImage,
        productId: productId,
        listedPrice: idxPrice >= 0 ? row[idxPrice] : '',
        actualPrice: idxActualPrice >= 0 ? row[idxActualPrice] : '',
        status: status,
        saleDate: idxSaleDate >= 0 ? row[idxSaleDate] : '',
        notes: idxNotes >= 0 ? row[idxNotes] : ''
      });
    }
    
    debugInfo.push('‚úÖ ‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡πÄ‡∏™‡∏£‡πá‡∏à: ' + cards.length + ' ‡∏Å‡∏≤‡∏£‡πå‡∏î');
    
    if (isJson) {
      return ContentService.createTextOutput(JSON.stringify({
        cards: cards,
        total: cards.length,
        debug: debugInfo
      })).setMimeType(ContentService.MimeType.JSON);
    }
    
    var html = '<html><body><h2>‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏£‡πâ‡∏≤‡∏ô</h2><ul>';
    cards.forEach(function(card) {
      html += '<li>' + card.cardName + ' - ' + card.listedPrice + ' ‡∏ö‡∏≤‡∏ó</li>';
    });
    html += '</ul></body></html>';
    return HtmlService.createHtmlOutput(html);
    
  } catch (error) {
    var errorMsg = '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.toString();
    var debugInfo = [];
    debugInfo.push('‚ùå Error ‡πÉ‡∏ô doGetShopCards (catch block)');
    debugInfo.push('üìã Error Type: ' + typeof error);
    debugInfo.push('üìã Error Message: ' + (error.message || error.toString()));
    debugInfo.push('üìã Error Stack: ' + (error.stack || 'no stack'));
    debugInfo.push('üìã Error Name: ' + (error.name || 'no name'));
    
    if (e && e.parameter && e.parameter.type === 'json') {
      return ContentService.createTextOutput(JSON.stringify({
        error: errorMsg,
        cards: [],
        debug: debugInfo
      })).setMimeType(ContentService.MimeType.JSON);
    }
    
    return HtmlService.createHtmlOutput(errorMsg + "<br><br>Debug:<br>" + debugInfo.join("<br>"));
  }
}

function linkImagesFromDrive() {
  var sheetName = '‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏£‡πâ‡∏≤‡∏ô';
  var driveFolderId = '1ZVmhWN_5eMshclIzvjBlcyDwGUJW4A11';
  var productIdCol = 10; // Column K = index 10 (A=0, B=1, C=2, D=3, E=4, F=5, G=6, H=7, I=8, J=9, K=10)
  var imageLinkCol = 4; // Column E = index 4 (A=0, B=1, C=2, D=3, E=4)
  
  try {
    // ‡πÉ‡∏ä‡πâ active spreadsheet ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô (‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö trigger)
    var spreadsheet = SpreadsheetApp.getActiveSpreadsheet();
    if (!spreadsheet) {
      return; // ‡πÑ‡∏°‡πà‡πÅ‡∏™‡∏î‡∏á alert
    }
    
    var sheet = spreadsheet.getSheetByName(sheetName);
    if (!sheet) {
      return; // ‡πÑ‡∏°‡πà‡πÅ‡∏™‡∏î‡∏á alert
    }
    
    var folder = DriveApp.getFolderById(driveFolderId);
    var files = folder.getFiles();
    var fileMap = {};
    var fileList = []; // ‡πÄ‡∏Å‡πá‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠ debug
    var fileCount = 0;
    
    // ‡∏™‡∏£‡πâ‡∏≤‡∏á fileMap ‡πÅ‡∏•‡∏∞‡πÄ‡∏Å‡πá‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
    while (files.hasNext()) {
      var file = files.next();
      var fileName = file.getName();
      fileMap[fileName] = file;
      fileList.push(fileName);
      fileCount++;
    }
    
    var data = sheet.getDataRange().getValues();
    var updatedCount = 0;
    var notFoundCount = 0;
    var skippedCount = 0;
    
    for (var i = 1; i < data.length; i++) {
      var productId = String(data[i][productIdCol] || '').trim();
      if (!productId) {
        skippedCount++;
        continue;
      }
      
      // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
      var existingLink = String(data[i][imageLinkCol] || '').trim();
      var hasValidLink = false;
      if (existingLink) {
        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á (‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ https://drive.google.com/thumbnail?id= ‡πÅ‡∏•‡∏∞ file ID)
        if (existingLink.indexOf('https://drive.google.com/thumbnail?id=') !== -1) {
          var idMatch = existingLink.match(/id=([a-zA-Z0-9_-]+)/);
          if (idMatch && idMatch[1] && idMatch[1].length > 10) {
            hasValidLink = true;
          }
        }
      }
      
      // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏´‡πâ‡∏Ç‡πâ‡∏≤‡∏°
      if (hasValidLink) {
        skippedCount++;
        continue;
      }
      
      // ‡∏•‡∏≠‡∏á‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå‡∏´‡∏•‡∏≤‡∏¢‡πÅ‡∏ö‡∏ö (‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏°‡∏µ space ‡∏´‡∏£‡∏∑‡∏≠ character ‡∏û‡∏¥‡πÄ‡∏®‡∏© ‡∏´‡∏£‡∏∑‡∏≠‡∏™‡∏∞‡∏Å‡∏î‡∏ú‡∏¥‡∏î)
      var frontFileName1 = productId + ' ‡∏´‡∏ô‡πâ‡∏≤.jpg';  // ‡∏°‡∏µ space, ‡∏™‡∏∞‡∏Å‡∏î‡∏ñ‡∏π‡∏Å
      var frontFileName2 = productId + '‡∏´‡∏ô‡πâ‡∏≤.jpg';   // ‡πÑ‡∏°‡πà‡∏°‡∏µ space, ‡∏™‡∏∞‡∏Å‡∏î‡∏ñ‡∏π‡∏Å
      var frontFileName3 = productId + ' ‡∏´‡∏ô‡∏±‡∏≤.jpg';   // ‡∏°‡∏µ space, ‡∏™‡∏∞‡∏Å‡∏î‡∏ú‡∏¥‡∏î (‡∏´‡∏ô‡∏±‡∏≤)
      var frontFileName4 = productId + '‡∏´‡∏ô‡∏±‡∏≤.jpg';    // ‡πÑ‡∏°‡πà‡∏°‡∏µ space, ‡∏™‡∏∞‡∏Å‡∏î‡∏ú‡∏¥‡∏î (‡∏´‡∏ô‡∏±‡∏≤)
      var frontFile = fileMap[frontFileName1] || fileMap[frontFileName2] || fileMap[frontFileName3] || fileMap[frontFileName4];
      
      // ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏ö ‡∏•‡∏≠‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÅ‡∏ö‡∏ö fuzzy (‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà‡∏°‡∏µ productId ‡πÅ‡∏•‡∏∞‡∏Ñ‡∏≥‡∏ß‡πà‡∏≤ "‡∏´‡∏ô‡πâ‡∏≤" ‡∏´‡∏£‡∏∑‡∏≠ "‡∏´‡∏ô‡∏±‡∏≤")
      if (!frontFile) {
        for (var fileName in fileMap) {
          // ‡∏´‡∏≤‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà‡∏°‡∏µ productId ‡πÅ‡∏•‡∏∞‡∏°‡∏µ‡∏Ñ‡∏≥‡∏ß‡πà‡∏≤ "‡∏´‡∏ô‡πâ‡∏≤" ‡∏´‡∏£‡∏∑‡∏≠ "‡∏´‡∏ô‡∏±‡∏≤" ‡πÅ‡∏•‡∏∞‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏ü‡∏•‡πå .jpg
          if (fileName.indexOf(productId) !== -1 && 
              (fileName.indexOf('‡∏´‡∏ô‡πâ‡∏≤') !== -1 || fileName.indexOf('‡∏´‡∏ô‡∏±‡∏≤') !== -1) && 
              (fileName.indexOf('.jpg') !== -1 || fileName.indexOf('.JPG') !== -1)) {
            frontFile = fileMap[fileName];
            break;
          }
        }
      }
      
      if (frontFile) {
        try {
          frontFile.setSharing(DriveApp.Access.ANYONE_WITH_LINK, DriveApp.Permission.VIEW);
        } catch (e) {
          // ‡∏ñ‡πâ‡∏≤ setSharing ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏Å‡πá‡∏Ç‡πâ‡∏≤‡∏°‡πÑ‡∏õ (‡∏≠‡∏≤‡∏à share ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß)
        }
        
        var fileId = frontFile.getId();
        // ‡πÉ‡∏ä‡πâ thumbnail URL ‡πÅ‡∏ó‡∏ô ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏à‡∏∞‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏î‡πâ‡πÄ‡∏£‡πá‡∏ß‡∏Å‡∏ß‡πà‡∏≤‡πÅ‡∏•‡∏∞‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÅ‡∏ä‡∏£‡πå
        var imageUrl = 'https://drive.google.com/thumbnail?id=' + fileId + '&sz=w1000';
        sheet.getRange(i + 1, imageLinkCol + 1).setValue(imageUrl);
        updatedCount++;
      } else {
        notFoundCount++;
      }
    }
    
    // ‡πÑ‡∏°‡πà‡πÅ‡∏™‡∏î‡∏á alert ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÄ‡∏™‡∏µ‡∏¢‡πÄ‡∏ß‡∏•‡∏≤
  } catch (error) {
    // ‡πÑ‡∏°‡πà‡πÅ‡∏™‡∏î‡∏á error ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÄ‡∏™‡∏µ‡∏¢‡πÄ‡∏ß‡∏•‡∏≤
    // ‡πÅ‡∏ï‡πà‡∏ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ debug ‡πÉ‡∏´‡πâ uncomment ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ
    // Logger.log('Error in linkImagesFromDrive: ' + error.toString());
  }
}

/**
 * ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
 * ‡∏£‡∏±‡∏ô‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå
 */
function testLinkImages() {
  var sheetName = '‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏£‡πâ‡∏≤‡∏ô';
  var driveFolderId = '1ZVmhWN_5eMshclIzvjBlcyDwGUJW4A11';
  var productIdCol = 10;
  var imageLinkCol = 4;
  
  try {
    // ‡πÉ‡∏ä‡πâ active spreadsheet ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô (‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö trigger)
    var spreadsheet = SpreadsheetApp.getActiveSpreadsheet();
    if (!spreadsheet) {
      SpreadsheetApp.getUi().alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏õ‡∏¥‡∏î‡πÑ‡∏ü‡∏•‡πå Google Sheets ‡∏Å‡πà‡∏≠‡∏ô');
      return;
    }
    
    var sheet = spreadsheet.getSheetByName(sheetName);
    if (!sheet) {
      Logger.log('‡πÑ‡∏°‡πà‡∏û‡∏ö sheet: ' + sheetName);
      SpreadsheetApp.getUi().alert('‡πÑ‡∏°‡πà‡∏û‡∏ö sheet: ' + sheetName);
      return;
    }
    
    var folder = DriveApp.getFolderById(driveFolderId);
    var files = folder.getFiles();
    var fileMap = {};
    var fileList = []; // ‡πÄ‡∏Å‡πá‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠ debug
    var fileCount = 0;
    
    while (files.hasNext()) {
      var file = files.next();
      var fileName = file.getName();
      fileMap[fileName] = file;
      fileList.push(fileName);
      fileCount++;
    }
    
    Logger.log('‡∏û‡∏ö‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: ' + fileCount + ' ‡πÑ‡∏ü‡∏•‡πå');
    Logger.log('‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏ô Drive: ' + fileList.join(', '));
    
    var data = sheet.getDataRange().getValues();
    Logger.log('‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: ' + (data.length - 1) + ' ‡πÅ‡∏ñ‡∏ß');
    
    var updatedCount = 0;
    var notFoundCount = 0;
    var skippedCount = 0;
    var notFoundIds = [];
    var notFoundDetails = [];
    
    for (var i = 1; i < data.length; i++) {
      var productId = String(data[i][productIdCol] || '').trim();
      if (!productId) {
        skippedCount++;
        continue;
      }
      
      var existingLink = String(data[i][imageLinkCol] || '').trim();
      var hasValidLink = false;
      if (existingLink) {
        if (existingLink.indexOf('https://drive.google.com/thumbnail?id=') !== -1) {
          var idMatch = existingLink.match(/id=([a-zA-Z0-9_-]+)/);
          if (idMatch && idMatch[1] && idMatch[1].length > 10) {
            hasValidLink = true;
          }
        }
      }
      
      if (hasValidLink) {
        skippedCount++;
        continue;
      }
      
      var frontFileName1 = productId + ' ‡∏´‡∏ô‡πâ‡∏≤.jpg';  // ‡∏°‡∏µ space, ‡∏™‡∏∞‡∏Å‡∏î‡∏ñ‡∏π‡∏Å
      var frontFileName2 = productId + '‡∏´‡∏ô‡πâ‡∏≤.jpg';   // ‡πÑ‡∏°‡πà‡∏°‡∏µ space, ‡∏™‡∏∞‡∏Å‡∏î‡∏ñ‡∏π‡∏Å
      var frontFileName3 = productId + ' ‡∏´‡∏ô‡∏±‡∏≤.jpg';   // ‡∏°‡∏µ space, ‡∏™‡∏∞‡∏Å‡∏î‡∏ú‡∏¥‡∏î (‡∏´‡∏ô‡∏±‡∏≤)
      var frontFileName4 = productId + '‡∏´‡∏ô‡∏±‡∏≤.jpg';    // ‡πÑ‡∏°‡πà‡∏°‡∏µ space, ‡∏™‡∏∞‡∏Å‡∏î‡∏ú‡∏¥‡∏î (‡∏´‡∏ô‡∏±‡∏≤)
      var frontFile = fileMap[frontFileName1] || fileMap[frontFileName2] || fileMap[frontFileName3] || fileMap[frontFileName4];
      var foundFileName = '';
      
      if (frontFile) {
        // ‡πÉ‡∏ä‡πâ‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö key ‡πÉ‡∏ô fileMap
        if (fileMap[frontFileName1]) {
          foundFileName = frontFileName1;
        } else if (fileMap[frontFileName2]) {
          foundFileName = frontFileName2;
        } else if (fileMap[frontFileName3]) {
          foundFileName = frontFileName3;
        } else if (fileMap[frontFileName4]) {
          foundFileName = frontFileName4;
        }
      } else {
        // ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏ö ‡∏•‡∏≠‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÅ‡∏ö‡∏ö fuzzy (‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà‡∏°‡∏µ productId ‡πÅ‡∏•‡∏∞‡∏Ñ‡∏≥‡∏ß‡πà‡∏≤ "‡∏´‡∏ô‡πâ‡∏≤" ‡∏´‡∏£‡∏∑‡∏≠ "‡∏´‡∏ô‡∏±‡∏≤")
        for (var fileName in fileMap) {
          // ‡∏´‡∏≤‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà‡∏°‡∏µ productId ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏ä‡∏∑‡πà‡∏≠ ‡πÅ‡∏•‡∏∞‡∏°‡∏µ‡∏Ñ‡∏≥‡∏ß‡πà‡∏≤ "‡∏´‡∏ô‡πâ‡∏≤" ‡∏´‡∏£‡∏∑‡∏≠ "‡∏´‡∏ô‡∏±‡∏≤" ‡πÅ‡∏•‡∏∞‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏ü‡∏•‡πå .jpg
          if (fileName.indexOf(productId) !== -1 && 
              (fileName.indexOf('‡∏´‡∏ô‡πâ‡∏≤') !== -1 || fileName.indexOf('‡∏´‡∏ô‡∏±‡∏≤') !== -1) && 
              (fileName.indexOf('.jpg') !== -1 || fileName.indexOf('.JPG') !== -1)) {
            frontFile = fileMap[fileName];
            foundFileName = fileName;
            break;
          }
        }
      }
      
      if (frontFile) {
        try {
          frontFile.setSharing(DriveApp.Access.ANYONE_WITH_LINK, DriveApp.Permission.VIEW);
        } catch (e) {}
        
        var fileId = frontFile.getId();
        var imageUrl = 'https://drive.google.com/thumbnail?id=' + fileId + '&sz=w1000';
        sheet.getRange(i + 1, imageLinkCol + 1).setValue(imageUrl);
        updatedCount++;
        Logger.log('‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡πÅ‡∏ñ‡∏ß ' + (i + 1) + ': ' + productId + ' -> ' + foundFileName);
      } else {
        notFoundCount++;
        notFoundIds.push(productId);
        var searchPatterns = '‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤: "' + frontFileName1 + '" ‡∏´‡∏£‡∏∑‡∏≠ "' + frontFileName2 + '"';
        notFoundDetails.push(productId + ' (' + searchPatterns + ')');
        Logger.log('‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÑ‡∏ü‡∏•‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö: ' + productId + ' - ' + searchPatterns);
      }
    }
    
    var message = '‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô!\n';
    message += '‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó: ' + updatedCount + ' ‡πÅ‡∏ñ‡∏ß\n';
    message += '‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÑ‡∏ü‡∏•‡πå: ' + notFoundCount + ' ‡πÅ‡∏ñ‡∏ß\n';
    message += '‡∏Ç‡πâ‡∏≤‡∏° (‡∏°‡∏µ‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÅ‡∏•‡πâ‡∏ß/‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏´‡∏±‡∏™): ' + skippedCount + ' ‡πÅ‡∏ñ‡∏ß\n';
    message += '‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏ô Drive: ' + fileCount + ' ‡πÑ‡∏ü‡∏•‡πå';
    
    if (notFoundIds.length > 0 && notFoundIds.length <= 10) {
      message += '\n\n‡∏£‡∏´‡∏±‡∏™‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏û‡∏ö:\n' + notFoundIds.join(', ');
      message += '\n\n‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î:\n' + notFoundDetails.join('\n');
      
      // ‡πÅ‡∏™‡∏î‡∏á‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ö‡∏£‡∏´‡∏±‡∏™‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏û‡∏ö
      message += '\n\n‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á‡πÉ‡∏ô Drive:';
      for (var n = 0; n < notFoundIds.length; n++) {
        var searchId = notFoundIds[n];
        var relatedFiles = [];
        for (var f = 0; f < fileList.length; f++) {
          if (fileList[f].indexOf(searchId) !== -1) {
            relatedFiles.push(fileList[f]);
          }
        }
        if (relatedFiles.length > 0) {
          message += '\n' + searchId + ': ' + relatedFiles.join(', ');
        } else {
          message += '\n' + searchId + ': ‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á';
        }
      }
    }
    
    // ‡πÅ‡∏™‡∏î‡∏á‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô Drive (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 30 ‡πÑ‡∏ü‡∏•‡πå)
    if (fileList.length > 0 && fileList.length <= 30) {
      message += '\n\n‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô Drive (' + fileList.length + ' ‡πÑ‡∏ü‡∏•‡πå):\n' + fileList.join('\n');
      Logger.log('\n‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô Drive:\n' + fileList.join('\n'));
    } else if (fileList.length > 30) {
      message += '\n\n‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô Drive: ' + fileList.length + ' ‡πÑ‡∏ü‡∏•‡πå (‡∏î‡∏π‡πÉ‡∏ô Logger)';
      Logger.log('\n‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô Drive:\n' + fileList.join('\n'));
    }
    
    Logger.log(message);
    SpreadsheetApp.getUi().alert(message);
  } catch (error) {
    var errorMsg = 'Error: ' + error.toString();
    Logger.log(errorMsg);
    SpreadsheetApp.getUi().alert(errorMsg);
  }
}

function updateImageColumn() {
  var sheetName = '‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏£‡πâ‡∏≤‡∏ô';
  var imageLinkCol = 4; // Column E
  var imageCol = 3; // Column D
  
  try {
    // ‡πÉ‡∏ä‡πâ active spreadsheet ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô (‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö trigger)
    var spreadsheet = SpreadsheetApp.getActiveSpreadsheet();
    if (!spreadsheet) {
      return;
    }
    
    var sheet = spreadsheet.getSheetByName(sheetName);
    if (!sheet) {
      return;
    }
    var data = sheet.getDataRange().getValues();
    var updatedCount = 0;
    
    for (var i = 1; i < data.length; i++) {
      var imageUrl = String(data[i][imageLinkCol] || '').trim();
      if (imageUrl && imageUrl.indexOf('http') !== -1) {
        sheet.getRange(i + 1, imageCol + 1).setValue('=IMAGE("' + imageUrl + '")');
        updatedCount++;
      }
    }
    
    // ‡πÑ‡∏°‡πà‡πÅ‡∏™‡∏î‡∏á alert ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÄ‡∏™‡∏µ‡∏¢‡πÄ‡∏ß‡∏•‡∏≤
  } catch (error) {
    // ‡πÑ‡∏°‡πà‡πÅ‡∏™‡∏î‡∏á error ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÄ‡∏™‡∏µ‡∏¢‡πÄ‡∏ß‡∏•‡∏≤
  }
}

/**
 * ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏õ‡∏∏‡πà‡∏°‡πÉ‡∏ô Google Sheets
 * ‡∏£‡∏±‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏õ‡∏∏‡πà‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó URL ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û
 */
function createButton() {
  try {
    // ‡πÉ‡∏ä‡πâ active spreadsheet ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô (‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö trigger)
    var spreadsheet = SpreadsheetApp.getActiveSpreadsheet();
    if (!spreadsheet) {
      SpreadsheetApp.getUi().alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏õ‡∏¥‡∏î‡πÑ‡∏ü‡∏•‡πå Google Sheets ‡∏Å‡πà‡∏≠‡∏ô');
      return;
    }
    
    var sheet = spreadsheet.getSheetByName('‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏£‡πâ‡∏≤‡∏ô');
    
    if (!sheet) {
      var allSheets = spreadsheet.getSheets();
      if (allSheets.length > 0) {
        sheet = allSheets[0];
      }
    }
    
    if (!sheet) {
      SpreadsheetApp.getUi().alert('‡πÑ‡∏°‡πà‡∏û‡∏ö sheet');
      return;
    }
    
    // ‡∏•‡∏ö‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏Å‡πà‡∏≤ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
    var drawings = sheet.getDrawings();
    drawings.forEach(function(drawing) {
      var note = drawing.getOnClick();
      if (note && note.indexOf('linkImagesFromDrive') !== -1) {
        drawing.remove();
      }
    });
    
    // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏õ‡∏∏‡πà‡∏°‡πÉ‡∏´‡∏°‡πà
    var range = sheet.getRange('O1'); // ‡∏ß‡∏≤‡∏á‡∏õ‡∏∏‡πà‡∏°‡∏ó‡∏µ‡πà Column O ‡πÅ‡∏ñ‡∏ß 1
    var button = sheet.newImage()
      .setUrl('https://www.gstatic.com/images/icons/material/system/1x/add_circle_outline_black_24dp.png')
      .setAnchorCell(range)
      .setWidth(100)
      .setHeight(30)
      .assignScript('linkImagesFromDrive');
    
    // ‡∏´‡∏£‡∏∑‡∏≠‡πÉ‡∏ä‡πâ‡∏ß‡∏¥‡∏ò‡∏µ‡∏™‡∏£‡πâ‡∏≤‡∏á shape ‡πÅ‡∏ó‡∏ô
    var buttonRange = sheet.getRange('O1');
    buttonRange.setValue('üîÑ ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó URL ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û');
    buttonRange.setBackground('#4285f4');
    buttonRange.setFontColor('#ffffff');
    buttonRange.setFontWeight('bold');
    buttonRange.setFontSize(11);
    buttonRange.setHorizontalAlignment('center');
    
    SpreadsheetApp.getUi().alert('‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß!\n\n‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡πÄ‡∏ã‡∏•‡∏•‡πå O1 ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏±‡∏ô‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô linkImagesFromDrive()');
  } catch (error) {
    SpreadsheetApp.getUi().alert('Error: ' + error.toString());
  }
}

/**
 * ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏°‡∏ô‡∏π‡πÉ‡∏ô Google Sheets
 * ‡∏£‡∏±‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏°‡∏ô‡∏π "‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏£‡πâ‡∏≤‡∏ô" ‡πÉ‡∏ô‡πÅ‡∏ñ‡∏ö‡πÄ‡∏°‡∏ô‡∏π
 * ‡πÅ‡∏•‡∏∞‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏†‡∏≤‡∏û‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡πÑ‡∏ü‡∏•‡πå
 */
function onOpen() {
  var ui = SpreadsheetApp.getUi();
  ui.createMenu('üÉè ‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏£‡πâ‡∏≤‡∏ô')
    .addItem('üîÑ ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó URL ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û', 'linkImagesFromDrive')
    .addItem('üñºÔ∏è ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó Column D ‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏π‡∏õ', 'updateImageColumn')
    .addSeparator()
    .addItem('üß™ ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó (‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå)', 'testLinkImages')
    .addToUi();
  
  // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏†‡∏≤‡∏û‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡πÑ‡∏ü‡∏•‡πå (‡πÉ‡∏ä‡πâ installable trigger ‡πÅ‡∏ó‡∏ô)
  // ‡πÑ‡∏°‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ‡πÄ‡∏û‡∏£‡∏≤‡∏∞ simple trigger ‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏à‡∏≥‡∏Å‡∏±‡∏î
}

/**
 * Trigger function ‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç sheet
 * ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏†‡∏≤‡∏û‡∏Å‡∏≤‡∏£‡πå‡∏î‡πÉ‡∏ô Column E ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
 * ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: Simple trigger ‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏à‡∏≥‡∏Å‡∏±‡∏î ‡∏Ñ‡∏ß‡∏£‡πÉ‡∏ä‡πâ installable trigger ‡πÅ‡∏ó‡∏ô
 */
function onEdit(e) {
  try {
    var sheet = e.source.getActiveSheet();
    var sheetName = sheet.getName();
    
    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô sheet "‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏£‡πâ‡∏≤‡∏ô" ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
    if (sheetName === '‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏£‡πâ‡∏≤‡∏ô') {
      // ‡πÉ‡∏ä‡πâ installable trigger ‡πÅ‡∏ó‡∏ô simple trigger
      // Simple trigger ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÉ‡∏ä‡πâ openById ‡πÑ‡∏î‡πâ
    }
  } catch (error) {
    // ‡πÑ‡∏°‡πà‡πÅ‡∏™‡∏î‡∏á error ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÄ‡∏™‡∏µ‡∏¢‡πÄ‡∏ß‡∏•‡∏≤
  }
}

/**
 * Installable trigger function ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏†‡∏≤‡∏û‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
 * ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ trigger ‡πÇ‡∏î‡∏¢‡πÑ‡∏õ‡∏ó‡∏µ‡πà: Triggers > Add Trigger > onEditInstallable
 * Event type: On edit
 * Event source: From spreadsheet
 */
function onEditInstallable(e) {
  try {
    var sheet = e.source.getActiveSheet();
    var sheetName = sheet.getName();
    
    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô sheet "‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏£‡πâ‡∏≤‡∏ô" ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
    if (sheetName === '‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏£‡πâ‡∏≤‡∏ô') {
      // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏†‡∏≤‡∏û‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
      linkImagesFromDrive();
    }
  } catch (error) {
    // ‡πÑ‡∏°‡πà‡πÅ‡∏™‡∏î‡∏á error ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÄ‡∏™‡∏µ‡∏¢‡πÄ‡∏ß‡∏•‡∏≤
  }
}

/**
 * Installable trigger function ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏†‡∏≤‡∏û‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡πÑ‡∏ü‡∏•‡πå
 * ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ trigger ‡πÇ‡∏î‡∏¢‡πÑ‡∏õ‡∏ó‡∏µ‡πà: Triggers > Add Trigger > onOpenInstallable
 * Event type: On open
 * Event source: From spreadsheet
 */
function onOpenInstallable(e) {
  try {
    // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏†‡∏≤‡∏û‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡πÑ‡∏ü‡∏•‡πå
    linkImagesFromDrive();
  } catch (error) {
    // ‡πÑ‡∏°‡πà‡πÅ‡∏™‡∏î‡∏á error ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÄ‡∏™‡∏µ‡∏¢‡πÄ‡∏ß‡∏•‡∏≤
  }
}
