/**
 * Google Apps Script ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ
 * Sheet: "‡∏Å‡∏≤‡∏£‡πå‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô ‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ"
 * Columns: ‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡πå‡∏î (A), ‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û (B), ‡∏£‡∏≤‡∏Ñ‡∏≤ (C), ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô (D)
 * 
 * API Usage:
 * GET: https://script.google.com/macros/s/YOUR_DEPLOYMENT_ID/exec?type=json
 */

function doGet(e) {
  try {
    var isJson = e && e.parameter && e.parameter.type === 'json';
    
    var spreadsheet;
    
    // ‡πÉ‡∏ä‡πâ getActiveSpreadsheet() ‡πÄ‡∏û‡∏£‡∏≤‡∏∞ Apps Script ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô Spreadsheet ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô
    try {
      spreadsheet = SpreadsheetApp.getActiveSpreadsheet();
      if (!spreadsheet) {
        if (isJson) {
          return ContentService.createTextOutput(JSON.stringify({
            error: "‡πÑ‡∏°‡πà‡∏û‡∏ö Spreadsheet",
            cards: [],
            suggestion: "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ Apps Script ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô Spreadsheet ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á"
          })).setMimeType(ContentService.MimeType.JSON);
        }
        return HtmlService.createHtmlOutput("‡πÑ‡∏°‡πà‡∏û‡∏ö Spreadsheet");
      }
    } catch (activeError) {
      if (isJson) {
        return ContentService.createTextOutput(JSON.stringify({
          error: "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á Spreadsheet ‡πÑ‡∏î‡πâ: " + activeError.toString(),
          cards: []
        })).setMimeType(ContentService.MimeType.JSON);
      }
      return HtmlService.createHtmlOutput("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á Spreadsheet ‡πÑ‡∏î‡πâ");
    }
    
    // ‡∏´‡∏≤ sheet "‡∏Å‡∏≤‡∏£‡πå‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô ‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ"
    var targetSheet = spreadsheet.getSheetByName('‡∏Å‡∏≤‡∏£‡πå‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô ‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ');
    
    if (!targetSheet) {
      // ‡∏•‡∏≠‡∏á‡∏´‡∏≤ sheet ‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‡∏ó‡∏µ‡πà‡∏≠‡∏≤‡∏à‡∏à‡∏∞‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏•‡πâ‡∏≤‡∏¢‡∏Å‡∏±‡∏ô
      var allSheets = spreadsheet.getSheets();
      var foundSheet = null;
      for (var s = 0; s < allSheets.length; s++) {
        var sheetName = allSheets[s].getName();
        if (sheetName.indexOf('‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ') !== -1 || sheetName.indexOf('‡∏Å‡∏≤‡∏£‡πå‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô') !== -1) {
          foundSheet = allSheets[s];
          break;
        }
      }
      
      if (!foundSheet && allSheets.length > 0) {
        foundSheet = allSheets[0]; // ‡πÉ‡∏ä‡πâ sheet ‡πÅ‡∏£‡∏Å‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠
      }
      
      targetSheet = foundSheet;
    }
    
    if (!targetSheet) {
      if (isJson) {
        return ContentService.createTextOutput(JSON.stringify({
          error: "‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ä‡∏µ‡∏ó '‡∏Å‡∏≤‡∏£‡πå‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô ‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ'",
          cards: []
        })).setMimeType(ContentService.MimeType.JSON);
      }
      return HtmlService.createHtmlOutput("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ä‡∏µ‡∏ó '‡∏Å‡∏≤‡∏£‡πå‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô ‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ'");
    }
    
    // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
    var data = targetSheet.getDataRange().getValues();
    
    if (data.length <= 1) {
      if (isJson) {
        return ContentService.createTextOutput(JSON.stringify({
          error: "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•",
          cards: []
        })).setMimeType(ContentService.MimeType.JSON);
      }
      return HtmlService.createHtmlOutput("‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•");
    }
    
    var headers = data[0];
    var cards = [];
    
    // ‡∏™‡∏£‡πâ‡∏≤‡∏á colIndex
    var colIndex = {};
    for (var h = 0; h < headers.length; h++) {
      colIndex[headers[h]] = h;
    }
    
    // Column indices
    var idxCardName = colIndex['‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡πå‡∏î'] !== undefined ? colIndex['‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡πå‡∏î'] : 0; // Column A
    var idxImageLink = colIndex['‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û'] !== undefined ? colIndex['‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û'] : 1; // Column B
    var idxPrice = colIndex['‡∏£‡∏≤‡∏Ñ‡∏≤'] !== undefined ? colIndex['‡∏£‡∏≤‡∏Ñ‡∏≤'] : 2; // Column C
    var idxQuantity = colIndex['‡∏à‡∏≥‡∏ô‡∏ß‡∏ô'] !== undefined ? colIndex['‡∏à‡∏≥‡∏ô‡∏ß‡∏ô'] : 3; // Column D
    
    // ‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
    for (var i = 1; i < data.length; i++) {
      var row = data[i];
      
      var cardName = idxCardName >= 0 ? String(row[idxCardName] || '').trim() : '';
      if (!cardName || cardName === '') {
        continue; // ‡∏Ç‡πâ‡∏≤‡∏°‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡πå‡∏î
      }
      
      // ‡∏≠‡πà‡∏≤‡∏ô‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏à‡∏≤‡∏Å Column B (‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û)
      var cardImage = '';
      if (idxImageLink >= 0) {
        var imageLink = row[idxImageLink];
        if (imageLink) {
          var imageLinkStr = String(imageLink);
          if (imageLinkStr.indexOf('http') !== -1) {
            // ‡πÅ‡∏õ‡∏•‡∏á Google Drive URL
            if (imageLinkStr.indexOf('drive.google.com/thumbnail') !== -1) {
              cardImage = imageLinkStr;
            } else if (imageLinkStr.indexOf('drive.google.com') !== -1) {
              var idMatch = imageLinkStr.match(/id=([a-zA-Z0-9_-]+)/);
              if (idMatch && idMatch[1]) {
                cardImage = 'https://drive.google.com/thumbnail?id=' + idMatch[1] + '&sz=w1000';
              } else {
                cardImage = imageLinkStr;
              }
            } else if (imageLinkStr.indexOf('lh3.googleusercontent.com') !== -1) {
              cardImage = imageLinkStr;
            } else {
              cardImage = imageLinkStr;
            }
          }
        }
      }
      
      var price = idxPrice >= 0 ? (row[idxPrice] || '') : '';
      var quantity = idxQuantity >= 0 ? (row[idxQuantity] || '') : '';
      
      cards.push({
        cardName: cardName,
        cardImage: cardImage,
        price: price,
        quantity: quantity
      });
    }
    
    if (isJson) {
      return ContentService.createTextOutput(JSON.stringify({
        cards: cards,
        total: cards.length
      })).setMimeType(ContentService.MimeType.JSON);
    }
    
    var html = '<html><body><h2>‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ</h2><ul>';
    cards.forEach(function(card) {
      html += '<li>' + card.cardName + ' - ' + card.price + ' ‡∏ö‡∏≤‡∏ó (‡∏à‡∏≥‡∏ô‡∏ß‡∏ô: ' + card.quantity + ')</li>';
    });
    html += '</ul></body></html>';
    return HtmlService.createHtmlOutput(html);
    
  } catch (error) {
    var errorMsg = '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.toString();
    
    if (e && e.parameter && e.parameter.type === 'json') {
      return ContentService.createTextOutput(JSON.stringify({
        error: errorMsg,
        cards: []
      })).setMimeType(ContentService.MimeType.JSON);
    }
    
    return HtmlService.createHtmlOutput(errorMsg);
  }
}

/**
 * ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏à‡∏≤‡∏Å Google Drive
 * ‡∏´‡∏≤‡πÑ‡∏ü‡∏•‡πå‡∏à‡∏≤‡∏Å Drive folder ‡πÅ‡∏•‡πâ‡∏ß‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó URL ‡πÉ‡∏ô Column B
 */
function linkImagesFromDrive() {
  var sheetName = '‡∏Å‡∏≤‡∏£‡πå‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô ‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ';
  var driveFolderId = '1ZVmhWN_5eMshclIzvjBlcyDwGUJW4A11'; // ‡πÉ‡∏ä‡πâ folder ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏≠‡∏∑‡πà‡∏ô‡πÜ
  var cardNameCol = 0; // Column A = index 0
  var imageLinkCol = 1; // Column B = index 1
  
  try {
    var spreadsheet = SpreadsheetApp.getActiveSpreadsheet();
    if (!spreadsheet) {
      return;
    }
    
    var sheet = spreadsheet.getSheetByName(sheetName);
    if (!sheet) {
      return;
    }
    
    var folder = DriveApp.getFolderById(driveFolderId);
    var files = folder.getFiles();
    var fileMap = {};
    
    // ‡∏™‡∏£‡πâ‡∏≤‡∏á fileMap ‡∏à‡∏≤‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå
    while (files.hasNext()) {
      var file = files.next();
      var fileName = file.getName();
      fileMap[fileName] = file;
    }
    
    var data = sheet.getDataRange().getValues();
    var updatedCount = 0;
    var notFoundCount = 0;
    
    for (var i = 1; i < data.length; i++) {
      var cardName = String(data[i][cardNameCol] || '').trim();
      if (!cardName) {
        continue;
      }
      
      // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
      var existingLink = String(data[i][imageLinkCol] || '').trim();
      var hasValidLink = false;
      if (existingLink) {
        if (existingLink.indexOf('https://drive.google.com/thumbnail?id=') !== -1) {
          var idMatch = existingLink.match(/id=([a-zA-Z0-9_-]+)/);
          if (idMatch && idMatch[1] && idMatch[1].length > 10) {
            hasValidLink = true;
          }
        }
      }
      
      // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏´‡πâ‡∏Ç‡πâ‡∏≤‡∏°
      if (hasValidLink) {
        continue;
      }
      
      // ‡∏•‡∏≠‡∏á‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå‡∏´‡∏•‡∏≤‡∏¢‡πÅ‡∏ö‡∏ö
      var frontFileName1 = cardName + ' ‡∏´‡∏ô‡πâ‡∏≤.jpg';
      var frontFileName2 = cardName + '‡∏´‡∏ô‡πâ‡∏≤.jpg';
      var frontFile = fileMap[frontFileName1] || fileMap[frontFileName2];
      
      // ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏ö ‡∏•‡∏≠‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÅ‡∏ö‡∏ö fuzzy
      if (!frontFile) {
        for (var fileName in fileMap) {
          if (fileName.indexOf(cardName) !== -1 && 
              (fileName.indexOf('‡∏´‡∏ô‡πâ‡∏≤') !== -1 || fileName.indexOf('‡∏´‡∏ô‡∏±‡∏≤') !== -1) && 
              (fileName.indexOf('.jpg') !== -1 || fileName.indexOf('.JPG') !== -1)) {
            frontFile = fileMap[fileName];
            break;
          }
        }
      }
      
      if (frontFile) {
        try {
          frontFile.setSharing(DriveApp.Access.ANYONE_WITH_LINK, DriveApp.Permission.VIEW);
        } catch (e) {}
        
        var fileId = frontFile.getId();
        var imageUrl = 'https://drive.google.com/thumbnail?id=' + fileId + '&sz=w1000';
        sheet.getRange(i + 1, imageLinkCol + 1).setValue(imageUrl);
        updatedCount++;
      } else {
        notFoundCount++;
      }
    }
    
  } catch (error) {
    Logger.log('Error in linkImagesFromDrive: ' + error.toString());
  }
}

/**
 * ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏°‡∏ô‡∏π‡πÉ‡∏ô Google Sheets
 */
function onOpen() {
  var ui = SpreadsheetApp.getUi();
  ui.createMenu('üÉè ‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ')
    .addItem('üîÑ ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó URL ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û', 'linkImagesFromDrive')
    .addSeparator()
    .addItem('‚úÇÔ∏è ‡∏Ñ‡∏£‡∏≠‡∏õ‡∏£‡∏π‡∏õ‡πÉ‡∏ô Drive', 'cropImageFromDrive')
    .addToUi();
}

/**
 * ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏£‡∏≠‡∏õ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÉ‡∏ô Google Drive
 * ‡πÉ‡∏ä‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô‡∏Å‡∏±‡∏ö‡πÉ‡∏ô Rare Card for sell
 */
function cropImageFromDrive() {
  try {
    var driveFolderId = '1ZVmhWN_5eMshclIzvjBlcyDwGUJW4A11';
    var folder = DriveApp.getFolderById(driveFolderId);
    var files = folder.getFiles();
    
    var imageFiles = [];
    var fileCount = 0;
    
    // ‡∏î‡∏∂‡∏á‡∏£‡∏π‡∏õ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏à‡∏≤‡∏Å folder
    while (files.hasNext() && fileCount < 100) {
      var file = files.next();
      var mimeType = file.getMimeType();
      
      if (mimeType.startsWith('image/')) {
        var fileId = file.getId();
        var fileName = file.getName();
        var thumbnailUrl = 'https://drive.google.com/thumbnail?id=' + fileId + '&sz=w800';
        
        imageFiles.push({
          id: fileId,
          name: fileName,
          thumbnail: thumbnailUrl
        });
        fileCount++;
      }
    }
    
    if (imageFiles.length === 0) {
      SpreadsheetApp.getUi().alert('‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÉ‡∏ô Drive folder');
      return;
    }
    
    // ‡∏™‡∏£‡πâ‡∏≤‡∏á HTML ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏π‡∏õ
    var html = '<!DOCTYPE html><html><head>';
    html += '<meta charset="UTF-8">';
    html += '<style>';
    html += 'body { font-family: Arial, sans-serif; padding: 20px; background: #f5f5f5; margin: 0; }';
    html += 'h2 { color: #333; margin-bottom: 20px; }';
    html += '.image-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; margin-bottom: 20px; max-height: 600px; overflow-y: auto; padding: 10px; }';
    html += '.image-item { background: white; border-radius: 8px; padding: 15px; transition: all 0.2s; border: 3px solid transparent; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }';
    html += '.image-item.selected { border-color: #34a853; background: #e8f5e9; box-shadow: 0 4px 12px rgba(52,168,83,0.3); }';
    html += '.image-thumbnail { width: 100%; max-height: 400px; object-fit: contain; border-radius: 4px; margin-bottom: 10px; display: block; }';
    html += '.image-name { font-size: 14px; color: #666; text-align: center; font-weight: 500; word-break: break-word; margin-bottom: 10px; }';
    html += '.select-btn { width: 100%; padding: 12px; font-size: 16px; font-weight: bold; border: none; border-radius: 6px; cursor: pointer; background: #4285f4; color: white; transition: all 0.2s; }';
    html += '.select-btn:hover { background: #357ae8; transform: scale(1.02); }';
    html += '.select-btn.selected { background: #34a853; }';
    html += '.select-btn.selected:hover { background: #2d8f47; }';
    html += '.crop-buttons { display: none; margin-top: 20px; padding: 20px; background: white; border-radius: 8px; border-top: 3px solid #ddd; }';
    html += '.crop-buttons.show { display: block; }';
    html += '.crop-buttons h3 { margin-top: 0; color: #333; }';
    html += '.crop-btn { padding: 15px 30px; margin: 8px; font-size: 16px; border: none; border-radius: 6px; cursor: pointer; background: #4285f4; color: white; font-weight: bold; min-width: 200px; }';
    html += '.crop-btn:hover { opacity: 0.9; transform: scale(1.05); }';
    html += '.crop-btn.top { background: #ea4335; }';
    html += '.crop-btn.top:hover { background: #d33b2c; }';
    html += '.crop-btn.bottom { background: #fbbc04; }';
    html += '.crop-btn.bottom:hover { background: #f9ab00; }';
    html += '.selected-info { margin-top: 15px; padding: 15px; background: #e3f2fd; border-radius: 6px; color: #1976d2; font-weight: bold; font-size: 16px; }';
    html += '</style>';
    html += '</head><body>';
    html += '<h2>‚úÇÔ∏è ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Ñ‡∏£‡∏≠‡∏õ (‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ)</h2>';
    html += '<div class="image-grid" id="imageGrid">';
    
    // ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏π‡∏õ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
    for (var i = 0; i < imageFiles.length; i++) {
      var file = imageFiles[i];
      html += '<div class="image-item" id="item-' + i + '" data-file-id="' + file.id + '" data-file-name="' + file.name.replace(/"/g, '&quot;') + '">';
      html += '<img src="' + file.thumbnail + '" class="image-thumbnail" alt="' + file.name.replace(/"/g, '&quot;') + '" loading="lazy">';
      html += '<div class="image-name">' + file.name + '</div>';
      html += '<button class="select-btn" id="btn-' + i + '" data-index="' + i + '">‚úì ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡∏ô‡∏µ‡πâ</button>';
      html += '</div>';
    }
    
    html += '</div>';
    html += '<div class="selected-info" id="selectedInfo" style="display:none;"></div>';
    html += '<div class="crop-buttons" id="cropButtons">';
    html += '<h3>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏Å‡∏≤‡∏£‡∏Ñ‡∏£‡∏≠‡∏õ:</h3>';
    html += '<button class="crop-btn top" data-position="top" onclick="cropImage(\'top\')">‚¨ÜÔ∏è ‡∏ö‡∏ô (‡πÄ‡∏ß‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡πÄ‡∏¢‡∏≠‡∏∞)</button>';
    html += '<button class="crop-btn" data-position="center" onclick="cropImage(\'center\')">‚û°Ô∏è ‡∏Å‡∏•‡∏≤‡∏á (‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥)</button>';
    html += '<button class="crop-btn bottom" data-position="bottom" onclick="cropImage(\'bottom\')">‚¨áÔ∏è ‡∏•‡πà‡∏≤‡∏á (‡πÄ‡∏ß‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô‡πÄ‡∏¢‡∏≠‡∏∞)</button>';
    html += '</div>';
    
    html += '<script>';
    html += 'var selectedFileId = null;';
    html += 'var selectedFileName = null;';
    html += '';
    html += 'function selectImageByIndex(index) {';
    html += '  try {';
    html += '    var clickedItem = document.getElementById("item-" + index);';
    html += '    if (!clickedItem) {';
    html += '      alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏π‡∏õ‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å");';
    html += '      return;';
    html += '    }';
    html += '    ';
    html += '    var fileId = clickedItem.getAttribute("data-file-id");';
    html += '    var fileName = clickedItem.getAttribute("data-file-name");';
    html += '    ';
    html += '    if (!fileId) {';
    html += '      alert("‡πÑ‡∏°‡πà‡∏û‡∏ö File ID");';
    html += '      return;';
    html += '    }';
    html += '    ';
    html += '    // ‡∏•‡∏ö selected class ‡∏à‡∏≤‡∏Å‡∏ó‡∏∏‡∏Å element';
    html += '    var allItems = document.querySelectorAll(".image-item");';
    html += '    var allButtons = document.querySelectorAll(".select-btn");';
    html += '    for (var i = 0; i < allItems.length; i++) {';
    html += '      allItems[i].classList.remove("selected");';
    html += '    }';
    html += '    for (var i = 0; i < allButtons.length; i++) {';
    html += '      allButtons[i].classList.remove("selected");';
    html += '      allButtons[i].textContent = "‚úì ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡∏ô‡∏µ‡πâ";';
    html += '    }';
    html += '    ';
    html += '    // ‡πÄ‡∏û‡∏¥‡πà‡∏° selected class ‡πÉ‡∏´‡πâ element ‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å';
    html += '    clickedItem.classList.add("selected");';
    html += '    var clickedBtn = document.getElementById("btn-" + index);';
    html += '    if (clickedBtn) {';
    html += '      clickedBtn.classList.add("selected");';
    html += '      clickedBtn.textContent = "‚úì ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß";';
    html += '    }';
    html += '    ';
    html += '    selectedFileId = fileId;';
    html += '    selectedFileName = fileName;';
    html += '    ';
    html += '    var infoDiv = document.getElementById("selectedInfo");';
    html += '    if (infoDiv) {';
    html += '      infoDiv.style.display = "block";';
    html += '      infoDiv.textContent = "‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ: " + fileName;';
    html += '    }';
    html += '    ';
    html += '    var cropDiv = document.getElementById("cropButtons");';
    html += '    if (cropDiv) {';
    html += '      cropDiv.classList.add("show");';
    html += '      setTimeout(function() {';
    html += '        cropDiv.scrollIntoView({ behavior: "smooth", block: "nearest" });';
    html += '      }, 100);';
    html += '    }';
    html += '  } catch (e) {';
    html += '    alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + e.message);';
    html += '    console.error(e);';
    html += '  }';
    html += '}';
    html += '';
    html += 'function setupButtons() {';
    html += '  var selectButtons = document.querySelectorAll(".select-btn");';
    html += '  for (var i = 0; i < selectButtons.length; i++) {';
    html += '    selectButtons[i].addEventListener("click", function(e) {';
    html += '      e.preventDefault();';
    html += '      e.stopPropagation();';
    html += '      var index = this.getAttribute("data-index");';
    html += '      if (index !== null && index !== undefined) {';
    html += '        selectImageByIndex(parseInt(index));';
    html += '      }';
    html += '    }, true);';
    html += '  }';
    html += '}';
    html += '';
    html += 'if (document.readyState === "loading") {';
    html += '  document.addEventListener("DOMContentLoaded", setupButtons);';
    html += '} else {';
    html += '  setupButtons();';
    html += '}';
    html += 'window.onload = setupButtons;';
    html += '';
    html += 'function cropImage(position) {';
    html += '  if (!selectedFileId) {';
    html += '    alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡∏Å‡πà‡∏≠‡∏ô");';
    html += '    return;';
    html += '  }';
    html += '  var positionText = position === "top" ? "‚¨ÜÔ∏è ‡∏ö‡∏ô" : position === "bottom" ? "‚¨áÔ∏è ‡∏•‡πà‡∏≤‡∏á" : "‚û°Ô∏è ‡∏Å‡∏•‡∏≤‡∏á";';
    html += '  if (confirm("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡∏£‡∏≠‡∏õ‡∏£‡∏π‡∏õ: " + selectedFileName + "\\n‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á: " + positionText + "\\n\\n‚ö†Ô∏è ‡∏Å‡∏≤‡∏£‡∏Ñ‡∏£‡∏≠‡∏õ‡∏à‡∏∞‡∏ó‡∏±‡∏ö‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏î‡∏¥‡∏°!")) {';
    html += '    var btn = document.querySelector(\'[data-position="\' + position + \'"]\');';
    html += '    if (btn) {';
    html += '      btn.disabled = true;';
    html += '      var originalText = btn.textContent;';
    html += '      btn.textContent = "‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡∏£‡∏≠‡∏õ...";';
    html += '    }';
    html += '    google.script.run.withSuccessHandler(function(result) {';
    html += '      if (btn) {';
    html += '        btn.disabled = false;';
    html += '        btn.textContent = originalText;';
    html += '      }';
    html += '      if (result && result.success) {';
    html += '        alert("‚úÖ ‡∏Ñ‡∏£‡∏≠‡∏õ‡∏£‡∏π‡∏õ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!\\n\\n‡πÑ‡∏ü‡∏•‡πå: " + result.fileName + "\\n‡∏Ç‡∏ô‡∏≤‡∏î‡πÉ‡∏´‡∏°‡πà: " + result.newSize.width + " x " + result.newSize.height + "px");';
    html += '        google.script.host.close();';
    html += '      } else {';
    html += '        alert("‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + (result ? result.error : "‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏"));';
    html += '      }';
    html += '    }).withFailureHandler(function(error) {';
    html += '      if (btn) {';
    html += '        btn.disabled = false;';
    html += '        btn.textContent = originalText;';
    html += '      }';
    html += '      alert("‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + (error ? error.message : "‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏"));';
    html += '    }).cropImageWithPosition(selectedFileId, position);';
    html += '  }';
    html += '}';
    html += '</script>';
    html += '</body></html>';
    
    var htmlOutput = HtmlService.createHtmlOutput(html)
      .setWidth(900)
      .setHeight(700);
    
    SpreadsheetApp.getUi().showModalDialog(htmlOutput, '‚úÇÔ∏è ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Ñ‡∏£‡∏≠‡∏õ');
    
  } catch (error) {
    SpreadsheetApp.getUi().alert('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.toString());
    Logger.log('Error in cropImageFromDrive: ' + error.toString());
  }
}

/**
 * ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏£‡∏≠‡∏õ‡∏£‡∏π‡∏õ‡∏à‡∏£‡∏¥‡∏á‡πÜ
 * @param {string} fileId - Google Drive File ID
 * @param {string} cropPosition - 'top', 'center', ‡∏´‡∏£‡∏∑‡∏≠ 'bottom'
 * @return {Object} ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏Å‡∏≤‡∏£‡∏Ñ‡∏£‡∏≠‡∏õ {success: boolean, fileName: string, newSize: {width, height}, error: string}
 */
function cropImageWithPosition(fileId, cropPosition) {
  try {
    var file = DriveApp.getFileById(fileId);
    
    if (!file) {
      return {
        success: false,
        error: '‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏ô Drive'
      };
    }
    
    var mimeType = file.getMimeType();
    if (!mimeType.startsWith('image/')) {
      return {
        success: false,
        error: '‡πÑ‡∏ü‡∏•‡πå‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û'
      };
    }
    
    var blob = file.getBlob();
    var image = ImagesService.newImage(blob);
    
    var originalWidth = image.getWidth();
    var originalHeight = image.getHeight();
    var originalAspectRatio = originalWidth / originalHeight;
    var targetAspectRatio = 2.5 / 3.5;
    
    var newWidth, newHeight, cropX, cropY;
    
    if (originalAspectRatio > targetAspectRatio) {
      newHeight = originalHeight;
      newWidth = Math.round(originalHeight * targetAspectRatio);
      cropX = Math.round((originalWidth - newWidth) / 2);
      cropY = 0;
    } else {
      newWidth = originalWidth;
      newHeight = Math.round(originalWidth / targetAspectRatio);
      cropX = 0;
      
      if (cropPosition === 'top') {
        cropY = 0;
      } else if (cropPosition === 'bottom') {
        cropY = originalHeight - newHeight;
      } else {
        cropY = Math.round((originalHeight - newHeight) / 2);
      }
    }
    
    var croppedImage = image.crop(cropX, cropY, newWidth, newHeight);
    var croppedBlob = croppedImage.getBlob();
    file.setContent(croppedBlob);
    
    return {
      success: true,
      fileName: file.getName(),
      originalSize: {
        width: originalWidth,
        height: originalHeight
      },
      newSize: {
        width: newWidth,
        height: newHeight
      },
      cropPosition: cropPosition,
      cropOffset: {
        x: cropX,
        y: cropY
      }
    };
    
  } catch (error) {
    Logger.log('Error cropping image: ' + error.toString());
    return {
      success: false,
      error: error.toString()
    };
  }
}

