// ===== à¸Ÿà¸±à¸‡à¸à¹Œà¸Šà¸±à¸™à¹à¸ˆà¹‰à¸‡à¹€à¸•à¸·à¸­à¸™ Telegram =====

// à¹à¸à¹‰à¹„à¸‚à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹€à¸«à¸¥à¹ˆà¸²à¸™à¸µà¹‰
const BOT_TOKEN = "8284717743:AAGfu8Z-r6SI_TeAslai9vA600nNagjzH5k";
const CHAT_ID = "-4911555842"; // Group Chat ID

const TELEGRAM_API_URL = `https://api.telegram.org/bot${BOT_TOKEN}`;

/**
 * à¸Ÿà¸±à¸‡à¸à¹Œà¸Šà¸±à¸™à¸—à¸µà¹ˆà¸—à¸³à¸‡à¸²à¸™à¹€à¸¡à¸·à¹ˆà¸­à¸¡à¸µà¸à¸²à¸£à¸ªà¹ˆà¸‡à¸Ÿà¸­à¸£à¹Œà¸¡
 */
function onFormSubmit(e) {
  try {
    // à¸”à¸¶à¸‡à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸ˆà¸²à¸à¸Ÿà¸­à¸£à¹Œà¸¡
    const responses = e.values;
    const timestamp = responses[0] || new Date().toLocaleString('th-TH');
    
    // à¸¥à¸­à¸‡à¸«à¸² nickname à¸ˆà¸²à¸à¸«à¸¥à¸²à¸¢ column (à¸›à¸£à¸±à¸šà¸•à¸²à¸¡à¹‚à¸„à¸£à¸‡à¸ªà¸£à¹‰à¸²à¸‡à¸Ÿà¸­à¸£à¹Œà¸¡à¸ˆà¸£à¸´à¸‡)
    const nickname = responses[1] || responses[2] || responses[3] || 'à¹„à¸¡à¹ˆà¸£à¸°à¸šà¸¸à¸Šà¸·à¹ˆà¸­';
    
    // à¸¥à¸­à¸‡à¸«à¸² phone à¸ˆà¸²à¸à¸«à¸¥à¸²à¸¢ column (à¸›à¸£à¸±à¸šà¸•à¸²à¸¡à¹‚à¸„à¸£à¸‡à¸ªà¸£à¹‰à¸²à¸‡à¸Ÿà¸­à¸£à¹Œà¸¡à¸ˆà¸£à¸´à¸‡)
    const phone = responses[4] || responses[5] || responses[6] || 'à¹„à¸¡à¹ˆà¸£à¸°à¸šà¸¸à¹€à¸šà¸­à¸£à¹Œà¹‚à¸—à¸£';
    
    // à¸™à¸±à¸šà¸ˆà¸³à¸™à¸§à¸™à¸„à¸™à¸—à¸µà¹ˆà¸ªà¸¡à¸±à¸„à¸£
    const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName("Form Responses 1");
    let totalCount = 0;
    
    if (sheet) {
      try {
        const data = sheet.getDataRange().getValues();
        totalCount = data.length - 1; // à¸¥à¸š header row
      } catch (countError) {
        console.warn('Warning: Could not count total participants:', countError);
      }
    }
    
    // à¸ªà¸£à¹‰à¸²à¸‡à¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡à¹à¸ˆà¹‰à¸‡à¹€à¸•à¸·à¸­à¸™
    const message = `ðŸŒ™ *à¸¡à¸µà¸„à¸™à¸ªà¸¡à¸±à¸„à¸£ Midnight Party à¹ƒà¸«à¸¡à¹ˆ!*

ðŸ‘¤ *à¸Šà¸·à¹ˆà¸­à¹€à¸¥à¹ˆà¸™:* ${nickname}
ðŸ“± *à¹€à¸šà¸­à¸£à¹Œà¹‚à¸—à¸£:* ${phone}
â° *à¹€à¸§à¸¥à¸²à¸—à¸µà¹ˆà¸ªà¸¡à¸±à¸„à¸£:* ${timestamp}

ðŸ“Š *à¸£à¸§à¸¡à¸œà¸¹à¹‰à¸ªà¸¡à¸±à¸„à¸£ Midnight Party: ${totalCount} à¸„à¸™*

---
ðŸ“Š [à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¸£à¸²à¸¢à¸Šà¸·à¹ˆà¸­à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”](https://uplevelguild.netlify.app/midnight-party)`;
    
    // à¸ªà¹ˆà¸‡à¹„à¸›à¸¢à¸±à¸‡ Telegram
    const payload = {
      chat_id: CHAT_ID,
      text: message,
      parse_mode: "Markdown",
      disable_web_page_preview: true
    };
    
    const response = UrlFetchApp.fetch(`${TELEGRAM_API_URL}/sendMessage`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      payload: JSON.stringify(payload)
    });
    
    // à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸š response
    if (response.getResponseCode() === 200) {
      console.log("âœ… à¸ªà¹ˆà¸‡à¸à¸²à¸£à¹à¸ˆà¹‰à¸‡à¹€à¸•à¸·à¸­à¸™ Midnight Party à¹„à¸›à¸¢à¸±à¸‡ Telegram à¸ªà¸³à¹€à¸£à¹‡à¸ˆ");
    } else {
      console.warn("âš ï¸ Telegram API response:", response.getResponseCode(), response.getContentText());
    }
    
  } catch (error) {
    console.error("âŒ à¹€à¸à¸´à¸”à¸‚à¹‰à¸­à¸œà¸´à¸”à¸žà¸¥à¸²à¸”à¹ƒà¸™à¸à¸²à¸£à¸ªà¹ˆà¸‡à¹à¸ˆà¹‰à¸‡à¹€à¸•à¸·à¸­à¸™ Telegram:", error);
    console.error("âŒ Error details:", error.toString());
    // à¹„à¸¡à¹ˆ throw error à¹€à¸žà¸·à¹ˆà¸­à¹„à¸¡à¹ˆà¹ƒà¸«à¹‰à¸à¸£à¸°à¸—à¸šà¸à¸±à¸šà¸à¸²à¸£à¸šà¸±à¸™à¸—à¸¶à¸à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹ƒà¸™ Google Sheet
  }
}

/**
 * à¸Ÿà¸±à¸‡à¸à¹Œà¸Šà¸±à¸™à¸—à¸”à¸ªà¸­à¸šà¸à¸²à¸£à¸ªà¹ˆà¸‡à¹„à¸›à¸¢à¸±à¸‡ Telegram
 */
function testTelegramNotification() {
  const testData = {
    values: [
      new Date().toLocaleString('th-TH'),
      "à¸œà¸¹à¹‰à¸—à¸”à¸ªà¸­à¸š Midnight Party",
      "",
      "",
      "0812345678",
      "",
      ""
    ]
  };
  
  onFormSubmit(testData);
  console.log("ðŸ§ª à¸ªà¹ˆà¸‡à¸à¸²à¸£à¸—à¸”à¸ªà¸­à¸š Midnight Party à¹„à¸›à¸¢à¸±à¸‡ Telegram à¹à¸¥à¹‰à¸§");
}

function doGet(e) {
  try {
    // Debug logging (à¸›à¸´à¸”à¹ƒà¸™ production à¸«à¸£à¸·à¸­à¹ƒà¸Šà¹‰à¹ƒà¸«à¹‰à¹€à¸«à¸¡à¸²à¸°à¸ªà¸¡)
    var isDebug = e && e.parameter && e.parameter.debug === 'true';
    var isJson = e && e.parameter && e.parameter.type === 'json';
    
    if (isDebug) console.log('doGet function called');
    
    // à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¸§à¹ˆà¸² spreadsheet à¸¡à¸µà¸­à¸¢à¸¹à¹ˆà¸«à¸£à¸·à¸­à¹„à¸¡à¹ˆ
    var spreadsheet = SpreadsheetApp.getActiveSpreadsheet();
    if (!spreadsheet) {
      if (isDebug) console.log('No active spreadsheet found');
      if (isJson) {
        return ContentService.createTextOutput(JSON.stringify({ 
          participants: [],
          error: "No active spreadsheet found"
        })).setMimeType(ContentService.MimeType.JSON);
      }
      return createResponse({ 
        participants: [],
        error: "No active spreadsheet found"
      });
    }
    
    if (isDebug) {
      console.log('Spreadsheet ID:', spreadsheet.getId());
      console.log('Spreadsheet name:', spreadsheet.getName());
    }
    
    // à¸¥à¸­à¸‡à¸«à¸² sheet à¸—à¸µà¹ˆà¸¡à¸µà¸­à¸¢à¸¹à¹ˆ
    var sheets = spreadsheet.getSheets();
    if (isDebug) console.log('Available sheets:', sheets.map(s => s.getName()));
    
    // à¸¥à¸­à¸‡à¸«à¸² sheet à¸—à¸µà¹ˆà¸¡à¸µà¸‚à¹‰à¸­à¸¡à¸¹à¸¥
    var targetSheet = null;
    var sheetNames = ['Form Responses 1', 'Form Responses', 'Responses', 'Sheet1'];
    
    for (var i = 0; i < sheetNames.length; i++) {
      var sheet = spreadsheet.getSheetByName(sheetNames[i]);
      if (sheet) {
        targetSheet = sheet;
        if (isDebug) console.log('Found sheet:', sheetNames[i]);
        break;
      }
    }
    
    if (!targetSheet) {
      if (isDebug) console.log('No suitable sheet found');
      if (isJson) {
        return ContentService.createTextOutput(JSON.stringify({ 
          participants: [],
          error: "No suitable sheet found. Available sheets: " + sheets.map(s => s.getName()).join(', ')
        })).setMimeType(ContentService.MimeType.JSON);
      }
      return createResponse({ 
        participants: [],
        error: "No suitable sheet found. Available sheets: " + sheets.map(s => s.getName()).join(', ')
      });
    }
    
    var data = targetSheet.getDataRange().getValues();
    if (isDebug) console.log('Data rows found:', data.length);
    
    if (data.length <= 1) {
      if (isDebug) console.log('No data rows found');
      if (isJson) {
        return ContentService.createTextOutput(JSON.stringify({ 
          participants: [],
          error: "No data rows found in sheet: " + targetSheet.getName()
        })).setMimeType(ContentService.MimeType.JSON);
      }
      return createResponse({ 
        participants: [],
        error: "No data rows found in sheet: " + targetSheet.getName()
      });
    }
    
    var headers = data[0];
    if (isDebug) console.log('Headers count:', headers.length);
    
    var participants = [];
    
    // à¸ªà¸£à¹‰à¸²à¸‡à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸œà¸¹à¹‰à¹ƒà¸Šà¹‰à¹ƒà¸™à¸£à¸¹à¸›à¹à¸šà¸šà¹€à¸”à¸µà¸¢à¸§à¸à¸±à¸š GBL
    for (var i = 1; i < data.length; i++) {
      var row = data[i];
      var participant = {};
      
      // à¸ªà¸£à¹‰à¸²à¸‡ object à¹‚à¸”à¸¢à¹ƒà¸Šà¹‰à¸Šà¸·à¹ˆà¸­ column à¹€à¸›à¹‡à¸™ key (à¹€à¸«à¸¡à¸·à¸­à¸™ GBL)
      for (var j = 0; j < headers.length; j++) {
        var header = headers[j];
        var value = row[j];
        
        // à¹à¸›à¸¥à¸‡à¸„à¹ˆà¸² null/undefined à¹€à¸›à¹‡à¸™ string à¸§à¹ˆà¸²à¸‡
        participant[header] = (value === null || value === undefined) ? '' : value;
      }
      
      participants.push(participant);
      
      // Log à¹€à¸‰à¸žà¸²à¸°à¸£à¸²à¸¢à¸à¸²à¸£à¹à¸£à¸à¹€à¸—à¹ˆà¸²à¸™à¸±à¹‰à¸™ à¹€à¸žà¸·à¹ˆà¸­ debug
      if (isDebug && i === 1) {
        console.log('First participant sample:', participant);
      }
    }
    
    var result = {
      participants: participants,
      debug: isDebug ? {
        sheetName: targetSheet.getName(),
        headers: headers,
        message: "Data loaded successfully from sheet",
        totalRows: data.length,
        totalParticipants: participants.length
      } : undefined
    };
    
    if (isDebug) console.log('Final result - participants count:', participants.length);
    
    // à¸–à¹‰à¸²à¸¡à¸µ type=json à¹ƒà¸«à¹‰à¹ƒà¸Šà¹‰ ContentService à¸•à¸£à¸‡à¹† à¹€à¸«à¸¡à¸·à¸­à¸™ Gym script
    var isJson = e && e.parameter && e.parameter.type === 'json';
    if (isJson) {
      return ContentService.createTextOutput(JSON.stringify(result))
        .setMimeType(ContentService.MimeType.JSON);
    }
    
    return createResponse(result);
    
  } catch (error) {
    console.error('Error in doGet:', error);
    var isJson = e && e.parameter && e.parameter.type === 'json';
    if (isJson) {
      return ContentService.createTextOutput(JSON.stringify({
        participants: [],
        error: error.toString(),
        stack: error.stack || '',
        debug: {
          message: "Error occurred while processing data",
          timestamp: new Date().toISOString()
        }
      })).setMimeType(ContentService.MimeType.JSON);
    }
    return createResponse({
      participants: [],
      error: error.toString(),
      stack: error.stack || '',
      debug: {
        message: "Error occurred while processing data",
        timestamp: new Date().toISOString()
      }
    });
  }
}

function createResponse(data) {
  var response = ContentService.createTextOutput(JSON.stringify(data));
  response.setMimeType(ContentService.MimeType.JSON);
  
  // à¹€à¸žà¸´à¹ˆà¸¡ CORS headers à¹€à¸žà¸·à¹ˆà¸­à¹à¸à¹‰à¸›à¸±à¸à¸«à¸² CORS error
  // Google Apps Script à¹„à¸¡à¹ˆà¸£à¸­à¸‡à¸£à¸±à¸šà¸à¸²à¸£à¸•à¸±à¹‰à¸‡à¸„à¹ˆà¸² headers à¹‚à¸”à¸¢à¸•à¸£à¸‡
  // à¹à¸•à¹ˆà¸ªà¸²à¸¡à¸²à¸£à¸–à¹ƒà¸Šà¹‰à¸§à¸´à¸˜à¸µà¸™à¸µà¹‰à¹„à¸”à¹‰à¹ƒà¸™à¸šà¸²à¸‡à¸à¸£à¸“à¸µ
  return response;
}

function doPost(e) {
  // POST request à¸„à¸§à¸£à¸ˆà¸°à¸—à¸³à¸‡à¸²à¸™à¹€à¸«à¸¡à¸·à¸­à¸™ GET à¸ªà¸³à¸«à¸£à¸±à¸š API à¸™à¸µà¹‰
  // à¹à¸•à¹ˆà¸ªà¸²à¸¡à¸²à¸£à¸–à¹ƒà¸Šà¹‰ e.postData à¹€à¸žà¸·à¹ˆà¸­à¸£à¸±à¸šà¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸ˆà¸²à¸ POST body à¹„à¸”à¹‰
  return doGet(e);
}

// à¸Ÿà¸±à¸‡à¸à¹Œà¸Šà¸±à¸™à¸—à¸”à¸ªà¸­à¸š
function testFunction() {
  console.log('Test function called');
  return 'Test successful';
}
