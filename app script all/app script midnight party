function doGet() {
  // ส่งข้อมูลเป็น JSON สำหรับการเรียกใช้จากหน้าเว็บ
  const data = getRegisteredUsers();
  return ContentService
    .createTextOutput(JSON.stringify(data))
    .setMimeType(ContentService.MimeType.JSON);
}

function getRegisteredUsers() {
  try {
    // ใช้ getActiveSpreadsheet() เหมือนกับ GBL
    var sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('Form Responses 1');
    var data = sheet.getDataRange().getValues();
    var headers = data[0];
    var users = [];
    var totalBoxes = 0;
    var totalSpots = 0;
    
    // หา index ของ columns ที่ต้องการ
    var nameIndex = headers.indexOf('ชื่อ-สกุล (Name-Surname)');
    var phoneIndex = headers.indexOf('เบอร์โทรศัพท์ติดต่อ (Contact Phone Number)');
    var nicknameIndex = headers.indexOf('ชื่อเล่น (Nickname)');
    var boxIndex = headers.indexOf('กรณีจอง Box: ต้องการที่ Box (1350/Box)? (In case of Box reservation: How many Boxes (1350/Box)?)');
    var spotIndex = headers.indexOf('กรณีจอง Spot: ต้องการกี่ Spot (500 บาท/Spot)? (In case of Spot reservation: How many Spots (500 Baht/Spot)?)');
    
    if (nameIndex === -1 || phoneIndex === -1) {
      return { error: 'ไม่พบ columns ที่ต้องการ' };
    }
    
    for (var i = 1; i < data.length; i++) {
      var row = data[i];
      if (row[nameIndex] && row[nameIndex].trim() !== '') {
        var user = {
          id: i,
          name: row[nameIndex].trim(),
          phone: row[phoneIndex] ? row[phoneIndex].toString().trim() : '',
          nickname: row[nicknameIndex] ? row[nicknameIndex].trim() : '',
          boxes: row[boxIndex] ? parseInt(row[boxIndex]) || 0 : 0,
          spots: row[spotIndex] ? parseInt(row[spotIndex]) || 0 : 0,
          timestamp: row[0] ? new Date(row[0]).toLocaleString('th-TH') : ''
        };
        
        users.push(user);
        totalBoxes += user.boxes;
        totalSpots += user.spots;
      }
    }
    
    return {
      users: users,
      total: users.length,
      totalBoxes: totalBoxes,
      totalSpots: totalSpots,
      success: true
    };
    
  } catch (error) {
    return { error: 'เกิดข้อผิดพลาด: ' + error.toString() };
  }
}

function getCodenameByPhone(phone) {
  try {
    // เปิด Google Sheet ของ codename mapping
    const codenameSheetId = 'YOUR_CODENAME_SHEET_ID'; // ใส่ ID ของ Sheet ที่มี codename mapping
    const sheet = SpreadsheetApp.openById(codenameSheetId);
    const worksheet = sheet.getSheetByName('Sheet1'); // หรือชื่อ sheet ที่มี codename
    
    if (!worksheet) {
      return null;
    }
    
    const data = worksheet.getDataRange().getValues();
    const headers = data[0];
    const rows = data.slice(1);
    
    // หา index ของ columns
    const phoneIndex = headers.indexOf('เบอร์โทรศัพท์'); // ปรับตามชื่อ column ใน sheet ของคุณ
    const codenameIndex = headers.indexOf('Codename'); // ปรับตามชื่อ column ใน sheet ของคุณ
    
    if (phoneIndex === -1 || codenameIndex === -1) {
      return null;
    }
    
    // ค้นหา codename จากเบอร์โทรศัพท์
    for (let row of rows) {
      if (row[phoneIndex] && row[phoneIndex].toString().trim() === phone.trim()) {
        return row[codenameIndex] ? row[codenameIndex].trim() : null;
      }
    }
    
    return null;
    
  } catch (error) {
    console.error('Error getting codename:', error);
    return null;
  }
}
