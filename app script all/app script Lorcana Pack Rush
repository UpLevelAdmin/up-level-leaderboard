// --- Telegram Configuration ---
const BOT_TOKEN = "8124787979:AAEWOqfiEACRxkrtZSWdTNuvGQr7uff_UoI";
const CHAT_ID = "-4911555842"; // Group Chat ID for Up Level

// --- Web App (GET) ---
function doGet(e) {
  return handleGet(e);
}

function handleGet(e) {
  // Default to returning JSON
  return getRegistrantsJSON();
}

function getRegistrantsJSON() {
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var sheet = ss.getSheets()[0]; // Assumes Form Responses is the first sheet
  var data = sheet.getDataRange().getValues();
  var headers = data[0];
  
  // Column Mapping
  var colMap = {};
  headers.forEach(function(h, i) {
    colMap[h.trim()] = i;
  });
  
  // Identify columns
  var colNickname = colMap["‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô"];
  var colPhone = colMap["‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå‡∏ó‡∏µ‡πà‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡πÑ‡∏î‡πâ"];
  var colLevel = colMap["‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡∏™‡∏ö‡∏Å‡∏≤‡∏£‡∏ì‡πå‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡πà‡∏ô Lorcana"];
  
  // Create response structure
  var groupedData = {};
  var eventDate = "‡∏ß‡∏±‡∏ô‡∏û‡∏∏‡∏ò‡∏ó‡∏µ‡πà 7 ‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏° 2569"; // Fixed Date for Pack Rush

  for (var i = 1; i < data.length; i++) {
    var row = data[i];
    var timestamp = row[0];
    
    // Skip if no timestamp
    if (!timestamp) continue;
    
    var nickname = row[colNickname];
    var phone = normalizePhone(row[colPhone]);
    var level = row[colLevel];
    
    // Only add if nickname and phone exist
    if (nickname && phone) {
      if (!groupedData[eventDate]) {
        groupedData[eventDate] = [];
      }
      
      groupedData[eventDate].push({
        nickname: nickname,
        phone: phone,
        level: level,
        timestamp: timestamp
      }); 
    }
  }
  
  return ContentService.createTextOutput(JSON.stringify({groupedData: groupedData}))
    .setMimeType(ContentService.MimeType.JSON);
}

// --- Trigger (Form Submit) ---
function onFormSubmit(e) {
  try {
    // Check if event object exists (it won't when running manually)
    if (!e || !e.namedValues) {
      console.error("No event object found. This function must be triggered by a Form Submit.");
      return;
    }

    var namedValues = e.namedValues;
    
    // Extract values using Header Names
    // Note: namedValues returns an array for each key
    var nickname = namedValues["‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô"] ? namedValues["‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô"][0] : "-";
    var phone = namedValues["‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå‡∏ó‡∏µ‡πà‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡πÑ‡∏î‡πâ"] ? namedValues["‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå‡∏ó‡∏µ‡πà‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡πÑ‡∏î‡πâ"][0] : "-";
    var level = namedValues["‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡∏™‡∏ö‡∏Å‡∏≤‡∏£‡∏ì‡πå‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡πà‡∏ô Lorcana"] ? namedValues["‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡∏™‡∏ö‡∏Å‡∏≤‡∏£‡∏ì‡πå‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡πà‡∏ô Lorcana"][0] : "-";
    var tutorial = namedValues["‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏ó‡∏µ‡∏°‡∏á‡∏≤‡∏ô‡∏™‡∏≠‡∏ô‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?"] ? namedValues["‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏ó‡∏µ‡∏°‡∏á‡∏≤‡∏ô‡∏™‡∏≠‡∏ô‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?"][0] : "-";
    var timestamp = namedValues["Timestamp"] ? namedValues["Timestamp"][0] : new Date().toLocaleString();
    var paymentProof = namedValues["‡πÅ‡∏ô‡∏ö‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô"] ? namedValues["‡πÅ‡∏ô‡∏ö‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô"][0] : "-";

    // Clean Phone
    phone = normalizePhone(phone);
    
    // Check total count for the event
    var currentCount = 0;
    try {
      var ss = SpreadsheetApp.getActiveSpreadsheet();
      var sheet = ss.getSheets()[0];
      currentCount = sheet.getLastRow() - 1; // Approximate count (minus header)
    } catch(err) {
      console.log("Could not get count: " + err);
    }

    // Construct Message
    var message = `üéÆ *‡∏°‡∏µ‡∏ú‡∏π‡πâ‡∏™‡∏°‡∏±‡∏Ñ‡∏£ Pack Rush ‡πÉ‡∏´‡∏°‡πà!* (‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà ${currentCount})
    
üë§ *‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô:* ${nickname}
üì± *‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£:* ${phone}
üî∞ *Level:* ${level}
üìö *‡∏™‡∏≠‡∏ô‡πÄ‡∏•‡πà‡∏ô:* ${tutorial}
‚è∞ *‡πÄ‡∏ß‡∏•‡∏≤:* ${timestamp}

---
üîé [‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î](https://uplevelguild.netlify.app/lorcana-pack-rush)
`;

    // Send to Telegram
    sendTelegramMessage(message);

  } catch (error) {
    console.error("Error in onFormSubmit: " + error);
    sendTelegramMessage("‚ùå Error processing Pack Rush registration: " + error);
  }
}

function sendTelegramMessage(text) {
  var url = `https://api.telegram.org/bot${BOT_TOKEN}/sendMessage`;
  var payload = {
    "chat_id": CHAT_ID,
    "text": text,
    "parse_mode": "Markdown",
    "disable_web_page_preview": true
  };
  
  var options = {
    "method": "post",
    "contentType": "application/json",
    "payload": JSON.stringify(payload)
  };
  
  try {
    UrlFetchApp.fetch(url, options);
    console.log("Sent Telegram message: " + text);
  } catch(e) {
    // Retry without markdown if failed (often due to special chars)
    payload.parse_mode = undefined;
    payload.text = text; // Use original text
    options.payload = JSON.stringify(payload);
    try {
      UrlFetchApp.fetch(url, options);
      console.log("Retry sent Telegram message (Plain Text): " + text);
    } catch(e2) {
      console.error("Failed to send Telegram message: " + e2);
    }
  }
}

// Helper to clean phone number
function normalizePhone(input) {
  var phone = String(input).replace(/[^\d]/g, "").trim();
  if (phone.length === 9 && phone[0] !== "0") return "0" + phone;
  if (phone.length === 10 && phone.startsWith("0")) return phone;
  return input; 
}
