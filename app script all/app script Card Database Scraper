/**
 * Google Apps Script ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏à‡∏≤‡∏Å‡πÄ‡∏ß‡πá‡∏ö Pokemon Card Asia
 * ‡πÅ‡∏•‡∏∞‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ß‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô Google Drive ‡πÅ‡∏•‡∏∞ Google Sheets
 * 
 * ‚ö†Ô∏è ‡∏Ñ‡∏≥‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏•‡∏¥‡∏Ç‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå:
 * - ‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ‡∏≠‡∏≤‡∏à‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏î‡πâ‡∏≤‡∏ô‡∏•‡∏¥‡∏Ç‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÅ‡∏•‡∏∞ Terms of Service
 * - ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏ä‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡πÅ‡∏•‡∏∞‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
 * - ‡∏Ñ‡∏ß‡∏£‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡∏à‡∏≤‡∏Å‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Å‡πà‡∏≠‡∏ô‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÄ‡∏ä‡∏¥‡∏á‡∏û‡∏≤‡∏ì‡∏¥‡∏ä‡∏¢‡πå
 */

// ==================== ‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ ====================
var CONFIG = {
  // ‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏£‡∏∑‡∏≠ ID ‡∏Ç‡∏≠‡∏á Google Drive Folder ‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÄ‡∏Å‡πá‡∏ö‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û
  // ‡∏ñ‡πâ‡∏≤‡πÉ‡∏™‡πà ID ‡∏à‡∏∞‡πÉ‡∏ä‡πâ‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ô‡∏±‡πâ‡∏ô‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á (‡πÄ‡∏ä‡πà‡∏ô: '15f0xNKHe4q8sNaMQo3uXs1qPBB0oVQx2')
  // ‡∏ñ‡πâ‡∏≤‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠ ‡∏à‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡∏£‡∏∑‡∏≠‡∏´‡∏≤‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡πâ‡∏ô (‡πÄ‡∏ä‡πà‡∏ô: 'Pokemon Card Database')
  DRIVE_FOLDER_NAME_OR_ID: 'Pokemon Card Database',
  
  // ‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏£‡∏∑‡∏≠ ID ‡∏Ç‡∏≠‡∏á Google Spreadsheet ‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
  // ‡∏ñ‡πâ‡∏≤‡πÉ‡∏™‡πà ID ‡∏à‡∏∞‡πÉ‡∏ä‡πâ Spreadsheet ‡∏ô‡∏±‡πâ‡∏ô‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á (‡πÄ‡∏ä‡πà‡∏ô: '1JvVCVxxXBS-2lpnT-IOrYBf2rF-OBRVFCW6MZEvpqxE')
  // ‡∏ñ‡πâ‡∏≤‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠ ‡∏à‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡∏£‡∏∑‡∏≠‡∏´‡∏≤ Spreadsheet ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡πâ‡∏ô (‡πÄ‡∏ä‡πà‡∏ô: 'Pokemon Card Database')
  SPREADSHEET_NAME_OR_ID: 'Pokemon Card Database',
  
  // ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏ï‡πà‡∏≠‡∏´‡∏ô‡πâ‡∏≤ (‡∏ñ‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö‡∏°‡∏µ pagination)
  CARDS_PER_PAGE: 50,
  
  // Delay ‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏£ request (‡∏°‡∏¥‡∏•‡∏•‡∏¥‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏´‡∏•‡∏µ‡∏Å‡πÄ‡∏•‡∏µ‡πà‡∏¢‡∏á rate limiting
  REQUEST_DELAY: 2000, // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏õ‡πá‡∏ô 2 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏´‡∏•‡∏µ‡∏Å‡πÄ‡∏•‡∏µ‡πà‡∏¢‡∏á rate limit
  
  // ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏Å‡∏¥‡∏î error (‡πÄ‡∏ä‡πà‡∏ô 504, 503, timeout)
  MAX_RETRIES: 5 // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏õ‡πá‡∏ô 5 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏±‡∏ö server errors
};

// ==================== ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏´‡∏•‡∏±‡∏Å ====================

/**
 * ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
 * ‡∏£‡∏±‡∏ô‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
 */
function startScrapingAllCards() {
  try {
    Logger.log('üöÄ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î...');
    
    // ‡∏™‡∏£‡πâ‡∏≤‡∏á/‡∏´‡∏≤‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÉ‡∏ô Drive
    var folder = getOrCreateDriveFolder(CONFIG.DRIVE_FOLDER_NAME_OR_ID);
    Logger.log('üìÅ ‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå: ' + folder.getUrl());
    Logger.log('üìÅ ‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå ID: ' + folder.getId());
    
    // ‡∏™‡∏£‡πâ‡∏≤‡∏á/‡∏´‡∏≤ Spreadsheet
    var spreadsheet = getOrCreateSpreadsheet(CONFIG.SPREADSHEET_NAME_OR_ID);
    Logger.log('üìä Spreadsheet: ' + spreadsheet.getUrl());
    Logger.log('üìä Spreadsheet ID: ' + spreadsheet.getId());
    var sheet = getOrCreateSheet(spreadsheet, 'Cards');
    
    // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ header ‡∏Ç‡∏≠‡∏á Spreadsheet
    setupSpreadsheetHeaders(sheet);
    
    // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
    var allCards = [];
    var page = 1;
    var hasMore = true;
    
    while (hasMore) {
      Logger.log('üìÑ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏´‡∏ô‡πâ‡∏≤ ' + page + '...');
      
      try {
        var cards = fetchCardsFromPage(page);
        
        if (!cards || cards.length === 0) {
          hasMore = false;
          Logger.log('‚úÖ ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô (‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πå‡∏î‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ)');
          break;
        }
        
        Logger.log('   ‡∏û‡∏ö‡∏Å‡∏≤‡∏£‡πå‡∏î ' + cards.length + ' ‡πÉ‡∏ö');
        allCards = allCards.concat(cards);
        
        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏´‡∏ô‡πâ‡∏≤‡∏ñ‡∏±‡∏î‡πÑ‡∏õ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
        if (cards.length < CONFIG.CARDS_PER_PAGE) {
          hasMore = false;
        }
        
        page++;
        
        // Delay ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏´‡∏•‡∏µ‡∏Å‡πÄ‡∏•‡∏µ‡πà‡∏¢‡∏á rate limiting
        Utilities.sleep(CONFIG.REQUEST_DELAY);
        
      } catch (error) {
        Logger.log('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á‡∏´‡∏ô‡πâ‡∏≤ ' + page + ': ' + error.toString());
        hasMore = false;
      }
    }
    
    Logger.log('üìä ‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ' + allCards.length + ' ‡∏Å‡∏≤‡∏£‡πå‡∏î');
    
    // ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÅ‡∏•‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
    var successCount = 0;
    var errorCount = 0;
    
    for (var i = 0; i < allCards.length; i++) {
      var card = allCards[i];
      
      try {
        Logger.log('üì• ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î: ' + card.name + ' (' + (i + 1) + '/' + allCards.length + ')');
        
        // ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û
        var imageFile = downloadCardImage(card, folder);
        
        // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏á Spreadsheet
        saveCardToSpreadsheet(sheet, card, imageFile);
        
        successCount++;
        
        // Delay ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏´‡∏•‡∏µ‡∏Å‡πÄ‡∏•‡∏µ‡πà‡∏¢‡∏á rate limiting
        Utilities.sleep(CONFIG.REQUEST_DELAY);
        
      } catch (error) {
        Logger.log('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏Å‡∏±‡∏ö: ' + card.name + ' - ' + error.toString());
        errorCount++;
        
        // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏°‡πâ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û
        try {
          saveCardToSpreadsheet(sheet, card, null);
        } catch (e) {
          Logger.log('‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: ' + e.toString());
        }
      }
    }
    
    Logger.log('‚úÖ ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô!');
    Logger.log('   ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + successCount + ' ‡∏Å‡∏≤‡∏£‡πå‡∏î');
    Logger.log('   ‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + errorCount + ' ‡∏Å‡∏≤‡∏£‡πå‡∏î');
    Logger.log('üìä Spreadsheet: ' + spreadsheet.getUrl());
    Logger.log('üìÅ Drive Folder: ' + folder.getUrl());
    
    // ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå (‡πÉ‡∏ä‡πâ Logger ‡πÅ‡∏ó‡∏ô getUi() ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏£‡∏±‡∏ô‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å‡∏ó‡∏∏‡∏Å context)
    var summary = '‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô!\n\n' +
      '‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ: ' + allCards.length + ' ‡∏Å‡∏≤‡∏£‡πå‡∏î\n' +
      '‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + successCount + ' ‡∏Å‡∏≤‡∏£‡πå‡∏î\n' +
      '‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + errorCount + ' ‡∏Å‡∏≤‡∏£‡πå‡∏î\n\n' +
      'Spreadsheet: ' + spreadsheet.getUrl() + '\n' +
      'Drive Folder: ' + folder.getUrl();
    
    Logger.log(summary);
    
    // ‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡πÅ‡∏™‡∏î‡∏á alert ‡∏ñ‡πâ‡∏≤‡∏£‡∏±‡∏ô‡∏à‡∏≤‡∏Å Spreadsheet UI
    try {
      SpreadsheetApp.getUi().alert(summary);
    } catch (e) {
      // ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÉ‡∏ä‡πâ getUi() ‡πÑ‡∏î‡πâ (‡∏£‡∏±‡∏ô‡∏à‡∏≤‡∏Å Apps Script editor)
      Logger.log('üí° ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Logs ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå');
    }
    
  } catch (error) {
    Logger.log('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.toString());
    try {
      SpreadsheetApp.getUi().alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.toString());
    } catch (e) {
      // ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÉ‡∏ä‡πâ getUi() ‡πÑ‡∏î‡πâ
      Logger.log('üí° ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Logs ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π error details');
    }
  }
}

/**
 * ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏à‡∏≤‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö (‡∏ï‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏á‡∏ï‡∏≤‡∏°‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡∏≠‡∏á‡πÄ‡∏ß‡πá‡∏ö)
 * 
 * ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ‡πÄ‡∏ß‡πá‡∏ö asia.pokemon-card.com ‡∏≠‡∏≤‡∏à‡πÉ‡∏ä‡πâ JavaScript ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
 * ‡∏≠‡∏≤‡∏à‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡∏ß‡∏¥‡∏ò‡∏µ‡∏≠‡∏∑‡πà‡∏ô ‡πÄ‡∏ä‡πà‡∏ô:
 * 1. ‡∏´‡∏≤ API endpoint ‡∏ó‡∏µ‡πà‡πÄ‡∏ß‡πá‡∏ö‡πÉ‡∏ä‡πâ
 * 2. ‡πÉ‡∏ä‡πâ Selenium ‡∏´‡∏£‡∏∑‡∏≠ Puppeteer (‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÉ‡∏ä‡πâ‡πÉ‡∏ô Apps Script)
 * 3. ‡πÉ‡∏ä‡πâ Pokemon TCG API ‡πÅ‡∏ó‡∏ô (‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥)
 */
function fetchCardsFromPage(page) {
  try {
    // ‡∏ß‡∏¥‡∏ò‡∏µ‡∏ó‡∏µ‡πà 1: ‡πÉ‡∏ä‡πâ Pokemon TCG API (‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥ - ‡∏°‡∏µ API ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡∏Å‡∏é‡∏´‡∏°‡∏≤‡∏¢)
    return fetchCardsFromPokemonTCGAPI(page);
    
    // ‡∏ß‡∏¥‡∏ò‡∏µ‡∏ó‡∏µ‡πà 2: ‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡∏î‡∏∂‡∏á‡∏à‡∏≤‡∏Å‡πÄ‡∏ß‡πá‡∏ö‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á (‡∏≠‡∏≤‡∏à‡πÑ‡∏°‡πà‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡πÉ‡∏ä‡πâ JavaScript)
    // return fetchCardsFromWebsite(page);
    
  } catch (error) {
    Logger.log('Error fetching cards: ' + error.toString());
    throw error;
  }
}

/**
 * ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏à‡∏≤‡∏Å Pokemon TCG API (‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥)
 * ‡∏°‡∏µ retry mechanism ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏±‡∏ö timeout ‡πÅ‡∏•‡∏∞ server errors
 */
function fetchCardsFromPokemonTCGAPI(page) {
  var apiUrl = 'https://api.pokemontcg.io/v2/cards?page=' + page + '&pageSize=' + CONFIG.CARDS_PER_PAGE;
  var retries = 0;
  var maxRetries = CONFIG.MAX_RETRIES;
  var retryDelay = 2000; // 2 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
  
  while (retries <= maxRetries) {
    try {
      Logger.log('   üì° ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏ô‡πâ‡∏≤ ' + page + ' (‡∏•‡∏≠‡∏á‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà ' + (retries + 1) + ')...');
      
      var response = UrlFetchApp.fetch(apiUrl, {
        'method': 'get',
        'headers': {
          'Accept': 'application/json',
          'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'
        },
        'muteHttpExceptions': true, // ‡πÑ‡∏°‡πà throw exception ‡πÄ‡∏°‡∏∑‡πà‡∏≠ HTTP error
        'followRedirects': true,
        'validateHttpsCertificates': true
      });
      
      var responseCode = response.getResponseCode();
      
      // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö response code
      if (responseCode === 200) {
        // ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
        var responseText = response.getContentText();
        
        if (!responseText || responseText.trim() === '') {
          throw new Error('Empty response from API');
        }
        
        var data = JSON.parse(responseText);
        var cards = [];
        
        if (data.data && Array.isArray(data.data)) {
          data.data.forEach(function(card) {
            cards.push({
              id: card.id || '',
              name: card.name || '',
              setName: card.set ? card.set.name : '',
              setCode: card.set ? card.set.id : '',
              number: card.number || '',
              imageUrl: card.images ? (card.images.large || card.images.small) : '',
              imageUrlSmall: card.images ? card.images.small : '',
              imageUrlLarge: card.images ? card.images.large : '',
              rarity: card.rarity || '',
              types: card.types ? card.types.join(', ') : '',
              supertype: card.supertype || '',
              subtypes: card.subtypes ? card.subtypes.join(', ') : '',
              hp: card.hp || '',
              attacks: card.attacks ? JSON.stringify(card.attacks) : '',
              attacksText: extractAttacksText(card.attacks), // ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏≤‡∏Å attacks ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
              abilities: card.abilities ? JSON.stringify(card.abilities) : '',
              abilitiesText: extractAbilitiesText(card.abilities), // ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏≤‡∏Å abilities ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
              text: card.text || '', // ‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πå‡∏î
              weaknesses: card.weaknesses ? JSON.stringify(card.weaknesses) : '',
              resistances: card.resistances ? JSON.stringify(card.resistances) : '',
              retreatCost: card.retreatCost || '',
              convertedRetreatCost: card.convertedRetreatCost || '',
              nationalPokedexNumbers: card.nationalPokedexNumbers ? card.nationalPokedexNumbers.join(', ') : '',
              legalities: card.legalities ? JSON.stringify(card.legalities) : '',
              tcgplayer: card.tcgplayer ? JSON.stringify(card.tcgplayer) : '',
              cardmarket: card.cardmarket ? JSON.stringify(card.cardmarket) : '',
              // Tags ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
              tags: generateCardTags(card),
              // ‡∏£‡∏ß‡∏°‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
              searchableText: generateSearchableText(card),
              updatedAt: new Date().toISOString()
            });
          });
        }
        
        Logger.log('   ‚úÖ ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + cards.length + ' ‡∏Å‡∏≤‡∏£‡πå‡∏î');
        return cards;
        
      } else if (responseCode === 504 || responseCode === 503 || responseCode === 502) {
        // Gateway Timeout ‡∏´‡∏£‡∏∑‡∏≠ Server Error - ‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà
        retries++;
        if (retries <= maxRetries) {
          Logger.log('   ‚ö†Ô∏è Server error ' + responseCode + ' - ‡∏à‡∏∞‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡πÉ‡∏ô ' + (retryDelay / 1000) + ' ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ...');
          Utilities.sleep(retryDelay);
          retryDelay *= 2; // Exponential backoff
          continue;
        } else {
          throw new Error('API returned status ' + responseCode + ' after ' + maxRetries + ' retries');
        }
        
      } else if (responseCode === 429) {
        // Rate limit - ‡∏£‡∏≠‡πÉ‡∏´‡πâ‡∏ô‡∏≤‡∏ô‡∏Ç‡∏∂‡πâ‡∏ô
        retries++;
        if (retries <= maxRetries) {
          var waitTime = retryDelay * 2; // ‡∏£‡∏≠‡∏ô‡∏≤‡∏ô‡∏Ç‡∏∂‡πâ‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö rate limit
          Logger.log('   ‚ö†Ô∏è Rate limit (429) - ‡∏à‡∏∞‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡πÉ‡∏ô ' + (waitTime / 1000) + ' ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ...');
          Utilities.sleep(waitTime);
          retryDelay *= 2;
          continue;
        } else {
          throw new Error('Rate limit exceeded after ' + maxRetries + ' retries');
        }
        
      } else {
        // Error ‡∏≠‡∏∑‡πà‡∏ô‡πÜ
        var errorText = response.getContentText();
        throw new Error('API returned status ' + responseCode + ': ' + errorText.substring(0, 200));
      }
      
    } catch (error) {
      retries++;
      
      // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô network error ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
      var errorMessage = error.toString();
      if (errorMessage.indexOf('504') !== -1 || 
          errorMessage.indexOf('503') !== -1 || 
          errorMessage.indexOf('502') !== -1 ||
          errorMessage.indexOf('timeout') !== -1 ||
          errorMessage.indexOf('Timeout') !== -1) {
        
        if (retries <= maxRetries) {
          Logger.log('   ‚ö†Ô∏è Network/Server error - ‡∏à‡∏∞‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡πÉ‡∏ô ' + (retryDelay / 1000) + ' ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ...');
          Logger.log('   Error: ' + errorMessage);
          Utilities.sleep(retryDelay);
          retryDelay *= 2;
          continue;
        }
      }
      
      // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà network error ‡∏´‡∏£‡∏∑‡∏≠‡∏•‡∏≠‡∏á‡∏Ñ‡∏£‡∏ö‡πÅ‡∏•‡πâ‡∏ß
      Logger.log('   ‚ùå Error fetching from Pokemon TCG API: ' + errorMessage);
      throw error;
    }
  }
  
  // ‡πÑ‡∏°‡πà‡∏Ñ‡∏ß‡∏£‡∏°‡∏≤‡∏ñ‡∏∂‡∏á‡∏à‡∏∏‡∏î‡∏ô‡∏µ‡πâ ‡πÅ‡∏ï‡πà‡∏ñ‡πâ‡∏≤‡∏°‡∏≤‡πÉ‡∏´‡πâ throw error
  throw new Error('Failed to fetch cards after ' + maxRetries + ' retries');
}

/**
 * ‡πÅ‡∏õ‡∏•‡∏á Attacks ‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÑ‡∏î‡πâ
 */
function extractAttacksText(attacks) {
  if (!attacks || !Array.isArray(attacks)) {
    return '';
  }
  
  var texts = [];
  attacks.forEach(function(attack) {
    if (attack.name) texts.push(attack.name);
    if (attack.text) texts.push(attack.text);
    if (attack.damage) texts.push(attack.damage);
  });
  
  return texts.join(' ');
}

/**
 * ‡πÅ‡∏õ‡∏•‡∏á Abilities ‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÑ‡∏î‡πâ
 */
function extractAbilitiesText(abilities) {
  if (!abilities || !Array.isArray(abilities)) {
    return '';
  }
  
  var texts = [];
  abilities.forEach(function(ability) {
    if (ability.name) texts.push(ability.name);
    if (ability.text) texts.push(ability.text);
    if (ability.type) texts.push(ability.type);
  });
  
  return texts.join(' ');
}

/**
 * ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÑ‡∏î‡πâ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡∏£‡∏ß‡∏°‡∏ä‡∏∑‡πà‡∏≠, ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ, attacks, abilities, text)
 */
function generateSearchableText(card) {
  var texts = [];
  
  // ‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡πå‡∏î
  if (card.name) texts.push(card.name);
  
  // Text (‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢)
  if (card.text) texts.push(card.text);
  
  // Attacks
  if (card.attacks && Array.isArray(card.attacks)) {
    card.attacks.forEach(function(attack) {
      if (attack.name) texts.push(attack.name);
      if (attack.text) texts.push(attack.text);
    });
  }
  
  // Abilities
  if (card.abilities && Array.isArray(card.abilities)) {
    card.abilities.forEach(function(ability) {
      if (ability.name) texts.push(ability.name);
      if (ability.text) texts.push(ability.text);
    });
  }
  
  return texts.join(' ').toLowerCase();
}

/**
 * ‡∏™‡∏£‡πâ‡∏≤‡∏á Tags ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πå‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
 * Tags ‡∏à‡∏∞‡∏£‡∏ß‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡πà‡∏≤‡∏á‡πÜ ‡πÄ‡∏ä‡πà‡∏ô ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó, ‡∏ß‡∏¥‡∏ß‡∏±‡∏í‡∏ô‡∏≤‡∏Å‡∏≤‡∏£, ‡πÅ‡∏£‡∏£‡πå‡∏£‡∏¥‡∏ï‡∏µ‡πâ, ‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏û‡∏¥‡πÄ‡∏®‡∏© ‡∏Ø‡∏•‡∏Ø
 */
function generateCardTags(card) {
  var tags = [];
  
  // ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏´‡∏•‡∏±‡∏Å (Pokemon, Trainer, Energy)
  if (card.supertype) {
    tags.push(card.supertype.toLowerCase());
  }
  
  // ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏¢‡πà‡∏≠‡∏¢ (Stage 1, Stage 2, Item, Support, Stadium, etc.)
  if (card.subtypes && Array.isArray(card.subtypes)) {
    card.subtypes.forEach(function(subtype) {
      tags.push(subtype.toLowerCase());
    });
  }
  
  // ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏û‡∏•‡∏±‡∏á‡∏á‡∏≤‡∏ô (Fire, Water, Grass, etc.)
  if (card.types && Array.isArray(card.types)) {
    card.types.forEach(function(type) {
      tags.push(type.toLowerCase());
    });
  }
  
  // ‡πÅ‡∏£‡∏£‡πå‡∏£‡∏¥‡∏ï‡∏µ‡πâ
  if (card.rarity) {
    var rarity = card.rarity.toLowerCase();
    tags.push(rarity);
    
    // ‡πÅ‡∏¢‡∏Å‡πÅ‡∏£‡∏£‡πå‡∏£‡∏¥‡∏ï‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà
    if (rarity.indexOf('common') !== -1) tags.push('common');
    if (rarity.indexOf('uncommon') !== -1) tags.push('uncommon');
    if (rarity.indexOf('rare') !== -1) tags.push('rare');
    if (rarity.indexOf('ultra') !== -1) tags.push('ultra-rare');
    if (rarity.indexOf('secret') !== -1) tags.push('secret-rare');
    if (rarity.indexOf('holo') !== -1) tags.push('holo');
  }
  
  // ‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏û‡∏¥‡πÄ‡∏®‡∏© (V, GX, ex, VMAX, VSTAR, etc.)
  if (card.subtypes && Array.isArray(card.subtypes)) {
    var specialTypes = ['v', 'gx', 'ex', 'vmax', 'vstar', 'v-union', 'radiant', 'ace spec'];
    card.subtypes.forEach(function(subtype) {
      var subtypeLower = subtype.toLowerCase();
      if (specialTypes.indexOf(subtypeLower) !== -1) {
        tags.push(subtypeLower);
      }
    });
  }
  
  // ‡∏ß‡∏¥‡∏ß‡∏±‡∏í‡∏ô‡∏≤‡∏Å‡∏≤‡∏£
  if (card.subtypes && Array.isArray(card.subtypes)) {
    if (card.subtypes.indexOf('Basic') !== -1) {
      tags.push('basic');
      tags.push('‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô');
    }
    if (card.subtypes.indexOf('Stage 1') !== -1) {
      tags.push('stage1');
      tags.push('‡∏£‡πà‡∏≤‡∏á1');
    }
    if (card.subtypes.indexOf('Stage 2') !== -1) {
      tags.push('stage2');
      tags.push('‡∏£‡πà‡∏≤‡∏á2');
    }
  }
  
  // ‡πÄ‡∏£‡∏Å‡∏Å‡∏π‡πÄ‡∏•‡∏ä‡∏±‡∏ô (‡∏à‡∏≤‡∏Å legalities)
  if (card.legalities) {
    try {
      var legalities = typeof card.legalities === 'string' ? JSON.parse(card.legalities) : card.legalities;
      if (legalities) {
        if (legalities.standard === 'Legal') tags.push('standard');
        if (legalities.expanded === 'Legal') tags.push('expanded');
        if (legalities.unlimited === 'Legal') tags.push('unlimited');
      }
    } catch (e) {
      // ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ parse legalities ‡πÑ‡∏î‡πâ
    }
  }
  
  // ‡∏Å‡∏≤‡∏£‡πå‡∏î‡πÄ‡∏ó‡∏£‡∏ô‡πÄ‡∏ô‡∏≠‡∏£‡πå‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ï‡πà‡∏≤‡∏á‡πÜ
  if (card.supertype === 'Trainer') {
    if (card.subtypes && Array.isArray(card.subtypes)) {
      card.subtypes.forEach(function(subtype) {
        var subtypeLower = subtype.toLowerCase();
        if (subtypeLower === 'item') tags.push('item');
        if (subtypeLower === 'supporter') tags.push('supporter');
        if (subtypeLower === 'stadium') tags.push('stadium');
        if (subtypeLower === 'tool') tags.push('tool');
        if (subtypeLower === 'pokemon tool') tags.push('pokemon-tool');
      });
    }
  }
  
  // ‡∏£‡∏ß‡∏° Tags ‡πÄ‡∏õ‡πá‡∏ô string (‡∏Ñ‡∏±‡πà‡∏ô‡∏î‡πâ‡∏ß‡∏¢ comma)
  return tags.join(', ');
}

/**
 * ‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡πÄ‡∏ß‡πá‡∏ö‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á (‡∏≠‡∏≤‡∏à‡πÑ‡∏°‡πà‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡πÉ‡∏ä‡πâ JavaScript)
 */
function fetchCardsFromWebsite(page) {
  try {
    // URL ‡∏Ç‡∏≠‡∏á‡πÄ‡∏ß‡πá‡∏ö (‡∏≠‡∏≤‡∏à‡∏ï‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏á)
    var baseUrl = 'https://asia.pokemon-card.com/th/deck-build/';
    
    // ‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡∏î‡∏∂‡∏á HTML
    var response = UrlFetchApp.fetch(baseUrl, {
      'method': 'get',
      'headers': {
        'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'
      }
    });
    
    var html = response.getContentText();
    
    // ‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡πÄ‡∏ß‡πá‡∏ö‡πÉ‡∏ä‡πâ JavaScript ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
    // ‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á HTML ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á‡∏≠‡∏≤‡∏à‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£
    // ‡∏≠‡∏≤‡∏à‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡∏ß‡∏¥‡∏ò‡∏µ‡∏≠‡∏∑‡πà‡∏ô ‡πÄ‡∏ä‡πà‡∏ô ‡∏´‡∏≤ API endpoint ‡∏ó‡∏µ‡πà‡πÄ‡∏ß‡πá‡∏ö‡πÉ‡∏ä‡πâ
    
    Logger.log('‚ö†Ô∏è ‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡πÄ‡∏ß‡πá‡∏ö‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á‡∏≠‡∏≤‡∏à‡πÑ‡∏°‡πà‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡πÄ‡∏ß‡πá‡∏ö‡πÉ‡∏ä‡πâ JavaScript');
    Logger.log('‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ Pokemon TCG API ‡πÅ‡∏ó‡∏ô');
    
    return [];
    
  } catch (error) {
    Logger.log('Error fetching from website: ' + error.toString());
    throw error;
  }
}

/**
 * ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏Å‡∏≤‡∏£‡πå‡∏î‡πÅ‡∏•‡∏∞‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ß‡πâ‡πÉ‡∏ô Drive
 */
function downloadCardImage(card, folder) {
  try {
    var imageUrl = card.imageUrlLarge || card.imageUrl || card.imageUrlSmall;
    
    if (!imageUrl) {
      throw new Error('‡πÑ‡∏°‡πà‡∏°‡∏µ URL ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û');
    }
    
    // ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û
    var response = UrlFetchApp.fetch(imageUrl, {
      'method': 'get',
      'headers': {
        'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'
      }
    });
    
    var blob = response.getBlob();
    
    // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå
    var fileName = sanitizeFileName(card.name) + '_' + 
                   sanitizeFileName(card.setCode) + '_' + 
                   card.number + '.jpg';
    
    // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏ô Drive
    var file = folder.createFile(blob);
    file.setName(fileName);
    
    // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÅ‡∏ä‡∏£‡πå‡πÄ‡∏õ‡πá‡∏ô Public
    file.setSharing(DriveApp.Access.ANYONE_WITH_LINK, DriveApp.Permission.VIEW);
    
    // ‡∏™‡∏£‡πâ‡∏≤‡∏á Direct Link
    var fileId = file.getId();
    var directLink = 'https://drive.google.com/uc?export=view&id=' + fileId;
    
    Logger.log('   ‚úÖ ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + fileName);
    
    return {
      id: fileId,
      name: fileName,
      url: directLink,
      webViewLink: file.getUrl()
    };
    
  } catch (error) {
    Logger.log('   ‚ùå ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ' + error.toString());
    throw error;
  }
}

/**
 * ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏•‡∏á Spreadsheet
 */
function saveCardToSpreadsheet(sheet, card, imageFile) {
  try {
    var row = [
      card.id || '',
      card.name || '',
      card.setName || '',
      card.setCode || '',
      card.number || '',
      card.rarity || '',
      card.types || '',
      card.supertype || '',
      card.subtypes || '',
      card.hp || '',
      card.retreatCost || '',
      card.attacksText || '', // ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏≤‡∏Å attacks
      card.abilitiesText || '', // ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏≤‡∏Å abilities
      card.text || '', // ‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πå‡∏î
      card.searchableText || '', // ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÑ‡∏î‡πâ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
      card.tags || '', // Tags
      imageFile ? imageFile.url : '',
      imageFile ? imageFile.name : '',
      card.imageUrlLarge || card.imageUrl || '',
      card.updatedAt || new Date().toISOString()
    ];
    
    sheet.appendRow(row);
    
  } catch (error) {
    Logger.log('Error saving to spreadsheet: ' + error.toString());
    throw error;
  }
}

/**
 * ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ header ‡∏Ç‡∏≠‡∏á Spreadsheet
 */
function setupSpreadsheetHeaders(sheet) {
  // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ header ‡πÅ‡∏•‡πâ‡∏ß‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á
  var lastRow = sheet.getLastRow();
  if (lastRow > 0) {
    // ‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡πâ‡∏ß ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á header ‡πÉ‡∏´‡∏°‡πà
    return;
  }
  
  var headers = [
    'Card ID',
    'Card Name',
    'Set Name',
    'Set Code',
    'Card Number',
    'Rarity',
    'Types',
    'Supertype',
    'Subtypes',
    'HP',
    'Retreat Cost',
    'Attacks Text', // ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏≤‡∏Å attacks
    'Abilities Text', // ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏≤‡∏Å abilities
    'Card Text', // ‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πå‡∏î
    'Searchable Text', // ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÑ‡∏î‡πâ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
    'Tags', // Tags ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
    'Image URL (Drive)',
    'Image File Name',
    'Original Image URL',
    'Updated At'
  ];
  
  sheet.appendRow(headers);
  
  // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö header
  var headerRange = sheet.getRange(1, 1, 1, headers.length);
  headerRange.setFontWeight('bold');
  headerRange.setBackground('#4285f4');
  headerRange.setFontColor('#ffffff');
  headerRange.setHorizontalAlignment('center');
  
  // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå
  sheet.setColumnWidth(1, 150); // Card ID
  sheet.setColumnWidth(2, 200); // Card Name
  sheet.setColumnWidth(3, 150); // Set Name
  sheet.setColumnWidth(4, 100); // Set Code
  sheet.setColumnWidth(5, 100); // Card Number
  sheet.setColumnWidth(11, 300); // Image URL
  sheet.setColumnWidth(12, 200); // Image File Name
  sheet.setColumnWidth(13, 300); // Original Image URL
}

/**
 * ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡∏£‡∏∑‡∏≠‡∏´‡∏≤‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÉ‡∏ô Drive
 * ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÅ‡∏•‡∏∞ Folder ID
 */
function getOrCreateDriveFolder(folderNameOrId) {
  // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô ID ‡∏´‡∏£‡∏∑‡∏≠‡∏ä‡∏∑‡πà‡∏≠
  // ID ‡∏°‡∏±‡∏Å‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏ß 33 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£‡πÅ‡∏•‡∏∞‡∏°‡∏µ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÄ‡∏â‡∏û‡∏≤‡∏∞
  if (folderNameOrId && folderNameOrId.length === 33 && /^[a-zA-Z0-9_-]+$/.test(folderNameOrId)) {
    try {
      // ‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡πÉ‡∏ä‡πâ‡πÄ‡∏õ‡πá‡∏ô ID
      var folder = DriveApp.getFolderById(folderNameOrId);
      Logger.log('‚úÖ ‡πÉ‡∏ä‡πâ‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß (ID): ' + folder.getName());
      return folder;
    } catch (error) {
      Logger.log('‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏î‡πâ‡∏ß‡∏¢ ID: ' + folderNameOrId + ' ‡∏à‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà‡∏î‡πâ‡∏ß‡∏¢‡∏ä‡∏∑‡πà‡∏≠');
      // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏î‡πâ‡∏ß‡∏¢ ID ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏ó‡∏ô
    }
  }
  
  // ‡πÉ‡∏ä‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå
  var folders = DriveApp.getFoldersByName(folderNameOrId);
  
  if (folders.hasNext()) {
    var folder = folders.next();
    Logger.log('‚úÖ ‡πÉ‡∏ä‡πâ‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß (‡∏ä‡∏∑‡πà‡∏≠): ' + folder.getName());
    return folder;
  } else {
    var newFolder = DriveApp.createFolder(folderNameOrId);
    Logger.log('‚úÖ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÉ‡∏´‡∏°‡πà: ' + newFolder.getName());
    return newFolder;
  }
}

/**
 * ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡∏£‡∏∑‡∏≠‡∏´‡∏≤ Spreadsheet
 * ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠ Spreadsheet ‡πÅ‡∏•‡∏∞ Spreadsheet ID
 */
function getOrCreateSpreadsheet(spreadsheetNameOrId) {
  // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô ID ‡∏´‡∏£‡∏∑‡∏≠‡∏ä‡∏∑‡πà‡∏≠
  // Spreadsheet ID ‡∏°‡∏±‡∏Å‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏ß 44 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£‡πÅ‡∏•‡∏∞‡∏°‡∏µ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÄ‡∏â‡∏û‡∏≤‡∏∞
  if (spreadsheetNameOrId && spreadsheetNameOrId.length >= 40 && /^[a-zA-Z0-9_-]+$/.test(spreadsheetNameOrId)) {
    try {
      // ‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡πÉ‡∏ä‡πâ‡πÄ‡∏õ‡πá‡∏ô ID
      var spreadsheet = SpreadsheetApp.openById(spreadsheetNameOrId);
      Logger.log('‚úÖ ‡πÉ‡∏ä‡πâ Spreadsheet ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß (ID): ' + spreadsheet.getName());
      return spreadsheet;
    } catch (error) {
      Logger.log('‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏û‡∏ö Spreadsheet ‡∏î‡πâ‡∏ß‡∏¢ ID: ' + spreadsheetNameOrId + ' ‡∏à‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà‡∏î‡πâ‡∏ß‡∏¢‡∏ä‡∏∑‡πà‡∏≠');
      // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏î‡πâ‡∏ß‡∏¢ ID ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏ó‡∏ô
    }
  }
  
  // ‡πÉ‡∏ä‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏ä‡∏∑‡πà‡∏≠ Spreadsheet
  var files = DriveApp.getFilesByName(spreadsheetNameOrId);
  
  if (files.hasNext()) {
    var spreadsheet = SpreadsheetApp.open(files.next());
    Logger.log('‚úÖ ‡πÉ‡∏ä‡πâ Spreadsheet ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß (‡∏ä‡∏∑‡πà‡∏≠): ' + spreadsheet.getName());
    return spreadsheet;
  } else {
    var newSpreadsheet = SpreadsheetApp.create(spreadsheetNameOrId);
    Logger.log('‚úÖ ‡∏™‡∏£‡πâ‡∏≤‡∏á Spreadsheet ‡πÉ‡∏´‡∏°‡πà: ' + newSpreadsheet.getName());
    return newSpreadsheet;
  }
}

/**
 * ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡∏£‡∏∑‡∏≠‡∏´‡∏≤ Sheet ‡πÉ‡∏ô Spreadsheet
 */
function getOrCreateSheet(spreadsheet, sheetName) {
  var sheet = spreadsheet.getSheetByName(sheetName);
  
  if (sheet) {
    return sheet;
  } else {
    return spreadsheet.insertSheet(sheetName);
  }
}

/**
 * ‡∏ó‡∏≥‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∞‡∏≠‡∏≤‡∏î‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå (‡∏•‡∏ö‡∏≠‡∏±‡∏Å‡∏Ç‡∏£‡∏∞‡∏û‡∏¥‡πÄ‡∏®‡∏©)
 */
function sanitizeFileName(fileName) {
  return fileName.replace(/[\/\\?%*:|"<>]/g, '_')
                 .replace(/\s+/g, '_')
                 .substring(0, 50); // ‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏ß
}

/**
 * ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ó‡∏î‡∏™‡∏≠‡∏ö - ‡∏î‡∏∂‡∏á‡∏Å‡∏≤‡∏£‡πå‡∏î 1 ‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏•‡∏∞‡πÄ‡∏ã‡∏ü‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö)
 * ‡∏î‡∏∂‡∏á‡πÅ‡∏Ñ‡πà 1 ‡∏´‡∏ô‡πâ‡∏≤ (50 ‡∏Å‡∏≤‡∏£‡πå‡∏î) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏•‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
 */
function testScrapingAndSave() {
  try {
    Logger.log('üß™ ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡∏∞‡πÄ‡∏ã‡∏ü‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...');
    
    // ‡∏™‡∏£‡πâ‡∏≤‡∏á/‡∏´‡∏≤‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÉ‡∏ô Drive
    var folder = getOrCreateDriveFolder(CONFIG.DRIVE_FOLDER_NAME_OR_ID);
    Logger.log('üìÅ ‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå: ' + folder.getUrl());
    Logger.log('üìÅ ‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå ID: ' + folder.getId());
    
    // ‡∏™‡∏£‡πâ‡∏≤‡∏á/‡∏´‡∏≤ Spreadsheet
    var spreadsheet = getOrCreateSpreadsheet(CONFIG.SPREADSHEET_NAME_OR_ID);
    Logger.log('üìä Spreadsheet: ' + spreadsheet.getUrl());
    Logger.log('üìä Spreadsheet ID: ' + spreadsheet.getId());
    var sheet = getOrCreateSheet(spreadsheet, 'Cards');
    
    // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ header ‡∏Ç‡∏≠‡∏á Spreadsheet
    setupSpreadsheetHeaders(sheet);
    
    // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πå‡∏î 1 ‡∏´‡∏ô‡πâ‡∏≤
    Logger.log('üìÑ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏´‡∏ô‡πâ‡∏≤ 1...');
    var cards = fetchCardsFromPage(1);
    Logger.log('‡∏û‡∏ö‡∏Å‡∏≤‡∏£‡πå‡∏î: ' + cards.length + ' ‡πÉ‡∏ö');
    
    if (cards.length === 0) {
      Logger.log('‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Å‡∏≤‡∏£‡πå‡∏î');
      return;
    }
    
    // ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÅ‡∏•‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡πÅ‡∏Ñ‡πà 5 ‡∏Å‡∏≤‡∏£‡πå‡∏î‡πÅ‡∏£‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ó‡∏î‡∏™‡∏≠‡∏ö)
    var testCount = Math.min(5, cards.length);
    Logger.log('üì• ‡∏à‡∏∞‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î ' + testCount + ' ‡∏Å‡∏≤‡∏£‡πå‡∏î‡πÅ‡∏£‡∏Å...');
    
    var successCount = 0;
    var errorCount = 0;
    
    for (var i = 0; i < testCount; i++) {
      var card = cards[i];
      
      try {
        Logger.log('üì• ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î: ' + card.name + ' (' + (i + 1) + '/' + testCount + ')');
        
        // ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û
        var imageFile = downloadCardImage(card, folder);
        
        // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏á Spreadsheet
        saveCardToSpreadsheet(sheet, card, imageFile);
        
        successCount++;
        Logger.log('   ‚úÖ ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + card.name);
        
        // Delay ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏´‡∏•‡∏µ‡∏Å‡πÄ‡∏•‡∏µ‡πà‡∏¢‡∏á rate limiting
        Utilities.sleep(CONFIG.REQUEST_DELAY);
        
      } catch (error) {
        Logger.log('   ‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏Å‡∏±‡∏ö: ' + card.name + ' - ' + error.toString());
        errorCount++;
        
        // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏°‡πâ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û
        try {
          saveCardToSpreadsheet(sheet, card, null);
        } catch (e) {
          Logger.log('   ‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: ' + e.toString());
        }
      }
    }
    
    var summary = '‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô!\n\n' +
      '‡∏ó‡∏î‡∏™‡∏≠‡∏ö: ' + testCount + ' ‡∏Å‡∏≤‡∏£‡πå‡∏î\n' +
      '‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + successCount + ' ‡∏Å‡∏≤‡∏£‡πå‡∏î\n' +
      '‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + errorCount + ' ‡∏Å‡∏≤‡∏£‡πå‡∏î\n\n' +
      'Spreadsheet: ' + spreadsheet.getUrl() + '\n' +
      'Drive Folder: ' + folder.getUrl();
    
    Logger.log('‚úÖ ' + summary);
    
    try {
      SpreadsheetApp.getUi().alert(summary);
    } catch (e) {
      Logger.log('üí° ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Logs ‡πÅ‡∏•‡∏∞‡∏î‡∏π Spreadsheet/Drive ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå');
    }
    
  } catch (error) {
    Logger.log('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.toString());
    try {
      SpreadsheetApp.getUi().alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.toString());
    } catch (e) {
      Logger.log('üí° ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Logs ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π error details');
    }
  }
}

/**
 * ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ó‡∏î‡∏™‡∏≠‡∏ö - ‡∏î‡∏∂‡∏á‡∏Å‡∏≤‡∏£‡πå‡∏î 1 ‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ó‡∏î‡∏™‡∏≠‡∏ö (‡πÑ‡∏°‡πà‡πÄ‡∏ã‡∏ü‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•)
 */
function testScraping() {
  try {
    Logger.log('üß™ ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...');
    
    var cards = fetchCardsFromPage(1);
    Logger.log('‡∏û‡∏ö‡∏Å‡∏≤‡∏£‡πå‡∏î: ' + cards.length + ' ‡πÉ‡∏ö');
    
    if (cards.length > 0) {
      Logger.log('‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πå‡∏î‡πÅ‡∏£‡∏Å:');
      Logger.log(JSON.stringify(cards[0], null, 2));
    }
    
    var successMessage = '‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏û‡∏ö‡∏Å‡∏≤‡∏£‡πå‡∏î ' + cards.length + ' ‡πÉ‡∏ö\n\n‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Logs ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î';
    Logger.log('‚úÖ ' + successMessage);
    
    // ‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡πÅ‡∏™‡∏î‡∏á alert ‡∏ñ‡πâ‡∏≤‡∏£‡∏±‡∏ô‡∏à‡∏≤‡∏Å Spreadsheet UI
    try {
      SpreadsheetApp.getUi().alert(successMessage);
    } catch (e) {
      // ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÉ‡∏ä‡πâ getUi() ‡πÑ‡∏î‡πâ (‡∏£‡∏±‡∏ô‡∏à‡∏≤‡∏Å Apps Script editor)
      Logger.log('üí° ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Logs ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå');
    }
    
  } catch (error) {
    Logger.log('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.toString());
    try {
      SpreadsheetApp.getUi().alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.toString());
    } catch (e) {
      // ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÉ‡∏ä‡πâ getUi() ‡πÑ‡∏î‡πâ
      Logger.log('üí° ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Logs ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π error details');
    }
  }
}

/**
 * ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏ï‡∏≤‡∏°‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö)
 */
function doGet(e) {
  try {
    var action = e.parameter.action || 'search';
    
    if (action === 'search') {
      var cardName = e.parameter.cardName || '';
      var cardSet = e.parameter.cardSet || '';
      var page = parseInt(e.parameter.page || '1');
      
      // Parse filters
      var filters = {
        supertype: e.parameter.supertype || '',
        subtype: e.parameter.subtype || '',
        type: e.parameter.type || '',
        rarity: e.parameter.rarity || '',
        tag: e.parameter.tag || '',
        regulation: e.parameter.regulation || ''
      };
      
      var result = searchCardsFromDatabase(cardName, cardSet, page, filters);
      return ContentService.createTextOutput(JSON.stringify(result))
        .setMimeType(ContentService.MimeType.JSON);
    }
    
    if (action === 'getAll') {
      var page = parseInt(e.parameter.page || '1');
      var pageSize = parseInt(e.parameter.pageSize || '50');
      
      var result = getAllCardsFromDatabase(page, pageSize);
      return ContentService.createTextOutput(JSON.stringify(result))
        .setMimeType(ContentService.MimeType.JSON);
    }
    
    return ContentService.createTextOutput(JSON.stringify({
      success: false,
      error: 'Invalid action'
    })).setMimeType(ContentService.MimeType.JSON);
    
  } catch (error) {
    return ContentService.createTextOutput(JSON.stringify({
      success: false,
      error: error.toString()
    })).setMimeType(ContentService.MimeType.JSON);
  }
}

/**
 * ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏à‡∏≤‡∏Å‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
 */
function searchCardsFromDatabase(cardName, cardSet, page) {
  try {
    var spreadsheet = getOrCreateSpreadsheet(CONFIG.SPREADSHEET_NAME_OR_ID);
    var sheet = spreadsheet.getSheetByName('Cards');
    
    if (!sheet) {
      return {
        success: false,
        error: 'Database not found. Please run startScrapingAllCards() first.'
      };
    }
    
    var data = sheet.getDataRange().getValues();
    if (data.length <= 1) {
      return {
        success: true,
        cards: [],
        total: 0,
        page: page,
        totalPages: 0
      };
    }
    
    var headers = data[0];
    var cards = [];
    
    for (var i = 1; i < data.length; i++) {
      var row = data[i];
      var name = String(row[1] || '').toLowerCase();
      var setName = String(row[2] || '').toLowerCase();
      
      var matches = true;
      
      if (cardName && name.indexOf(cardName.toLowerCase()) === -1) {
        matches = false;
      }
      
      if (cardSet && setName.indexOf(cardSet.toLowerCase()) === -1) {
        matches = false;
      }
      
      if (matches) {
        cards.push({
          id: row[0] || '',
          name: row[1] || '',
          setName: row[2] || '',
          setCode: row[3] || '',
          number: row[4] || '',
          rarity: row[5] || '',
          types: row[6] || '',
          supertype: row[7] || '',
          subtypes: row[8] || '',
          hp: row[9] || '',
          retreatCost: row[10] || '',
          attacksText: row[11] || '',
          abilitiesText: row[12] || '',
          text: row[13] || '',
          searchableText: row[14] || '',
          tags: row[15] || '',
          imageUrl: row[16] || row[18] || '',
          imageFileName: row[17] || '',
          originalImageUrl: row[18] || ''
        });
      }
    }
    
    // Pagination
    var pageSize = CONFIG.CARDS_PER_PAGE;
    var total = cards.length;
    var totalPages = Math.ceil(total / pageSize);
    var startIndex = (page - 1) * pageSize;
    var endIndex = startIndex + pageSize;
    var paginatedCards = cards.slice(startIndex, endIndex);
    
    return {
      success: true,
      cards: paginatedCards,
      total: total,
      page: page,
      totalPages: totalPages
    };
    
  } catch (error) {
    return {
      success: false,
      error: error.toString()
    };
  }
}

/**
 * ‡∏î‡∏∂‡∏á‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏à‡∏≤‡∏Å‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡∏û‡∏£‡πâ‡∏≠‡∏° pagination)
 */
function getAllCardsFromDatabase(page, pageSize) {
  try {
    var spreadsheet = getOrCreateSpreadsheet(CONFIG.SPREADSHEET_NAME_OR_ID);
    var sheet = spreadsheet.getSheetByName('Cards');
    
    if (!sheet) {
      return {
        success: false,
        error: 'Database not found. Please run startScrapingAllCards() first.'
      };
    }
    
    var data = sheet.getDataRange().getValues();
    if (data.length <= 1) {
      return {
        success: true,
        cards: [],
        total: 0,
        page: page,
        totalPages: 0
      };
    }
    
    var headers = data[0];
    var cards = [];
    
    for (var i = 1; i < data.length; i++) {
      var row = data[i];
      cards.push({
        id: row[0] || '',
        name: row[1] || '',
        setName: row[2] || '',
        setCode: row[3] || '',
        number: row[4] || '',
        rarity: row[5] || '',
        types: row[6] || '',
        supertype: row[7] || '',
        subtypes: row[8] || '',
        hp: row[9] || '',
        retreatCost: row[10] || '',
        attacksText: row[11] || '',
        abilitiesText: row[12] || '',
        text: row[13] || '',
        searchableText: row[14] || '',
        tags: row[15] || '',
        imageUrl: row[16] || row[18] || '',
        imageFileName: row[17] || '',
        originalImageUrl: row[18] || ''
      });
    }
    
    // Pagination
    var total = cards.length;
    var totalPages = Math.ceil(total / pageSize);
    var startIndex = (page - 1) * pageSize;
    var endIndex = startIndex + pageSize;
    var paginatedCards = cards.slice(startIndex, endIndex);
    
    return {
      success: true,
      cards: paginatedCards,
      total: total,
      page: page,
      totalPages: totalPages
    };
    
  } catch (error) {
    return {
      success: false,
      error: error.toString()
    };
  }
}

