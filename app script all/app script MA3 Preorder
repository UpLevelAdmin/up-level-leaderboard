/**
 * Google Apps Script ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏∞‡∏ö‡∏ö‡∏û‡∏£‡∏µ‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå MA3 ‡πÅ‡∏•‡∏∞‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô Midnight Party
 * 
 * ‚ö†Ô∏è ‡∏ß‡∏¥‡∏ò‡∏µ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤:
 * 1. ‡πÑ‡∏õ‡∏ó‡∏µ‡πà Google Sheet: https://docs.google.com/spreadsheets/d/1wi2OXnelj5D61E8Jv6wBN0RwCRbsQlgiWXnfGxrjlww/edit
 * 2. ‡∏Ñ‡∏•‡∏¥‡∏Å Extensions > Apps Script
 * 3. Copy ‡πÇ‡∏Ñ‡πâ‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏ô‡∏µ‡πâ‡πÑ‡∏õ‡∏ß‡∏≤‡∏á‡πÉ‡∏ô Apps Script Editor
 * 4. ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Trigger: ‡∏Ñ‡∏•‡∏¥‡∏Å Triggers (‡∏ô‡∏≤‡∏¨‡∏¥‡∏Å‡∏≤) > Add Trigger
 *    - Choose which function to run: onFormSubmit
 *    - Select event source: From spreadsheet
 *    - Select event type: On form submit
 * 5. Deploy ‡πÄ‡∏õ‡πá‡∏ô Web App:
 *    - ‡∏Ñ‡∏•‡∏¥‡∏Å Deploy > New deployment
 *    - Type: Web app
 *    - Execute as: Me
 *    - Who has access: Anyone
 *    - ‡∏Ñ‡∏•‡∏¥‡∏Å Deploy ‡πÅ‡∏•‡∏∞ Copy URL ‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ
 * 6. ‡∏ô‡∏≥ URL ‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡πÑ‡∏õ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå ma3-preorder.html (‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î apiUrl)
 * 
 * Sheet Structure (Sheet1):
 * - Column A: Timestamp (‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏∞‡∏ó‡∏±‡∏ö)
 * - Column B: ‡∏ä‡∏∑‡πà‡∏≠ - ‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•
 * - Column C: ‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô
 * - Column D: ‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£
 * - Column E: ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô (raw data)
 * - Column G: ‡∏°‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏á‡∏≤‡∏ô‡πÑ‡∏´‡∏° (‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô "‡∏°‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏á‡∏≤‡∏ô" = ‡∏°‡∏≤‡πÑ‡∏î‡πâ, ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà = ‡πÑ‡∏°‡πà‡∏°‡∏≤)
 * - Column J: ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô box (‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß)
 */

// ===== ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô Telegram =====

// ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏´‡∏•‡πà‡∏≤‡∏ô‡∏µ‡πâ
const BOT_TOKEN = "8284717743:AAGfu8Z-r6SI_TeAslai9vA600nNagjzH5k";
const CHAT_ID = "-4911555842"; // Group Chat ID

const TELEGRAM_API_URL = `https://api.telegram.org/bot${BOT_TOKEN}`;

// ===== ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πå‡∏î‡πÇ‡∏õ‡∏£‡πÇ‡∏° =====
const PROMO_CARDS = [
  {
    number: "047",
    imageUrl: "https://asia.pokemon-card.com/th/wp-content/uploads/sites/4/2025/11/th_news_MPromo_047.png"
  },
  {
    number: "048",
    imageUrl: "https://asia.pokemon-card.com/th/wp-content/uploads/sites/4/2025/11/th_news_MPromo_048.png"
  },
  {
    number: "049",
    imageUrl: "https://asia.pokemon-card.com/th/wp-content/uploads/sites/4/2025/11/th_news_MPromo_049.png"
  },
  {
    number: "050",
    imageUrl: "https://asia.pokemon-card.com/th/wp-content/uploads/sites/4/2025/11/th_news_MPromo_050.png"
  }
];

/**
 * ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏à‡∏≥‡∏ô‡∏ß‡∏ô promo card packs ‡∏à‡∏≤‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô Box
 * ‡∏ã‡∏∑‡πâ‡∏≠ 2 Box = 1 Promo Card Pack
 */
function calculatePromoPacks(boxes) {
  if (!boxes || boxes < 2) return 0;
  return Math.floor(boxes / 2);
}

/**
 * ‡∏™‡∏∏‡πà‡∏°‡∏Å‡∏≤‡∏£‡πå‡∏î‡πÇ‡∏õ‡∏£‡πÇ‡∏° 1 ‡πÉ‡∏ö‡∏à‡∏≤‡∏Å 4 ‡πÅ‡∏ö‡∏ö
 * ‡πÉ‡∏ä‡πâ phone + timestamp ‡πÄ‡∏õ‡πá‡∏ô seed ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏Ñ‡∏á‡∏ó‡∏µ‡πà‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏Ñ‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô
 */
function getRandomPromoCard(phone, timestamp) {
  // ‡∏™‡∏£‡πâ‡∏≤‡∏á seed ‡∏à‡∏≤‡∏Å phone ‡πÅ‡∏•‡∏∞ timestamp
  var seed = 0;
  if (phone) {
    for (var i = 0; i < phone.length; i++) {
      seed += phone.charCodeAt(i);
    }
  }
  if (timestamp) {
    seed += new Date(timestamp).getTime();
  }
  
  // ‡πÉ‡∏ä‡πâ seed ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏∏‡πà‡∏°‡∏Å‡∏≤‡∏£‡πå‡∏î
  var random = seed % PROMO_CARDS.length;
  return PROMO_CARDS[random];
}

/**
 * ‡πÅ‡∏õ‡∏•‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Box/Carton ‡∏à‡∏≤‡∏Å string ‡πÄ‡∏õ‡πá‡∏ô‡∏à‡∏≥‡∏ô‡∏ß‡∏ô Box (‡∏£‡∏ß‡∏° carton ‡∏ó‡∏µ‡πà‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô box ‡πÅ‡∏•‡πâ‡∏ß)
 * ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ï‡πà‡∏≤‡∏á‡πÜ ‡πÄ‡∏ä‡πà‡∏ô:
 * - "4 boxes", "1 BOX", "2 BOX"
 * - "5 ‡∏ö‡πá‡∏≠‡∏Ñ", "1 ‡∏ï‡∏±‡πâ‡∏ô" (‡∏ï‡∏±‡πâ‡∏ô = carton = 20 boxes)
 * - "1 BOX (1,550 ‡∏ö‡∏≤‡∏ó)"
 * - "1 C/" (C = Carton)
 */
function parseBoxQuantity(boxData) {
  if (!boxData) return 0;
  
  if (typeof boxData === 'number') {
    return boxData;
  }
  
  if (typeof boxData === 'string') {
    var totalBoxes = 0;
    var text = boxData.trim();
    
    // ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏Ñ‡∏≤‡∏≠‡∏≠‡∏Å (‡πÄ‡∏ä‡πà‡∏ô "(1,550 ‡∏ö‡∏≤‡∏ó)")
    text = text.replace(/\([^)]*\)/g, '');
    
    // ‡πÅ‡∏õ‡∏•‡∏á carton (‡∏ï‡∏±‡πâ‡∏ô, C, Carton) ‡πÄ‡∏õ‡πá‡∏ô boxes (1 carton = 20 boxes)
    // ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö: "1 ‡∏ï‡∏±‡πâ‡∏ô", "1 C", "1 Carton", "1 C/", "1 carton"
    var cartonPatterns = [
      /(\d+)\s*(?:‡∏ï‡∏±‡πâ‡∏ô|‡∏ï‡∏±‡∏ô|carton|Carton|CARTON|C\/|C\b)/gi,
      /(\d+)\s*(?:‡∏Ñ‡∏≤‡∏ï‡∏±‡πâ‡∏ô|‡∏Ñ‡∏≤‡∏ï‡∏±‡∏ô)/gi
    ];
    
    for (var i = 0; i < cartonPatterns.length; i++) {
      var cartonMatch = text.match(cartonPatterns[i]);
      if (cartonMatch) {
        var cartonCount = parseInt(cartonMatch[1]) || 0;
        totalBoxes += cartonCount * 20; // 1 carton = 20 boxes
        // ‡∏•‡∏ö‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà match ‡∏≠‡∏≠‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏ô‡∏±‡∏ö‡∏ã‡πâ‡∏≥
        text = text.replace(cartonPatterns[i], '');
      }
    }
    
    // ‡∏´‡∏≤‡∏à‡∏≥‡∏ô‡∏ß‡∏ô Box ‡∏à‡∏≤‡∏Å‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ï‡πà‡∏≤‡∏á‡πÜ
    // ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö: "4 boxes", "1 BOX", "2 Box", "5 ‡∏ö‡πá‡∏≠‡∏Ñ", "3 ‡∏ö‡πá‡∏≠‡∏Å", "2 ‡∏Å‡∏•‡πà‡∏≠‡∏á"
    var boxPatterns = [
      /(\d+)\s*(?:BOX|Box|box|boxes|BOXES)/gi,
      /(\d+)\s*(?:‡∏ö‡πá‡∏≠‡∏Ñ|‡∏ö‡πá‡∏≠‡∏Å|‡∏ö‡πá‡∏≠‡∏Å‡∏ã‡πå|‡∏Å‡∏•‡πà‡∏≠‡∏á)/gi
    ];
    
    for (var j = 0; j < boxPatterns.length; j++) {
      var boxMatch = text.match(boxPatterns[j]);
      if (boxMatch) {
        var boxCount = parseInt(boxMatch[1]) || 0;
        totalBoxes += boxCount;
        // ‡∏•‡∏ö‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà match ‡∏≠‡∏≠‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏ô‡∏±‡∏ö‡∏ã‡πâ‡∏≥
        text = text.replace(boxPatterns[j], '');
      }
    }
    
    // ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà match ‡∏•‡∏≠‡∏á‡∏´‡∏≤‡πÅ‡∏Ñ‡πà‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÄ‡∏î‡∏µ‡∏¢‡∏ß (‡∏≠‡∏≤‡∏à‡πÄ‡∏õ‡πá‡∏ô box)
    if (totalBoxes === 0) {
      var numMatch = text.match(/(\d+)/);
      if (numMatch) {
        totalBoxes = parseInt(numMatch[1]) || 0;
      }
    }
    
    return totalBoxes;
  }
  
  return 0;
}

/**
 * ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°
 */
function onFormSubmit(e) {
  try {
    // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏ü‡∏≠‡∏£‡πå‡∏°
    const responses = e.values;
    const timestamp = responses[0] || new Date().toLocaleString('th-TH');
    
    // Column B: ‡∏ä‡∏∑‡πà‡∏≠ - ‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•
    const fullName = responses[1] || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠';
    
    // Column C: ‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô
    const nickname = responses[2] || responses[1] || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠';
    
    // Column D: ‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠
    const phone = responses[3] || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£';
    
    // Column E: ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠
    const quantity = responses[4] || '0';
    
    // Column G: ‡∏°‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏á‡∏≤‡∏ô Midnight Party ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
    const attendingParty = responses[6] || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
    
    // ‡∏ô‡∏±‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠
    const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName("Form Responses 1");
    let totalCount = 0;
    
    if (sheet) {
      try {
        const data = sheet.getDataRange().getValues();
        totalCount = data.length - 1; // ‡∏•‡∏ö header row
      } catch (countError) {
        console.warn('Warning: Could not count total participants:', countError);
      }
    }
    
    // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
    const message = `üéâ *‡∏°‡∏µ‡∏Ñ‡∏ô‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠ MA3 ‡πÅ‡∏•‡∏∞‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô Midnight Party ‡πÉ‡∏´‡∏°‡πà!*

üë§ *‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô:* ${nickname}
üì± *‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£:* ${phone}
üì¶ *‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠:* ${quantity}
üéâ *‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏á‡∏≤‡∏ô:* ${attendingParty}
‚è∞ *‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠:* ${timestamp}

üìä *‡∏£‡∏ß‡∏°‡∏ú‡∏π‡πâ‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠: ${totalCount} ‡∏Ñ‡∏ô*

---
üìä [‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î](https://uplevelguild.netlify.app/ma3-preorder)`;
    
    // ‡∏™‡πà‡∏á‡πÑ‡∏õ‡∏¢‡∏±‡∏á Telegram
    const payload = {
      chat_id: CHAT_ID,
      text: message,
      parse_mode: "Markdown",
      disable_web_page_preview: true
    };
    
    const response = UrlFetchApp.fetch(`${TELEGRAM_API_URL}/sendMessage`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      payload: JSON.stringify(payload)
    });
    
    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö response
    if (response.getResponseCode() === 200) {
      console.log("‚úÖ ‡∏™‡πà‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô MA3 Pre-order ‡πÑ‡∏õ‡∏¢‡∏±‡∏á Telegram ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
    } else {
      console.warn("‚ö†Ô∏è Telegram API response:", response.getResponseCode(), response.getContentText());
    }
    
  } catch (error) {
    console.error("‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô Telegram:", error);
    console.error("‚ùå Error details:", error.toString());
    // ‡πÑ‡∏°‡πà throw error ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏Å‡∏£‡∏∞‡∏ó‡∏ö‡∏Å‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô Google Sheet
  }
}

/**
 * ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡πÑ‡∏õ‡∏¢‡∏±‡∏á Telegram
 */
function testTelegramNotification() {
  const testData = {
    values: [
      new Date().toLocaleString('th-TH'),
      "‡∏ú‡∏π‡πâ‡∏ó‡∏î‡∏™‡∏≠‡∏ö MA3",
      "‡∏ó‡∏î‡∏™‡∏≠‡∏ö",
      "0812345678",
      "2 BOX",
      "",
      "‡πÉ‡∏ä‡πà"
    ]
  };
  
  onFormSubmit(testData);
  console.log("üß™ ‡∏™‡πà‡∏á‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö MA3 Pre-order ‡πÑ‡∏õ‡∏¢‡∏±‡∏á Telegram ‡πÅ‡∏•‡πâ‡∏ß");
}

function doGet(e) {
  try {
    // Debug logging (‡∏õ‡∏¥‡∏î‡πÉ‡∏ô production ‡∏´‡∏£‡∏∑‡∏≠‡πÉ‡∏ä‡πâ‡πÉ‡∏´‡πâ‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°)
    var isDebug = e && e.parameter && e.parameter.debug === 'true';
    var isJson = e && e.parameter && e.parameter.type === 'json';
    
    if (isDebug) console.log('doGet function called');
    
    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ spreadsheet ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
    var spreadsheet = SpreadsheetApp.getActiveSpreadsheet();
    
    // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏û‡∏ö (‡∏Å‡∏£‡∏ì‡∏µ Standalone Script) ‡πÉ‡∏´‡πâ‡∏•‡∏≠‡∏á‡πÄ‡∏õ‡∏¥‡∏î‡∏î‡πâ‡∏ß‡∏¢ ID
    if (!spreadsheet) {
      try {
        // ID ‡∏à‡∏≤‡∏Å URL: https://docs.google.com/spreadsheets/d/1wi2OXnelj5D61E8Jv6wBN0RwCRbsQlgiWXnfGxrjlww/edit
        spreadsheet = SpreadsheetApp.openById("1wi2OXnelj5D61E8Jv6wBN0RwCRbsQlgiWXnfGxrjlww");
      } catch (e) {
        console.error("Could not open spreadsheet by ID:", e);
      }
    }

    if (!spreadsheet) {
      if (isDebug) console.log('No active spreadsheet found');
      if (isJson) {
        return ContentService.createTextOutput(JSON.stringify({ 
          participants: [],
          error: "No active spreadsheet found"
        })).setMimeType(ContentService.MimeType.JSON);
      }
      return createResponse({ 
        participants: [],
        error: "No active spreadsheet found"
      });
    }
    
    if (isDebug) {
      console.log('Spreadsheet ID:', spreadsheet.getId());
      console.log('Spreadsheet name:', spreadsheet.getName());
    }
    
    // ‡∏•‡∏≠‡∏á‡∏´‡∏≤ sheet ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà
    var sheets = spreadsheet.getSheets();
    if (isDebug) console.log('Available sheets:', sheets.map(s => s.getName()));
    
    // ‡∏•‡∏≠‡∏á‡∏´‡∏≤ sheet ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• - ‡∏≠‡πà‡∏≤‡∏ô‡∏à‡∏≤‡∏Å Sheet1 ‡∏Å‡πà‡∏≠‡∏ô
    var targetSheet = null;
    var sheetNames = ['Sheet1', 'Form Responses 1', 'Form Responses', 'Responses'];
    
    for (var i = 0; i < sheetNames.length; i++) {
      var sheet = spreadsheet.getSheetByName(sheetNames[i]);
      if (sheet) {
        targetSheet = sheet;
        if (isDebug) console.log('Found sheet:', sheetNames[i]);
        break;
      }
    }
    
    if (!targetSheet) {
      if (isDebug) console.log('No suitable sheet found');
      if (isJson) {
        return ContentService.createTextOutput(JSON.stringify({ 
          participants: [],
          error: "No suitable sheet found. Available sheets: " + sheets.map(s => s.getName()).join(', ')
        })).setMimeType(ContentService.MimeType.JSON);
      }
      return createResponse({ 
        participants: [],
        error: "No suitable sheet found. Available sheets: " + sheets.map(s => s.getName()).join(', ')
      });
    }
    
    var data = targetSheet.getDataRange().getValues();
    if (isDebug) console.log('Data rows found:', data.length);
    
    if (data.length <= 1) {
      if (isDebug) console.log('No data rows found');
      if (isJson) {
        return ContentService.createTextOutput(JSON.stringify({ 
          participants: [],
          error: "No data rows found in sheet: " + targetSheet.getName()
        })).setMimeType(ContentService.MimeType.JSON);
      }
      return createResponse({ 
        participants: [],
        error: "No data rows found in sheet: " + targetSheet.getName()
      });
    }
    
    var headers = data[0];
    if (isDebug) console.log('Headers count:', headers.length);
    
    var participants = [];
    
    // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ö midnight-party script
    for (var i = 1; i < data.length; i++) {
      var row = data[i];
      var participant = {};
      
      // ‡∏™‡∏£‡πâ‡∏≤‡∏á object ‡πÇ‡∏î‡∏¢‡πÉ‡∏ä‡πâ‡∏ä‡∏∑‡πà‡∏≠ column ‡πÄ‡∏õ‡πá‡∏ô key
      for (var j = 0; j < headers.length; j++) {
        var header = headers[j];
        var value = row[j];
        
        // ‡πÅ‡∏õ‡∏•‡∏á‡∏Ñ‡πà‡∏≤ null/undefined ‡πÄ‡∏õ‡πá‡∏ô string ‡∏ß‡πà‡∏≤‡∏á
        participant[header] = (value === null || value === undefined) ? '' : value;
      }
      
      // ‡πÉ‡∏ä‡πâ Column J (‡∏à‡∏≥‡∏ô‡∏ß‡∏ô box) ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á - ‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß
      // Column J = index 9 (0-based: A=0, B=1, C=2, D=3, E=4, F=5, G=6, H=7, I=8, J=9)
      var boxes = 0;
      var boxColumnJ = null;
      
      // ‡∏•‡∏≠‡∏á‡∏´‡∏≤ Column J ‡πÇ‡∏î‡∏¢‡πÉ‡∏ä‡πâ index ‡∏Å‡πà‡∏≠‡∏ô (Column J = index 9)
      if (row.length > 9) {
        boxColumnJ = row[9];
      }
      
      // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏´‡πâ‡∏•‡∏≠‡∏á‡∏´‡∏≤‡πÇ‡∏î‡∏¢‡∏ä‡∏∑‡πà‡∏≠ column ‡∏à‡∏≤‡∏Å header
      if (boxColumnJ === null || boxColumnJ === undefined || boxColumnJ === '') {
        boxColumnJ = participant['‡∏à‡∏≥‡∏ô‡∏ß‡∏ô box'] || participant['‡∏à‡∏≥‡∏ô‡∏ß‡∏ô Box'] || participant['‡∏à‡∏≥‡∏ô‡∏ß‡∏ô box '] || '';
      }
      
      // ‡∏ñ‡πâ‡∏≤ Column J ‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡πÄ‡∏•‡∏¢
      if (typeof boxColumnJ === 'number') {
        boxes = boxColumnJ;
      } else if (boxColumnJ !== null && boxColumnJ !== undefined && boxColumnJ !== '') {
        // ‡∏•‡∏≠‡∏á‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç
        if (typeof boxColumnJ === 'string') {
          var numValue = parseFloat(boxColumnJ.toString().trim());
          if (!isNaN(numValue) && isFinite(numValue)) {
            boxes = numValue;
          } else {
            // ‡∏ñ‡πâ‡∏≤‡πÅ‡∏õ‡∏•‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÉ‡∏´‡πâ‡∏•‡∏≠‡∏á parse ‡∏à‡∏≤‡∏Å Column E (backup)
            var boxData = participant['‡∏à‡∏≥‡∏ô‡∏ß‡∏ô'] || 
                         participant['‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠ (1 BOX = 1,550 ‡∏ö‡∏≤‡∏ó, 1 C/)'] || 
                         participant['‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠'] || '';
            boxes = parseBoxQuantity(boxData);
          }
        }
      } else {
        // ‡∏ñ‡πâ‡∏≤ Column J ‡∏ß‡πà‡∏≤‡∏á‡πÉ‡∏´‡πâ‡∏•‡∏≠‡∏á parse ‡∏à‡∏≤‡∏Å Column E (backup)
        var boxData = participant['‡∏à‡∏≥‡∏ô‡∏ß‡∏ô'] || 
                     participant['‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠ (1 BOX = 1,550 ‡∏ö‡∏≤‡∏ó, 1 C/)'] || 
                     participant['‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠'] || '';
        boxes = parseBoxQuantity(boxData);
      }
      
      var promoPacks = calculatePromoPacks(boxes);
      
      // ‡∏™‡∏∏‡πà‡∏°‡∏Å‡∏≤‡∏£‡πå‡∏î‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏•‡∏∞ pack
      participant.boxes = boxes;
      participant.promoPacks = promoPacks;
      participant.promoCards = [];
      
      if (promoPacks > 0) {
        var phone = participant['‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠ (0xx-xxx-xxxx)'] || 
                   participant['‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠'] || 
                   participant['‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£'] || '';
        var timestamp = participant['Timestamp'] || participant['Timestamp'] || row[0] || '';
        
        // ‡∏™‡∏∏‡πà‡∏°‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏•‡∏∞ pack (‡πÉ‡∏ä‡πâ phone + pack index ‡πÄ‡∏õ‡πá‡∏ô seed)
        for (var p = 0; p < promoPacks; p++) {
          var card = getRandomPromoCard(phone + '_' + p, timestamp);
          participant.promoCards.push(card);
        }
      }
      
      participants.push(participant);
      
      // Log ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏£‡∏Å‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô ‡πÄ‡∏û‡∏∑‡πà‡∏≠ debug
      if (isDebug && i === 1) {
        console.log('First participant sample:', participant);
      }
    }
    
    var result = {
      participants: participants,
      debug: isDebug ? {
        sheetName: targetSheet.getName(),
        headers: headers,
        message: "Data loaded successfully from sheet",
        totalRows: data.length,
        totalParticipants: participants.length
      } : undefined
    };
    
    if (isDebug) console.log('Final result - participants count:', participants.length);
    
    // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ type=json ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ ContentService ‡∏ï‡∏£‡∏á‡πÜ
    var isJson = e && e.parameter && e.parameter.type === 'json';
    if (isJson) {
      return ContentService.createTextOutput(JSON.stringify(result))
        .setMimeType(ContentService.MimeType.JSON);
    }
    
    return createResponse(result);
    
  } catch (error) {
    console.error('Error in doGet:', error);
    var isJson = e && e.parameter && e.parameter.type === 'json';
    if (isJson) {
      return ContentService.createTextOutput(JSON.stringify({
        participants: [],
        error: error.toString(),
        stack: error.stack || '',
        debug: {
          message: "Error occurred while processing data",
          timestamp: new Date().toISOString()
        }
      })).setMimeType(ContentService.MimeType.JSON);
    }
    return createResponse({
      participants: [],
      error: error.toString(),
      stack: error.stack || '',
      debug: {
        message: "Error occurred while processing data",
        timestamp: new Date().toISOString()
      }
    });
  }
}

function createResponse(data) {
  var response = ContentService.createTextOutput(JSON.stringify(data));
  response.setMimeType(ContentService.MimeType.JSON);
  
  // ‡πÄ‡∏û‡∏¥‡πà‡∏° CORS headers ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏Å‡πâ‡∏õ‡∏±‡∏ç‡∏´‡∏≤ CORS error
  // Google Apps Script ‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ headers ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á
  // ‡πÅ‡∏ï‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÉ‡∏ä‡πâ‡∏ß‡∏¥‡∏ò‡∏µ‡∏ô‡∏µ‡πâ‡πÑ‡∏î‡πâ‡πÉ‡∏ô‡∏ö‡∏≤‡∏á‡∏Å‡∏£‡∏ì‡∏µ
  return response;
}

function doPost(e) {
  // POST request ‡∏Ñ‡∏ß‡∏£‡∏à‡∏∞‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô GET ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö API ‡∏ô‡∏µ‡πâ
  // ‡πÅ‡∏ï‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÉ‡∏ä‡πâ e.postData ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å POST body ‡πÑ‡∏î‡πâ
  return doGet(e);
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ó‡∏î‡∏™‡∏≠‡∏ö
function testFunction() {
  console.log('Test function called');
  return 'Test successful';
}
