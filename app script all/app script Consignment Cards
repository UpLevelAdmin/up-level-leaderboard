function doGet(e) {
  try {
    var isJson = e && e.parameter && e.parameter.type === 'json';
    
    var spreadsheetId = '1JvVCVxxXBS-2lpnT-IOrYBf2rF-OBRVFCW6MZEvpqxE';
    var spreadsheet;
    
    try {
      spreadsheet = SpreadsheetApp.openById(spreadsheetId);
    } catch (err) {
      if (isJson) {
        return ContentService.createTextOutput(JSON.stringify({
          error: "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏õ‡∏¥‡∏î Google Sheet ‡πÑ‡∏î‡πâ: " + err.toString(),
          cards: []
        })).setMimeType(ContentService.MimeType.JSON);
      }
      return HtmlService.createHtmlOutput("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏õ‡∏¥‡∏î Google Sheet ‡πÑ‡∏î‡πâ");
    }
    
    var targetSheet = null;
    var sheetNames = ['‡∏ù‡∏≤‡∏Å‡∏Ç‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πå‡∏î', 'Sheet1'];
    
    for (var i = 0; i < sheetNames.length; i++) {
      var sheet = spreadsheet.getSheetByName(sheetNames[i]);
      if (sheet) {
        targetSheet = sheet;
        break;
      }
    }
    
    if (!targetSheet) {
      var allSheets = spreadsheet.getSheets();
      if (allSheets.length > 0) {
        targetSheet = allSheets[0];
      }
    }
    
    if (!targetSheet) {
      if (isJson) {
        return ContentService.createTextOutput(JSON.stringify({
          error: "‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ä‡∏µ‡∏ó‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•",
          cards: []
        })).setMimeType(ContentService.MimeType.JSON);
      }
      return HtmlService.createHtmlOutput("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ä‡∏µ‡∏ó‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•");
    }
    
    var data = targetSheet.getDataRange().getValues();
    
    if (data.length <= 1) {
      if (isJson) {
        return ContentService.createTextOutput(JSON.stringify({
          error: "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•",
          cards: []
        })).setMimeType(ContentService.MimeType.JSON);
      }
      return HtmlService.createHtmlOutput("‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•");
    }
    
    var headers = data[0];
    var cards = [];
    
    var colIndex = {};
    for (var h = 0; h < headers.length; h++) {
      var header = String(headers[h]).trim();
      colIndex[header] = h;
    }
    
    for (var i = 1; i < data.length; i++) {
      var row = data[i];
      
      var depositDate = row[colIndex['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ù‡∏≤‡∏Å']] || '';
      var consignorName = row[colIndex['‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏ù‡∏≤‡∏Å‡∏Ç‡∏≤‡∏¢']] || '';
      var phone = row[colIndex['‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£']] || '';
      var folderSlot = row[colIndex['‡∏ä‡πà‡∏≠‡∏á‡πÉ‡∏ô‡πÅ‡∏ü‡πâ‡∏°']] || '';
      var cardName = row[colIndex['‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡πå‡∏î']] || '';
      var listedPrice = row[colIndex['‡∏£‡∏≤‡∏Ñ‡∏≤‡∏õ‡πâ‡∏≤‡∏¢']] || '';
      var actualPrice = row[colIndex['‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Ç‡∏≤‡∏¢‡∏à‡∏£‡∏¥‡∏á']] || '';
      var status = row[colIndex['‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞']] || '';
      var saleDate = row[colIndex['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏¢/‡∏Ñ‡∏∑‡∏ô']] || '';
      var refundAmount = row[colIndex['‡∏¢‡∏≠‡∏î‡∏Ñ‡∏∑‡∏ô‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ (90%)']] || '';
      var notes = row[colIndex['‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏']] || '';
      
      var cardImage = '';
      var cardBackImage = '';
      var productId = row[colIndex['‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤']] || '';
      
      // ‡∏≠‡πà‡∏≤‡∏ô‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏à‡∏≤‡∏Å Column G ‡∏Å‡πà‡∏≠‡∏ô (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß
      var imageLinkColIndex = colIndex['‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏†‡∏≤‡∏û‡∏Å‡∏≤‡∏£‡πå‡∏î'];
      if (imageLinkColIndex !== undefined) {
        var imageLinkValue = row[imageLinkColIndex];
        if (imageLinkValue) {
          var imageLinkStr = String(imageLinkValue).trim();
          if (imageLinkStr.indexOf('http') !== -1) {
            // ‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô thumbnail URL ‡∏ñ‡πâ‡∏≤‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô
            if (imageLinkStr.indexOf('thumbnail?id=') !== -1) {
              cardImage = imageLinkStr;
            } else {
              var idMatch = imageLinkStr.match(/id=([a-zA-Z0-9_-]+)/);
              if (idMatch && idMatch[1]) {
                cardImage = 'https://drive.google.com/thumbnail?id=' + idMatch[1] + '&sz=w1000';
              } else {
                cardImage = imageLinkStr;
              }
            }
          }
        }
      }
      
      // ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ ‡∏•‡∏≠‡∏á‡∏≠‡πà‡∏≤‡∏ô‡∏à‡∏≤‡∏Å Column F
      if (!cardImage) {
        var imageColIndex = colIndex['‡∏†‡∏≤‡∏û‡∏Å‡∏≤‡∏£‡πå‡∏î'];
        if (imageColIndex !== undefined) {
          try {
            var formulas = targetSheet.getRange(i + 1, imageColIndex + 1).getFormula();
            if (formulas && formulas.indexOf('IMAGE') !== -1) {
              var urlMatch = formulas.match(/IMAGE\(["'](.*?)["']\)/);
              if (urlMatch && urlMatch[1]) {
                cardImage = urlMatch[1];
              }
            }
          } catch (e) {}
        }
      }
      
      // ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏π‡∏õ‡∏´‡∏ô‡πâ‡∏≤ ‡πÅ‡∏•‡∏∞‡∏°‡∏µ productId ‡πÉ‡∏´‡πâ‡∏î‡∏∂‡∏á‡∏à‡∏≤‡∏Å Drive (‡πÅ‡∏ï‡πà‡∏à‡∏∞‡∏ó‡∏≥‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ö‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß)
      // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏π‡∏õ‡πÉ‡∏ô Column G ‡∏à‡∏∞‡∏™‡πà‡∏á productId ‡πÑ‡∏õ‡πÉ‡∏´‡πâ frontend ‡∏î‡∏∂‡∏á‡∏£‡∏π‡∏õ‡∏ó‡∏µ‡∏´‡∏•‡∏±‡∏á
      // ‡πÅ‡∏ï‡πà‡∏ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡πÄ‡∏£‡πá‡∏ß‡∏Ç‡∏∂‡πâ‡∏ô ‡πÉ‡∏´‡πâ‡∏£‡∏±‡∏ô linkImagesFromDrive() ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏ï‡∏¥‡∏° Column G ‡∏Å‡πà‡∏≠‡∏ô
      
      var statusStr = String(status).trim();
      if (statusStr === '‡∏¢‡∏±‡∏á‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà' || statusStr === '') {
        if (cardName && String(cardName).trim() !== '') {
          var card = {
            depositDate: depositDate || '',
            consignorName: consignorName || '',
            phone: phone || '',
            folderSlot: folderSlot || '',
            cardName: cardName || '',
            cardImage: cardImage || '', // ‡∏≠‡∏≤‡∏à‡∏ß‡πà‡∏≤‡∏á‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏î‡∏∂‡∏á‡∏à‡∏≤‡∏Å Drive
            cardBackImage: cardBackImage || '', // ‡∏≠‡∏≤‡∏à‡∏ß‡πà‡∏≤‡∏á‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏î‡∏∂‡∏á‡∏à‡∏≤‡∏Å Drive
            productId: String(productId).trim() || '', // ‡∏™‡πà‡∏á productId ‡πÑ‡∏õ‡πÉ‡∏´‡πâ frontend ‡∏î‡∏∂‡∏á‡∏£‡∏π‡∏õ‡∏ó‡∏µ‡∏´‡∏•‡∏±‡∏á
            listedPrice: listedPrice || '',
            actualPrice: actualPrice || '',
            status: statusStr || '‡∏¢‡∏±‡∏á‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà',
            saleDate: saleDate || '',
            refundAmount: refundAmount || '',
            notes: notes || ''
          };
          
          cards.push(card);
        }
      }
    }
    
    if (isJson) {
      return ContentService.createTextOutput(JSON.stringify({
        cards: cards,
        total: cards.length
      })).setMimeType(ContentService.MimeType.JSON);
    }
    
    var html = '<html><body><h2>‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏ù‡∏≤‡∏Å‡∏Ç‡∏≤‡∏¢</h2><ul>';
    cards.forEach(function(card) {
      html += '<li>' + card.cardName + ' - ' + card.listedPrice + ' ‡∏ö‡∏≤‡∏ó</li>';
    });
    html += '</ul></body></html>';
    return HtmlService.createHtmlOutput(html);
    
  } catch (error) {
    var errorMsg = '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.toString();
    
    if (e && e.parameter && e.parameter.type === 'json') {
      return ContentService.createTextOutput(JSON.stringify({
        error: errorMsg,
        cards: []
      })).setMimeType(ContentService.MimeType.JSON);
    }
    
    return HtmlService.createHtmlOutput(errorMsg);
  }
}

function linkImagesFromDrive() {
  var spreadsheetId = '1JvVCVxxXBS-2lpnT-IOrYBf2rF-OBRVFCW6MZEvpqxE';
  var sheetName = '‡∏ù‡∏≤‡∏Å‡∏Ç‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πå‡∏î';
  var driveFolderId = '15f0xNKHe4q8sNaMQo3uXs1qPBB0oVQx2';
  var productIdCol = 13; // Column N = index 13
  var imageLinkCol = 6; // Column G = index 6 (A=0, B=1, C=2, D=3, E=4, F=5, G=6)
  
  try {
    var spreadsheet = SpreadsheetApp.openById(spreadsheetId);
    var sheet = spreadsheet.getSheetByName(sheetName);
    if (!sheet) {
      SpreadsheetApp.getUi().alert('‡πÑ‡∏°‡πà‡∏û‡∏ö sheet');
      return;
    }
    
    var folder = DriveApp.getFolderById(driveFolderId);
    var files = folder.getFiles();
    var fileMap = {};
    
    while (files.hasNext()) {
      var file = files.next();
      fileMap[file.getName()] = file;
    }
    
    var data = sheet.getDataRange().getValues();
    var updatedCount = 0;
    var notFoundCount = 0;
    
    for (var i = 1; i < data.length; i++) {
      var productId = String(data[i][productIdCol] || '').trim();
      if (!productId) continue;
      
      var frontFileName = productId + ' ‡∏´‡∏ô‡πâ‡∏≤.jpg';
      var frontFile = fileMap[frontFileName];
      
      if (frontFile) {
        try {
          frontFile.setSharing(DriveApp.Access.ANYONE_WITH_LINK, DriveApp.Permission.VIEW);
        } catch (e) {}
        
        var fileId = frontFile.getId();
        // ‡πÉ‡∏ä‡πâ thumbnail URL ‡πÅ‡∏ó‡∏ô ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏à‡∏∞‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏î‡πâ‡πÄ‡∏£‡πá‡∏ß‡∏Å‡∏ß‡πà‡∏≤‡πÅ‡∏•‡∏∞‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÅ‡∏ä‡∏£‡πå
        var imageUrl = 'https://drive.google.com/thumbnail?id=' + fileId + '&sz=w1000';
        sheet.getRange(i + 1, imageLinkCol + 1).setValue(imageUrl);
        updatedCount++;
      } else {
        notFoundCount++;
      }
    }
    
    SpreadsheetApp.getUi().alert('‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô! ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó ' + updatedCount + ' ‡πÅ‡∏ñ‡∏ß, ‡πÑ‡∏°‡πà‡∏û‡∏ö ' + notFoundCount + ' ‡πÅ‡∏ñ‡∏ß');
  } catch (error) {
    SpreadsheetApp.getUi().alert('Error: ' + error.toString());
  }
}

function updateImageColumn() {
  var spreadsheetId = '1JvVCVxxXBS-2lpnT-IOrYBf2rF-OBRVFCW6MZEvpqxE';
  var sheetName = '‡∏ù‡∏≤‡∏Å‡∏Ç‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πå‡∏î';
  var imageLinkCol = 6; // Column G
  var imageCol = 5; // Column F
  
  try {
    var spreadsheet = SpreadsheetApp.openById(spreadsheetId);
    var sheet = spreadsheet.getSheetByName(sheetName);
    var data = sheet.getDataRange().getValues();
    var updatedCount = 0;
    
    for (var i = 1; i < data.length; i++) {
      var imageUrl = String(data[i][imageLinkCol] || '').trim();
      if (imageUrl && imageUrl.indexOf('http') !== -1) {
        sheet.getRange(i + 1, imageCol + 1).setValue('=IMAGE("' + imageUrl + '")');
        updatedCount++;
      }
    }
    
    SpreadsheetApp.getUi().alert('‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó Column F ‡πÅ‡∏•‡πâ‡∏ß: ' + updatedCount + ' ‡πÅ‡∏ñ‡∏ß');
  } catch (error) {
    SpreadsheetApp.getUi().alert('Error: ' + error.toString());
  }
}

/**
 * ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏õ‡∏∏‡πà‡∏°‡πÉ‡∏ô Google Sheets
 * ‡∏£‡∏±‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏õ‡∏∏‡πà‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó URL ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û
 */
function createButton() {
  var spreadsheetId = '1JvVCVxxXBS-2lpnT-IOrYBf2rF-OBRVFCW6MZEvpqxE';
  
  try {
    var spreadsheet = SpreadsheetApp.openById(spreadsheetId);
    var sheet = spreadsheet.getSheetByName('‡∏ù‡∏≤‡∏Å‡∏Ç‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πå‡∏î');
    
    if (!sheet) {
      var allSheets = spreadsheet.getSheets();
      if (allSheets.length > 0) {
        sheet = allSheets[0];
      }
    }
    
    if (!sheet) {
      SpreadsheetApp.getUi().alert('‡πÑ‡∏°‡πà‡∏û‡∏ö sheet');
      return;
    }
    
    // ‡∏•‡∏ö‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏Å‡πà‡∏≤ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
    var drawings = sheet.getDrawings();
    drawings.forEach(function(drawing) {
      var note = drawing.getOnClick();
      if (note && note.indexOf('linkImagesFromDrive') !== -1) {
        drawing.remove();
      }
    });
    
    // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏õ‡∏∏‡πà‡∏°‡πÉ‡∏´‡∏°‡πà
    var range = sheet.getRange('O1'); // ‡∏ß‡∏≤‡∏á‡∏õ‡∏∏‡πà‡∏°‡∏ó‡∏µ‡πà Column O ‡πÅ‡∏ñ‡∏ß 1
    var button = sheet.newImage()
      .setUrl('https://www.gstatic.com/images/icons/material/system/1x/add_circle_outline_black_24dp.png')
      .setAnchorCell(range)
      .setWidth(100)
      .setHeight(30)
      .assignScript('linkImagesFromDrive');
    
    // ‡∏´‡∏£‡∏∑‡∏≠‡πÉ‡∏ä‡πâ‡∏ß‡∏¥‡∏ò‡∏µ‡∏™‡∏£‡πâ‡∏≤‡∏á shape ‡πÅ‡∏ó‡∏ô
    var buttonRange = sheet.getRange('O1');
    buttonRange.setValue('üîÑ ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó URL ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û');
    buttonRange.setBackground('#4285f4');
    buttonRange.setFontColor('#ffffff');
    buttonRange.setFontWeight('bold');
    buttonRange.setFontSize(11);
    buttonRange.setHorizontalAlignment('center');
    
    SpreadsheetApp.getUi().alert('‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß!\n\n‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡πÄ‡∏ã‡∏•‡∏•‡πå O1 ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏±‡∏ô‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô linkImagesFromDrive()');
  } catch (error) {
    SpreadsheetApp.getUi().alert('Error: ' + error.toString());
  }
}

/**
 * ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏°‡∏ô‡∏π‡πÉ‡∏ô Google Sheets
 * ‡∏£‡∏±‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏°‡∏ô‡∏π "‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏ù‡∏≤‡∏Å‡∏Ç‡∏≤‡∏¢" ‡πÉ‡∏ô‡πÅ‡∏ñ‡∏ö‡πÄ‡∏°‡∏ô‡∏π
 */
function onOpen() {
  var ui = SpreadsheetApp.getUi();
  ui.createMenu('üÉè ‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏ù‡∏≤‡∏Å‡∏Ç‡∏≤‡∏¢')
    .addItem('üîÑ ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó URL ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û', 'linkImagesFromDrive')
    .addItem('üñºÔ∏è ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó Column F ‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏π‡∏õ', 'updateImageColumn')
    .addToUi();
}
