function doGet(e) {
  try {
    var isJson = e && e.parameter && e.parameter.type === 'json';
    
    var spreadsheetId = '1JvVCVxxXBS-2lpnT-IOrYBf2rF-OBRVFCW6MZEvpqxE';
    var spreadsheet = SpreadsheetApp.openById(spreadsheetId);
    
    var targetSheet = spreadsheet.getSheetByName('‡∏ù‡∏≤‡∏Å‡∏Ç‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πå‡∏î');
    if (!targetSheet) {
      targetSheet = spreadsheet.getSheetByName('Sheet1');
    }
    if (!targetSheet) {
      var allSheets = spreadsheet.getSheets();
      if (allSheets.length > 0) {
        targetSheet = allSheets[0];
      }
    }
    
    if (!targetSheet) {
      if (isJson) {
        return ContentService.createTextOutput(JSON.stringify({
          error: "‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ä‡∏µ‡∏ó‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•",
          cards: []
        })).setMimeType(ContentService.MimeType.JSON);
      }
      return HtmlService.createHtmlOutput("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ä‡∏µ‡∏ó‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•");
    }
    
    // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏°‡∏≤‡πÉ‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß (‡πÄ‡∏£‡πá‡∏ß‡∏Å‡∏ß‡πà‡∏≤‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á‡∏ó‡∏µ‡∏•‡∏∞‡πÅ‡∏ñ‡∏ß)
    var data = targetSheet.getDataRange().getValues();
    
    if (data.length <= 1) {
      if (isJson) {
        return ContentService.createTextOutput(JSON.stringify({
          error: "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•",
          cards: []
        })).setMimeType(ContentService.MimeType.JSON);
      }
      return HtmlService.createHtmlOutput("‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•");
    }
    
    var headers = data[0];
    var cards = [];
    
    // ‡∏™‡∏£‡πâ‡∏≤‡∏á colIndex ‡πÅ‡∏ö‡∏ö‡πÄ‡∏£‡πá‡∏ß (‡πÉ‡∏ä‡πâ index ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á)
    var colIndex = {};
    var headerCount = headers.length;
    for (var h = 0; h < headerCount; h++) {
      colIndex[headers[h]] = h;
    }
    
    // Cache column indices ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
    var idxDate = colIndex['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ù‡∏≤‡∏Å'];
    var idxConsignor = colIndex['‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏ù‡∏≤‡∏Å‡∏Ç‡∏≤‡∏¢'];
    var idxPhone = colIndex['‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£'];
    var idxSlot = colIndex['‡∏ä‡πà‡∏≠‡∏á‡πÉ‡∏ô‡πÅ‡∏ü‡πâ‡∏°'];
    var idxCardName = colIndex['‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡πå‡∏î'];
    var idxPrice = colIndex['‡∏£‡∏≤‡∏Ñ‡∏≤‡∏õ‡πâ‡∏≤‡∏¢'];
    var idxActualPrice = colIndex['‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Ç‡∏≤‡∏¢‡∏à‡∏£‡∏¥‡∏á'];
    var idxStatus = colIndex['‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞'];
    var idxSaleDate = colIndex['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏¢/‡∏Ñ‡∏∑‡∏ô'];
    var idxRefund = colIndex['‡∏¢‡∏≠‡∏î‡∏Ñ‡∏∑‡∏ô‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ (90%)'];
    var idxNotes = colIndex['‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏'];
    var idxProductId = colIndex['‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤'];
    var idxImageLink = colIndex['‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏†‡∏≤‡∏û‡∏Å‡∏≤‡∏£‡πå‡∏î'];
    
    // ‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÅ‡∏ö‡∏ö batch (‡πÄ‡∏£‡πá‡∏ß‡∏Å‡∏ß‡πà‡∏≤‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏ó‡∏µ‡∏•‡∏∞‡πÅ‡∏ñ‡∏ß)
    var rowCount = data.length;
    var cardImage, imageLink, imageLinkStr, idMatch, cardName, status;
    
    for (var i = 1; i < rowCount; i++) {
      var row = data[i];
      
      // ‡∏≠‡πà‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏î‡∏¢‡πÉ‡∏ä‡πâ index ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á (‡πÄ‡∏£‡πá‡∏ß‡∏Å‡∏ß‡πà‡∏≤)
      cardName = row[idxCardName];
      if (!cardName) continue; // ‡∏Ç‡πâ‡∏≤‡∏°‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡πå‡∏î
      
      status = row[idxStatus];
      // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÅ‡∏ö‡∏ö‡πÄ‡∏£‡πá‡∏ß (‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á String() ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô)
      if (status && status !== '‡∏¢‡∏±‡∏á‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà') continue;
      
      // ‡∏≠‡πà‡∏≤‡∏ô‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏à‡∏≤‡∏Å Column G ‡πÅ‡∏ö‡∏ö‡πÄ‡∏£‡πá‡∏ß
      cardImage = '';
      if (idxImageLink !== undefined) {
        imageLink = row[idxImageLink];
        if (imageLink) {
          imageLinkStr = String(imageLink);
          if (imageLinkStr.indexOf('http') !== -1) {
            if (imageLinkStr.indexOf('thumbnail?id=') !== -1) {
              cardImage = imageLinkStr;
            } else {
              idMatch = imageLinkStr.match(/id=([a-zA-Z0-9_-]+)/);
              if (idMatch && idMatch[1]) {
                cardImage = 'https://drive.google.com/thumbnail?id=' + idMatch[1] + '&sz=w1000';
              } else {
                cardImage = imageLinkStr;
              }
            }
          }
        }
      }
      
      // ‡∏î‡∏∂‡∏á‡∏£‡∏π‡∏õ‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å Drive ‡πÇ‡∏î‡∏¢‡πÉ‡∏ä‡πâ productId
      var cardBackImage = '';
      var productId = String(row[idxProductId] || '').trim();
      if (productId) {
        try {
          var driveFolderId = '15f0xNKHe4q8sNaMQo3uXs1qPBB0oVQx2';
          var folder = DriveApp.getFolderById(driveFolderId);
          var backFileName = productId + ' ‡∏´‡∏•‡∏±‡∏á.jpg';
          var backFiles = folder.getFilesByName(backFileName);
          
          if (backFiles.hasNext()) {
            var backFile = backFiles.next();
            try {
              backFile.setSharing(DriveApp.Access.ANYONE_WITH_LINK, DriveApp.Permission.VIEW);
            } catch (e) {}
            var backFileId = backFile.getId();
            cardBackImage = 'https://drive.google.com/thumbnail?id=' + backFileId + '&sz=w1000';
          }
        } catch (e) {
          // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏Å‡∏¥‡∏î error ‡πÉ‡∏´‡πâ‡∏Ç‡πâ‡∏≤‡∏°‡πÑ‡∏õ (‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏™‡∏î‡∏á error)
        }
      }
      
      // ‡∏™‡∏£‡πâ‡∏≤‡∏á object ‡πÅ‡∏ö‡∏ö‡πÄ‡∏£‡πá‡∏ß (‡πÉ‡∏ä‡πâ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡πÑ‡∏ß‡πâ‡πÅ‡∏•‡πâ‡∏ß)
      cards.push({
        depositDate: row[idxDate] || '',
        consignorName: row[idxConsignor] || '',
        phone: row[idxPhone] || '',
        folderSlot: row[idxSlot] || '',
        cardName: cardName,
        cardImage: cardImage,
        cardBackImage: cardBackImage,
        productId: productId,
        listedPrice: row[idxPrice] || '',
        actualPrice: row[idxActualPrice] || '',
        status: '‡∏¢‡∏±‡∏á‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà',
        saleDate: row[idxSaleDate] || '',
        refundAmount: row[idxRefund] || '',
        notes: row[idxNotes] || ''
      });
    }
    
    if (isJson) {
      return ContentService.createTextOutput(JSON.stringify({
        cards: cards,
        total: cards.length
      })).setMimeType(ContentService.MimeType.JSON);
    }
    
    var html = '<html><body><h2>‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏ù‡∏≤‡∏Å‡∏Ç‡∏≤‡∏¢</h2><ul>';
    cards.forEach(function(card) {
      html += '<li>' + card.cardName + ' - ' + card.listedPrice + ' ‡∏ö‡∏≤‡∏ó</li>';
    });
    html += '</ul></body></html>';
    return HtmlService.createHtmlOutput(html);
    
  } catch (error) {
    var errorMsg = '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.toString();
    
    if (e && e.parameter && e.parameter.type === 'json') {
      return ContentService.createTextOutput(JSON.stringify({
        error: errorMsg,
        cards: []
      })).setMimeType(ContentService.MimeType.JSON);
    }
    
    return HtmlService.createHtmlOutput(errorMsg);
  }
}

function linkImagesFromDrive() {
  var spreadsheetId = '1JvVCVxxXBS-2lpnT-IOrYBf2rF-OBRVFCW6MZEvpqxE';
  var sheetName = '‡∏ù‡∏≤‡∏Å‡∏Ç‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πå‡∏î';
  var driveFolderId = '15f0xNKHe4q8sNaMQo3uXs1qPBB0oVQx2';
  var productIdCol = 13; // Column N = index 13
  var imageLinkCol = 6; // Column G = index 6 (A=0, B=1, C=2, D=3, E=4, F=5, G=6)
  
  try {
    var spreadsheet = SpreadsheetApp.openById(spreadsheetId);
    var sheet = spreadsheet.getSheetByName(sheetName);
    if (!sheet) {
      SpreadsheetApp.getUi().alert('‡πÑ‡∏°‡πà‡∏û‡∏ö sheet');
      return;
    }
    
    var folder = DriveApp.getFolderById(driveFolderId);
    var files = folder.getFiles();
    var fileMap = {};
    
    while (files.hasNext()) {
      var file = files.next();
      fileMap[file.getName()] = file;
    }
    
    var data = sheet.getDataRange().getValues();
    var updatedCount = 0;
    var notFoundCount = 0;
    
    for (var i = 1; i < data.length; i++) {
      var productId = String(data[i][productIdCol] || '').trim();
      if (!productId) continue;
      
      var frontFileName = productId + ' ‡∏´‡∏ô‡πâ‡∏≤.jpg';
      var frontFile = fileMap[frontFileName];
      
      if (frontFile) {
        try {
          frontFile.setSharing(DriveApp.Access.ANYONE_WITH_LINK, DriveApp.Permission.VIEW);
        } catch (e) {}
        
        var fileId = frontFile.getId();
        // ‡πÉ‡∏ä‡πâ thumbnail URL ‡πÅ‡∏ó‡∏ô ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏à‡∏∞‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏î‡πâ‡πÄ‡∏£‡πá‡∏ß‡∏Å‡∏ß‡πà‡∏≤‡πÅ‡∏•‡∏∞‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÅ‡∏ä‡∏£‡πå
        var imageUrl = 'https://drive.google.com/thumbnail?id=' + fileId + '&sz=w1000';
        sheet.getRange(i + 1, imageLinkCol + 1).setValue(imageUrl);
        updatedCount++;
      } else {
        notFoundCount++;
      }
    }
    
    SpreadsheetApp.getUi().alert('‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô! ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó ' + updatedCount + ' ‡πÅ‡∏ñ‡∏ß, ‡πÑ‡∏°‡πà‡∏û‡∏ö ' + notFoundCount + ' ‡πÅ‡∏ñ‡∏ß');
  } catch (error) {
    SpreadsheetApp.getUi().alert('Error: ' + error.toString());
  }
}

function updateImageColumn() {
  var spreadsheetId = '1JvVCVxxXBS-2lpnT-IOrYBf2rF-OBRVFCW6MZEvpqxE';
  var sheetName = '‡∏ù‡∏≤‡∏Å‡∏Ç‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πå‡∏î';
  var imageLinkCol = 6; // Column G
  var imageCol = 5; // Column F
  
  try {
    var spreadsheet = SpreadsheetApp.openById(spreadsheetId);
    var sheet = spreadsheet.getSheetByName(sheetName);
    var data = sheet.getDataRange().getValues();
    var updatedCount = 0;
    
    for (var i = 1; i < data.length; i++) {
      var imageUrl = String(data[i][imageLinkCol] || '').trim();
      if (imageUrl && imageUrl.indexOf('http') !== -1) {
        sheet.getRange(i + 1, imageCol + 1).setValue('=IMAGE("' + imageUrl + '")');
        updatedCount++;
      }
    }
    
    SpreadsheetApp.getUi().alert('‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó Column F ‡πÅ‡∏•‡πâ‡∏ß: ' + updatedCount + ' ‡πÅ‡∏ñ‡∏ß');
  } catch (error) {
    SpreadsheetApp.getUi().alert('Error: ' + error.toString());
  }
}

/**
 * ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏õ‡∏∏‡πà‡∏°‡πÉ‡∏ô Google Sheets
 * ‡∏£‡∏±‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏õ‡∏∏‡πà‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó URL ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û
 */
function createButton() {
  var spreadsheetId = '1JvVCVxxXBS-2lpnT-IOrYBf2rF-OBRVFCW6MZEvpqxE';
  
  try {
    var spreadsheet = SpreadsheetApp.openById(spreadsheetId);
    var sheet = spreadsheet.getSheetByName('‡∏ù‡∏≤‡∏Å‡∏Ç‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πå‡∏î');
    
    if (!sheet) {
      var allSheets = spreadsheet.getSheets();
      if (allSheets.length > 0) {
        sheet = allSheets[0];
      }
    }
    
    if (!sheet) {
      SpreadsheetApp.getUi().alert('‡πÑ‡∏°‡πà‡∏û‡∏ö sheet');
      return;
    }
    
    // ‡∏•‡∏ö‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏Å‡πà‡∏≤ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
    var drawings = sheet.getDrawings();
    drawings.forEach(function(drawing) {
      var note = drawing.getOnClick();
      if (note && note.indexOf('linkImagesFromDrive') !== -1) {
        drawing.remove();
      }
    });
    
    // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏õ‡∏∏‡πà‡∏°‡πÉ‡∏´‡∏°‡πà
    var range = sheet.getRange('O1'); // ‡∏ß‡∏≤‡∏á‡∏õ‡∏∏‡πà‡∏°‡∏ó‡∏µ‡πà Column O ‡πÅ‡∏ñ‡∏ß 1
    var button = sheet.newImage()
      .setUrl('https://www.gstatic.com/images/icons/material/system/1x/add_circle_outline_black_24dp.png')
      .setAnchorCell(range)
      .setWidth(100)
      .setHeight(30)
      .assignScript('linkImagesFromDrive');
    
    // ‡∏´‡∏£‡∏∑‡∏≠‡πÉ‡∏ä‡πâ‡∏ß‡∏¥‡∏ò‡∏µ‡∏™‡∏£‡πâ‡∏≤‡∏á shape ‡πÅ‡∏ó‡∏ô
    var buttonRange = sheet.getRange('O1');
    buttonRange.setValue('üîÑ ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó URL ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û');
    buttonRange.setBackground('#4285f4');
    buttonRange.setFontColor('#ffffff');
    buttonRange.setFontWeight('bold');
    buttonRange.setFontSize(11);
    buttonRange.setHorizontalAlignment('center');
    
    SpreadsheetApp.getUi().alert('‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß!\n\n‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡πÄ‡∏ã‡∏•‡∏•‡πå O1 ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏±‡∏ô‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô linkImagesFromDrive()');
  } catch (error) {
    SpreadsheetApp.getUi().alert('Error: ' + error.toString());
  }
}

/**
 * ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏°‡∏ô‡∏π‡πÉ‡∏ô Google Sheets
 * ‡∏£‡∏±‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏°‡∏ô‡∏π "‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏ù‡∏≤‡∏Å‡∏Ç‡∏≤‡∏¢" ‡πÉ‡∏ô‡πÅ‡∏ñ‡∏ö‡πÄ‡∏°‡∏ô‡∏π
 */
function onOpen() {
  var ui = SpreadsheetApp.getUi();
  ui.createMenu('üÉè ‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏ù‡∏≤‡∏Å‡∏Ç‡∏≤‡∏¢')
    .addItem('üîÑ ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó URL ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û', 'linkImagesFromDrive')
    .addItem('üñºÔ∏è ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó Column F ‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏π‡∏õ', 'updateImageColumn')
    .addToUi();
}
