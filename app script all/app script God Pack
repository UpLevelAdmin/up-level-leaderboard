function doGet(e) {
  try {
    var isJson = e && e.parameter && e.parameter.type === 'json';
    
    // เปิด Google Sheet ที่มี ID นี้
    // ⚠️ หมายเหตุ: ถ้า app script นี้อยู่ใน Google Sheet เดียวกันกับข้อมูล ให้ใช้ SpreadsheetApp.getActiveSpreadsheet() แทน
    var spreadsheetId = '1Qjpp6Kp4JdUCokXM7KO7opGx7ZFBQuXaksw8ql-ZXjo';
    var spreadsheet;
    
    try {
      spreadsheet = SpreadsheetApp.openById(spreadsheetId);
    } catch (err) {
      // ถ้าเปิดไม่ได้ ลองใช้ active spreadsheet แทน
      spreadsheet = SpreadsheetApp.getActiveSpreadsheet();
    }
    
    // หา sheet "รายชื่อคนซื้อ God Pack"
    var targetSheet = spreadsheet.getSheetByName('รายชื่อคนซื้อ God Pack');
    
    if (!targetSheet) {
      // ถ้าไม่เจอ ลองหา sheet อื่นๆ
      var sheetNames = ['รายชื่อคนซื้อ God Pack', 'Form Responses 1', 'Form Responses', 'Responses'];
      for (var i = 0; i < sheetNames.length; i++) {
        var sheet = spreadsheet.getSheetByName(sheetNames[i]);
        if (sheet) {
          targetSheet = sheet;
          break;
        }
      }
    }
    
    if (!targetSheet) {
      var allSheets = spreadsheet.getSheets();
      if (allSheets.length > 0) {
        targetSheet = allSheets[0]; // ใช้ sheet แรกที่เจอ
      }
    }
    
    if (!targetSheet) {
      if (isJson) {
        return ContentService.createTextOutput(JSON.stringify({
          error: "ไม่พบชีทข้อมูล",
          participants: []
        })).setMimeType(ContentService.MimeType.JSON);
      }
      return HtmlService.createHtmlOutput("ไม่พบชีทข้อมูล");
    }
    
    // ดึงข้อมูลทั้งหมดมาในครั้งเดียว (เร็วกว่า)
    var data = targetSheet.getDataRange().getValues();
    
    if (data.length <= 1) {
      if (isJson) {
        return ContentService.createTextOutput(JSON.stringify({
          error: "ไม่มีข้อมูล",
          participants: []
        })).setMimeType(ContentService.MimeType.JSON);
      }
      return HtmlService.createHtmlOutput("ไม่มีข้อมูล");
    }
    
    var headers = data[0];
    var participants = [];
    
    // สร้าง colIndex แบบเร็ว
    var colIndex = {};
    var headerCount = headers.length;
    for (var h = 0; h < headerCount; h++) {
      colIndex[headers[h]] = h;
    }
    
    // Cache column indices
    var idxName = colIndex['ชื่อ-สกุล'];
    var idxPhone = colIndex['เบอร์โทรศัพท์ติดต่อ'];
    var idxQuantity = colIndex['จำนวน GOD PACK ที่ซื้อ'];
    var idxQuantityOld = colIndex['จำนวน GOD PACK ที่ต้องการพรีออเดอร์ (ซองละ 299 บาท)'];
    var idxNickname = colIndex['ชื่อเล่น, ฉายา'];
    
    // ประมวลผลข้อมูลทั้งหมดแบบ batch (เร็วกว่า)
    var rowCount = data.length;
    var participant, row, name, phone, quantity, nickname;
    
    for (var i = 1; i < rowCount; i++) {
      row = data[i];
      
      // อ่านข้อมูลโดยใช้ index โดยตรง (เร็วกว่า)
      name = idxName !== undefined ? String(row[idxName] || '').trim() : '';
      phone = idxPhone !== undefined ? String(row[idxPhone] || '').trim() : '';
      
      // ข้ามถ้าไม่มีชื่อและเบอร์โทร
      if (!name && !phone) continue;
      
      // อ่านจำนวนซอง
      quantity = 0;
      if (idxQuantity !== undefined && row[idxQuantity]) {
        quantity = parseInt(row[idxQuantity]) || 0;
      } else if (idxQuantityOld !== undefined && row[idxQuantityOld]) {
        quantity = parseInt(row[idxQuantityOld]) || 0;
      }
      
      nickname = idxNickname !== undefined ? String(row[idxNickname] || '').trim() : '';
      
      // สร้าง object แบบเร็ว (ใช้เฉพาะข้อมูลที่จำเป็น)
      participant = {};
      
      // เพิ่มเฉพาะข้อมูลที่จำเป็น
      if (idxName !== undefined) participant['ชื่อ-สกุล'] = name;
      if (idxPhone !== undefined) participant['เบอร์โทรศัพท์ติดต่อ'] = phone;
      if (idxQuantity !== undefined) participant['จำนวน GOD PACK ที่ซื้อ'] = quantity;
      if (idxQuantityOld !== undefined) participant['จำนวน GOD PACK ที่ต้องการพรีออเดอร์ (ซองละ 299 บาท)'] = quantity;
      if (idxNickname !== undefined) participant['ชื่อเล่น, ฉายา'] = nickname;
      
      // เพิ่มข้อมูลอื่นๆ ถ้ามี
      for (var j = 0; j < headers.length; j++) {
        if (participant[headers[j]] === undefined) {
          var value = row[j];
          participant[headers[j]] = (value === null || value === undefined) ? '' : value;
        }
      }
      
      participants.push(participant);
    }
    
    if (isJson) {
      return ContentService.createTextOutput(JSON.stringify({
        participants: participants,
        total: participants.length
      })).setMimeType(ContentService.MimeType.JSON);
    }
    
    // ถ้าไม่ใช่ JSON ให้แสดง HTML
    var html = '<html><body><h2>God Pack Orders</h2><ul>';
    participants.forEach(function(p) {
      var quantity = p['จำนวน GOD PACK ที่ซื้อ'] || p['จำนวน GOD PACK ที่ต้องการพรีออเดอร์ (ซองละ 299 บาท)'] || 0;
      html += '<li>' + (p['ชื่อ-สกุล'] || 'ไม่มีชื่อ') + ' - ' + quantity + ' ซอง</li>';
    });
    html += '</ul></body></html>';
    return HtmlService.createHtmlOutput(html);
    
  } catch (error) {
    var errorMsg = 'เกิดข้อผิดพลาด: ' + error.toString();
    console.error(errorMsg);
    
    if (e && e.parameter && e.parameter.type === 'json') {
      return ContentService.createTextOutput(JSON.stringify({
        error: errorMsg,
        participants: []
      })).setMimeType(ContentService.MimeType.JSON);
    }
    
    return HtmlService.createHtmlOutput(errorMsg);
  }
}

