// ‚úÖ Up Level Challenge: Road to Premier Ball - App Script

function onOpen() {
  const ui = SpreadsheetApp.getUi();
  
  // üéØ ‡πÄ‡∏°‡∏ô‡∏π Road to Premier Ball
  const roadToPremierMenu = ui.createMenu("üéØ Road to Premier Ball")
    .addItem("üìä ‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏™‡∏°‡∏±‡∏Ñ‡∏£", "showRoadToPremierSummary")
    .addItem("üìÖ ‡∏î‡∏π‡∏ú‡∏π‡πâ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏ï‡∏≤‡∏°‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà", "showParticipantsByDate")
    .addItem("üèÜ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô", "recordMatchResult")
    .addItem("üéÅ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡∏Å‡πÅ‡∏ï‡πâ‡∏°", "recordPointRedemption")
    .addItem("üìà ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÅ‡∏ï‡πâ‡∏°‡∏™‡∏∞‡∏™‡∏°", "updatePoints")
    .addSeparator()
    .addItem("üîß ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Trigger ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥", "setupRoadToPremierTrigger")
    .addItem("üìä ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ Triggers", "checkTriggerStatus");

  // üõ†Ô∏è ‡πÄ‡∏°‡∏ô‡∏π‡∏£‡∏∞‡∏ö‡∏ö
  const systemMenu = ui.createMenu("üõ†Ô∏è ‡∏£‡∏∞‡∏ö‡∏ö")
    .addItem("üóëÔ∏è ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ã‡πâ‡∏≥", "clearDuplicateEntries")
    .addItem("‚ùå ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏™‡∏°‡∏±‡∏Ñ‡∏£", "removeParticipant")
    .addItem("üîÑ ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡πÅ‡∏ï‡πâ‡∏°‡∏™‡∏∞‡∏™‡∏°", "resetAllPoints")
    .addItem("üìä ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•", "exportData");

  // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏°‡∏ô‡∏π‡∏´‡∏•‡∏±‡∏Å
  ui.createMenu("üéØ Road to Premier Ball")
    .addSubMenu(roadToPremierMenu)
    .addSubMenu(systemMenu)
    .addToUi();
}

// ‚úÖ ‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Google Form - Road to Premier Ball
function onFormSubmit(e) {
  try {
    Logger.log("üì• ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏ü‡∏≠‡∏£‡πå‡∏° Road to Premier Ball - onFormSubmit");
    Logger.log("Event data: " + JSON.stringify(e));
    
    const values = e.values;
    const timestamp = values[0];
    const registrationDate = values[1]; // ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô
    const fullName = values[2]; // ‡∏ä‡∏∑‡πà‡∏≠ - ‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏• (‡∏†‡∏≤‡∏©‡∏≤‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©)
    const nickname = values[3]; // ‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô
    const trainerId = values[4]; // Trainer ID
    const phone = normalizePhone(values[5]); // ‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠
    const playLevel = values[6]; // ‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡πà‡∏ô
    const termsConfirmed = values[7]; // ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç

    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const participantsSheet = ss.getSheetByName("Participants");
    const pointsSheet = ss.getSheetByName("Points System");

    if (!participantsSheet) {
      throw new Error("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ä‡∏µ‡∏ó Participants");
    }

    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ã‡πâ‡∏≥
    const existingData = participantsSheet.getDataRange().getValues();
    const existingPhones = existingData.slice(1).map(row => normalizePhone(row[5]));
    const existingTrainerIds = existingData.slice(1).map(row => String(row[4]).trim());

    let isDuplicate = false;
    let duplicateReason = "";

    if (existingPhones.includes(phone)) {
      isDuplicate = true;
      duplicateReason = "‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏ã‡πâ‡∏≥";
    }

    if (existingTrainerIds.includes(trainerId.trim())) {
      isDuplicate = true;
      duplicateReason += duplicateReason ? ", Trainer ID ‡∏ã‡πâ‡∏≥" : "Trainer ID ‡∏ã‡πâ‡∏≥";
    }

    // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏™‡∏°‡∏±‡∏Ñ‡∏£
    const newRow = [
      timestamp,
      registrationDate,
      fullName,
      nickname,
      trainerId,
      phone,
      playLevel,
      termsConfirmed,
      isDuplicate ? `DUPLICATE: ${duplicateReason}` : "OK",
      0 // ‡πÅ‡∏ï‡πâ‡∏°‡∏™‡∏∞‡∏™‡∏°‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
    ];

    const newRowIndex = participantsSheet.getLastRow() + 1;
    participantsSheet.getRange(newRowIndex, 1, 1, newRow.length).setValues([newRow]);
    
    // ‡∏ï‡∏±‡πâ‡∏á‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£
    participantsSheet.getRange(newRowIndex, 6).setNumberFormat("@");

    if (isDuplicate) {
      // ‡πÑ‡∏Æ‡πÑ‡∏•‡∏ó‡πå‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ã‡πâ‡∏≥
      participantsSheet.getRange(newRowIndex, 1, 1, newRow.length).setBackground("#f28b82");
      Logger.log("‚ö†Ô∏è ‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ã‡πâ‡∏≥: " + duplicateReason);
    } else {
      // ‡πÑ‡∏Æ‡πÑ‡∏•‡∏ó‡πå‡πÅ‡∏ñ‡∏ß‡πÉ‡∏´‡∏°‡πà
      participantsSheet.getRange(newRowIndex, 1, 1, newRow.length).setBackground("#d9ead3");
      Logger.log("‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢");
    }

    // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏ï‡πâ‡∏°‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ
    initializePointsSystem();

    // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
    updateSummaryData();
    
    Logger.log("‚úÖ ‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏ü‡∏≠‡∏£‡πå‡∏° Road to Premier Ball ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô");
    
  } catch (error) {
    Logger.log("‚ùå onFormSubmit Error: " + error.toString());
    Logger.log("Event data: " + JSON.stringify(e));
    
    // ‡∏™‡πà‡∏á‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô
    try {
      const adminEmail = Session.getActiveUser().getEmail();
      MailApp.sendEmail({
        to: adminEmail,
        subject: "‚ö†Ô∏è Road to Premier Ball Form Submit Error",
        body: `‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏ü‡∏≠‡∏£‡πå‡∏° Road to Premier Ball:\n\n${error.toString()}\n\nEvent: ${JSON.stringify(e)}\n\n‡πÄ‡∏ß‡∏•‡∏≤: ${new Date().toLocaleString('th-TH')}`
      });
      Logger.log("‚úÖ ‡∏™‡πà‡∏á‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢");
    } catch (emailError) {
      Logger.log("‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡πà‡∏á‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÑ‡∏î‡πâ: " + emailError.toString());
    }
  }
}

// ‚úÖ ‡∏õ‡∏£‡∏±‡∏ö‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô
function normalizePhone(phone) {
  if (!phone) return "";
  let normalized = String(phone).replace(/[^\d]/g, "");
  if (normalized.length === 9 && normalized[0] !== "0") {
    normalized = "0" + normalized;
  }
  return normalized;
}

// ‚úÖ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ä‡∏µ‡∏ó Participants
function createParticipantsSheet() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const participantsSheet = ss.insertSheet("Participants");
  
  // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏ï‡∏≤‡∏£‡∏≤‡∏á
  const headers = [
    "‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà/‡πÄ‡∏ß‡∏•‡∏≤", "‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô", "‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏• (‡∏†‡∏≤‡∏©‡∏≤‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©)", 
    "‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô", "Trainer ID", "‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠", 
    "‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡πà‡∏ô", "‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç", "‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞", "‡πÅ‡∏ï‡πâ‡∏°‡∏™‡∏∞‡∏™‡∏°"
  ];
  
  participantsSheet.getRange(1, 1, 1, headers.length).setValues([headers]);
  participantsSheet.getRange(1, 1, 1, headers.length).setBackground("#4285f4").setFontColor("white").setFontWeight("bold");
  participantsSheet.autoResizeColumns(1, headers.length);
  
  Logger.log("‚úÖ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ä‡∏µ‡∏ó Participants ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢");
  return participantsSheet;
}

// ‚úÖ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏ï‡πâ‡∏°‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ
function initializePointsSystem() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  let pointsSheet = ss.getSheetByName("Points System");
  
  if (!pointsSheet) {
    pointsSheet = ss.insertSheet("Points System");
    
    // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏ï‡∏≤‡∏£‡∏≤‡∏á
    const headers = [
      "‡πÅ‡∏ï‡πâ‡∏°", "‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•", "‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠", "‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡∏Å‡πÅ‡∏•‡πâ‡∏ß", "‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏"
    ];
    
    const rewards = [
      [1, "Booster Pack 1 ‡∏ã‡∏≠‡∏á", 50, 0, ""],
      [2, "‡∏•‡∏π‡∏Å‡πÄ‡∏ï‡πã‡∏≤‡∏ò‡∏£‡∏£‡∏°‡∏î‡∏≤ 1 ‡∏ä‡∏∏‡∏î / ‡∏ï‡∏±‡∏ß‡∏ô‡∏±‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ / ‡πÅ‡∏ü‡πâ‡∏°‡∏û‡∏¥‡∏Ñ‡∏≤‡∏ä‡∏π", 20, 0, ""],
      [3, "‡∏•‡∏π‡∏Å‡πÄ‡∏ï‡πã‡∏≤‡∏ô‡∏±‡∏ö‡πÅ‡∏î‡πÄ‡∏°‡∏à / Sleeve DefendD", 15, 0, ""],
      [5, "Deck Case / Outter Sleeves / ‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏û‡∏±‡∏ö‡πÄ‡∏Å‡πá‡∏ö‡∏Å‡∏≤‡∏£‡πå‡∏î", 10, 0, ""],
      [7, "Sleeve Pok√©mon / ‡∏Å‡∏•‡πà‡∏≠‡∏á‡πÉ‡∏™‡πà Playmat / ‡πÅ‡∏ü‡πâ‡∏°‡∏Å‡∏≤‡∏£‡πå‡∏î", 8, 0, ""],
      [10, "Deck Case + Sleeve / ‡∏ä‡∏∏‡∏î‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏£‡∏ß‡∏° / 12 Booster Packs", 5, 0, ""],
      [12, "Deck Case + Sleeve + ‡∏Å‡∏•‡πà‡∏≠‡∏á Playmat / ‡πÅ‡∏ü‡πâ‡∏° + ‡∏•‡∏π‡∏Å‡πÄ‡∏ï‡πã‡∏≤‡∏ô‡∏±‡∏ö‡πÅ‡∏î‡πÄ‡∏°‡∏à + ‡∏ï‡∏±‡∏ß‡∏ô‡∏±‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ / 15 Booster Packs", 3, 0, ""],
      [15, "Booster Box / Playmat", 2, 0, ""]
    ];
    
    pointsSheet.getRange(1, 1, 1, headers.length).setValues([headers]);
    pointsSheet.getRange(2, 1, rewards.length, headers.length).setValues(rewards);
    
    // ‡∏ï‡∏±‡πâ‡∏á‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö
    pointsSheet.getRange(1, 1, 1, headers.length).setBackground("#4285f4").setFontColor("white").setFontWeight("bold");
    pointsSheet.autoResizeColumns(1, headers.length);
    
    Logger.log("‚úÖ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏ï‡πâ‡∏°‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢");
  }
}

// ‚úÖ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
function updateSummaryData() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  let summarySheet = ss.getSheetByName("Summary");
  
  if (!summarySheet) {
    summarySheet = ss.insertSheet("Summary");
  }
  
  const participantsSheet = ss.getSheetByName("Participants");
  const participantsData = participantsSheet.getDataRange().getValues();
  
  // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥
  const totalParticipants = participantsData.length - 1; // ‡∏•‡∏ö‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠
  const uniqueParticipants = new Set(participantsData.slice(1).map(row => normalizePhone(row[5]))).size;
  const duplicateEntries = totalParticipants - uniqueParticipants;
  
  // ‡∏™‡∏£‡∏∏‡∏õ‡∏ï‡∏≤‡∏°‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà
  const dateSummary = {};
  participantsData.slice(1).forEach(row => {
    const date = row[1];
    if (date) {
      dateSummary[date] = (dateSummary[date] || 0) + 1;
    }
  });
  
  // ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏£‡∏∏‡∏õ
  summarySheet.clear();
  summarySheet.getRange(1, 1).setValue("üìä ‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Road to Premier Ball");
  summarySheet.getRange(1, 1).setFontSize(16).setFontWeight("bold");
  
  summarySheet.getRange(3, 1).setValue("‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ú‡∏π‡πâ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î:");
  summarySheet.getRange(3, 2).setValue(totalParticipants);
  
  summarySheet.getRange(4, 1).setValue("‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ú‡∏π‡πâ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÑ‡∏°‡πà‡∏ã‡πâ‡∏≥:");
  summarySheet.getRange(4, 2).setValue(uniqueParticipants);
  
  summarySheet.getRange(5, 1).setValue("‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ã‡πâ‡∏≥:");
  summarySheet.getRange(5, 2).setValue(duplicateEntries);
  
  summarySheet.getRange(7, 1).setValue("üìÖ ‡∏™‡∏£‡∏∏‡∏õ‡∏ï‡∏≤‡∏°‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:");
  summarySheet.getRange(7, 1).setFontWeight("bold");
  
  let row = 8;
  Object.keys(dateSummary).forEach(date => {
    summarySheet.getRange(row, 1).setValue(date);
    summarySheet.getRange(row, 2).setValue(dateSummary[date]);
    row++;
  });
  
  summarySheet.autoResizeColumns(1, 2);
  Logger.log("‚úÖ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢");
}

// ‚úÖ ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏™‡∏°‡∏±‡∏Ñ‡∏£
function showRoadToPremierSummary() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const participantsSheet = ss.getSheetByName("Participants");
  
  if (!participantsSheet) {
    SpreadsheetApp.getUi().alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ä‡∏µ‡∏ó Participants");
    return;
  }
  
  const data = participantsSheet.getDataRange().getValues();
  const totalParticipants = data.length - 1;
  const uniqueParticipants = new Set(data.slice(1).map(row => normalizePhone(row[5]))).size;
  
  const message = `üìä ‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Road to Premier Ball\n\n` +
    `‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ú‡∏π‡πâ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: ${totalParticipants}\n` +
    `‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ú‡∏π‡πâ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÑ‡∏°‡πà‡∏ã‡πâ‡∏≥: ${uniqueParticipants}\n` +
    `‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ã‡πâ‡∏≥: ${totalParticipants - uniqueParticipants}`;
  
  SpreadsheetApp.getUi().alert(message);
}

// ‚úÖ ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏π‡πâ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏ï‡∏≤‡∏°‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà
function showParticipantsByDate() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const participantsSheet = ss.getSheetByName("Participants");
  
  if (!participantsSheet) {
    SpreadsheetApp.getUi().alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ä‡∏µ‡∏ó Participants");
    return;
  }
  
  const data = participantsSheet.getDataRange().getValues();
  const dateSummary = {};
  
  data.slice(1).forEach(row => {
    const date = row[1];
    if (date) {
      dateSummary[date] = (dateSummary[date] || 0) + 1;
    }
  });
  
  let message = "üìÖ ‡∏ú‡∏π‡πâ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏ï‡∏≤‡∏°‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:\n\n";
  Object.keys(dateSummary).forEach(date => {
    message += `${date}: ${dateSummary[date]} ‡∏Ñ‡∏ô\n`;
  });
  
  SpreadsheetApp.getUi().alert(message);
}

// ‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô
function recordMatchResult() {
  const ui = SpreadsheetApp.getUi();
  
  const trainerId = ui.prompt("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô", "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà Trainer ID:", ui.ButtonSet.OK_CANCEL);
  if (trainerId.getSelectedButton() !== ui.Button.OK) return;
  
  const result = ui.alert("‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô", "‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏ä‡∏ô‡∏∞‡∏´‡∏£‡∏∑‡∏≠‡πÅ‡∏û‡πâ?", ui.ButtonSet.YES_NO);
  const isWin = result === ui.Button.YES;
  
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const participantsSheet = ss.getSheetByName("Participants");
  const data = participantsSheet.getDataRange().getValues();
  
  // ‡∏´‡∏≤‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏à‡∏≤‡∏Å Trainer ID
  let playerRow = -1;
  for (let i = 1; i < data.length; i++) {
    if (String(data[i][4]).trim() === trainerId.getResponseText().trim()) {
      playerRow = i + 1;
      break;
    }
  }
  
  if (playerRow === -1) {
    ui.alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô", "‡πÑ‡∏°‡πà‡∏û‡∏ö Trainer ID ‡∏ó‡∏µ‡πà‡∏£‡∏∞‡∏ö‡∏∏");
    return;
  }
  
  // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÅ‡∏ï‡πâ‡∏°
  const currentPoints = Number(data[playerRow - 1][9]) || 0;
  const newPoints = currentPoints + (isWin ? 1 : 0);
  
  participantsSheet.getRange(playerRow, 10).setValue(newPoints);
  
  // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏ô Match Log
  logMatchResult(trainerId.getResponseText(), isWin, newPoints);
  
  ui.alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢", `‡πÅ‡∏ï‡πâ‡∏°‡∏™‡∏∞‡∏™‡∏°‡πÉ‡∏´‡∏°‡πà: ${newPoints}`);
}

// ‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡∏Å‡πÅ‡∏ï‡πâ‡∏°
function recordPointRedemption() {
  const ui = SpreadsheetApp.getUi();
  
  const trainerId = ui.prompt("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡∏Å‡πÅ‡∏ï‡πâ‡∏°", "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà Trainer ID:", ui.ButtonSet.OK_CANCEL);
  if (trainerId.getSelectedButton() !== ui.Button.OK) return;
  
  const points = ui.prompt("‡πÅ‡∏ï‡πâ‡∏°‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ", "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÅ‡∏ï‡πâ‡∏°‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ:", ui.ButtonSet.OK_CANCEL);
  if (points.getSelectedButton() !== ui.Button.OK) return;
  
  const pointsUsed = Number(points.getResponseText());
  if (isNaN(pointsUsed) || pointsUsed <= 0) {
    ui.alert("‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á", "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÅ‡∏ï‡πâ‡∏°‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÅ‡∏•‡∏∞‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 0");
    return;
  }
  
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const participantsSheet = ss.getSheetByName("Participants");
  const data = participantsSheet.getDataRange().getValues();
  
  // ‡∏´‡∏≤‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏à‡∏≤‡∏Å Trainer ID
  let playerRow = -1;
  for (let i = 1; i < data.length; i++) {
    if (String(data[i][4]).trim() === trainerId.getResponseText().trim()) {
      playerRow = i + 1;
      break;
    }
  }
  
  if (playerRow === -1) {
    ui.alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô", "‡πÑ‡∏°‡πà‡∏û‡∏ö Trainer ID ‡∏ó‡∏µ‡πà‡∏£‡∏∞‡∏ö‡∏∏");
    return;
  }
  
  const currentPoints = Number(data[playerRow - 1][9]) || 0;
  if (currentPoints < pointsUsed) {
    ui.alert("‡πÅ‡∏ï‡πâ‡∏°‡πÑ‡∏°‡πà‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏û‡∏≠", `‡πÅ‡∏ï‡πâ‡∏°‡∏ó‡∏µ‡πà‡∏°‡∏µ: ${currentPoints}, ‡πÅ‡∏ï‡πâ‡∏°‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ: ${pointsUsed}`);
    return;
  }
  
  // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÅ‡∏ï‡πâ‡∏°
  const newPoints = currentPoints - pointsUsed;
  participantsSheet.getRange(playerRow, 10).setValue(newPoints);
  
  // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏ô Redemption Log
  logPointRedemption(trainerId.getResponseText(), pointsUsed, newPoints);
  
  ui.alert("‡πÅ‡∏•‡∏Å‡πÅ‡∏ï‡πâ‡∏°‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢", `‡πÅ‡∏ï‡πâ‡∏°‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠: ${newPoints}`);
}

// ‚úÖ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÅ‡∏ï‡πâ‡∏°‡∏™‡∏∞‡∏™‡∏°
function updatePoints() {
  const ui = SpreadsheetApp.getUi();
  
  const trainerId = ui.prompt("‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÅ‡∏ï‡πâ‡∏°‡∏™‡∏∞‡∏™‡∏°", "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà Trainer ID:", ui.ButtonSet.OK_CANCEL);
  if (trainerId.getSelectedButton() !== ui.Button.OK) return;
  
  const points = ui.prompt("‡πÅ‡∏ï‡πâ‡∏°‡∏™‡∏∞‡∏™‡∏°‡πÉ‡∏´‡∏°‡πà", "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÅ‡∏ï‡πâ‡∏°‡∏™‡∏∞‡∏™‡∏°:", ui.ButtonSet.OK_CANCEL);
  if (points.getSelectedButton() !== ui.Button.OK) return;
  
  const newPoints = Number(points.getResponseText());
  if (isNaN(newPoints) || newPoints < 0) {
    ui.alert("‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á", "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÅ‡∏ï‡πâ‡∏°‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÅ‡∏•‡∏∞‡πÑ‡∏°‡πà‡∏ô‡πâ‡∏≠‡∏¢‡∏Å‡∏ß‡πà‡∏≤ 0");
    return;
  }
  
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const participantsSheet = ss.getSheetByName("Participants");
  const data = participantsSheet.getDataRange().getValues();
  
  // ‡∏´‡∏≤‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏à‡∏≤‡∏Å Trainer ID
  let playerRow = -1;
  for (let i = 1; i < data.length; i++) {
    if (String(data[i][4]).trim() === trainerId.getResponseText().trim()) {
      playerRow = i + 1;
      break;
    }
  }
  
  if (playerRow === -1) {
    ui.alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô", "‡πÑ‡∏°‡πà‡∏û‡∏ö Trainer ID ‡∏ó‡∏µ‡πà‡∏£‡∏∞‡∏ö‡∏∏");
    return;
  }
  
  const oldPoints = Number(data[playerRow - 1][9]) || 0;
  participantsSheet.getRange(playerRow, 10).setValue(newPoints);
  
  // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏ô Points Log
  logPointsUpdate(trainerId.getResponseText(), oldPoints, newPoints);
  
  ui.alert("‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÅ‡∏ï‡πâ‡∏°‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢", `‡πÅ‡∏ï‡πâ‡∏°‡πÄ‡∏î‡∏¥‡∏°: ${oldPoints}, ‡πÅ‡∏ï‡πâ‡∏°‡πÉ‡∏´‡∏°‡πà: ${newPoints}`);
}

// ‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô
function logMatchResult(trainerId, isWin, newPoints) {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  let matchLogSheet = ss.getSheetByName("Match Log");
  
  if (!matchLogSheet) {
    matchLogSheet = ss.insertSheet("Match Log");
    const headers = ["‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà/‡πÄ‡∏ß‡∏•‡∏≤", "Trainer ID", "‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô", "‡πÅ‡∏ï‡πâ‡∏°‡∏™‡∏∞‡∏™‡∏°‡πÉ‡∏´‡∏°‡πà"];
    matchLogSheet.getRange(1, 1, 1, headers.length).setValues([headers]);
    matchLogSheet.getRange(1, 1, 1, headers.length).setBackground("#4285f4").setFontColor("white").setFontWeight("bold");
  }
  
  const now = Utilities.formatDate(new Date(), Session.getScriptTimeZone(), "dd/MM/yyyy HH:mm:ss");
  const result = isWin ? "‡∏ä‡∏ô‡∏∞" : "‡πÅ‡∏û‡πâ";
  
  const newRow = [now, trainerId, result, newPoints];
  const newRowIndex = matchLogSheet.getLastRow() + 1;
  matchLogSheet.getRange(newRowIndex, 1, 1, newRow.length).setValues([newRow]);
  matchLogSheet.getRange(newRowIndex, 1).setNumberFormat("@");
}

// ‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡∏Å‡πÅ‡∏ï‡πâ‡∏°
function logPointRedemption(trainerId, pointsUsed, remainingPoints) {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  let redemptionLogSheet = ss.getSheetByName("Redemption Log");
  
  if (!redemptionLogSheet) {
    redemptionLogSheet = ss.insertSheet("Redemption Log");
    const headers = ["‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà/‡πÄ‡∏ß‡∏•‡∏≤", "Trainer ID", "‡πÅ‡∏ï‡πâ‡∏°‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ", "‡πÅ‡∏ï‡πâ‡∏°‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠"];
    redemptionLogSheet.getRange(1, 1, 1, headers.length).setValues([headers]);
    redemptionLogSheet.getRange(1, 1, 1, headers.length).setBackground("#4285f4").setFontColor("white").setFontWeight("bold");
  }
  
  const now = Utilities.formatDate(new Date(), Session.getScriptTimeZone(), "dd/MM/yyyy HH:mm:ss");
  const newRow = [now, trainerId, pointsUsed, remainingPoints];
  const newRowIndex = redemptionLogSheet.getLastRow() + 1;
  redemptionLogSheet.getRange(newRowIndex, 1, 1, newRow.length).setValues([newRow]);
  redemptionLogSheet.getRange(newRowIndex, 1).setNumberFormat("@");
}

// ‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÅ‡∏ï‡πâ‡∏°
function logPointsUpdate(trainerId, oldPoints, newPoints) {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  let pointsLogSheet = ss.getSheetByName("Points Log");
  
  if (!pointsLogSheet) {
    pointsLogSheet = ss.insertSheet("Points Log");
    const headers = ["‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà/‡πÄ‡∏ß‡∏•‡∏≤", "Trainer ID", "‡πÅ‡∏ï‡πâ‡∏°‡πÄ‡∏î‡∏¥‡∏°", "‡πÅ‡∏ï‡πâ‡∏°‡πÉ‡∏´‡∏°‡πà", "‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á"];
    pointsLogSheet.getRange(1, 1, 1, headers.length).setValues([headers]);
    pointsLogSheet.getRange(1, 1, 1, headers.length).setBackground("#4285f4").setFontColor("white").setFontWeight("bold");
  }
  
  const now = Utilities.formatDate(new Date(), Session.getScriptTimeZone(), "dd/MM/yyyy HH:mm:ss");
  const change = newPoints - oldPoints;
  const changeText = change > 0 ? `+${change}` : String(change);
  
  const newRow = [now, trainerId, oldPoints, newPoints, changeText];
  const newRowIndex = pointsLogSheet.getLastRow() + 1;
  pointsLogSheet.getRange(newRowIndex, 1, 1, newRow.length).setValues([newRow]);
  pointsLogSheet.getRange(newRowIndex, 1).setNumberFormat("@");
}

// ‚úÖ ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ã‡πâ‡∏≥
function clearDuplicateEntries() {
  const ui = SpreadsheetApp.getUi();
  const result = ui.alert("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö", "‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ã‡πâ‡∏≥‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?", ui.ButtonSet.YES_NO);
  
  if (result !== ui.Button.YES) return;
  
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const participantsSheet = ss.getSheetByName("Participants");
  const data = participantsSheet.getDataRange().getValues();
  
  const uniqueEntries = [];
  const seenPhones = new Set();
  const seenTrainerIds = new Set();
  
  // ‡πÄ‡∏Å‡πá‡∏ö‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠
  uniqueEntries.push(data[0]);
  
  // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ã‡πâ‡∏≥
  for (let i = 1; i < data.length; i++) {
    const phone = normalizePhone(data[i][5]);
    const trainerId = String(data[i][4]).trim();
    
    if (!seenPhones.has(phone) && !seenTrainerIds.has(trainerId)) {
      uniqueEntries.push(data[i]);
      seenPhones.add(phone);
      seenTrainerIds.add(trainerId);
    }
  }
  
  // ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà
  participantsSheet.clear();
  participantsSheet.getRange(1, 1, uniqueEntries.length, uniqueEntries[0].length).setValues(uniqueEntries);
  
  // ‡∏ï‡∏±‡πâ‡∏á‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö
  participantsSheet.getRange(1, 1, 1, uniqueEntries[0].length).setBackground("#4285f4").setFontColor("white").setFontWeight("bold");
  participantsSheet.autoResizeColumns(1, uniqueEntries[0].length);
  
  ui.alert("‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ã‡πâ‡∏≥‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢", `‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ã‡πâ‡∏≥ ${data.length - uniqueEntries.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`);
}

// ‚úÖ ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏™‡∏°‡∏±‡∏Ñ‡∏£
function removeParticipant() {
  const ui = SpreadsheetApp.getUi();
  
  const trainerId = ui.prompt("‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏™‡∏°‡∏±‡∏Ñ‡∏£", "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà Trainer ID:", ui.ButtonSet.OK_CANCEL);
  if (trainerId.getSelectedButton() !== ui.Button.OK) return;
  
  const result = ui.alert("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö", `‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ${trainerId.getResponseText()} ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`, ui.ButtonSet.YES_NO);
  if (result !== ui.Button.YES) return;
  
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const participantsSheet = ss.getSheetByName("Participants");
  const data = participantsSheet.getDataRange().getValues();
  
  // ‡∏´‡∏≤‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏à‡∏≤‡∏Å Trainer ID
  let playerRow = -1;
  for (let i = 1; i < data.length; i++) {
    if (String(data[i][4]).trim() === trainerId.getResponseText().trim()) {
      playerRow = i + 1;
      break;
    }
  }
  
  if (playerRow === -1) {
    ui.alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô", "‡πÑ‡∏°‡πà‡∏û‡∏ö Trainer ID ‡∏ó‡∏µ‡πà‡∏£‡∏∞‡∏ö‡∏∏");
    return;
  }
  
  // ‡∏•‡∏ö‡πÅ‡∏ñ‡∏ß
  participantsSheet.deleteRow(playerRow);
  
  ui.alert("‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢", `‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ${trainerId.getResponseText()} ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢`);
}

// ‚úÖ ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡πÅ‡∏ï‡πâ‡∏°‡∏™‡∏∞‡∏™‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
function resetAllPoints() {
  const ui = SpreadsheetApp.getUi();
  const result = ui.alert("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï", "‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡πÅ‡∏ï‡πâ‡∏°‡∏™‡∏∞‡∏™‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÄ‡∏õ‡πá‡∏ô 0 ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?", ui.ButtonSet.YES_NO);
  
  if (result !== ui.Button.YES) return;
  
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const participantsSheet = ss.getSheetByName("Participants");
  const data = participantsSheet.getDataRange().getValues();
  
  // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡πÅ‡∏ï‡πâ‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÄ‡∏õ‡πá‡∏ô 0
  for (let i = 2; i <= participantsSheet.getLastRow(); i++) {
    participantsSheet.getRange(i, 10).setValue(0);
  }
  
  ui.alert("‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡πÅ‡∏ï‡πâ‡∏°‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢", "‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡πÅ‡∏ï‡πâ‡∏°‡∏™‡∏∞‡∏™‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÄ‡∏õ‡πá‡∏ô 0 ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢");
}

// ‚úÖ ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
function exportData() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const participantsSheet = ss.getSheetByName("Participants");
  
  if (!participantsSheet) {
    SpreadsheetApp.getUi().alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ä‡∏µ‡∏ó Participants");
    return;
  }
  
  const data = participantsSheet.getDataRange().getValues();
  const csvContent = data.map(row => row.join(",")).join("\n");
  
  // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå CSV
  const blob = Utilities.newBlob(csvContent, "text/csv", "Road_to_Premier_Ball_Participants.csv");
  
  // ‡∏™‡πà‡∏á‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÑ‡∏ü‡∏•‡πå CSV
  const adminEmail = Session.getActiveUser().getEmail();
  MailApp.sendEmail({
    to: adminEmail,
    subject: "üìä ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏™‡∏°‡∏±‡∏Ñ‡∏£ Road to Premier Ball",
    body: "‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏™‡∏°‡∏±‡∏Ñ‡∏£ Road to Premier Ball ‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏£‡πâ‡∏≠‡∏á‡∏Ç‡∏≠",
    attachments: [blob]
  });
  
  SpreadsheetApp.getUi().alert("‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢", "‡∏™‡πà‡∏á‡πÑ‡∏ü‡∏•‡πå CSV ‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÅ‡∏•‡πâ‡∏ß");
}

// ‚úÖ ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Trigger ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
function setupRoadToPremierTrigger() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  
  // ‡∏•‡∏ö trigger ‡πÄ‡∏î‡∏¥‡∏°
  const triggers = ScriptApp.getProjectTriggers();
  triggers.forEach(trigger => {
    if (trigger.getHandlerFunction() === "onFormSubmit") {
      ScriptApp.deleteTrigger(trigger);
    }
  });
  
  // ‡∏™‡∏£‡πâ‡∏≤‡∏á trigger ‡πÉ‡∏´‡∏°‡πà
  ScriptApp.newTrigger("onFormSubmit")
    .for(ss)
    .onFormSubmit()
    .create();
  
  SpreadsheetApp.getUi().alert("‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Trigger ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢", "‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Trigger ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢");
}

// ‚úÖ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ Triggers
function checkTriggerStatus() {
  const triggers = ScriptApp.getProjectTriggers();
  let message = "üìä ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ Triggers:\n\n";
  
  if (triggers.length === 0) {
    message += "‡πÑ‡∏°‡πà‡∏°‡∏µ Trigger ‡∏ó‡∏µ‡πà‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÑ‡∏ß‡πâ";
  } else {
    triggers.forEach((trigger, index) => {
      message += `${index + 1}. ${trigger.getHandlerFunction()}\n`;
      message += `   Event: ${trigger.getEventType()}\n`;
      message += `   Source: ${trigger.getTriggerSource()}\n\n`;
    });
  }
  
  SpreadsheetApp.getUi().alert("‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ Triggers", message);
}

// ‚úÖ API ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö - ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏™‡∏°‡∏±‡∏Ñ‡∏£ Road to Premier Ball
function doGet(e) {
  try {
    const action = e.parameter.func || 'getParticipants';
    
    switch(action) {
      case 'getParticipants':
        return getParticipantsData();
      case 'getParticipantsByDate':
        return getParticipantsByDate(e.parameter.date);
      case 'getSummary':
        return getSummaryData();
      default:
        return ContentService
          .createTextOutput(JSON.stringify({
            status: "error",
            message: "Unknown function"
          }))
          .setMimeType(ContentService.MimeType.JSON);
    }
  } catch (error) {
    return ContentService
      .createTextOutput(JSON.stringify({
        status: "error",
        message: error.toString()
      }))
      .setMimeType(ContentService.MimeType.JSON);
  }
}

// ‚úÖ ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
function getParticipantsData() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  
  // ‡∏•‡∏≠‡∏á‡∏´‡∏≤ Form Responses sheet ‡∏Å‡πà‡∏≠‡∏ô
  let participantsSheet = ss.getSheetByName("Form Responses 1");
  
  if (!participantsSheet) {
    // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ Form Responses ‡∏•‡∏≠‡∏á‡∏´‡∏≤ Participants
    participantsSheet = ss.getSheetByName("Participants");
  }
  
  if (!participantsSheet) {
    // ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ ‡πÉ‡∏´‡πâ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ä‡∏µ‡∏ó Participants
    participantsSheet = createParticipantsSheet();
  }
  
  const data = participantsSheet.getDataRange().getValues();
  if (data.length <= 1) {
    return ContentService
      .createTextOutput(JSON.stringify({
        status: "success",
        participants: [],
        total: 0
      }))
      .setMimeType(ContentService.MimeType.JSON);
  }
  
  const headers = data[0];
  const participants = [];
  
  for (let i = 1; i < data.length; i++) {
    const row = data[i];
    const participant = {
      timestamp: row[0],
      registrationDate: row[1],
      fullName: row[2],
      nickname: row[3],
      trainerId: row[4],
      phone: row[5],
      playLevel: row[6],
      termsConfirmed: row[7],
      status: row[8] || "OK",
      points: row[9] || 0
    };
    participants.push(participant);
  }
  
  return ContentService
    .createTextOutput(JSON.stringify({
      status: "success",
      participants: participants,
      total: participants.length
    }))
    .setMimeType(ContentService.MimeType.JSON);
}

// ‚úÖ ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏ï‡∏≤‡∏°‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà
function getParticipantsByDate(date) {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const participantsSheet = ss.getSheetByName("Participants");
  
  if (!participantsSheet) {
    return ContentService
      .createTextOutput(JSON.stringify({
        status: "error",
        message: "Participants sheet not found"
      }))
      .setMimeType(ContentService.MimeType.JSON);
  }
  
  const data = participantsSheet.getDataRange().getValues();
  const participants = [];
  
  for (let i = 1; i < data.length; i++) {
    const row = data[i];
    if (row[1] === date) { // ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô
      const participant = {
        nickname: row[3],
        phone: row[5],
        level: row[6],
        trainerId: row[4],
        points: row[9] || 0
      };
      participants.push(participant);
    }
  }
  
  retu