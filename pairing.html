<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pairing | Up Level Guild</title>
  <link rel="stylesheet" href="style.css">
  <style>
    .pairing-container {
      max-width: 900px;
      margin: 32px auto;
      background: rgba(255,255,255,0.97);
      border-radius: 20px;
      box-shadow: 0 20px 40px rgba(0,0,0,0.10);
      padding: 2rem 1rem 2.5rem 1rem;
    }
    .accordion {
      border-radius: 12px;
      margin-bottom: 1.2rem;
      box-shadow: 0 4px 16px rgba(100,100,200,0.07);
      background: #f7f8fa;
      overflow: hidden;
    }
    .accordion-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: linear-gradient(90deg, #667eea 60%, #f7fafc 100%);
      color: #fff;
      font-weight: 700;
      font-size: 1.15rem;
      padding: 1rem 1.2rem;
      cursor: pointer;
      border: none;
      outline: none;
      transition: background 0.2s;
    }
    .accordion-header.collapsed {
      background: #e0e7ff;
      color: #333;
    }
    .accordion-content {
      display: none;
      background: #fff;
      padding: 0 1.2rem 1.2rem 1.2rem;
      animation: fadeIn 0.3s;
    }
    .accordion-content.active {
      display: block;
    }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    .pairing-list {
      display: flex;
      flex-direction: column;
      gap: 1.1rem;
      margin-top: 1.2rem;
    }
    .pairing-card {
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 14px;
      box-shadow: 0 2px 8px rgba(100,100,200,0.07);
      padding: 1.1rem 0.7rem;
      font-size: 1.13rem;
      gap: 0.7rem;
      flex-wrap: wrap;
      position: relative;
      background: var(--pairing-bg, #f8fafc);
      transition: background 0.2s;
    }
    .pairing-table-no {
      background: #667eea;
      color: #fff;
      font-weight: 700;
      border-radius: 8px;
      padding: 0.4em 1em;
      min-width: 70px;
      max-width: 70px;
      text-align: center;
      font-size: 1.1em;
      margin-right: 1.1em;
      flex-shrink: 0;
    }
    .player-block {
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 8px;
      padding: 0.2em 0.7em;
      margin: 0 0.2em;
      min-width: 120px;
      max-width: 180px;
      box-sizing: border-box;
      font-weight: 700;
      font-size: 1.1em;
      transition: background 0.2s;
      text-align: center;
      flex-shrink: 1;
      flex-grow: 1;
    }
    .player-bg-win {
      background: #e0f2fe !important;
      box-shadow: 0 2px 8px #bae6fd;
    }
    .player-bg-loss {
      background: #fee2e2 !important;
      box-shadow: 0 2px 8px #fecaca;
    }
    .player-bg-draw {
      background: #fef9c3 !important;
      box-shadow: 0 2px 8px #fde68a;
    }
    .player-emoji {
      font-size: 1.1em;
      margin-right: 0.3em;
      margin-left: -0.2em;
    }
    .codename-rank {
      display: inline-flex;
      align-items: center;
      gap: 0.18em;
      font-size: 1em;
    }
    .vs {
      font-size: 1.1em;
      color: #888;
      margin: 0 0.7em;
      font-weight: 600;
      min-width: 32px;
      text-align: center;
    }
    .pairing-result {
      font-size: 1.35em;
      font-weight: 700;
      color: #4f46e5;
      background: #e0e7ff;
      border-radius: 8px;
      padding: 0.2em 1.1em;
      min-width: 70px;
      text-align: center;
      box-shadow: 0 2px 8px #e0e7ff;
      margin: 0 1.1em;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .pairing-wait {
      color: #aaa;
      font-size: 1.1em;
      font-weight: 500;
      margin: 0 1em;
      min-width: 70px;
      text-align: center;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    @media (max-width: 768px) {
      .pairing-container { padding: 0.5rem; }
      .accordion-header { font-size: 1rem; padding: 0.7rem 0.7rem; }
      .pairing-card { font-size: 0.98rem; padding: 0.7rem 0.2rem; }
      .pairing-table-no { font-size: 0.98em; min-width: 50px; max-width: 50px; }
      .player-block { font-size: 1em; min-width: 70px; max-width: 120px; }
      .pairing-result, .pairing-wait { font-size: 1.1em; min-width: 50px; }
    }
  </style>
</head>
<body>
  <a href="index.html" class="home-button" title="‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å"></a>
  <div class="pairing-container">
    <div style="text-align:center; margin-bottom: 1.5rem;">
      <img src="https://i.postimg.cc/wjzpnxjB/Up-Level-01-1.png" alt="Up Level Guild Logo" style="width:110px; filter: drop-shadow(0 4px 8px rgba(0,0,0,0.18)); margin-bottom: 0.5rem;">
      <h1 style="font-size:2.1rem; font-weight:700; margin:0; color:#4f46e5;">Pairing - Up Level Guild</h1>
      <div style="color:#666; font-size:1.05rem; margin-top:0.3rem;">‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà‡∏Å‡∏≤‡∏£‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô Pokemon TCG</div>
    </div>
    <div id="pairing-accordion">
      <div style="text-align:center; color:#888; padding:2rem;" id="loading">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div>
    </div>
  </div>
  <script>
    const API_URL = 'https://script.google.com/macros/s/AKfycbwVoGEvUEmeIkC-e2aPSrF7T82HqOpMwByW-SSbv7EohQ_zG2EbA2uv5TyPnqhuy5rmrg/exec';
    const MEMBER_API = "https://script.google.com/macros/s/AKfycbxtjsDwHI6nJU4OIHExUxMaZwUn3qwakvdkzwbQO7C8Trzz5Gh84SX6F1gqb4BOFQcn/exec?func=getMemberDashboardData";

    const rankEmojis = {
      "Rookie": "üê£",
      "Bronze": "üõ°Ô∏è",
      "Silver": "‚öîÔ∏è",
      "Gold": "ü•á",
      "Platinum": "‚ú®",
      "Diamond": "üíé",
      "Grandmaster": "üëë",
      "Legend": "üêâ"
    };

    function buildPhoneMap(members) {
      const map = {};
      members.forEach(m => {
        const phone = String(m.phone || m["Player Phone"] || m["Phone"]).replace(/\D/g, "");
        if (phone) map[phone] = { codename: m.codename || m["Codename"], rank: m.rank || m["Rank"] };
      });
      return map;
    }

    function getTelById(players, id) {
      for (let i = 1; i < players.length; i++) {
        if (String(players[i][0]) === String(id)) {
          return players[i][2];
        }
      }
      return null;
    }

    // ‡πÄ‡∏≠‡∏ü‡πÄ‡∏ü‡∏Å‡∏ï‡πå codename ‡∏ï‡∏≤‡∏°‡πÅ‡∏£‡∏á‡∏Ñ‡πå (‡πÅ‡∏ö‡∏ö gymstanding)
    function renderCodenameEffect(codename, rank) {
      if (!codename) return '';
      if (rank === 'Gold') {
        return `<span class="codename wave gold">${codename}</span>`;
      } else if (rank === 'Platinum') {
        return `<span class="codename wave platinum">${codename}</span>`;
      } else if (rank === 'Diamond') {
        return `<span class="codename wave diamond">${codename}</span>`;
      } else if (rank === 'Grandmaster') {
        return `<span class="codename wave grandmaster">${codename}</span>`;
      } else if (rank === 'Legend') {
        return `<span class="codename wave legend">${codename}</span>`;
      } else {
        return `<span class="codename">${codename}</span>`;
      }
    }

    async function renderPairing(pairing, players, phoneMap) {
      // Group by round
      const header = pairing[0];
      const rounds = {};
      for (let i = 1; i < pairing.length; i++) {
        const row = pairing[i];
        const round = row[0];
        if (!rounds[round]) rounds[round] = [];
        rounds[round].push(row);
      }
      // Sort round keys
      const roundKeys = Object.keys(rounds).sort((a,b)=>a-b);
      // ‡∏û‡∏≤‡∏™‡πÄ‡∏ó‡∏•‡∏™‡∏µ‡∏™‡∏•‡∏±‡∏ö
      const pastelColors = ["#f0f9ff", "#f3e8ff", "#fef9c3", "#ffe4e6", "#f1f5f9", "#fce7f3"];
      // Accordion
      let html = '';
      for (let r of roundKeys) {
        html += `<div class="accordion">
          <button class="accordion-header collapsed" onclick="toggleAccordion(this)">‡∏£‡∏≠‡∏ö‡∏ó‡∏µ‡πà ${r} (${rounds[r].length} ‡∏Ñ‡∏π‡πà) <span style='font-size:1.2em;'>&#x25BC;</span></button>
          <div class="accordion-content">
            <div class="pairing-list">`;
        rounds[r].forEach((row, idx) => {
          // [ROUND, TABLE, P1_ID, PLAYER 1, WIN_P1, DRAW, WIN_P2, P2_ID, PLAYER 2, RESULT, STATUS, Drop]
          const tableNo = row[1];
          const p1Tel = getTelById(players, row[2]);
          const p2Tel = getTelById(players, row[7]);
          const p1Phone = p1Tel?.replace(/\D/g,"");
          const p2Phone = p2Tel?.replace(/\D/g,"");
          const p1Codename = phoneMap[p1Phone]?.codename;
          const p2Codename = phoneMap[p2Phone]?.codename;
          const p1Rank = phoneMap[p1Phone]?.rank;
          const p2Rank = phoneMap[p2Phone]?.rank;
          let p1Block = '';
          let p2Block = '';
          let p1Class = 'player-block';
          let p2Class = 'player-block';
          let p1Emoji = '';
          let p2Emoji = '';
          let result = row[9];
          let resultDisplay = '';
          if (result === '1:0') {
            p1Class += ' player-bg-win';
            p2Class += ' player-bg-loss';
            p1Emoji = '<span class="player-emoji">üèÜ</span>';
            p2Emoji = '<span class="player-emoji">üò¢</span>';
            resultDisplay = '<span class="pairing-result">1 : 0</span>';
          } else if (result === '0:1') {
            p1Class += ' player-bg-loss';
            p2Class += ' player-bg-win';
            p1Emoji = '<span class="player-emoji">üò¢</span>';
            p2Emoji = '<span class="player-emoji">üèÜ</span>';
            resultDisplay = '<span class="pairing-result">0 : 1</span>';
          } else if (result === '1:1') {
            p1Class += ' player-bg-draw';
            p2Class += ' player-bg-draw';
            p1Emoji = '<span class="player-emoji">ü§ù</span>';
            p2Emoji = '<span class="player-emoji">ü§ù</span>';
            resultDisplay = '<span class="pairing-result" style="color:#f59e42;">1 : 1</span>';
          } else {
            resultDisplay = '<span class="pairing-wait">‡∏£‡∏≠‡∏ú‡∏•</span>';
          }
          p1Block = `<span class="codename-rank" data-rank="${p1Rank||''}">${rankEmojis[p1Rank]||''} ${p1Emoji}${p1Codename ? renderCodenameEffect(p1Codename, p1Rank) : row[3]} ${rankEmojis[p1Rank]||''}</span>`;
          p2Block = `<span class="codename-rank" data-rank="${p2Rank||''}">${rankEmojis[p2Rank]||''} ${p2Codename ? renderCodenameEffect(p2Codename, p2Rank) : row[8]} ${p2Emoji}${rankEmojis[p2Rank]||''}</span>`;
          const pastel = pastelColors[idx % pastelColors.length];
          html += `<div class="pairing-card" style="--pairing-bg: ${pastel}">
            <span class="pairing-table-no">‡πÇ‡∏ï‡πä‡∏∞ ${tableNo}</span>
            <span class="${p1Class}">${p1Block}</span>
            <span class="pairing-result">${resultDisplay}</span>
            <span class="${p2Class}">${p2Block}</span>
          </div>`;
        });
        html += '</div></div></div>';
      }
      document.getElementById('pairing-accordion').innerHTML = html;
      // Hide all but last round
      const acc = document.querySelectorAll('.accordion');
      acc.forEach((a,i)=>{
        const content = a.querySelector('.accordion-content');
        const header = a.querySelector('.accordion-header');
        if(i!==acc.length-1) {
          content.style.display = 'none';
          header.classList.add('collapsed');
        } else {
          content.style.display = 'block';
          header.classList.remove('collapsed');
        }
      });
    }

    function toggleAccordion(btn) {
      const content = btn.nextElementSibling;
      const isOpen = content.style.display==='block';
      document.querySelectorAll('.accordion-content').forEach(c=>c.style.display='none');
      document.querySelectorAll('.accordion-header').forEach(h=>h.classList.add('collapsed'));
      if(!isOpen) {
        content.style.display = 'block';
        btn.classList.remove('collapsed');
      }
    }

    async function loadData() {
      document.getElementById('loading').style.display = 'block';
      try {
        const [pairingRes, memberRes] = await Promise.all([
          fetch(API_URL),
          fetch(MEMBER_API)
        ]);
        const pairingData = await pairingRes.json();
        const members = await memberRes.json();
        const phoneMap = buildPhoneMap(members);
        renderPairing(pairingData.pairing, pairingData.players, phoneMap);
      } catch (e) {
        document.getElementById('pairing-accordion').innerHTML = '<div style="color:#e11d48;text-align:center;padding:2rem;">‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ</div>';
      }
      document.getElementById('loading').style.display = 'none';
    }

    loadData();
  </script>
</body>
</html> 