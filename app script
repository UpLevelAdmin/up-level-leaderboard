// ‚úÖ Up Level Guild System - ‡πÄ‡∏°‡∏ô‡∏π‡∏´‡∏•‡∏±‡∏Å‡πÅ‡∏•‡∏∞‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£

function onOpen() {
  const ui = SpreadsheetApp.getUi();
  ui.createMenu("‚¨ÜÔ∏è Up Level Guild")
    // üéâ ‡πÄ‡∏°‡∏ô‡∏π‡∏õ‡∏≤‡∏£‡πå‡∏ï‡∏µ‡πâ
    .addItem("üìä ‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏≤‡∏£‡πå‡∏ï‡∏µ‡πâ", "showPartySummary")
    .addItem("‚ú® ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏õ‡∏≤‡∏£‡πå‡∏ï‡∏µ‡πâ (‡∏à‡∏≤‡∏Å‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£)", "createParty")
    .addItem("‚ûï ‡πÄ‡∏ä‡∏¥‡∏ç‡πÄ‡∏Ç‡πâ‡∏≤‡∏õ‡∏≤‡∏£‡πå‡∏ï‡∏µ‡πâ", "addMemberToParty")
    .addItem("‚ùå ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏õ‡∏≤‡∏£‡πå‡∏ï‡∏µ‡πâ", "removeFromParty")
    .addItem("üîÅ ‡∏¢‡πâ‡∏≤‡∏¢‡∏õ‡∏≤‡∏£‡πå‡∏ï‡∏µ‡πâ", "moveToAnotherParty")
    .addItem("üí• ‡∏¢‡∏∏‡∏ö‡∏õ‡∏≤‡∏£‡πå‡∏ï‡∏µ‡πâ", "disbandParty")
    
    .addSeparator()

    // ‚öîÔ∏è EXP & Party Point
    .addItem("üì• ‡πÄ‡∏û‡∏¥‡πà‡∏° EXP & Party Point ‡∏à‡∏≤‡∏Å‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° (1 ‡∏Ñ‡∏ô)", "addExpFromActivity")
    .addItem("üì• ‡πÄ‡∏û‡∏¥‡πà‡∏° EXP & Party Point ‡∏à‡∏≤‡∏Å‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° (‡∏´‡∏•‡∏≤‡∏¢‡∏Ñ‡∏ô)", "addExpFromActivityBulk")
    .addItem("üü¢ ‡πÄ‡∏û‡∏¥‡πà‡∏° EXP ‡πÅ‡∏ö‡∏ö Manual", "manualAddExp")
    .addItem("üß© ‡πÄ‡∏û‡∏¥‡πà‡∏° Party Point ‡πÅ‡∏ö‡∏ö Manual", "manualAddPartyPoint")
    .addItem("üéÅ ‡πÅ‡∏•‡∏Å‡πÅ‡∏ï‡πâ‡∏° Party Point", "redeemPartyPoint")
    .addItem("‚úÖ ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÄ‡∏Ñ‡∏ß‡∏™ (‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏ö‡∏≠‡∏£‡πå)", "approveQuestByPhone")
    .addItem("‚Ü©Ô∏è ‡∏¢‡πâ‡∏≠‡∏ô EXP ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î (1 ‡∏Ñ‡∏ô)", "undoLastExpSingle")
    .addItem("‚Ü©Ô∏è ‡∏¢‡πâ‡∏≠‡∏ô EXP ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î (‡∏´‡∏•‡∏≤‡∏¢‡∏Ñ‡∏ô)", "undoLastExpBulk")
    .addItem("‚úÖ ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏Ñ‡∏≥‡∏ó‡πâ‡∏≤", "approveChallenge")
    .addItem("‚úÖ ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ Party vs Party", "approvePartyChallenge") // <-- ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏õ‡∏∏‡πà‡∏°‡∏ô‡∏µ‡πâ
    .addItem("üìä ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ó‡πâ‡∏≤‡πÅ‡∏Ç‡πà‡∏á", "recordChallengeResult")
    .addItem("üèÜ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏• Party vs Party", "recordPartyChallengeResult") // üÜï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏°‡∏ô‡∏π‡πÉ‡∏´‡∏°‡πà

    .addSeparator()

    // üõ†Ô∏è ‡∏£‡∏∞‡∏ö‡∏ö & ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
    .addItem("üéØ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Rank", "updateRanks")
    .addItem("üèÜ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Leaderboard", "updateLeaderboard")
    .addItem("üóëÔ∏è ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ã‡πâ‡∏≥", "clearDuplicateEntriesDebug")
    .addItem("‚ùå ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å", "removeMember")
    .addItem("üîë ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡πÉ‡∏´‡∏°‡πà", "addAdminEmail")
    .addItem("üîÑ ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å", "changeMemberPhoneNumber") // üÜï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏°‡∏ô‡∏π‡πÉ‡∏´‡∏°‡πà
    .addToUi();
}

/**
 * Checks if the given email belongs to an admin.
 * Admins are defined in the 'Admin Settings' sheet.
 * Uses CacheService to reduce sheet reads.
 * @param {string} email The email to check.
 * @returns {boolean} True if the user is an admin.
 */
function isAdmin(email) {
  if (!email) {
    return false;
  }
  
  const cache = CacheService.getScriptCache();
  const CACHE_KEY = 'admin_emails';
  let cachedAdmins = cache.get(CACHE_KEY);
  
  if (cachedAdmins) {
    const adminList = JSON.parse(cachedAdmins);
    return adminList.includes(email.toLowerCase());
  }

  try {
    const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName("Admin Settings");
    if (!sheet) {
      console.log("Admin Settings sheet not found. No users will be considered admins.");
      return false;
    }
    const adminEmails = sheet.getRange("A:A").getValues()
                          .flat()
                          .map(e => String(e).trim().toLowerCase())
                          .filter(e => e); 

    if (adminEmails.length > 0) {
      // Cache for 1 hour
      cache.put(CACHE_KEY, JSON.stringify(adminEmails), 3600);
    }
    
    return adminEmails.includes(email.toLowerCase());

  } catch (e) {
    console.error("Error checking admin status: " + e.toString());
    return false;
  }
}

/**
 * Adds a new email to the admin list.
 * Only an existing admin can perform this action.
 */
function addAdminEmail() {
  const ui = SpreadsheetApp.getUi();
  const currentUserEmail = Session.getActiveUser().getEmail();

  if (!isAdmin(currentUserEmail)) {
    ui.alert("üîí Access Denied", "You do not have permission to add new admins.", ui.ButtonSet.OK);
    return;
  }
  
  const prompt = ui.prompt("‚ûï Add New Admin", "Enter the email address of the new admin:", ui.ButtonSet.OK_CANCEL);
  
  if (prompt.getSelectedButton() === ui.Button.OK) {
    const newAdminEmail = prompt.getResponseText().trim().toLowerCase();
    
    if (!newAdminEmail || !/^\S+@\S+\.\S+$/.test(newAdminEmail)) {
      ui.alert("‚ùå Invalid Email", "Please enter a valid email address.", ui.ButtonSet.OK);
      return;
    }
    
    try {
      const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName("Admin Settings");
      if (!sheet) {
        ui.alert("‚ùå Error", "The 'Admin Settings' sheet could not be found.", ui.ButtonSet.OK);
        return;
      }
      
      const existingAdmins = sheet.getRange("A:A").getValues().flat().map(e => String(e).trim().toLowerCase());
      if (existingAdmins.includes(newAdminEmail)) {
        ui.alert("‚ÑπÔ∏è Already Exists", "This email is already an admin.", ui.ButtonSet.OK);
        return;
      }
      
      sheet.appendRow([newAdminEmail]);
      
      CacheService.getScriptCache().remove('admin_emails');
      
      ui.alert("‚úÖ Success", `Successfully added ${newAdminEmail} as a new admin.`, ui.ButtonSet.OK);
      
    } catch (e) {
      ui.alert("‚ùå Error", "An error occurred: " + e.message, ui.ButtonSet.OK);
      console.error("addAdminEmail Error: " + e.toString());
    }
  }
}

function logAdminAction(functionName, details = "", admin = "Unknown") {
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName("Admin Log");
  const now = Utilities.formatDate(new Date(), Session.getScriptTimeZone(), "dd/MM/yyyy HH:mm:ss");
  sheet.appendRow([now, admin, functionName, details]);
}



// ‚úÖ normalizePhone() ‚Äî ‡∏•‡πâ‡∏≤‡∏á‡πÅ‡∏•‡∏∞‡∏à‡∏±‡∏î‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÉ‡∏´‡πâ‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢
function normalizePhone(input) {
  const phone = String(input).replace(/[^\d]/g, "").trim();
  if (phone.length === 9 && phone[0] !== "0") return "0" + phone;
  if (phone.length === 10 && phone.startsWith("0")) return phone;
  return "";
}

// ‚úÖ validatePhoneOrAlert() ‚Äî ‡πÄ‡∏ä‡πá‡∏Å‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡πÄ‡∏ö‡∏≠‡∏£‡πå
function validatePhoneOrAlert(phone, ui) {
  if (!phone || phone.length !== 10 || !phone.startsWith("0")) {
    ui.alert("‚ùå ‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á (‡∏Ñ‡∏ß‡∏£‡∏°‡∏µ 10 ‡∏´‡∏•‡∏±‡∏Å‡∏Ç‡∏∂‡πâ‡∏ô‡∏ï‡πâ‡∏ô‡∏î‡πâ‡∏ß‡∏¢ 0)");
    return false;
  }
  return true;
}

// ‚úÖ ‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Google Form
function onFormSubmit(e) {
  const values = e.values;
  const fullName = values[1];
  const nickname = values[2];
  const rawPhone = values[3];
  const phone = normalizePhone(rawPhone);
  const codename = values[4].trim();
  const memberType = values[5];
  const referrer = normalizePhone(values[6] || "");

  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const dbSheet = ss.getSheetByName("Member Database");
  const dashSheet = ss.getSheetByName("Member Dashboard");

  const rowNum = dbSheet.getLastRow();
  const lastCol = dbSheet.getLastColumn();

  const phonesInDash = dashSheet.getRange(2, 2, Math.max(dashSheet.getLastRow() - 1, 1)).getValues()
    .flat().map(p => normalizePhone(p));
  const codenamesInDash = dashSheet.getRange(2, 3, Math.max(dashSheet.getLastRow() - 1, 1)).getValues()
    .flat().map(c => String(c).toLowerCase().trim());

  Logger.log("üì• ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ü‡∏≠‡∏£‡πå‡∏°");
  Logger.log("üìû ‡πÄ‡∏ö‡∏≠‡∏£‡πå: " + phone);
  Logger.log("üßë Codename: " + codename);

  let foundPhoneDup = phonesInDash.includes(phone);
  let foundCodenameDup = codenamesInDash.includes(codename.toLowerCase());

  if (foundPhoneDup) {
    dbSheet.getRange(rowNum, 4).setValue(`${phone} (DUPLICATE)`);
    dbSheet.getRange(rowNum, 4).setNumberFormat("@");
    Logger.log("‚ö†Ô∏è ‡∏û‡∏ö‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏ã‡πâ‡∏≥!");
  }

  if (foundCodenameDup) {
    dbSheet.getRange(rowNum, 5).setValue(`${codename} (DUPLICATE)`);
    Logger.log("‚ö†Ô∏è ‡∏û‡∏ö Codename ‡∏ã‡πâ‡∏≥!");
  }

  if (foundPhoneDup || foundCodenameDup) {
    if (rowNum >= 2 && lastCol >= 1) {
      dbSheet.getRange(rowNum, 1, 1, lastCol).setBackground("#f28b82");
    }
    Logger.log("üõë ‡∏´‡∏¢‡∏∏‡∏î‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ã‡πâ‡∏≥");
    return;
  }

  // --- ‡∏õ‡∏£‡∏±‡∏ö logic ‡∏Å‡∏≤‡∏£‡∏ö‡∏ß‡∏Å EXP ‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ ---
  let initialExp = 0;
  if (memberType.includes("Premium")) {
    initialExp = 3;
    if (referrer && phonesInDash.includes(referrer)) {
      initialExp += 1; // ‡∏ú‡∏π‡πâ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÑ‡∏î‡πâ‡πÄ‡∏û‡∏¥‡πà‡∏° 1
      addExpToPhone(referrer, 2); // referrer ‡πÑ‡∏î‡πâ 2 EXP ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
      logExp(referrer, "‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏™‡∏°‡∏±‡∏Ñ‡∏£ Premium (+2 EXP)", 2);
    }
  }

  // ‚úÖ ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤ Member Dashboard ‡πÇ‡∏î‡∏¢ setValues + ‡∏•‡πá‡∏≠‡∏Å‡πÄ‡∏ö‡∏≠‡∏£‡πå
  const newRow = [nickname, phone, codename, "Rookie", initialExp, ""];
  const newRowIndex = dashSheet.getLastRow() + 1;
  dashSheet.getRange(newRowIndex, 1, 1, newRow.length).setValues([newRow]);
  dashSheet.getRange(newRowIndex, 2).setNumberFormat("@");

  // ‚úÖ ‡∏•‡πá‡∏≠‡∏Å‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÉ‡∏ô Member Database ‡∏î‡πâ‡∏ß‡∏¢
  dbSheet.getRange(rowNum, 4).setNumberFormat("@");

  logExp(phone, "‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å", initialExp);

  // --- ‡∏•‡∏ö logic ‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏µ‡πà referrer ‡πÑ‡∏î‡πâ 1 EXP ‡∏ó‡∏∏‡∏Å 2 ‡∏Ñ‡∏ô ---

  updateRanks();
  updateLeaderboard();
}




// ‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö EXP ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡πÅ‡∏ö‡∏ö‡πÄ‡∏ï‡πá‡∏°
function logExp(phone, activity, amount) {
  const normalized = normalizePhone(phone);
  const dashSheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName("Member Dashboard");
  const dashData = dashSheet.getDataRange().getValues();
  const member = dashData.find(row => normalizePhone(row[1]) === normalized);
  const codename = member ? member[2] : "‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ä‡∏∑‡πà‡∏≠";

  const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName("EXP Log");
  const row = sheet.getLastRow() + 1;
  const now = Utilities.formatDate(new Date(), Session.getScriptTimeZone(), "dd/MM/yyyy HH:mm:ss");

  sheet.getRange(row, 1, 1, 5).setValues([[normalized, codename, now, activity, amount]]);
  sheet.getRange(row, 1).setNumberFormat("@");

  updateRanks();
  updateLeaderboard();
}




// ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏° EXP ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á‡∏à‡∏≤‡∏Å‡πÄ‡∏ö‡∏≠‡∏£‡πå
function addExpToPhone(phone, amount) {
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName("Member Dashboard");
  const data = sheet.getDataRange().getValues();
  const normalized = normalizePhone(phone);

  for (let i = 1; i < data.length; i++) {
    if (normalizePhone(data[i][1]) === normalized) {
      const current = Number(data[i][4]);
      sheet.getRange(i + 1, 5).setValue(current + amount);
      logExp(phone, "‡πÄ‡∏û‡∏¥‡πà‡∏° EXP ‡πÇ‡∏î‡∏¢‡∏£‡∏∞‡∏ö‡∏ö", amount);
      return;
    }
  }
}

// ‚úÖ ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì Rank ‡∏à‡∏≤‡∏Å EXP ‡πÅ‡∏•‡πâ‡∏ß‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÉ‡∏´‡πâ‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô
function updateRanks() {
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName("Member Dashboard");
  const data = sheet.getDataRange().getValues();
  for (let i = 1; i < data.length; i++) {
    const rawExp = data[i][4];
    const exp = Number(rawExp) || 0;

    let rank = "Rookie";
    if (exp >= 200) rank = "Legend";
    else if (exp >= 120) rank = "Grandmaster";
    else if (exp >= 75) rank = "Diamond";
    else if (exp >= 50) rank = "Platinum";
    else if (exp >= 30) rank = "Gold";
    else if (exp >= 15) rank = "Silver";
    else if (exp >= 5) rank = "Bronze";

    sheet.getRange(i + 1, 4).setValue(rank);
  }
}


// ‚úÖ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ï‡∏≤‡∏£‡∏≤‡∏á Leaderboard ‡πÇ‡∏î‡∏¢‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏° EXP ‡∏°‡∏≤‡∏Å‡∏™‡∏∏‡∏î
function updateLeaderboard() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const dash = ss.getSheetByName("Member Dashboard");
  const lb = ss.getSheetByName("Leaderboard");
  const data = dash.getRange(2, 1, dash.getLastRow() - 1, 6).getValues();
  const result = [["‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô", "Phone", "Codename", "Rank", "EXP", "Party"]];
  for (let i = 0; i < data.length; i++) {
    // --- Normalize ‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô string 10 ‡∏´‡∏•‡∏±‡∏Å ---
    let phone = String(data[i][1]).trim();
    if (phone.length === 9 && phone[0] !== "0") phone = "0" + phone;
    if (phone.length !== 10) phone = ""; // ‡∏Å‡∏±‡∏ô‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏ú‡∏¥‡∏î
    result.push([data[i][0], phone, data[i][2], data[i][3], data[i][4], data[i][5] || ""]);
  }
  result.sort((a, b) => b[4] - a[4]);
  lb.clearContents();
  lb.getRange(1, 1, result.length, result[0].length).setValues(result);
}

// ‚úÖ ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÉ‡∏ä‡πâ‡∏Å‡∏±‡∏ö Web App ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏ä‡∏µ‡∏ó Leaderboard
function getLeaderboardData() {
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName("Leaderboard");
  if (!sheet) return [];
  return sheet.getRange(2, 1, sheet.getLastRow() - 1, 5).getValues();
}



// ‚úÖ ‡∏™‡∏£‡∏∏‡∏õ‡∏õ‡∏≤‡∏£‡πå‡∏ï‡∏µ‡πâ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
function showPartySummary() {
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName("Party");
  const data = sheet.getDataRange().getValues();
  const ui = SpreadsheetApp.getUi();
  let msg = "üéâ ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏õ‡∏≤‡∏£‡πå‡∏ï‡∏µ‡πâ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î";

  for (let i = 1; i < data.length; i++) {
    msg += `\n${data[i][0]} - ‡πÅ‡∏ï‡πâ‡∏°: ${data[i][2]}`;
  }
  ui.alert(msg);
}

// ‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏õ‡∏≤‡∏£‡πå‡∏ï‡∏µ‡πâ ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏ß‡∏•‡∏≤‡πÅ‡∏ö‡∏ö‡πÄ‡∏ï‡πá‡∏°
function logPartyActivity(partyName, codename, activity, note = "") {
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName("Party Log");
  const now = Utilities.formatDate(new Date(), Session.getScriptTimeZone(), "dd/MM/yyyy HH:mm:ss");
  sheet.appendRow([
    now,
    partyName,
    codename,
    activity,
    "",  // Party Point
    note
  ]);
}

// ‚úÖ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏õ‡∏≤‡∏£‡πå‡∏ï‡∏µ‡πâ (‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ Rank Gold+ ‡πÅ‡∏•‡∏∞‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏≠‡∏¢‡∏π‡πà‡∏õ‡∏≤‡∏£‡πå‡∏ï‡∏µ‡πâ)
function createParty() {
  const ui = SpreadsheetApp.getUi();
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const dashSheet = ss.getSheetByName("Member Dashboard");
  const partySheet = ss.getSheetByName("Party");
  const trackerSheet = ss.getSheetByName("Party Tracker");
  const adminPrompt = ui.prompt("‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô", "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å log)", ui.ButtonSet.OK_CANCEL);
  if (adminPrompt.getSelectedButton() !== ui.Button.OK) return;
  const admin = adminPrompt.getResponseText().trim();

  // ‡∏£‡∏±‡∏ö‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£
  const phonePrompt = ui.prompt("‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏õ‡∏≤‡∏£‡πå‡∏ï‡∏µ‡πâ", "‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏ú‡∏π‡πâ‡∏Å‡πà‡∏≠‡∏ï‡∏±‡πâ‡∏á", ui.ButtonSet.OK_CANCEL);
  if (phonePrompt.getSelectedButton() !== ui.Button.OK) return;
  const phone = normalizePhone(phonePrompt.getResponseText().trim());

  const dashData = dashSheet.getDataRange().getValues();
  const member = dashData.find(row => normalizePhone(row[1]) === phone);
  if (!member) return ui.alert("‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏ô‡∏µ‡πâ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö");

  const nickname = member[0];
  const codename = member[2];
  const rank = member[3];
  const currentParty = member[5];

  const allowedRanks = ["Gold", "Platinum", "Diamond", "Grandmaster", "Legend"];
  if (!allowedRanks.includes(rank)) return ui.alert("‚ùå ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ Rank ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ Gold ‡∏Ç‡∏∂‡πâ‡∏ô‡πÑ‡∏õ");

  if (currentParty && currentParty !== "") return ui.alert("‚ùå ‡∏Ñ‡∏∏‡∏ì‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏õ‡∏≤‡∏£‡πå‡∏ï‡∏µ‡πâ‡∏≠‡∏∑‡πà‡∏ô‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß");

  // ‡∏£‡∏±‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡∏õ‡∏≤‡∏£‡πå‡∏ï‡∏µ‡πâ‡πÉ‡∏´‡∏°‡πà
  const namePrompt = ui.prompt("‡∏ï‡∏±‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏õ‡∏≤‡∏£‡πå‡∏ï‡∏µ‡πâ‡πÉ‡∏´‡∏°‡πà", "‡∏ä‡∏∑‡πà‡∏≠‡∏´‡πâ‡∏≤‡∏°‡∏ã‡πâ‡∏≥", ui.ButtonSet.OK_CANCEL);
  if (namePrompt.getSelectedButton() !== ui.Button.OK) return;
  const partyName = namePrompt.getResponseText().trim();

  // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡∏ã‡πâ‡∏≥
  const partyNames = partySheet.getLastRow() > 1
    ? partySheet.getRange(2, 1, partySheet.getLastRow() - 1).getValues().flat()
    : [];
  if (partyNames.includes(partyName)) return ui.alert("‚ùå ‡∏°‡∏µ‡∏ä‡∏∑‡πà‡∏≠‡∏õ‡∏≤‡∏£‡πå‡∏ï‡∏µ‡πâ‡∏ô‡∏µ‡πâ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß");

  // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏Ç‡πâ‡∏≤ Party sheet ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏•‡πá‡∏≠‡∏Å format ‡πÄ‡∏ö‡∏≠‡∏£‡πå
  const partyRow = partySheet.getLastRow() + 1;
  partySheet.getRange(partyRow, 1, 1, 3).setValues([[partyName, phone, 0]]);
  partySheet.getRange(partyRow, 2).setNumberFormat("@");

  // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏Ç‡πâ‡∏≤ Party Tracker ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏•‡πá‡∏≠‡∏Å format ‡πÄ‡∏ö‡∏≠‡∏£‡πå
  const trackerRow = trackerSheet.getLastRow() + 1;
  trackerSheet.getRange(trackerRow, 1, 1, 5).setValues([[partyName, codename, phone, "‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡∏õ‡∏≤‡∏£‡πå‡∏ï‡∏µ‡πâ", new Date()]]);
  trackerSheet.getRange(trackerRow, 3).setNumberFormat("@");

  // ‚úÖ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Dashboard
  const memberRow = dashData.findIndex(row => normalizePhone(row[1]) === phone);
  dashSheet.getRange(memberRow + 1, 6).setValue(partyName);

  updateLeaderboard();
  ui.alert(`‚úÖ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏õ‡∏≤‡∏£‡πå‡∏ï‡∏µ‡πâ ${partyName} ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß`);
  logAdminAction("‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏õ‡∏≤‡∏£‡πå‡∏ï‡∏µ‡πâ", `${codename} (${phone}) ‚Üí ${partyName}`, admin);
  sortAndHighlightPartyTracker();
}





// ‚úÖ ‡πÄ‡∏ä‡∏¥‡∏ç‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡πÄ‡∏Ç‡πâ‡∏≤‡∏õ‡∏≤‡∏£‡πå‡∏ï‡∏µ‡πâ ‡∏û‡∏£‡πâ‡∏≠‡∏° log ‡∏•‡∏á Party Tracker ‡πÅ‡∏•‡∏∞ Party Log
function addMemberToParty() {
  const ui = SpreadsheetApp.getUi();
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const dashSheet = ss.getSheetByName("Member Dashboard");
  const partySheet = ss.getSheetByName("Party");
  const trackerSheet = ss.getSheetByName("Party Tracker");
  const partyLogSheet = ss.getSheetByName("Party Log");

  const adminPrompt = ui.prompt("‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô", "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å log)", ui.ButtonSet.OK_CANCEL);
  if (adminPrompt.getSelectedButton() !== ui.Button.OK || !adminPrompt.getResponseText().trim()) return;
  const admin = adminPrompt.getResponseText().trim();

  const phonePrompt = ui.prompt("‡πÄ‡∏ä‡∏¥‡∏ç‡πÄ‡∏Ç‡πâ‡∏≤‡∏õ‡∏≤‡∏£‡πå‡∏ï‡∏µ‡πâ", "‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏Ç‡∏≠‡∏á‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å", ui.ButtonSet.OK_CANCEL);
  if (phonePrompt.getSelectedButton() !== ui.Button.OK) return;
  const phone = normalizePhone(phonePrompt.getResponseText().trim());
  if (!validatePhoneOrAlert(phone, ui)) return;

  const dashData = dashSheet.getDataRange().getValues();
  const memberIndex = dashData.findIndex(row => normalizePhone(row[1]) === phone);
  if (memberIndex === -1) return ui.alert("‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏ô‡∏µ‡πâ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö");

  const codename = dashData[memberIndex][2];
  const currentParty = dashData[memberIndex][5];
  if (currentParty && currentParty !== "") return ui.alert("‚ùå ‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏ô‡∏µ‡πâ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏õ‡∏≤‡∏£‡πå‡∏ï‡∏µ‡πâ‡πÅ‡∏•‡πâ‡∏ß");

  const partyList = partySheet.getRange(2, 1, partySheet.getLastRow() - 1).getValues().flat();
  if (partyList.length === 0) return ui.alert("‚ùå ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏≤‡∏£‡πå‡∏ï‡∏µ‡πâ‡πÉ‡∏´‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å");

  const partyPrompt = ui.prompt("‡∏ä‡∏∑‡πà‡∏≠‡∏õ‡∏≤‡∏£‡πå‡∏ï‡∏µ‡πâ", `‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡∏ï‡πà‡∏≠‡πÑ‡∏õ‡∏ô‡∏µ‡πâ:\n\n${partyList.join("\n")}`, ui.ButtonSet.OK_CANCEL);
  if (partyPrompt.getSelectedButton() !== ui.Button.OK) return;
  const selectedParty = partyPrompt.getResponseText().trim();

  if (!partyList.includes(selectedParty)) return ui.alert("‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡∏õ‡∏≤‡∏£‡πå‡∏ï‡∏µ‡πâ‡∏ô‡∏µ‡πâ");

  // ‚úÖ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ä‡∏∑‡πà‡∏≠‡∏õ‡∏≤‡∏£‡πå‡∏ï‡∏µ‡πâ‡πÉ‡∏ô Dashboard
  dashSheet.getRange(memberIndex + 1, 6).setValue(selectedParty);

  // ‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á Party Tracker
  const now = Utilities.formatDate(new Date(), Session.getScriptTimeZone(), "dd/MM/yyyy HH:mm:ss");
  const trackerRow = trackerSheet.getLastRow() + 1;
  trackerSheet.getRange(trackerRow, 1, 1, 5).setValues([
    [selectedParty, codename, `'${phone}`, "‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å", now]
  ]);

  // ‚úÖ Log ‡∏•‡∏á Party Log ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ä‡∏∑‡πà‡∏≠‡∏õ‡∏≤‡∏£‡πå‡∏ï‡∏µ‡πâ
  logPartyActivity(selectedParty, codename, `‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏õ‡∏≤‡∏£‡πå‡∏ï‡∏µ‡πâ ${selectedParty}`, "‡πÄ‡∏ä‡∏¥‡∏ç‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏°‡∏ô‡∏π");
  logAdminAction("‡πÄ‡∏ä‡∏¥‡∏ç‡πÄ‡∏Ç‡πâ‡∏≤‡∏õ‡∏≤‡∏£‡πå‡∏ï‡∏µ‡πâ", `${codename} (${phone}) ‚Üí ${selectedParty}`, admin);

  updateLeaderboard();
  sortAndHighlightPartyTracker();
  ui.alert(`‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏° ${codename} ‡πÄ‡∏Ç‡πâ‡∏≤‡∏õ‡∏≤‡∏£‡πå‡∏ï‡∏µ‡πâ ${selectedParty} ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß`);
}



function removeMember() {
  const ui = SpreadsheetApp.getUi();
  const ss = SpreadsheetApp.getActiveSpreadsheet();

  // ‚úÖ ‡∏Ç‡∏≠‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô
  const adminPrompt = ui.prompt("‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô", "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å log)", ui.ButtonSet.OK_CANCEL);
  if (adminPrompt.getSelectedButton() !== ui.Button.OK) return;
  const admin = adminPrompt.getResponseText().trim();

  const dbSheet = ss.getSheetByName("Member Database");
  const dashSheet = ss.getSheetByName("Member Dashboard");
  const lbSheet = ss.getSheetByName("Leaderboard");
  const partySheet = ss.getSheetByName("Party");
  const trackerSheet = ss.getSheetByName("Party Tracker");

  const phonePrompt = ui.prompt("‡∏•‡∏ö‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å", "‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö", ui.ButtonSet.OK_CANCEL);
  if (phonePrompt.getSelectedButton() !== ui.Button.OK) return;
  const phone = normalizePhone(phonePrompt.getResponseText().trim());

  // ‚ö†Ô∏è ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏•‡∏ö
  const confirm = ui.alert("‚ö†Ô∏è ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö", `‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡πÄ‡∏ö‡∏≠‡∏£‡πå ${phone}?\n\n‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏•‡∏ö ‡∏¢‡∏Å‡πÄ‡∏ß‡πâ‡∏ô Member Database`, ui.ButtonSet.YES_NO);
  if (confirm !== ui.Button.YES) return;

  // 1. ‚úÖ ‡πÑ‡∏Æ‡πÑ‡∏•‡∏ï‡πå‡πÅ‡∏î‡∏á‡πÉ‡∏ô Member Database
  const dbData = dbSheet.getDataRange().getValues();
  for (let i = 1; i < dbData.length; i++) {
    if (normalizePhone(dbData[i][3]) === phone) {
      dbSheet.getRange(i + 1, 1, 1, dbData[0].length).setBackground("#FFCCCC");
    }
  }

  // 2. ‚úÖ ‡∏•‡∏ö‡∏à‡∏≤‡∏Å Member Dashboard
  const dashData = dashSheet.getDataRange().getValues();
  for (let i = dashData.length - 1; i >= 1; i--) {
    if (normalizePhone(dashData[i][1]) === phone) {
      dashSheet.deleteRow(i + 1);
    }
  }

  // 3. ‚úÖ ‡∏•‡∏ö‡∏à‡∏≤‡∏Å Leaderboard
  const lbData = lbSheet.getDataRange().getValues();
  for (let i = lbData.length - 1; i >= 1; i--) {
    if (normalizePhone(lbData[i][1]) === phone) {
      lbSheet.deleteRow(i + 1);
    }
  }

  // 4. ‚úÖ ‡∏•‡∏ö‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏õ‡∏≤‡∏£‡πå‡∏ï‡∏µ‡πâ‡πÉ‡∏ô‡∏ä‡∏µ‡∏ó Party (‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤)
  const partyData = partySheet.getDataRange().getValues();
  for (let i = partyData.length - 1; i >= 1; i--) {
    if (normalizePhone(partyData[i][1]) === phone) {
      partySheet.deleteRow(i + 1);
    }
  }

  // 5. ‚úÖ ‡∏•‡∏ö‡∏à‡∏≤‡∏Å Party Tracker (‡∏ó‡∏∏‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏°‡∏µ‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏ô‡∏µ‡πâ)
  const trackerData = trackerSheet.getDataRange().getValues();
  for (let i = trackerData.length - 1; i >= 1; i--) {
    if (normalizePhone(trackerData[i][2]) === phone) {
      trackerSheet.deleteRow(i + 1);
    }
  }

  updateLeaderboard();
  ui.alert("‚úÖ ‡∏•‡∏ö‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡πÅ‡∏•‡∏∞‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß");

  // ‚úÖ Log Admin
  logAdminAction("‡∏•‡∏ö‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å", `‡πÄ‡∏ö‡∏≠‡∏£‡πå: ${phone}`, admin);
}



// ‚úÖ ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏õ‡∏≤‡∏£‡πå‡∏ï‡∏µ‡πâ
function removeFromParty() {
  const ui = SpreadsheetApp.getUi();
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const trackerSheet = ss.getSheetByName("Party Tracker");
  const dashSheet = ss.getSheetByName("Member Dashboard");
  const adminPrompt = ui.prompt("‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô", "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å log)", ui.ButtonSet.OK_CANCEL);
  if (adminPrompt.getSelectedButton() !== ui.Button.OK) return;
  const admin = adminPrompt.getResponseText().trim();


  const phonePrompt = ui.prompt("‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏õ‡∏≤‡∏£‡πå‡∏ï‡∏µ‡πâ", "‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å", ui.ButtonSet.OK_CANCEL);
  if (phonePrompt.getSelectedButton() !== ui.Button.OK) return;
  const phone = normalizePhone(phonePrompt.getResponseText().trim());
  if (!validatePhoneOrAlert(phone, ui)) return;

  const trackerData = trackerSheet.getDataRange().getValues();
  let found = false;

  for (let i = trackerData.length - 1; i >= 1; i--) {
    if (normalizePhone(trackerData[i][2]) === phone) {
      trackerSheet.deleteRow(i + 1);
      found = true;
      break;
    }
  }

  const dashData = dashSheet.getDataRange().getValues();
  let codename = "", partyName = "";

  for (let i = 1; i < dashData.length; i++) {
    if (normalizePhone(dashData[i][1]) === phone) {
      codename = dashData[i][2];
      partyName = dashData[i][5];
      dashSheet.getRange(i + 1, 6).setValue("");
      break;
    }
  }

  if (partyName && codename) {
    logPartyActivity(partyName, codename, "‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏õ‡∏≤‡∏£‡πå‡∏ï‡∏µ‡πâ");
  }

  updateLeaderboard();
  ui.alert(found ? `‚úÖ ‡∏•‡∏ö ${codename} ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏õ‡∏≤‡∏£‡πå‡∏ï‡∏µ‡πâ‡πÅ‡∏•‡πâ‡∏ß` : `‚ÑπÔ∏è ‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏ô‡∏µ‡πâ‡πÉ‡∏ô‡∏õ‡∏≤‡∏£‡πå‡∏ï‡∏µ‡πâ‡πÉ‡∏î‡πÄ‡∏•‡∏¢`);
  logAdminAction("‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏õ‡∏≤‡∏£‡πå‡∏ï‡∏µ‡πâ", `${codename} (${phone}) ‚Üê ${partyName}`, admin);
  sortAndHighlightPartyTracker();
}

// ‚úÖ ‡∏¢‡πâ‡∏≤‡∏¢‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡πÑ‡∏õ‡∏õ‡∏≤‡∏£‡πå‡∏ï‡∏µ‡πâ‡πÉ‡∏´‡∏°‡πà (‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£)
function moveToAnotherParty() {
  const ui = SpreadsheetApp.getUi();
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const trackerSheet = ss.getSheetByName("Party Tracker");
  const dashSheet = ss.getSheetByName("Member Dashboard");
  const partySheet = ss.getSheetByName("Party");
  const adminPrompt = ui.prompt("‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô", "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å log)", ui.ButtonSet.OK_CANCEL);
  if (adminPrompt.getSelectedButton() !== ui.Button.OK) return;
  const admin = adminPrompt.getResponseText().trim();


  const phone = normalizePhone(ui.prompt("‡∏¢‡πâ‡∏≤‡∏¢‡∏õ‡∏≤‡∏£‡πå‡∏ï‡∏µ‡πâ", "‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏¢‡πâ‡∏≤‡∏¢", ui.ButtonSet.OK_CANCEL)
    .getResponseText().trim());

  const dashData = dashSheet.getDataRange().getValues();
  let codename = "", oldParty = "", dashRow = -1;

  for (let i = 1; i < dashData.length; i++) {
    if (normalizePhone(dashData[i][1]) === phone) {
      codename = dashData[i][2];
      oldParty = dashData[i][5];
      dashRow = i + 1;
      break;
    }
  }

  if (!codename) return ui.alert("‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏ô‡∏µ‡πâ‡πÉ‡∏ô Member Dashboard");

  const newParty = ui.prompt("‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏õ‡∏≤‡∏£‡πå‡∏ï‡∏µ‡πâ‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏¢‡πâ‡∏≤‡∏¢‡πÄ‡∏Ç‡πâ‡∏≤", ui.ButtonSet.OK_CANCEL)
    .getResponseText().trim();

  const existingParties = partySheet.getRange(2, 1, partySheet.getLastRow() - 1).getValues().flat();
  if (!existingParties.includes(newParty)) return ui.alert("‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏õ‡∏≤‡∏£‡πå‡∏ï‡∏µ‡πâ‡∏ô‡∏µ‡πâ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö");

  const trackerData = trackerSheet.getDataRange().getValues();
  const partyMembers = trackerData.filter(row => row[0] === newParty);
  if (partyMembers.length >= 5) return ui.alert("‚ùå ‡∏õ‡∏≤‡∏£‡πå‡∏ï‡∏µ‡πâ‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏Ñ‡∏£‡∏ö 5 ‡∏Ñ‡∏ô‡πÅ‡∏•‡πâ‡∏ß");

  for (let i = trackerData.length - 1; i >= 1; i--) {
    if (normalizePhone(trackerData[i][2]) === phone) {
      trackerSheet.deleteRow(i + 1);
      break;
    }
  }

  const row = trackerSheet.getLastRow() + 1;
  trackerSheet.getRange(row, 1, 1, 5).setValues([[newParty, codename, phone, "‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å", new Date()]]);
  trackerSheet.getRange(row, 3).setNumberFormat("@");

  dashSheet.getRange(dashRow, 6).setValue(newParty);
  updateLeaderboard();

  // ‚úÖ Log ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ä‡∏∑‡πà‡∏≠‡∏õ‡∏≤‡∏£‡πå‡∏ï‡∏µ‡πâ‡πÉ‡∏ô activity
  if (oldParty) {
    logPartyActivity(oldParty, codename, "‡∏¢‡πâ‡∏≤‡∏¢‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏õ‡∏≤‡∏£‡πå‡∏ï‡∏µ‡πâ", `‡πÑ‡∏õ‡∏¢‡∏±‡∏á ${newParty}`);
  }
  logPartyActivity(newParty, codename, `‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏õ‡∏≤‡∏£‡πå‡∏ï‡∏µ‡πâ ${newParty}`, `‡∏à‡∏≤‡∏Å ${oldParty}`);

  ui.alert(`‚úÖ ‡∏¢‡πâ‡∏≤‡∏¢ ${codename} ‡πÑ‡∏õ‡∏õ‡∏≤‡∏£‡πå‡∏ï‡∏µ‡πâ ${newParty} ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à`);
  logAdminAction("‡∏¢‡πâ‡∏≤‡∏¢‡∏õ‡∏≤‡∏£‡πå‡∏ï‡∏µ‡πâ", `${codename} (${phone}): ${oldParty} ‚Üí ${newParty}`, admin);
  sortAndHighlightPartyTracker();
}




// ‚úÖ ‡∏à‡∏±‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏á Party Tracker ‡πÅ‡∏•‡∏∞‡πÄ‡∏ô‡πâ‡∏ô‡∏™‡∏µ‡∏ï‡∏≤‡∏°‡∏ä‡∏∑‡πà‡∏≠‡∏õ‡∏≤‡∏£‡πå‡∏ï‡∏µ‡πâ
function sortAndHighlightPartyTracker() {
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName("Party Tracker");
  const range = sheet.getDataRange();
  const values = range.getValues();
  if (values.length <= 1) return;

  const headers = values[0];
  const data = values.slice(1);
  data.sort((a, b) => a[0].localeCompare(b[0]));
  sheet.getRange(2, 1, data.length, data[0].length).setValues(data);
  sheet.getRange(2, 1, sheet.getLastRow() - 1, sheet.getLastColumn()).setBackground(null);

  let currentParty = "";
  let currentColor = "";
  for (let i = 0; i < data.length; i++) {
    const partyName = data[i][0];
    if (partyName !== currentParty) {
      currentParty = partyName;
      currentColor = getRandomPastelHex();
    }
    sheet.getRange(i + 2, 1, 1, data[0].length).setBackground(currentColor);
  }
}

function getRandomPastelHex() {
  const r = Math.floor((Math.random() * 127) + 127);
  const g = Math.floor((Math.random() * 127) + 127);
  const b = Math.floor((Math.random() * 127) + 127);
  return rgbToHex(r, g, b);
}

function rgbToHex(r, g, b) {
  return "#" + [r, g, b].map(x => {
    const hex = x.toString(16);
    return hex.length === 1 ? "0" + hex : hex;
  }).join("");
}

// ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏° EXP ‡πÉ‡∏´‡πâ‡∏Ñ‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏à‡∏≤‡∏Å‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° (‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£)
function addExpFromActivity() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const ui = SpreadsheetApp.getUi();
  const dashSheet = ss.getSheetByName("Member Dashboard");
  const activitySheet = ss.getSheetByName("Activity List");
  const partySheet = ss.getSheetByName("Party");
  const partyLogSheet = ss.getSheetByName("Party Log");
  const adminPrompt = ui.prompt("‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô", "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å log)", ui.ButtonSet.OK_CANCEL);
  if (adminPrompt.getSelectedButton() !== ui.Button.OK) return;
  const admin = adminPrompt.getResponseText().trim();

  const activityData = activitySheet.getRange(2, 1, activitySheet.getLastRow() - 1, 3).getValues();
  const activityList = activityData.map((row, i) => `${i + 1}. ${row[0]} (${row[1]} EXP)`).join("\n");
  const activityPrompt = ui.prompt("‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° (‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏•‡∏Ç)", `‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°:\n\n${activityList}`, ui.ButtonSet.OK_CANCEL);
  if (activityPrompt.getSelectedButton() !== ui.Button.OK) return;
  const activityIndex = Number(activityPrompt.getResponseText().trim()) - 1;
  if (isNaN(activityIndex) || activityIndex < 0 || activityIndex >= activityData.length) {
    ui.alert("‚ùå ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á");
    return;
  }
  const [activityName, exp, pointsConfig] = activityData[activityIndex];

  const phonePrompt = ui.prompt("‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£", ui.ButtonSet.OK_CANCEL);
  if (phonePrompt.getSelectedButton() !== ui.Button.OK) return;
  const phone = normalizePhone(phonePrompt.getResponseText().trim());
  if (!validatePhoneOrAlert(phone, ui)) return;

  const dashData = dashSheet.getDataRange().getValues();
  let codename = "";
  let rowIndex = -1;
  for (let i = 1; i < dashData.length; i++) {
    const dashPhone = normalizePhone(dashData[i][1]);
    if (dashPhone === phone) {
      codename = dashData[i][2];
      rowIndex = i + 1;
      break;
    }
  }

  if (!codename) {
    ui.alert("‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏ô‡∏µ‡πâ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö");
    return;
  }

  // --- ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£ ---
  let summary = `‡∏Ñ‡∏∏‡∏ì‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏à‡∏∞‡πÄ‡∏û‡∏¥‡πà‡∏° EXP ‡πÉ‡∏´‡πâ‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å:\n\n- ‡∏ä‡∏∑‡πà‡∏≠: ${codename}\n- ‡πÄ‡∏ö‡∏≠‡∏£‡πå: ${phone}\n- ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°: ${activityName}\n- EXP: ${exp}`;
  if (pointsConfig && String(pointsConfig).trim() !== "") {
    summary += `\n- Party Point: ${pointsConfig}`;
  }
  const confirm = ui.alert("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏° EXP", summary + "\n\n‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?", ui.ButtonSet.YES_NO);
  if (confirm !== ui.Button.YES) return;

  const currentExp = Number(dashSheet.getRange(rowIndex, 5).getValue());
  dashSheet.getRange(rowIndex, 5).setValue(currentExp + Number(exp));
  logExp(phone, activityName, exp);

  let partyPointMessage = "";
  // üÜï ‡∏ï‡∏£‡∏£‡∏Å‡∏∞‡πÉ‡∏´‡∏°‡πà: ‡πÉ‡∏´‡πâ Party Point ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÉ‡∏ô Activity List
  if (pointsConfig && String(pointsConfig).trim() !== "") {
    const partyName = dashSheet.getRange(rowIndex, 6).getValue();
    if (partyName) {
      let pointAmount = 0;
      if (String(pointsConfig).trim().toLowerCase() === "‡∏ï‡∏≤‡∏°‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å") {
        const trackerSheet = ss.getSheetByName("Party Tracker");
        const trackerData = trackerSheet.getDataRange().getValues();
        pointAmount = trackerData.filter(row => row[0] === partyName).length;
      } else {
        pointAmount = Number(pointsConfig);
      }

      if (!isNaN(pointAmount) && pointAmount > 0) {
        const partyData = partySheet.getDataRange().getValues();
        const partyIndex = partyData.findIndex(row => row[0] === partyName);

        if (partyIndex !== -1) {
          const currentPoint = Number(partyData[partyIndex][2]);
          partySheet.getRange(partyIndex + 1, 3).setValue(currentPoint + pointAmount);
          partyLogSheet.appendRow([new Date(), partyName, codename, activityName, pointAmount, `‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏à‡∏≤‡∏Å‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° EXP`]);
          partyPointMessage = `\n\n‚úÖ ‡πÅ‡∏•‡∏∞‡πÄ‡∏û‡∏¥‡πà‡∏° ${pointAmount} ‡πÅ‡∏ï‡πâ‡∏°‡πÉ‡∏´‡πâ‡∏õ‡∏≤‡∏£‡πå‡∏ï‡∏µ‡πâ '${partyName}'`;
        }
      }
    }
  }

  ui.alert(`‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏° ${exp} EXP ‡πÉ‡∏´‡πâ ${codename} (${phone}) ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß` + partyPointMessage);
  logAdminAction("‡πÄ‡∏û‡∏¥‡πà‡∏° EXP & Party Point", `‡πÉ‡∏´‡πâ ${codename} (${phone}) | ${activityName} +${exp}`, admin);
  updateRanks();
  updateLeaderboard();
}

// ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏° EXP ‡πÉ‡∏´‡πâ‡∏´‡∏•‡∏≤‡∏¢‡∏Ñ‡∏ô‡∏à‡∏≤‡∏Å‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡πÄ‡∏î‡∏µ‡∏¢‡∏ß (‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£)
function addExpFromActivityBulk() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const ui = SpreadsheetApp.getUi();
  const dashSheet = ss.getSheetByName("Member Dashboard");
  const activitySheet = ss.getSheetByName("Activity List");
  const expLogSheet = ss.getSheetByName("EXP Log");
  const partySheet = ss.getSheetByName("Party");
  const partyLogSheet = ss.getSheetByName("Party Log");
  const adminPrompt = ui.prompt("‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô", "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å log)", ui.ButtonSet.OK_CANCEL);
  if (adminPrompt.getSelectedButton() !== ui.Button.OK) return;
  const admin = adminPrompt.getResponseText().trim();


  const activityData = activitySheet.getRange(2, 1, activitySheet.getLastRow() - 1, 3).getValues();
  const activityList = activityData.map((row, i) => `${i + 1}. ${row[0]} (${row[1]} EXP)`).join("\n");

  const activityPrompt = ui.prompt("‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° (‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏•‡∏Ç)", `‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏à‡∏≤‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£:\n\n${activityList}`, ui.ButtonSet.OK_CANCEL);
  if (activityPrompt.getSelectedButton() !== ui.Button.OK) return;
  const activityIndex = Number(activityPrompt.getResponseText().trim()) - 1;
  if (isNaN(activityIndex) || activityIndex < 0 || activityIndex >= activityData.length) {
    ui.alert("‚ùå ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á");
    return;
  }

  const [activityName, exp, pointsConfig] = activityData[activityIndex];

  const phonePrompt = ui.prompt("‡πÄ‡∏û‡∏¥‡πà‡∏° EXP", "‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£ (‡πÄ‡∏ß‡πâ‡∏ô‡∏ß‡∏£‡∏£‡∏Ñ , ‡∏´‡∏£‡∏∑‡∏≠‡∏Ç‡∏∂‡πâ‡∏ô‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÉ‡∏´‡∏°‡πà)", ui.ButtonSet.OK_CANCEL);
  if (phonePrompt.getSelectedButton() !== ui.Button.OK) return;
  const phonesRaw = phonePrompt.getResponseText().trim();
  const rawPhones = phonesRaw.split(/\s|,|\n/).map(p => p.trim()).filter(p => p);
  const phones = rawPhones.map(normalizePhone);

  const dashData = dashSheet.getDataRange().getValues();
  const updated = [];
  const partyPointsGiven = new Set(); // ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡πÅ‡∏ï‡πâ‡∏°‡∏õ‡∏≤‡∏£‡πå‡∏ï‡∏µ‡πâ‡∏ã‡πâ‡∏≥‡∏ã‡πâ‡∏≠‡∏ô
  let summaryList = [];

  for (let phone of phones) {
    for (let i = 1; i < dashData.length; i++) {
      const dashPhone = normalizePhone(dashData[i][1]);
      if (dashPhone === phone) {
        const codename = dashData[i][2];
        summaryList.push(`- ${codename} (${phone})`);
        break;
      }
    }
  }

  // --- ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£ ---
  let summary = `‡∏Ñ‡∏∏‡∏ì‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏à‡∏∞‡πÄ‡∏û‡∏¥‡πà‡∏° EXP ‡πÉ‡∏´‡πâ‡∏Å‡∏±‡∏ö:\n\n${summaryList.join("\n")}\n\n‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°: ${activityName}\nEXP: ${exp}`;
  if (pointsConfig && String(pointsConfig).trim() !== "") {
    summary += `\nParty Point: ${pointsConfig}`;
  }
  const confirm = ui.alert("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏° EXP (‡∏´‡∏•‡∏≤‡∏¢‡∏Ñ‡∏ô)", summary + "\n\n‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?", ui.ButtonSet.YES_NO);
  if (confirm !== ui.Button.YES) return;

  for (let phone of phones) {
    for (let i = 1; i < dashData.length; i++) {
      const dashPhone = normalizePhone(dashData[i][1]);
      if (dashPhone === phone) {
        const codename = dashData[i][2];
        const currentExp = Number(dashData[i][4]);
        dashSheet.getRange(i + 1, 5).setValue(currentExp + Number(exp));
        
        // ‚úÖ Log EXP ‡∏î‡πâ‡∏ß‡∏¢ format ‡πÄ‡∏ö‡∏≠‡∏£‡πå
        const logRow = expLogSheet.getLastRow() + 1;
        expLogSheet.getRange(logRow, 1, 1, 5).setValues([[phone, codename, new Date(), activityName, exp]]);
        expLogSheet.getRange(logRow, 1).setNumberFormat("@");

        updated.push(codename);

        const partyName = dashData[i][5];
        // üÜï ‡∏ï‡∏£‡∏£‡∏Å‡∏∞‡πÉ‡∏´‡∏°‡πà: ‡πÉ‡∏´‡πâ Party Point ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÉ‡∏ô Activity List
        if (partyName && pointsConfig && String(pointsConfig).trim() !== "" && !partyPointsGiven.has(partyName)) {
            let pointAmount = 0;
            if (String(pointsConfig).trim().toLowerCase() === "‡∏ï‡∏≤‡∏°‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å") {
              const trackerSheet = ss.getSheetByName("Party Tracker");
              const trackerData = trackerSheet.getDataRange().getValues();
              pointAmount = trackerData.filter(row => row[0] === partyName).length;
            } else {
              pointAmount = Number(pointsConfig);
            }

            if (!isNaN(pointAmount) && pointAmount > 0) {
              const partyData = partySheet.getDataRange().getValues();
              const partyIndex = partyData.findIndex(row => row[0] === partyName);

              if (partyIndex !== -1) {
                const currentPoint = Number(partyData[partyIndex][2]);
                partySheet.getRange(partyIndex + 1, 3).setValue(currentPoint + pointAmount);
                partyLogSheet.appendRow([
                  new Date(), partyName, codename, activityName, pointAmount,
                  `‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏à‡∏≤‡∏Å‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° EXP (Bulk)`
                ]);
                partyPointsGiven.add(partyName); // Mark party as having received points
              }
            }
        }
        break;
      }
    }
  }

  ui.alert(`‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏° EXP ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÉ‡∏´‡πâ‡∏Å‡∏±‡∏ö: \n${updated.join("\n")}`);
  logAdminAction("‡πÄ‡∏û‡∏¥‡πà‡∏° EXP & Party Point (‡∏´‡∏•‡∏≤‡∏¢‡∏Ñ‡∏ô)", `${phones.length} ‡∏Ñ‡∏ô | ${activityName} +${exp}`, admin);
  updateRanks();
  updateLeaderboard();
}


// ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏° EXP ‡πÅ‡∏ö‡∏ö manual (‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£)
function manualAddExp() {
  
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const ui = SpreadsheetApp.getUi();
  const dashSheet = ss.getSheetByName("Member Dashboard");
  const logSheet = ss.getSheetByName("EXP Log");
  
  // 1. ‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô
  const adminPrompt = ui.prompt("‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô", "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å log)", ui.ButtonSet.OK_CANCEL);
  if (adminPrompt.getSelectedButton() !== ui.Button.OK) return;
  const admin = adminPrompt.getResponseText().trim();
  
  // 2. ‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£
  const phonePrompt = ui.prompt("‡πÄ‡∏û‡∏¥‡πà‡∏° EXP", "‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£", ui.ButtonSet.OK_CANCEL);
  if (phonePrompt.getSelectedButton() !== ui.Button.OK) return;
  const phone = normalizePhone(phonePrompt.getResponseText().trim());

  const dashData = dashSheet.getDataRange().getValues();
  const memberIndex = dashData.findIndex(row => normalizePhone(row[1]) === phone);
  if (memberIndex === -1) return ui.alert("‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏ô‡∏µ‡πâ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö");

  const codename = dashData[memberIndex][2];

  // 3. ‡∏Å‡∏£‡∏≠‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô EXP
  const expPrompt = ui.prompt("‡πÄ‡∏û‡∏¥‡πà‡∏° EXP", `‡∏Å‡∏£‡∏≠‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô EXP ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö ${codename}`, ui.ButtonSet.OK_CANCEL);
  if (expPrompt.getSelectedButton() !== ui.Button.OK) return;
  const exp = Number(expPrompt.getResponseText().trim());
  if (isNaN(exp)) return ui.alert("‚ùå ‡∏Å‡∏£‡∏≠‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô EXP ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á");

  // 4. ‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°
  const activityPrompt = ui.prompt("‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°", `‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö ${codename}`, ui.ButtonSet.OK_CANCEL);
  if (activityPrompt.getSelectedButton() !== ui.Button.OK) return;
  const activity = activityPrompt.getResponseText().trim();
  if (!activity) return ui.alert("‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°");

  // --- ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£ ---
  let summary = `‡∏Ñ‡∏∏‡∏ì‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏à‡∏∞‡πÄ‡∏û‡∏¥‡πà‡∏° EXP ‡πÅ‡∏ö‡∏ö manual ‡πÉ‡∏´‡πâ‡∏Å‡∏±‡∏ö:\n\n- ${codename} (${phone})\n- ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô EXP: ${exp}\n- ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°: ${activity}`;
  const confirm = ui.alert("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏° EXP (Manual)", summary + "\n\n‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?", ui.ButtonSet.YES_NO);
  if (confirm !== ui.Button.YES) return;

  // 5. ‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏° EXP
  const currentExp = Number(dashData[memberIndex][4]);
  dashSheet.getRange(memberIndex + 1, 5).setValue(currentExp + exp);

  // 6. ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å log
  const row = logSheet.getLastRow() + 1;
  logSheet.getRange(row, 1, 1, 5).setValues([[phone, codename, new Date(), activity, exp]]);
  logSheet.getRange(row, 1).setNumberFormat("@");

  ui.alert(`‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏° ${exp} EXP ‡πÉ‡∏´‡πâ ${codename} ‡πÅ‡∏•‡πâ‡∏ß\n‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°: ${activity}`);
  logAdminAction("‡πÄ‡∏û‡∏¥‡πà‡∏° EXP (Manual)", `‡πÉ‡∏´‡πâ ${codename} (${phone}) +${exp} | ${activity}`, admin);
  updateRanks();
  updateLeaderboard();
}


// ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏° Party Point ‡πÅ‡∏ö‡∏ö manual (‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£)
function manualAddPartyPoint() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const ui = SpreadsheetApp.getUi();
  const dashSheet = ss.getSheetByName("Member Dashboard");
  const partySheet = ss.getSheetByName("Party");
  const partyLogSheet = ss.getSheetByName("Party Log");
  
  // 1. ‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô
  const adminPrompt = ui.prompt("‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô", "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å log)", ui.ButtonSet.OK_CANCEL);
  if (adminPrompt.getSelectedButton() !== ui.Button.OK) return;
  const admin = adminPrompt.getResponseText().trim();

  // 2. ‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å
  const phonePrompt = ui.prompt("‡πÄ‡∏û‡∏¥‡πà‡∏° Party Point", "‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å", ui.ButtonSet.OK_CANCEL);
  if (phonePrompt.getSelectedButton() !== ui.Button.OK) return;
  const phone = normalizePhone(phonePrompt.getResponseText().trim());

  const dashData = dashSheet.getDataRange().getValues();
  const memberIndex = dashData.findIndex(row => normalizePhone(row[1]) === phone);
  if (memberIndex === -1) return ui.alert("‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏ô‡∏µ‡πâ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö");

  const codename = dashData[memberIndex][2];
  const partyName = dashData[memberIndex][5];
  if (!partyName) return ui.alert("‚ùå ‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏õ‡∏≤‡∏£‡πå‡∏ï‡∏µ‡πâ");

  // 3. ‡∏Å‡∏£‡∏≠‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô Party Point
  const pointPrompt = ui.prompt("‡∏à‡∏≥‡∏ô‡∏ß‡∏ô Party Point", `‡∏à‡∏∞‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡πâ‡∏õ‡∏≤‡∏£‡πå‡∏ï‡∏µ‡πâ ${partyName} ‡∏Å‡∏µ‡πà‡πÅ‡∏ï‡πâ‡∏°?`, ui.ButtonSet.OK_CANCEL);
  if (pointPrompt.getSelectedButton() !== ui.Button.OK) return;
  const point = Number(pointPrompt.getResponseText().trim());
  if (isNaN(point)) return ui.alert("‚ùå ‡∏Å‡∏£‡∏≠‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÅ‡∏ï‡πâ‡∏°‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á");

  // 4. ‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°
  const activityPrompt = ui.prompt("‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°", `‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏≤‡∏£‡πå‡∏ï‡∏µ‡πâ ${partyName}`, ui.ButtonSet.OK_CANCEL);
  if (activityPrompt.getSelectedButton() !== ui.Button.OK) return;
  const activity = activityPrompt.getResponseText().trim();
  if (!activity) return ui.alert("‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°");

  // --- ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£ ---
  let summary = `‡∏Ñ‡∏∏‡∏ì‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏à‡∏∞‡πÄ‡∏û‡∏¥‡πà‡∏° Party Point ‡πÅ‡∏ö‡∏ö manual ‡πÉ‡∏´‡πâ‡∏Å‡∏±‡∏ö:\n\n- ‡∏õ‡∏≤‡∏£‡πå‡∏ï‡∏µ‡πâ: ${partyName}\n- ‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å: ${codename} (${phone})\n- ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô: ${point}\n- ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°: ${activity}`;
  const confirm = ui.alert("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏° Party Point (Manual)", summary + "\n\n‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?", ui.ButtonSet.YES_NO);
  if (confirm !== ui.Button.YES) return;

  // 5. ‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏° Party Point
  const partyData = partySheet.getDataRange().getValues();
  const partyIndex = partyData.findIndex(row => row[0] === partyName);
  if (partyIndex === -1) return ui.alert("‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏õ‡∏≤‡∏£‡πå‡∏ï‡∏µ‡πâ‡∏ô‡∏µ‡πâ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö");

  const currentPoint = Number(partyData[partyIndex][2]);
  partySheet.getRange(partyIndex + 1, 3).setValue(currentPoint + point);

  // 6. ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å log
  const row = partyLogSheet.getLastRow() + 1;
  partyLogSheet.getRange(row, 1, 1, 6).setValues([
    [new Date(), partyName, codename, activity, point, "‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏î‡πâ‡∏ß‡∏¢‡∏ï‡∏ô‡πÄ‡∏≠‡∏á"]
  ]);
  partyLogSheet.getRange(row, 3).setNumberFormat("@");

  logAdminAction("‡πÄ‡∏û‡∏¥‡πà‡∏° Party Point", `‡πÉ‡∏´‡πâ‡∏õ‡∏≤‡∏£‡πå‡∏ï‡∏µ‡πâ ${partyName} +${point} (${codename}) | ${activity}`, admin);
  ui.alert(`‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏° Party Point ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÉ‡∏´‡πâ‡∏õ‡∏≤‡∏£‡πå‡∏ï‡∏µ‡πâ ${partyName}\n‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°: ${activity}`);
}





function disbandParty() {
  const ui = SpreadsheetApp.getUi();
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const partySheet = ss.getSheetByName("Party");
  const trackerSheet = ss.getSheetByName("Party Tracker");
  const dashSheet = ss.getSheetByName("Member Dashboard");
  const partyLogSheet = ss.getSheetByName("Party Log");
  const adminPrompt = ui.prompt("‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô", "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å log)", ui.ButtonSet.OK_CANCEL);
  if (adminPrompt.getSelectedButton() !== ui.Button.OK) return;
  const admin = adminPrompt.getResponseText().trim();


  // üîΩ ‡∏™‡∏£‡πâ‡∏≤‡∏á Dropdown ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏õ‡∏≤‡∏£‡πå‡∏ï‡∏µ‡πâ
  const partyNames = partySheet.getRange(2, 1, partySheet.getLastRow() - 1).getValues().flat();
  if (partyNames.length === 0) {
    ui.alert("‚ùå ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏≤‡∏£‡πå‡∏ï‡∏µ‡πâ‡πÉ‡∏´‡πâ‡∏¢‡∏∏‡∏ö");
    return;
  }

  const list = partyNames.map((p, i) => `${i + 1}. ${p}`).join("\n");
  const prompt = ui.prompt("‡∏¢‡∏∏‡∏ö‡∏õ‡∏≤‡∏£‡πå‡∏ï‡∏µ‡πâ", `‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏≤‡∏£‡πå‡∏ï‡∏µ‡πâ‡πÇ‡∏î‡∏¢‡∏û‡∏¥‡∏°‡∏û‡πå‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç:\n\n${list}`, ui.ButtonSet.OK_CANCEL);
  if (prompt.getSelectedButton() !== ui.Button.OK) return;

  const index = Number(prompt.getResponseText().trim()) - 1;
  if (isNaN(index) || index < 0 || index >= partyNames.length) {
    ui.alert("‚ùå ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á");
    return;
  }

  const partyName = partyNames[index];

  // ‚ö†Ô∏è ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏¢‡∏∏‡∏ö
  const trackerData_pre = trackerSheet.getDataRange().getValues();
  const members = trackerData_pre.filter(row => row[0] === partyName).map(r => r[1]);
  const confirm = ui.alert("‚ö†Ô∏è ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏¢‡∏∏‡∏ö‡∏õ‡∏≤‡∏£‡πå‡∏ï‡∏µ‡πâ", `‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏¢‡∏∏‡∏ö‡∏õ‡∏≤‡∏£‡πå‡∏ï‡∏µ‡πâ "${partyName}"?\n\n‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å (${members.length} ‡∏Ñ‡∏ô): ${members.join(", ")}\n\n‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏õ‡∏≤‡∏£‡πå‡∏ï‡∏µ‡πâ‡∏ô‡∏µ‡πâ`, ui.ButtonSet.YES_NO);
  if (confirm !== ui.Button.YES) return;

  // ‚úÖ ‡∏•‡∏ö‡∏à‡∏≤‡∏Å‡∏ä‡∏µ‡∏ó Party
  const partyData = partySheet.getDataRange().getValues();
  for (let i = 1; i < partyData.length; i++) {
    if (partyData[i][0] === partyName) {
      partySheet.deleteRow(i + 1);
      break;
    }
  }

  // ‚úÖ ‡∏•‡∏ö‡∏à‡∏≤‡∏Å Party Tracker (‡∏à‡∏≤‡∏Å‡∏•‡πà‡∏≤‡∏á‡∏Ç‡∏∂‡πâ‡∏ô‡∏ö‡∏ô)
  const trackerData_post = trackerSheet.getDataRange().getValues();
  for (let i = trackerData_post.length - 1; i >= 1; i--) {
    if (trackerData_post[i][0] === partyName) {
      trackerSheet.deleteRow(i + 1);
    }
  }

  // ‚úÖ ‡∏•‡∏ö‡∏à‡∏≤‡∏Å Member Dashboard
  const dashData = dashSheet.getDataRange().getValues();
  for (let i = 1; i < dashData.length; i++) {
    if (dashData[i][5] === partyName) {
      dashSheet.getRange(i + 1, 6).setValue(""); // ‡∏•‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡∏õ‡∏≤‡∏£‡πå‡∏ï‡∏µ‡πâ‡∏≠‡∏≠‡∏Å
    }
  }

  // ‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å log: ‡∏õ‡∏≤‡∏£‡πå‡∏ï‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡∏¢‡∏∏‡∏ö
  partyLogSheet.appendRow([
    new Date(),
    partyName,
    "System",
    "‡∏õ‡∏≤‡∏£‡πå‡∏ï‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡∏¢‡∏∏‡∏ö",
    "",
    "‡∏•‡∏ö‡πÇ‡∏î‡∏¢‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏°‡∏ô‡∏π"
  ]);

  updateLeaderboard();
  sortAndHighlightPartyTracker();
  logAdminAction("‡∏¢‡∏∏‡∏ö‡∏õ‡∏≤‡∏£‡πå‡∏ï‡∏µ‡πâ", `‡∏ä‡∏∑‡πà‡∏≠: ${partyName}`, admin);
  ui.alert(`‚úÖ ‡∏¢‡∏∏‡∏ö‡∏õ‡∏≤‡∏£‡πå‡∏ï‡∏µ‡πâ "${partyName}" ‡πÅ‡∏•‡∏∞‡∏•‡∏ö‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏≠‡∏≠‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß`);
}


function undoLastExpSingle() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const ui = SpreadsheetApp.getUi();
  const dash = ss.getSheetByName("Member Dashboard");
  const log = ss.getSheetByName("EXP Log");

  const adminPrompt = ui.prompt("‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô", "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å log)", ui.ButtonSet.OK_CANCEL);
  if (adminPrompt.getSelectedButton() !== ui.Button.OK) return;
  const admin = adminPrompt.getResponseText().trim();

  const phonePrompt = ui.prompt("‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏° EXP", "‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏Ç‡∏≠‡∏á‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å", ui.ButtonSet.OK_CANCEL);
  if (phonePrompt.getSelectedButton() !== ui.Button.OK) return;
  const phone = normalizePhone(phonePrompt.getResponseText().trim());

  const logData = log.getDataRange().getValues();
  for (let i = logData.length - 1; i >= 1; i--) {
    if (normalizePhone(logData[i][0]) === phone) {
      const codename = logData[i][1];
      const activity = logData[i][3];
      const exp = Number(logData[i][4]);
      if (isNaN(exp)) {
        ui.alert("‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• EXP ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î");
        return;
      }

      const dashData = dash.getDataRange().getValues();
      for (let j = 1; j < dashData.length; j++) {
        if (normalizePhone(dashData[j][1]) === phone) {
          const currentExp = Number(dashData[j][4]);
          dash.getRange(j + 1, 5).setValue(currentExp - exp);

          const now = Utilities.formatDate(new Date(), Session.getScriptTimeZone(), "dd/MM/yyyy HH:mm:ss");

          // ‚úÖ log ‡πÅ‡∏ö‡∏ö‡∏•‡πá‡∏≠‡∏Å format ‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô
          const rowIndex = log.getLastRow() + 1;
          log.getRange(rowIndex, 1).setNumberFormat("@"); // format ‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏Å‡πà‡∏≠‡∏ô
          log.getRange(rowIndex, 1, 1, 5).setValues([[phone, codename, now, `UNDO: ${activity}`, -exp]]);

          ui.alert(`‚Ü©Ô∏è ‡∏¢‡πâ‡∏≠‡∏ô ${exp} EXP ‡∏à‡∏≤‡∏Å‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° "${activity}" ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß`);
          logAdminAction("UNDO EXP ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î (1 ‡∏Ñ‡∏ô)", `‡πÄ‡∏ö‡∏≠‡∏£‡πå: ${phone} | -${exp} (${activity})`, admin);
          updateRanks();
          updateLeaderboard();
          return;
        }
      }
    }
  }

  ui.alert("‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• EXP ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏Ç‡∏≠‡∏á‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏ô‡∏µ‡πâ");
}




function undoLastExpBulk() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const ui = SpreadsheetApp.getUi();
  const dash = ss.getSheetByName("Member Dashboard");
  const log = ss.getSheetByName("EXP Log");
  const adminPrompt = ui.prompt("‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô", "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å log)", ui.ButtonSet.OK_CANCEL);
  if (adminPrompt.getSelectedButton() !== ui.Button.OK) return;
  const admin = adminPrompt.getResponseText().trim();

  const phonePrompt = ui.prompt("‡∏¢‡πâ‡∏≠‡∏ô EXP (‡∏´‡∏•‡∏≤‡∏¢‡∏Ñ‡∏ô)", "‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£ (‡πÄ‡∏ß‡πâ‡∏ô‡∏ß‡∏£‡∏£‡∏Ñ , ‡∏´‡∏£‡∏∑‡∏≠‡∏Ç‡∏∂‡πâ‡∏ô‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÉ‡∏´‡∏°‡πà)", ui.ButtonSet.OK_CANCEL);
  if (phonePrompt.getSelectedButton() !== ui.Button.OK) return;
  const phonesRaw = phonePrompt.getResponseText().trim();
  const rawPhones = phonesRaw.split(/\s|,|\n/).map(p => p.trim()).filter(p => p);
  const phones = rawPhones.map(normalizePhone);

  const logData = log.getDataRange().getValues();
  const dashData = dash.getDataRange().getValues();
  let count = 0;

  for (let phone of phones) {
    for (let i = logData.length - 1; i >= 1; i--) {
      if (normalizePhone(logData[i][0]) === phone) {
        const codename = logData[i][1];
        const activity = logData[i][3];
        const exp = Number(logData[i][4]);
        if (isNaN(exp)) break;

        for (let j = 1; j < dashData.length; j++) {
          if (normalizePhone(dashData[j][1]) === phone) {
            const currentExp = Number(dashData[j][4]);
            dash.getRange(j + 1, 5).setValue(currentExp - exp);

            const now = Utilities.formatDate(new Date(), Session.getScriptTimeZone(), "dd/MM/yyyy HH:mm:ss");
            log.appendRow([phone, codename, now, `UNDO: ${activity}`, -exp]);
            log.getRange(log.getLastRow(), 1).setNumberFormat("@");

            count++;
            break;
          }
        }
        break;
      }
    }
  }

  if (count > 0) {
    ui.alert(`‚Ü©Ô∏è ‡∏¢‡πâ‡∏≠‡∏ô EXP ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÉ‡∏´‡πâ ${count} ‡∏Ñ‡∏ô`);
    logAdminAction("UNDO EXP ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î (‡∏´‡∏•‡∏≤‡∏¢‡∏Ñ‡∏ô)", `${count} ‡∏Ñ‡∏ô`, admin);
    updateRanks();
    updateLeaderboard();
  } else {
    ui.alert("‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• EXP ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏Ç‡∏≠‡∏á‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏ó‡∏µ‡πà‡πÉ‡∏´‡πâ‡∏°‡∏≤");
  }
}

// ‚úÖ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Web App - ‡∏™‡πà‡∏á Quest List ‡πÄ‡∏õ‡πá‡∏ô JSON
function getQuestList() {
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName("Quest List");
  const data = sheet.getDataRange().getValues();
  const headers = data[0];
  const quests = [];

  for (let i = 1; i < data.length; i++) {
     // ‡πÅ‡∏Å‡πâ getQuestList() ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ
      if (data[i][7] !== true) continue; // index 7 = ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå H (checkbox)
    const quest = {};
    headers.forEach((key, index) => {
      quest[key] = data[i][index];
    });
    quests.push(quest);
  }
  return ContentService.createTextOutput(JSON.stringify(quests)).setMimeType(ContentService.MimeType.JSON);
}

// ‚úÖ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô submitQuest(phone, questId)
function submitQuest(e) {
  const phone = normalizePhone(e.parameter.phone);
  const questId = e.parameter.questId;
  const codename = getCodenameFromPhone(phone);

  const questSheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName("Quest List");
  const logSheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName("Quest Log");
  const questData = questSheet.getDataRange().getValues();
  let questName = "";

  for (let i = 1; i < questData.length; i++) {
    if (questData[i][0] === questId) {
      questName = questData[i][1];
      break;
    }
  }

  if (!questName) {
    return ContentService.createTextOutput("‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÄ‡∏Ñ‡∏ß‡∏™‡∏ô‡∏µ‡πâ");
  }

  const now = Utilities.formatDate(new Date(), Session.getScriptTimeZone(), "dd/MM/yyyy HH:mm");
  logSheet.appendRow([now, phone, codename, questId, questName, "‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à", "", "Web"]);
  return ContentService.createTextOutput("‚úÖ ‡∏™‡πà‡∏á‡πÄ‡∏Ñ‡∏ß‡∏™‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß");
}

// ‚úÖ helper: ‡∏´‡∏≤ codename ‡∏à‡∏≤‡∏Å‡πÄ‡∏ö‡∏≠‡∏£‡πå
function getCodenameFromPhone(phone) {
  const dashSheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName("Member Dashboard");
  const data = dashSheet.getDataRange().getValues();
  for (let i = 1; i < data.length; i++) {
    if (normalizePhone(data[i][1]) === normalizePhone(phone)) {
      return data[i][2];
    }
  }
  return "‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ä‡∏∑‡πà‡∏≠";
}

function doGet(e) {
  // Route for the admin panel
  if (e.parameter.page === 'admin') {
    return showAdminPage();
  }
  if (e.parameter.page === 'profile') {
    return HtmlService.createHtmlOutputFromFile('profile.html').setTitle("Member Profile");
  }
  if (e.parameter.page === 'leaderboard') {
    return HtmlService.createHtmlOutputFromFile('leaderboard.html').setTitle("Leaderboard");
  }
  if (e.parameter.page === 'quests') {
    return HtmlService.createHtmlOutputFromFile('quests.html').setTitle("Quest Board");
  }
  if (e.parameter.page === 'challenge') {
    return HtmlService.createHtmlOutputFromFile('challenge.html').setTitle("Challenge");
  }

  const func = e?.parameter?.func;
  if (func === "getLeaderboard") return getLeaderboardData();
  if (func === "getQuestList") return getQuestList();
  if (func === "submitQuest") return submitQuest(e);
  if (func === "getFeaturedQuestsRandom") return getFeaturedQuestsRandom();
  if (func === "getQuestActivityLog") return getQuestActivityLog();
  if (func === "submitQuestToLog") return submitQuestToLog(e);
  if (func === "getCodename") return getCodename(e);
  if (func === "getCodenameList") return getCodenameList();
  if (func === "getChallengeList") return getChallengeList();
  if (func === "getPartyByPhone") return getPartyByPhone(e); // Added for completeness
  if (func === "getMemberProfile") return getMemberProfile(e.parameter.phone);
  if (func === "getPartyMembers") return getPartyMembers(e.parameter.partyName);
  if (func === "getPartyList") return getPartyList();
  if (func === "submitPartyChallenge") return submitPartyChallenge(e);
  if (func === "verifyPartyLeader") return verifyPartyLeader(e);
  if (func === "partyChallengeListPublic") return partyChallengeListPublic();
  if (func === "acceptPartyChallenge") return acceptPartyChallenge(e); // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ
  if (func === "getMemberDashboardData") return getMemberDashboardData();
  if (func === "getGymStandingData") return getGymStandingData();
  return HtmlService.createHtmlOutput("<p>‚úÖ Up Level Guild System Web App</p>");
}

function doPost(e) {
  logToDebugSheet('doPost: raw e', e);
  const func = e?.parameter?.func;
  if (func === "submitQuest") return submitQuest(e);
  if (func === "submitChallengeRequest") return submitChallengeRequest(e);
  if (func === "acceptChallenge") return acceptChallenge(e);
  if (func === "updateChallengeStatus") return updateChallengeStatus(e);
  if (func === "submitPartyChallenge") return submitPartyChallenge(e);
  if (func === "verifyPartyLeader") return verifyPartyLeader(e);
  if (func === "acceptPartyChallenge") return acceptPartyChallenge(e);
  return ContentService.createTextOutput("‚ùå Invalid Request").setMimeType(ContentService.MimeType.TEXT);
}


function getLeaderboardData() {
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName("Leaderboard");
  const data = sheet.getDataRange().getValues();
  const headers = data[0];
  const result = data.slice(1).map(row => {
    const obj = {};
    headers.forEach((h, i) => obj[h] = row[i]);
    return obj;
  });

  return ContentService.createTextOutput(JSON.stringify(result))
    .setMimeType(ContentService.MimeType.JSON);
}


function getFeaturedQuestsRandom() {
  try {
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const sheet = ss.getSheetByName("Quest List");
    
    if (!sheet) {
      console.error("Error: Sheet 'Quest List' not found.");
      return ContentService.createTextOutput(JSON.stringify([])).setMimeType(ContentService.MimeType.JSON);
    }

    const data = sheet.getDataRange().getValues();
    if (data.length < 2) {
      return ContentService.createTextOutput(JSON.stringify([])).setMimeType(ContentService.MimeType.JSON);
    }
    
    const headers = data[0];
    const activeQuests = [];

    // --- ‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç ---
    // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏°‡∏≤‡πÄ‡∏ä‡πá‡∏Å‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ó‡∏µ‡πà 8 (index 7) ‡∏ã‡∏∂‡πà‡∏á‡πÄ‡∏õ‡πá‡∏ô Checkbox ‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏Ñ‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô true ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
    for (let i = 1; i < data.length; i++) {
      if (data[i][7] === true) { // ‡πÄ‡∏ä‡πá‡∏Å‡∏ß‡πà‡∏≤‡∏ï‡∏¥‡πä‡∏Å‡∏ñ‡∏π‡∏Å‡∏ó‡∏µ‡πà‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå H 'Is Active' ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
        const quest = {};
        headers.forEach((key, index) => {
          if (key) { quest[key] = data[i][index]; }
        });
        activeQuests.push(quest);
      }
    }

    // ‡∏™‡∏∏‡πà‡∏°‡πÄ‡∏Ñ‡∏ß‡∏™‡∏Ç‡∏∂‡πâ‡∏ô‡∏°‡∏≤ 3 ‡∏≠‡∏±‡∏ô
    const shuffled = activeQuests.sort(() => 0.5 - Math.random());
    const selected = shuffled.slice(0, 3);
    
    // ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡πÄ‡∏õ‡πá‡∏ô Array ‡∏ï‡∏£‡∏á‡πÜ
    return ContentService.createTextOutput(JSON.stringify(selected))
           .setMimeType(ContentService.MimeType.JSON);
           
  } catch (e) {
    console.error("getFeaturedQuestsRandom Error: " + e.toString());
    return ContentService.createTextOutput(JSON.stringify([])).setMimeType(ContentService.MimeType.JSON);
  }
}

function getQuestActivityLog() {
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName("EXP Log");
  const data = sheet.getDataRange().getValues();
  const result = [];

  for (let i = data.length - 1; i > 0 && result.length < 5; i--) {
    const activity = data[i][3];
    if (typeof activity === 'string' && activity.startsWith("‡∏ó‡∏≥‡πÄ‡∏Ñ‡∏ß‡∏™")) {
      const codename = data[i][1];
      const questName = activity.replace("‡∏ó‡∏≥‡πÄ‡∏Ñ‡∏ß‡∏™: ", "").trim();
      result.push({ Codename: codename, QuestName: questName });
    }
  }

  return ContentService.createTextOutput(JSON.stringify(result))
    .setMimeType(ContentService.MimeType.JSON);
}


function submitQuestToLog(e) {
  const phone = normalizePhone(e.parameter.phone);
  const questId = e.parameter.questId;
  const codename = getCodenameFromPhone(phone);

  const questSheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName("Quest List");
  const questData = questSheet.getDataRange().getValues();
  let questName = "";

  for (let i = 1; i < questData.length; i++) {
    if (questData[i][0] === questId) {
      questName = questData[i][1];
        break;
      }
    }

  if (!questName) {
    return ContentService.createTextOutput("‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö Quest ‡∏ô‡∏µ‡πâ").setMimeType(ContentService.MimeType.TEXT);
  }

  const now = Utilities.formatDate(new Date(), Session.getScriptTimeZone(), "dd/MM/yyyy HH:mm");
  const logSheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName("Quest Log");

  const newRow = [now, "", codename, questId, questName, "‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à", "", "Web"];
  const rowIndex = logSheet.getLastRow() + 1;
  logSheet.getRange(rowIndex, 1, 1, newRow.length).setValues([newRow]);

  // ‚úÖ ‡πÉ‡∏™‡πà‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÅ‡∏¢‡∏Å ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏•‡πá‡∏≠‡∏Å‡∏ü‡∏≠‡∏£‡πå‡πÅ‡∏°‡∏ï
  logSheet.getRange(rowIndex, 2).setValue(phone);
  logSheet.getRange(rowIndex, 2).setNumberFormat("@");

  return ContentService.createTextOutput("‚úÖ ‡∏™‡πà‡∏á‡πÄ‡∏Ñ‡∏ß‡∏™‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß").setMimeType(ContentService.MimeType.TEXT);
}




function approveQuestByPhone() {
  const ui = SpreadsheetApp.getUi();
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const logSheet = ss.getSheetByName("Quest Log");
  const questSheet = ss.getSheetByName("Quest List");
  const dashSheet = ss.getSheetByName("Member Dashboard");
  const expLogSheet = ss.getSheetByName("EXP Log");

  const adminPrompt = ui.prompt("‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÄ‡∏Ñ‡∏ß‡∏™", "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô:", ui.ButtonSet.OK_CANCEL);
  if (adminPrompt.getSelectedButton() !== ui.Button.OK) return;
  const admin = adminPrompt.getResponseText().trim();

  const phonePrompt = ui.prompt("‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏ö‡∏≠‡∏£‡πå", "‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏Ç‡∏≠‡∏á‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÄ‡∏Ñ‡∏ß‡∏™", ui.ButtonSet.OK_CANCEL);
  if (phonePrompt.getSelectedButton() !== ui.Button.OK) return;
  const phone = normalizePhone(phonePrompt.getResponseText().trim());

  const dashData = dashSheet.getDataRange().getValues();
  const dashRow = dashData.find(row => normalizePhone(row[1]) === phone);
  const codename = dashRow ? dashRow[2] : "‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ä‡∏∑‡πà‡∏≠";

  const logData = logSheet.getDataRange().getValues();
  const pendingQuests = [];
  for (let i = 1; i < logData.length; i++) {
    if (normalizePhone(logData[i][1]) === phone && logData[i][5] === "‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à") {
      pendingQuests.push({ row: i + 1, name: logData[i][4], id: logData[i][3] });
    }
  }

  if (pendingQuests.length === 0) {
    ui.alert("‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÄ‡∏Ñ‡∏ß‡∏™‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏ô‡∏µ‡πâ");
    return;
  }

  let listText = pendingQuests.map((q, i) => `${i + 1}. ${q.name}`).join("\n");
  const pickPrompt = ui.prompt("‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏Ñ‡∏ß‡∏™", `‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏Ñ‡∏ô‡∏ô‡∏µ‡πâ‡∏™‡πà‡∏á‡πÄ‡∏Ñ‡∏ß‡∏™‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤:\n\n${listText}\n\n‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥`, ui.ButtonSet.OK_CANCEL);
  if (pickPrompt.getSelectedButton() !== ui.Button.OK) return;
  const index = Number(pickPrompt.getResponseText().trim()) - 1;
  if (isNaN(index) || index < 0 || index >= pendingQuests.length) {
    ui.alert("‚ùå ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á");
    return;
  }

  const selectedQuest = pendingQuests[index];

  const questData = questSheet.getDataRange().getValues();
  const questInfo = questData.find(row => row[0] === selectedQuest.id);
  if (!questInfo) {
    ui.alert("‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Ñ‡∏ß‡∏™‡πÉ‡∏ô Quest List");
    return;
  }

  const exp = Number(questInfo[3]) || 0;
  const pp = Number(questInfo[4]) || 0;

  for (let i = 1; i < dashData.length; i++) {
    if (normalizePhone(dashData[i][1]) === phone) {
      const currentExp = Number(dashData[i][4]);
      dashSheet.getRange(i + 1, 5).setValue(currentExp + exp);
        break;
      }
    }

  const now = Utilities.formatDate(new Date(), Session.getScriptTimeZone(), "dd/MM/yyyy HH:mm:ss");
  expLogSheet.appendRow([phone, codename, now, `‡∏ó‡∏≥‡πÄ‡∏Ñ‡∏ß‡∏™: ${selectedQuest.name}`, exp]);
  expLogSheet.getRange(expLogSheet.getLastRow(), 1).setNumberFormat("@");

  logAdminAction("‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÄ‡∏Ñ‡∏ß‡∏™", `${codename} (${phone}) ‚Üí ${selectedQuest.name} +${exp}`, admin);

  logSheet.getRange(selectedQuest.row, 6).setValue("‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô");
  logSheet.getRange(selectedQuest.row, 8).setValue(admin);

  ui.alert(`‚úÖ ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÄ‡∏Ñ‡∏ß‡∏™ "${selectedQuest.name}" ‡πÉ‡∏´‡πâ ${codename} ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß`);
  updateRanks();
  updateLeaderboard();
}


function getCodenameFromPhone(phone) {
  const dashSheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName("Member Dashboard");
  const data = dashSheet.getDataRange().getValues();
  for (let i = 1; i < data.length; i++) {
    if (normalizePhone(data[i][1]) === normalizePhone(phone)) {
      return data[i][2]; // codename ‡∏≠‡∏¢‡∏π‡πà‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå 3
    }
  }
  return "‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ä‡∏∑‡πà‡∏≠";
}

function getCodename(e) {
  const phone = normalizePhone(e.parameter.phone);
  return ContentService.createTextOutput(getCodenameFromPhone(phone)).setMimeType(ContentService.MimeType.TEXT);
}

function getCodenameList() {
      const dashSheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName("Member Dashboard");
  const data = dashSheet.getDataRange().getValues();
  const codenames = data.slice(1).map(row => row[2]).filter(name => name);
  return ContentService.createTextOutput(JSON.stringify(codenames)).setMimeType(ContentService.MimeType.JSON);
}

function submitChallengeRequest(e) {
  const logSheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName("Challenge Log");
  const challengeSheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName("Challenge");
  const now = Utilities.formatDate(new Date(), Session.getScriptTimeZone(), "dd/MM/yyyy HH:mm:ss");

  if (!e || !e.postData) {
    logSheet.appendRow([now, "‚ùå ‡πÑ‡∏°‡πà‡∏°‡∏µ postData", "", "", ""]);
    return ContentService.createTextOutput("‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á‡∏°‡∏≤");
  }

  const data = JSON.parse(e.postData.contents);
  const phoneRaw = data.phone;
  const phone = normalizePhone(phoneRaw);
  const codename = getCodenameFromPhone(phone);
  const { type, target, mode, wager, title } = data;
  const challengeTitle = title && title.trim() ? title.trim() : generateRandomChallengeTitle(codename);

  const uuid = new Date().getTime().toString(); // üÜï ‡πÉ‡∏ä‡πâ timestamp ‡πÄ‡∏õ‡πá‡∏ô ID

  const values = [
    Utilities.formatDate(new Date(), Session.getScriptTimeZone(), "dd/MM/yyyy HH:mm"),
    phone,
    codename,
    type,
    target,
    mode,
    wager,
    challengeTitle,
    "‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥",
    uuid  // üÜï ‡πÄ‡∏û‡∏¥‡πà‡∏° ID ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
  ];

  try {
    const newRow = challengeSheet.getLastRow() + 1;
    challengeSheet.getRange(newRow, 1, 1, values.length).setValues([values]);
    challengeSheet.getRange(newRow, 2).setNumberFormat("@");

    logSheet.appendRow([now, "‚úÖ ‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏ó‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢", phone, codename, challengeTitle]);

    return ContentService.createTextOutput("‚úÖ ‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏ó‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß ‡∏£‡∏≠‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥")
      .setMimeType(ContentService.MimeType.TEXT);
  } catch (err) {
    logSheet.appendRow([now, "‚ùå ERROR", phone, codename, err.message]);
    return ContentService.createTextOutput("‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏Ç‡∏ì‡∏∞‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏ó‡πâ‡∏≤: " + err.message)
      .setMimeType(ContentService.MimeType.TEXT);
  }
}






function fixChallengePhoneColumn() {
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName("Challenge");
  const phones = sheet.getRange(2, 2, sheet.getLastRow() - 1).getValues();
  for (let i = 0; i < phones.length; i++) {
    const raw = String(phones[i][0]).trim();
    if (raw.length === 9 && !raw.startsWith("0")) {
      sheet.getRange(i + 2, 2).setNumberFormat("@");
      sheet.getRange(i + 2, 2).setValue("0" + raw);
    }
  }
}




function generateRandomChallengeTitle(codename) {
  const formats = [
    "‡∏®‡∏∂‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏î‡∏Ç‡∏≠‡∏á " + codename,
    "‡∏ó‡πâ‡∏≤‡πÅ‡∏ö‡∏ö‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏£‡∏á‡πÉ‡∏à!",
    "‡∏Ç‡∏≠‡πÅ‡∏Ñ‡πà‡πÑ‡∏î‡πâ‡πÅ‡∏Ç‡πà‡∏á!",
    "‡∏ù‡∏∂‡∏Å‡∏ù‡∏µ‡∏°‡∏∑‡∏≠‡∏Å‡∏±‡∏ö‡πÉ‡∏Ñ‡∏£‡∏™‡∏±‡∏Å‡∏Ñ‡∏ô",
    "‡πÄ‡∏ß‡∏ó‡∏µ‡∏ô‡∏µ‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏Å‡∏µ‡∏¢‡∏£‡∏ï‡∏¥‡∏¢‡∏®!",
    "‡πÉ‡∏Ñ‡∏£‡∏à‡∏∞‡∏≠‡∏¢‡∏π‡πà ‡πÉ‡∏Ñ‡∏£‡∏à‡∏∞‡πÑ‡∏õ"
  ];
  return formats[Math.floor(Math.random() * formats.length)];
}





function getChallengeList() {
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName("Challenge");
  const data = sheet.getDataRange().getValues();
  const headers = data[0];
  const results = [];

  for (let i = 1; i < data.length; i++) {
    const row = data[i];
    // ‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏≥‡∏ó‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ "‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥" ‡∏´‡∏£‡∏∑‡∏≠ "‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏î‡∏ß‡∏•"
    if (row[headers.indexOf("‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ñ‡∏≥‡∏ó‡πâ‡∏≤")] === "‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥" || 
        row[headers.indexOf("‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ñ‡∏≥‡∏ó‡πâ‡∏≤")] === "‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏î‡∏ß‡∏•") {
      const item = {};
      headers.forEach((key, index) => item[key] = row[index]);
      results.push(item);
    }
  }

  return ContentService.createTextOutput(JSON.stringify(results))
    .setMimeType(ContentService.MimeType.JSON);
}

function approveChallenge() {
  const ui = SpreadsheetApp.getUi();
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName("Challenge");
  const data = sheet.getDataRange().getValues();

  const adminPrompt = ui.prompt("‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô", "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å log)", ui.ButtonSet.OK_CANCEL);
  if (adminPrompt.getSelectedButton() !== ui.Button.OK || !adminPrompt.getResponseText().trim()) return;
  const admin = adminPrompt.getResponseText().trim();

  const pending = [];
  for (let i = 1; i < data.length; i++) {
    if (data[i][8] === "‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥") {
      pending.push({ index: i + 1, title: data[i][7], codename: data[i][2] });
    }
  }

  if (pending.length === 0) {
    ui.alert("‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏≥‡∏ó‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥");
    return;
  }

  const list = pending.map((p, i) => `${i + 1}. ${p.codename} - ${p.title}`).join("\n");
  const prompt = ui.prompt("‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏Ñ‡∏≥‡∏ó‡πâ‡∏≤", `‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏≥‡∏ó‡πâ‡∏≤‡πÇ‡∏î‡∏¢‡∏û‡∏¥‡∏°‡∏û‡πå‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç:\n\n${list}`, ui.ButtonSet.OK_CANCEL);
  if (prompt.getSelectedButton() !== ui.Button.OK) return;
  const choice = Number(prompt.getResponseText().trim()) - 1;
  if (isNaN(choice) || choice < 0 || choice >= pending.length) {
    ui.alert("‚ùå ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á");
    return;
  }

  const row = pending[choice].index;
  const challengeTitle = pending[choice].title;
  const codename = pending[choice].codename;
  sheet.getRange(row, 9).setValue("‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥");

  logAdminAction("‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏Ñ‡∏≥‡∏ó‡πâ‡∏≤", `‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏Ñ‡∏≥‡∏ó‡πâ‡∏≤‡∏Ç‡∏≠‡∏á ${codename}: "${challengeTitle}"`, admin);
  ui.alert(`‚úÖ ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏Ñ‡∏≥‡∏ó‡πâ‡∏≤‡∏Ç‡∏≠‡∏á ${codename} ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß`);
}


function acceptChallenge(e) {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const sheet = ss.getSheetByName("Challenge");
  const data = sheet.getDataRange().getValues();
  const headers = data[0];

  const idCol = headers.indexOf("ID");
  const typeCol = headers.indexOf("‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó");
  const targetCol = headers.indexOf("‡∏ú‡∏π‡πâ‡∏ñ‡∏π‡∏Å‡∏ó‡πâ‡∏≤");
  const acceptCol = headers.indexOf("‡∏ú‡∏π‡πâ‡∏ï‡∏≠‡∏ö‡∏£‡∏±‡∏ö");
  const statusCol = headers.indexOf("‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ñ‡∏≥‡∏ó‡πâ‡∏≤");

  const { phone, fullname, id, type, target } = JSON.parse(e.postData.contents);
  const codename = getCodenameByPhone(phone);
  const realname = getFullNameByPhone(phone);

  if (!codename || !realname || realname.trim() !== fullname.trim()) {
    return ContentService.createTextOutput("‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å ‡∏´‡∏£‡∏∑‡∏≠‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏ó‡∏µ‡πà‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô");
  }

  const rowIndex = data.findIndex(r => r[idCol] == id);
  if (rowIndex === -1) return ContentService.createTextOutput("‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ñ‡∏≥‡∏ó‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏£‡∏∞‡∏ö‡∏∏");

  const row = data[rowIndex];
  if (row[acceptCol]) return ContentService.createTextOutput("‚ùå ‡∏°‡∏µ‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏Ñ‡∏≥‡∏ó‡πâ‡∏≤‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡πâ‡∏ß");

  if (row[typeCol] === "direct" && row[targetCol] !== codename) {
    return ContentService.createTextOutput("‚ùå ‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏ú‡∏π‡πâ‡∏ñ‡∏π‡∏Å‡∏ó‡πâ‡∏≤‡πÉ‡∏ô‡∏Ñ‡∏≥‡∏ó‡πâ‡∏≤‡∏ô‡∏µ‡πâ");
  }

  // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏π‡πâ‡∏ï‡∏≠‡∏ö‡∏£‡∏±‡∏ö
  sheet.getRange(rowIndex + 1, acceptCol + 1).setValue(codename);

  // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô open ‚Üí ‡∏ï‡∏±‡πâ‡∏á‡∏ú‡∏π‡πâ‡∏ñ‡∏π‡∏Å‡∏ó‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏ú‡∏π‡πâ‡∏ï‡∏≠‡∏ö‡∏£‡∏±‡∏ö‡πÄ‡∏•‡∏¢
  if (row[typeCol] === "open") {
    sheet.getRange(rowIndex + 1, targetCol + 1).setValue(codename);
  }

  // ‚úÖ ‡∏ï‡∏±‡πâ‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏õ‡πá‡∏ô "‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏î‡∏ß‡∏•" ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
  if (statusCol !== -1) {
    sheet.getRange(rowIndex + 1, statusCol + 1).setValue("‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏î‡∏ß‡∏•");
  }

  return ContentService.createTextOutput("‚úÖ ‡∏£‡∏±‡∏ö‡∏Ñ‡∏≥‡∏ó‡πâ‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏î‡∏ß‡∏• !!");
}



function recordChallengeResult() {
  const ui = SpreadsheetApp.getUi();
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName("Challenge");
  const partySheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName("Party");
  const data = sheet.getDataRange().getValues();
  const headers = data[0];

  const adminPrompt = ui.prompt("‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô", "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å log)", ui.ButtonSet.OK_CANCEL);
  if (adminPrompt.getSelectedButton() !== ui.Button.OK || !adminPrompt.getResponseText().trim()) return;
  const admin = adminPrompt.getResponseText().trim();

  const idIndex = headers.indexOf("ID");
  const phoneIndex = headers.indexOf("‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£");
  const codenameIndex = headers.indexOf("Codename");
  const targetIndex = headers.indexOf("‡∏ú‡∏π‡πâ‡∏ñ‡∏π‡∏Å‡∏ó‡πâ‡∏≤");
  const acceptIndex = headers.indexOf("‡∏ú‡∏π‡πâ‡∏ï‡∏≠‡∏ö‡∏£‡∏±‡∏ö");
  const statusIndex = headers.indexOf("‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ñ‡∏≥‡∏ó‡πâ‡∏≤");

  // üîç ‡∏Ñ‡∏≥‡∏ó‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß
  const approvedRows = data.slice(1).filter(r => r[statusIndex] === "‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥");
  if (approvedRows.length === 0) return ui.alert("‚ùå ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏≥‡∏ó‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥");

  const challengeOptions = approvedRows.map(r => `${r[idIndex]} | ${r[codenameIndex]} vs ${r[acceptIndex]}`);
  const choicePrompt = ui.prompt(
    "üìå ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏≥‡∏ó‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏•",
    challengeOptions.join("\n") + "\n\n‡∏Å‡∏£‡∏≠‡∏Å ID ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ (‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç):",
    ui.ButtonSet.OK_CANCEL
  );
  if (choicePrompt.getSelectedButton() !== ui.Button.OK) return;
  const selectedId = choicePrompt.getResponseText().trim();

  const rowIndex = data.findIndex(r => r[idIndex] == selectedId);
  if (rowIndex === -1) return ui.alert("‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ñ‡∏≥‡∏ó‡πâ‡∏≤‡∏î‡πâ‡∏ß‡∏¢ ID ‡∏ô‡∏µ‡πâ");

  const row = data[rowIndex];
  const creatorPhone = normalizePhone(row[phoneIndex]);
  const creatorCodename = row[codenameIndex];
  const acceptorCodename = row[acceptIndex];
  const targetCodename = row[targetIndex];

  if (!acceptorCodename) return ui.alert("‚ùå ‡∏Ñ‡∏≥‡∏ó‡πâ‡∏≤‡∏ô‡∏µ‡πâ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö");

  // üîΩ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏π‡πâ‡∏ä‡∏ô‡∏∞
  const winnerPrompt = ui.prompt(
    "üèÜ ‡πÉ‡∏Ñ‡∏£‡∏Ñ‡∏∑‡∏≠‡∏ú‡∏π‡πâ‡∏ä‡∏ô‡∏∞",
    `1. ${creatorCodename}\n2. ${acceptorCodename}\n\n‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠ Codename ‡∏ó‡∏µ‡πà‡∏ä‡∏ô‡∏∞`,
    ui.ButtonSet.OK_CANCEL
  );
  if (winnerPrompt.getSelectedButton() !== ui.Button.OK) return;
  const winnerCodename = winnerPrompt.getResponseText().trim();

  const winnerPhone = getPhoneByCodename(winnerCodename);
  const loserPhone = (winnerCodename === creatorCodename)
    ? getPhoneByCodename(acceptorCodename)
    : creatorPhone;

  // üéÅ ‡∏Å‡∏£‡∏≠‡∏Å EXP ‡∏ó‡∏µ‡πà‡πÄ‡∏î‡∏¥‡∏°‡∏û‡∏±‡∏ô (optional)
  const wagerPrompt = ui.prompt(
    "üéÅ EXP ‡∏ó‡∏µ‡πà‡πÄ‡∏î‡∏¥‡∏°‡∏û‡∏±‡∏ô (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)",
    "‡πÄ‡∏ä‡πà‡∏ô 3 ‡∏´‡∏£‡∏∑‡∏≠ -2 (‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÉ‡∏™‡πà‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ú‡∏•‡πÄ‡∏î‡∏¥‡∏°‡∏û‡∏±‡∏ô)", ui.ButtonSet.OK_CANCEL
  );
  if (wagerPrompt.getSelectedButton() !== ui.Button.OK) return; // Allow empty response to proceed
  const expText = wagerPrompt.getResponseText().trim();
  const expAmount = expText ? parseInt(expText) : 0;

  // üÜï ‡∏Å‡∏£‡∏≠‡∏Å Party Point ‡∏ó‡∏µ‡πà‡πÄ‡∏î‡∏¥‡∏°‡∏û‡∏±‡∏ô (optional)
  const partyWagerPrompt = ui.prompt(
    "üéÅ Party Point ‡∏ó‡∏µ‡πà‡πÄ‡∏î‡∏¥‡∏°‡∏û‡∏±‡∏ô (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)",
    "‡πÄ‡∏ä‡πà‡∏ô 5 (‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÉ‡∏™‡πà‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ú‡∏•‡πÄ‡∏î‡∏¥‡∏°‡∏û‡∏±‡∏ô)", ui.ButtonSet.OK_CANCEL
  );
  if (partyWagerPrompt.getSelectedButton() !== ui.Button.OK) return;
  const partyWager = partyWagerPrompt.getResponseText().trim() ? Number(partyWagerPrompt.getResponseText().trim()) : 0;

  // üõ† ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
  sheet.getRange(rowIndex + 1, statusIndex + 1).setValue("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏•‡πÅ‡∏•‡πâ‡∏ß");

  // ‚úÖ ‡πÉ‡∏´‡πâ EXP & Party ‡∏ó‡∏±‡πâ‡∏á‡∏Ñ‡∏π‡πà
  giveExpAndParty(creatorPhone, "‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ó‡πâ‡∏≤‡πÅ‡∏Ç‡πà‡∏á", 1);
  giveExpAndParty(getPhoneByCodename(acceptorCodename), "‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ó‡πâ‡∏≤‡πÅ‡∏Ç‡πà‡∏á", 1);

  // ‚ûï‚ûñ ‡∏Å‡∏£‡∏ì‡∏µ‡∏°‡∏µ‡πÄ‡∏î‡∏¥‡∏°‡∏û‡∏±‡∏ô EXP
  if (!isNaN(expAmount) && expAmount !== 0) {
    giveExp(winnerPhone, `‡∏ä‡∏ô‡∏∞‡πÄ‡∏î‡∏¥‡∏°‡∏û‡∏±‡∏ô EXP`, expAmount);
    giveExp(loserPhone, `‡πÅ‡∏û‡πâ‡πÄ‡∏î‡∏¥‡∏°‡∏û‡∏±‡∏ô EXP`, -expAmount);
  }

  // üÜï ‚ûï‚ûñ Party Point ‡πÄ‡∏î‡∏¥‡∏°‡∏û‡∏±‡∏ô (‡∏´‡πâ‡∏≤‡∏°‡∏ï‡∏¥‡∏î‡∏•‡∏ö)
  if (partyWager && partyWager > 0) {
    const partyData = partySheet.getDataRange().getValues();
    const winnerParty = getPartyByPhone(winnerPhone);
    const loserParty = getPartyByPhone(loserPhone);
    const winnerIdx = partyData.findIndex(r => r[0] === winnerParty);
    const loserIdx = partyData.findIndex(r => r[0] === loserParty);
    let loserCurrent = loserIdx !== -1 ? Number(partyData[loserIdx][2]) : 0;
    let winnerCurrent = winnerIdx !== -1 ? Number(partyData[winnerIdx][2]) : 0;
    const canLose = Math.max(0, loserCurrent - partyWager);
    const actualLost = loserCurrent - canLose;
    // ‡∏•‡∏ö‡∏ù‡∏±‡πà‡∏á‡πÅ‡∏û‡πâ
    if (loserIdx !== -1) partySheet.getRange(loserIdx + 1, 3).setValue(canLose);
    // ‡∏ö‡∏ß‡∏Å‡∏ù‡∏±‡πà‡∏á‡∏ä‡∏ô‡∏∞
    if (winnerIdx !== -1) partySheet.getRange(winnerIdx + 1, 3).setValue(winnerCurrent + actualLost);
  }

  const logMessage = `‡∏ú‡∏•: ${winnerCodename} ‡∏ä‡∏ô‡∏∞ ${acceptorCodename}. EXP ‡πÄ‡∏î‡∏¥‡∏°‡∏û‡∏±‡∏ô: ${expAmount || 0}`;
  logAdminAction("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ó‡πâ‡∏≤‡πÅ‡∏Ç‡πà‡∏á", logMessage, admin);
  ui.alert(`‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${winnerCodename} ‡∏ä‡∏ô‡∏∞\n+1 EXP/Party ‡∏ó‡∏±‡πâ‡∏á‡∏Ñ‡∏π‡πà${expAmount ? `\n‡πÄ‡∏î‡∏¥‡∏°‡∏û‡∏±‡∏ô EXP: ${expAmount}` : ""}${partyWager ? `\n‡πÄ‡∏î‡∏¥‡∏°‡∏û‡∏±‡∏ô Party Point: ${partyWager}` : ""}`);
}

function normalizePhone(phone) {
  phone = phone.replace(/\D/g, "");
  if (phone.length === 9 && !phone.startsWith("0")) return "0" + phone;
  return phone;
}

function getPhoneByCodename(codename) {
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName("Member Dashboard");
  const data = sheet.getDataRange().getValues();
  for (let i = 1; i < data.length; i++) {
    if (String(data[i][2]).toLowerCase().trim() === codename.toLowerCase().trim()) {
      return normalizePhone(data[i][1]);
    }
  }
  return "";
}

function getCodenameByPhone(phone) {
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName("Member Dashboard");
  const data = sheet.getDataRange().getValues();
  for (let i = 1; i < data.length; i++) {
    if (normalizePhone(data[i][1]) === normalizePhone(phone)) {
      return data[i][2];
    }
  }
  return "";
}

function giveExpAndParty(phone, note, exp = 1) {
  giveExp(phone, note, exp);
  givePartyPoint(phone, note, 1);
}

function giveExp(phone, note, amount) {
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName("EXP Log");
  const time = new Date();
  const codename = getCodenameByPhone(phone);
  sheet.appendRow([phone, codename, time, note, amount]);
  sheet.getRange(sheet.getLastRow(), 1).setNumberFormat("@");
  updateRanks();
  updateLeaderboard();
}

function givePartyPoint(phone, note, amount) {
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName("Party Log");
  const time = new Date();
  const codename = getCodenameByPhone(phone);
  const partyName = getPartyByPhone(phone);
  
  sheet.appendRow([time, partyName, codename, note, amount, "‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö"]);
  sheet.getRange(sheet.getLastRow(), 3).setNumberFormat("@");
  
  // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Party Point ‡πÉ‡∏ô‡∏ä‡∏µ‡∏ó Party
  if (partyName) {
    const partySheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName("Party");
    const partyData = partySheet.getDataRange().getValues();
    for (let i = 1; i < partyData.length; i++) {
      if (partyData[i][0] === partyName) {
        const currentPoint = Number(partyData[i][2]) || 0;
        partySheet.getRange(i + 1, 3).setValue(currentPoint + amount);
        break;
      }
    }
  }
}

// ‚úÖ helper: ‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡∏õ‡∏≤‡∏£‡πå‡∏ï‡∏µ‡πâ‡∏à‡∏≤‡∏Å‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£
function getPartyByPhone(phone) {
  const dashSheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName("Member Dashboard");
  const data = dashSheet.getDataRange().getValues();
  for (let i = 1; i < data.length; i++) {
    if (normalizePhone(data[i][1]) === normalizePhone(phone)) {
      return data[i][5] || "";
    }
  }
  return "";
}

// ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏´‡∏•‡πà‡∏≤‡∏ô‡∏µ‡πâ‡∏ï‡πà‡∏≠‡∏ó‡πâ‡∏≤‡∏¢‡πÑ‡∏ü‡∏•‡πå app script ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì (‡∏´‡∏•‡∏±‡∏á‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢)

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ñ‡∏≥‡∏ó‡πâ‡∏≤ (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏°‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡πÉ‡∏ô HTML)
function updateChallengeStatus(request) {
  try {
    const data = JSON.parse(request.postData.contents);
    const id = data.id;
    const status = data.status;
    
    const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName("Challenge");
    const dataRange = sheet.getDataRange();
    const values = dataRange.getValues();
    const headers = values[0];
    
    const idIndex = headers.indexOf("ID");
    const statusIndex = headers.indexOf("‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ñ‡∏≥‡∏ó‡πâ‡∏≤");
    
    // ‡∏´‡∏≤‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà‡∏°‡∏µ ID ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô
    let rowIndex = -1;
    for (let i = 1; i < values.length; i++) {
      if (values[i][idIndex] == id) {
        rowIndex = i + 1;
        break;
      }
    }

    if (rowIndex === -1) {
      return ContentService.createTextOutput("‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ñ‡∏≥‡∏ó‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏°‡∏µ ID ‡∏ô‡∏µ‡πâ");
    }
    
    // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
    sheet.getRange(rowIndex, statusIndex + 1).setValue(status);
    
    return ContentService.createTextOutput("‚úÖ ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢");
    
  } catch (error) {
    return ContentService.createTextOutput("‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + error.toString());
  }
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠ - ‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏ï‡πá‡∏°‡∏à‡∏≤‡∏Å‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£ (‡∏Ñ‡πâ‡∏ô‡∏à‡∏≤‡∏Å Member Database)
function getFullNameByPhone(phone) {
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName("Member Database");
  const data = sheet.getDataRange().getValues();
  for (let i = 1; i < data.length; i++) {
    if (normalizePhone(data[i][3]) === normalizePhone(phone)) {
      return data[i][1]; // ‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•
    }
  }
  return "";
}

/**
 * Handles the form submission event.
 * This function should be set as the "On form submit" trigger for the spreadsheet.
 * @param {Object} e The event object.
 */
function handleFormSubmit(e) {
  const lock = LockService.getScriptLock();
  if (!lock.tryLock(15000)) {
    console.log("Server is busy, submission for " + e.namedValues['‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£'] + " will be processed later if needed, but the row is already in the sheet.");
    return;
  }

  try {
    const dbSheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName("Member Database");
    const newRowRange = e.range;
    const newRowIndex = newRowRange.getRow();
    
    // --- Get data from the submitted form ---
    // Make sure the keys here EXACTLY match your Google Form question titles
    const codename = e.namedValues['Codename'][0].trim();
    const phone = normalizePhone(e.namedValues['‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£'][0].trim());
    const rank = e.namedValues['Rank'][0].trim();
    const isPremium = e.namedValues['Premium?'][0] === 'Yes'; // Adjust 'Yes' if your form uses a different value
    const referrer = e.namedValues['‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏ú‡∏π‡πâ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)'] ? normalizePhone(e.namedValues['‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏ú‡∏π‡πâ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)'][0].trim()) : "";

    // --- Search for duplicates (excluding the newly added row) ---
    const dbData = dbSheet.getDataRange().getValues();
    let originalRowIndex = -1;

    for (let i = 1; i < dbData.length; i++) {
      // Skip the row that was just added
      if (i + 1 === newRowIndex) continue;
      
      if (normalizePhone(dbData[i][3]) === phone) { // Assuming phone is in column D (index 3)
        originalRowIndex = i + 1;
        break;
      }
    }

    if (originalRowIndex !== -1) {
      // --- DUPLICATE FOUND ---
      // 1. Update the original row with new data
      dbSheet.getRange(originalRowIndex, 1).setValue(new Date()); // Update timestamp
      dbSheet.getRange(originalRowIndex, 2).setValue(codename);   // Update Codename
      dbSheet.getRange(originalRowIndex, 5).setValue(rank);       // Update Rank
      
      // 2. CRITICAL: Delete the new row that the form just added
      dbSheet.deleteRow(newRowIndex);
      
      // 3. Update other sheets
      updateDashboardAndLeaderboardForExistingUser(phone, codename, rank);

    } else {
      // --- NEW MEMBER ---
      // The row is already in Member Database, just fill in other details
      const initialExp = isPremium ? 2 : 1;
      dbSheet.getRange(newRowIndex, 3).setValue("Member");
      dbSheet.getRange(newRowIndex, 6).setValue(initialExp);
      dbSheet.getRange(newRowIndex, 7).setValue(isPremium);
      dbSheet.getRange(newRowIndex, 8).setValue(referrer);
      
      // Add to other sheets
      const dashSheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName("Member Dashboard");
      dashSheet.appendRow([new Date(), phone, codename, rank, initialExp, ""]);

      const lbSheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName("Leaderboard");
      lbSheet.appendRow([new Date(), phone, codename, rank, initialExp, ""]);

      logExp(phone, "‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å", initialExp);

      if (isPremium && referrer) {
        const referrerData = dbData.find(row => normalizePhone(row[3]) === referrer);
        if (referrerData) {
          logExp(referrer, "‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏™‡∏°‡∏±‡∏Ñ‡∏£ (Premium)", 2);
        }
      }
    }

    updateLeaderboard();

  } catch (err) {
    // Log error to know if something goes wrong
    console.error("handleFormSubmit Error: " + err.toString());
    console.error("Event Object: " + JSON.stringify(e));
  } finally {
    lock.releaseLock();
  }
}

// You can keep this helper function as it is still useful
function updateDashboardAndLeaderboardForExistingUser(phone, codename, rank) {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const dashSheet = ss.getSheetByName("Member Dashboard");
  const lbSheet = ss.getSheetByName("Leaderboard");
  
  // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Member Dashboard
  const dashData = dashSheet.getDataRange().getValues();
  for (let i = 1; i < dashData.length; i++) {
    if (normalizePhone(dashData[i][1]) === phone) {
      dashSheet.getRange(i + 1, 3).setValue(codename); // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Codename
      dashSheet.getRange(i + 1, 4).setValue(rank);     // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Rank
      break;
    }
  }
  
  // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Leaderboard
  const lbData = lbSheet.getDataRange().getValues();
  for (let i = 1; i < lbData.length; i++) {
    if (normalizePhone(lbData[i][1]) === phone) {
      lbSheet.getRange(i + 1, 3).setValue(codename); // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Codename
      lbSheet.getRange(i + 1, 4).setValue(rank);     // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Rank
      break;
    }
  }
  
  updateRanks();
  updateLeaderboard();
}

// ‚úÖ ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ã‡πâ‡∏≥‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö
function clearDuplicateEntriesDebug() {
  const ui = SpreadsheetApp.getUi();
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const dashSheet = ss.getSheetByName("Member Dashboard");
  const dbSheet = ss.getSheetByName("Member Database");
  
  const adminPrompt = ui.prompt("‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô", "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å log)", ui.ButtonSet.OK_CANCEL);
  if (adminPrompt.getSelectedButton() !== ui.Button.OK) return;
  const admin = adminPrompt.getResponseText().trim();

  const dashData = dashSheet.getDataRange().getValues();
  const phones = new Map();
  const codenames = new Map();
  let duplicates = [];

  // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ã‡πâ‡∏≥
  for (let i = 1; i < dashData.length; i++) {
    const phone = normalizePhone(dashData[i][1]);
    const codename = String(dashData[i][2]).toLowerCase().trim();
    
    if (phones.has(phone)) {
      duplicates.push({ row: i + 1, type: "phone", value: phone, existing: phones.get(phone) });
    } else {
      phones.set(phone, i + 1);
    }
    
    if (codenames.has(codename)) {
      duplicates.push({ row: i + 1, type: "codename", value: codename, existing: codenames.get(codename) });
    } else {
      codenames.set(codename, i + 1);
    }
  }

  if (duplicates.length === 0) {
    ui.alert("‚úÖ ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ã‡πâ‡∏≥‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö");
    return;
  }

  // ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ã‡πâ‡∏≥
  let message = `‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ã‡πâ‡∏≥ ${duplicates.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£:\n\n`;
  duplicates.forEach((dup, index) => {
    const member = dashData[dup.row - 1];
    message += `${index + 1}. ‡πÅ‡∏ñ‡∏ß ${dup.row}: ${member[0]} (${dup.type}: ${dup.value})\n`;
  });

  const confirm = ui.alert("üóëÔ∏è ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ã‡πâ‡∏≥", message + "\n‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ã‡πâ‡∏≥‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?", ui.ButtonSet.YES_NO);
  if (confirm !== ui.Button.YES) return;

  // ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ã‡πâ‡∏≥ (‡∏à‡∏≤‡∏Å‡∏•‡πà‡∏≤‡∏á‡∏Ç‡∏∂‡πâ‡∏ô‡∏ö‡∏ô)
  duplicates.sort((a, b) => b.row - a.row);
  let deletedCount = 0;
  
  for (const dup of duplicates) {
    try {
      dashSheet.deleteRow(dup.row);
      deletedCount++;
    } catch (e) {
      console.error(`‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏ö‡πÅ‡∏ñ‡∏ß ${dup.row}: ${e.message}`);
    }
  }

  updateLeaderboard();
  logAdminAction("‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ã‡πâ‡∏≥", `‡∏•‡∏ö ${deletedCount} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`, admin);
  ui.alert(`‚úÖ ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ã‡πâ‡∏≥‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß ${deletedCount} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`);
}

function getPartyByPhone(e) {
  if (!e || !e.parameter || !e.parameter.phone) {
    return ContentService.createTextOutput("‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö phone ‡πÉ‡∏ô parameter: " + JSON.stringify(e && e.parameter)).setMimeType(ContentService.MimeType.TEXT);
  }
  const phone = normalizePhone(e.parameter.phone);
  const partyName = getPartyNameByPhone(phone); // Assuming you rename the original for clarity
  return ContentService.createTextOutput(partyName).setMimeType(ContentService.MimeType.TEXT);
}

// Renamed for clarity from previous steps. 
// If you have 'getPartyByPhone', you can rename it to this.
function getPartyNameByPhone(phone) {
  const dashSheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName("Member Dashboard");
  const data = dashSheet.getDataRange().getValues();
  for (let i = 1; i < data.length; i++) {
    if (normalizePhone(data[i][1]) === normalizePhone(phone)) {
      return data[i][5] || "";
    }
  }
  return "";
}

/**
 * Serves the Admin Panel web page.
 * It checks for admin privileges before serving the page.
 */
function showAdminPage() {
  const userEmail = Session.getActiveUser().getEmail();
  // Server-side check for security. If not an admin, show a generic access denied page.
  if (!isAdmin(userEmail)) {
     return HtmlService.createHtmlOutput('<h1>Access Denied</h1><p>You are not authorized to view this page.</p>');
  }
  // If user is an admin, serve the actual admin panel page.
  return HtmlService.createHtmlOutputFromFile('Admin.html')
    .setTitle("Up Level Admin Panel")
    .addMetaTag('viewport', 'width=device-width, initial-scale=1.0');
}

/**
 * Called by the Admin Web App to get initial data.
 * It returns the user's email and their admin status.
 * This allows the web app to display the correct UI (admin tools or access denied message).
 */
function getAdminWebAppInitialData() {
  const email = Session.getActiveUser().getEmail();
  const userIsAdmin = isAdmin(email);
  return {
    isAdmin: userIsAdmin,
    email: email
  };
}

/**
 * üÜï Changes a member's phone number across all relevant sheets.
 * This is an admin-only function.
 */
function changeMemberPhoneNumber() {
  const ui = SpreadsheetApp.getUi();
  const ss = SpreadsheetApp.getActiveSpreadsheet();

  const adminPrompt = ui.prompt("‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô", "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å log)", ui.ButtonSet.OK_CANCEL);
  if (adminPrompt.getSelectedButton() !== ui.Button.OK || !adminPrompt.getResponseText().trim()) {
    return;
  }
  const admin = adminPrompt.getResponseText().trim();

  const oldPhonePrompt = ui.prompt("‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å", "‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£ '‡πÄ‡∏Å‡πà‡∏≤' ‡∏Ç‡∏≠‡∏á‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å:", ui.ButtonSet.OK_CANCEL);
  if (oldPhonePrompt.getSelectedButton() !== ui.Button.OK) return;
  const oldPhone = normalizePhone(oldPhonePrompt.getResponseText().trim());

  if (!oldPhone) {
      ui.alert("‚ùå ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡πÄ‡∏Å‡πà‡∏≤");
      return;
  }

  const dashSheet = ss.getSheetByName("Member Dashboard");
  const dashData = dashSheet.getDataRange().getValues();
  const memberIndex = dashData.findIndex(row => normalizePhone(row[1]) === oldPhone);

  if (memberIndex === -1) {
    ui.alert(`‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£ '${oldPhone}' ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö (Member Dashboard)`);
    return;
  }

  const codename = dashData[memberIndex][2];

  const newPhonePrompt = ui.prompt("‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å", `‡∏û‡∏ö‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å: ${codename}\n\n‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£ '‡πÉ‡∏´‡∏°‡πà':`, ui.ButtonSet.OK_CANCEL);
  if (newPhonePrompt.getSelectedButton() !== ui.Button.OK) return;
  const newPhone = normalizePhone(newPhonePrompt.getResponseText().trim());

  if (!validatePhoneOrAlert(newPhone, ui)) return;

  if (oldPhone === newPhone) {
      ui.alert("‚ùå ‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡πÉ‡∏´‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡∏ã‡πâ‡∏≥‡∏Å‡∏±‡∏ö‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡πÄ‡∏Å‡πà‡∏≤");
      return;
  }

  const newPhoneExists = dashData.some((row, index) => index !== memberIndex && normalizePhone(row[1]) === newPhone);
  if (newPhoneExists) {
    ui.alert("‚ùå ‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡πÉ‡∏´‡∏°‡πà‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏Ñ‡∏ô‡∏≠‡∏∑‡πà‡∏ô‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß");
    return;
  }
  
  const confirm = ui.alert("‚ö†Ô∏è ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á", `‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏Ç‡∏≠‡∏á '${codename}'\n\n‡∏à‡∏≤‡∏Å: ${oldPhone}\n‡πÄ‡∏õ‡πá‡∏ô: ${newPhone}\n\n‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ó‡∏∏‡∏Å‡∏ä‡∏µ‡∏ó‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á`, ui.ButtonSet.YES_NO);
  if (confirm !== ui.Button.YES) {
    return;
  }

  try {
    SpreadsheetApp.getUi().showSidebar(HtmlService.createHtmlOutput("<p>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ä‡∏µ‡∏ó‡∏ï‡πà‡∏≤‡∏á‡πÜ ‡πÇ‡∏õ‡∏£‡∏î‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà...</p>").setTitle("Processing..."));

    // --- Define all sheets and columns to update ---
    const sheetsToUpdate = [
      { name: "Member Dashboard", col: 2 },
      { name: "Member Database", col: 4 },
      { name: "EXP Log", col: 1 },
      { name: "Party", col: 2 }, // Owner Phone Number
      { name: "Party Tracker", col: 3 },
      { name: "Quest Log", col: 2 },
      { name: "Challenge", col: 2 },
      { name: "Challenge Log", col: 3 }
    ];

    for (const config of sheetsToUpdate) {
        const sheet = ss.getSheetByName(config.name);
        if (sheet) {
            const data = sheet.getDataRange().getValues();
            for (let i = 1; i < data.length; i++) {
                if (normalizePhone(data[i][config.col - 1]) === oldPhone) {
                    sheet.getRange(i + 1, config.col).setValue(newPhone).setNumberFormat("@");
                }
            }
        }
    }

    logAdminAction("‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å", `‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏Ç‡∏≠‡∏á ${codename} ‡∏à‡∏≤‡∏Å ${oldPhone} ‡πÄ‡∏õ‡πá‡∏ô ${newPhone}`, admin);
    ui.alert("‚úÖ ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!");

  } catch (e) {
    ui.alert("‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏Ç‡∏ì‡∏∞‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: " + e.message);
    console.error("changeMemberPhoneNumber Error: " + e.toString());
  }
}

/**
 * üÜï Adds party points based on a predefined list of activities.
 * This function prompts for admin, activity, and a party member's phone number.
 */
function addPartyPointFromActivity() {
  const ui = SpreadsheetApp.getUi();
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  
  const adminPrompt = ui.prompt("‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô", "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å log)", ui.ButtonSet.OK_CANCEL);
  if (adminPrompt.getSelectedButton() !== ui.Button.OK || !adminPrompt.getResponseText().trim()) {
    return;
  }
  const admin = adminPrompt.getResponseText().trim();

  const activitySheet = ss.getSheetByName("Party Activity List");
  if (!activitySheet) {
    ui.alert("‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ä‡∏µ‡∏ó 'Party Activity List'", "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ä‡∏µ‡∏ó‡πÉ‡∏´‡∏°‡πà‡∏ä‡∏∑‡πà‡∏≠ 'Party Activity List' ‡πÇ‡∏î‡∏¢‡∏°‡∏µ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå A ‡πÄ‡∏õ‡πá‡∏ô '‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏õ‡∏≤‡∏£‡πå‡∏ï‡∏µ‡πâ' ‡πÅ‡∏•‡∏∞‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå B ‡πÄ‡∏õ‡πá‡∏ô '‡πÅ‡∏ï‡πâ‡∏°‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ'", ui.ButtonSet.OK);
    return;
  }
  
  const activityData = activitySheet.getRange(2, 1, activitySheet.getLastRow() - 1, 2).getValues().filter(r => r[0] && r[1]);
  if (activityData.length === 0) {
      ui.alert("‚ùå ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡πÉ‡∏ô‡∏ä‡∏µ‡∏ó 'Party Activity List'");
      return;
  }

  const activityList = activityData.map((row, i) => `${i + 1}. ${row[0]} (${row[1]} ‡πÅ‡∏ï‡πâ‡∏°)`).join("\n");
  const activityPrompt = ui.prompt("‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏õ‡∏≤‡∏£‡πå‡∏ï‡∏µ‡πâ (‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏•‡∏Ç)", `‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°:\n\n${activityList}`, ui.ButtonSet.OK_CANCEL);
  if (activityPrompt.getSelectedButton() !== ui.Button.OK) return;

  const activityIndex = Number(activityPrompt.getResponseText().trim()) - 1;
  if (isNaN(activityIndex) || activityIndex < 0 || activityIndex >= activityData.length) {
    ui.alert("‚ùå ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á");
    return;
  }
  
  const [activityName, points] = activityData[activityIndex];
  
  const phonePrompt = ui.prompt("‡πÄ‡∏û‡∏¥‡πà‡∏° Party Point", "‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏Ç‡∏≠‡∏á‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡πÉ‡∏ô‡∏õ‡∏≤‡∏£‡πå‡∏ï‡∏µ‡πâ (‡πÉ‡∏Ñ‡∏£‡∏Å‡πá‡πÑ‡∏î‡πâ):", ui.ButtonSet.OK_CANCEL);
  if (phonePrompt.getSelectedButton() !== ui.Button.OK) return;
  const phone = normalizePhone(phonePrompt.getResponseText().trim());

  if (!validatePhoneOrAlert(phone, ui)) return;

  const dashSheet = ss.getSheetByName("Member Dashboard");
  const dashData = dashSheet.getDataRange().getValues();
  const member = dashData.find(row => normalizePhone(row[1]) === phone);

  if (!member) {
    ui.alert("‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏ô‡∏µ‡πâ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö");
    return;
  }
  
  const codename = member[2];
  const partyName = member[5];

  if (!partyName) {
    ui.alert(`‚ùå ‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å '${codename}' ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏õ‡∏≤‡∏£‡πå‡∏ï‡∏µ‡πâ‡πÉ‡∏î‡πÜ`);
    return;
  }
  
  let pointAmount = 0;
  // üÜï ‡∏ï‡∏£‡∏£‡∏Å‡∏∞‡πÉ‡∏´‡∏°‡πà: ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡πà‡∏≤ 'points'
  if (String(points).trim() === "‡∏ï‡∏≤‡∏°‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å") {
    const trackerSheet = ss.getSheetByName("Party Tracker");
    if (!trackerSheet) {
      ui.alert("‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ä‡∏µ‡∏ó 'Party Tracker' ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å");
      return;
    }
    const trackerData = trackerSheet.getDataRange().getValues();
    const memberCount = trackerData.filter(row => row[0] === partyName).length;
    pointAmount = memberCount > 0 ? memberCount : 1; // ‡πÉ‡∏´‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1
  } else {
    pointAmount = Number(points);
    if (isNaN(pointAmount)) {
      ui.alert("‚ùå ‡∏Ñ‡πà‡∏≤‡πÅ‡∏ï‡πâ‡∏°‡πÉ‡∏ô‡∏ä‡∏µ‡∏ó 'Party Activity List' ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ô‡∏µ‡πâ");
      return;
    }
  }

  // üÜï ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô
  const confirmMessage = `‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å: ${codename}\n‡∏õ‡∏≤‡∏£‡πå‡∏ï‡∏µ‡πâ: ${partyName}\n\n‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏° ${pointAmount} ‡πÅ‡∏ï‡πâ‡∏° ‡∏à‡∏≤‡∏Å‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° '${activityName}' ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`;
  const confirm = ui.alert("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏ï‡πâ‡∏°", confirmMessage, ui.ButtonSet.YES_NO);
  if (confirm !== ui.Button.YES) return;

  const partySheet = ss.getSheetByName("Party");
  const partyLogSheet = ss.getSheetByName("Party Log");
  const partyData = partySheet.getDataRange().getValues();
  const partyIndex = partyData.findIndex(row => row[0] === partyName);

  if (partyIndex === -1) {
    ui.alert(`‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏õ‡∏≤‡∏£‡πå‡∏ï‡∏µ‡πâ '${partyName}' ‡πÉ‡∏ô‡∏ä‡∏µ‡∏ó Party`);
    return;
  }

  const currentPoint = Number(partyData[partyIndex][2]);
  partySheet.getRange(partyIndex + 1, 3).setValue(currentPoint + pointAmount);

  partyLogSheet.appendRow([
    new Date(), 
    partyName, 
    codename, 
    activityName, 
    pointAmount, 
    `‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏à‡∏≤‡∏Å‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡πÇ‡∏î‡∏¢ ${admin}`
  ]);
  
  logAdminAction("‡πÄ‡∏û‡∏¥‡πà‡∏° Party Point ‡∏à‡∏≤‡∏Å‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°", `‡πÉ‡∏´‡πâ‡∏õ‡∏≤‡∏£‡πå‡∏ï‡∏µ‡πâ ${partyName} +${pointAmount} ‡πÅ‡∏ï‡πâ‡∏° (‡∏ú‡πà‡∏≤‡∏ô ${codename}) | ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°: ${activityName}`, admin);
  ui.alert(`‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏° ${pointAmount} ‡πÅ‡∏ï‡πâ‡∏°‡πÉ‡∏´‡πâ‡∏õ‡∏≤‡∏£‡πå‡∏ï‡∏µ‡πâ '${partyName}' ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!`);
}

/**
 * üÜï Searches for a member's profile data across multiple sheets.
 * @param {string} codename The codename of the member to search for.
 * @returns {ContentService} A JSON object with the member's profile data or an error message.
 */
function getMemberProfile(phone) {
  if (!phone) {
    return ContentService.createTextOutput(JSON.stringify({ error: "Phone number is required." })).setMimeType(ContentService.MimeType.JSON);
  }
  const normalizedPhone = normalizePhone(phone);

  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const dashSheet = ss.getSheetByName("Member Dashboard");
  const partySheet = ss.getSheetByName("Party");

  if (!dashSheet || !partySheet) {
    return ContentService.createTextOutput(JSON.stringify({ error: "Required sheet not found." })).setMimeType(ContentService.MimeType.JSON);
  }

  const dashData = dashSheet.getDataRange().getValues();
  const partyData = partySheet.getDataRange().getValues();

  const memberRow = dashData.find(row => normalizePhone(String(row[1])) === normalizedPhone);

  if (!memberRow) {
    return ContentService.createTextOutput(JSON.stringify({ error: "‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏î‡πâ‡∏ß‡∏¢‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏ô‡∏µ‡πâ" })).setMimeType(ContentService.MimeType.JSON);
  }

  const memberInfo = {
    nickname: memberRow[0],
    codename: memberRow[2],
    rank: memberRow[3],
    exp: memberRow[4],
    partyName: memberRow[5] || "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏≤‡∏£‡πå‡∏ï‡∏µ‡πâ"
  };

  let partyInfo = {
    partyPoints: "-"
  };

  if (memberInfo.partyName !== "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏≤‡∏£‡πå‡∏ï‡∏µ‡πâ") {
    const partyRow = partyData.find(row => row[0] === memberInfo.partyName);
    if (partyRow) {
      partyInfo.partyPoints = partyRow[2] || 0;
    }
  }

  const profileData = { ...memberInfo, ...partyInfo };

  return ContentService.createTextOutput(JSON.stringify(profileData)).setMimeType(ContentService.MimeType.JSON);
}

/**
 * ‡∏Ñ‡∏∑‡∏ô‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡πÉ‡∏ô‡∏õ‡∏≤‡∏£‡πå‡∏ï‡∏µ‡πâ (Codename, Rank, Nickname) ‡∏à‡∏≤‡∏Å Party Tracker
 * @param {string} partyName
 * @returns {ContentService} JSON array
 */
function getPartyMembers(partyName) {
  if (!partyName) {
    return ContentService.createTextOutput(JSON.stringify({ error: "Party name is required." })).setMimeType(ContentService.MimeType.JSON);
  }
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const trackerSheet = ss.getSheetByName("Party Tracker");
  const dashSheet = ss.getSheetByName("Member Dashboard");
  if (!trackerSheet || !dashSheet) {
    return ContentService.createTextOutput(JSON.stringify({ error: "Required sheet not found." })).setMimeType(ContentService.MimeType.JSON);
  }
  const trackerData = trackerSheet.getDataRange().getValues();
  const dashData = dashSheet.getDataRange().getValues();
  // ‡∏´‡∏≤‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡πÉ‡∏ô‡∏õ‡∏≤‡∏£‡πå‡∏ï‡∏µ‡πâ‡∏ô‡∏µ‡πâ
  const members = trackerData.slice(1)
    .filter(row => String(row[0] || '').trim() === String(partyName).trim())
    .map(row => {
      const codename = row[1];
      // ‡∏´‡∏≤ rank/nickname ‡∏à‡∏≤‡∏Å Member Dashboard
      const dashRow = dashData.find(d => String(d[2]).trim() === String(codename).trim());
      return {
        codename,
        rank: dashRow ? dashRow[3] : '',
        nickname: dashRow ? dashRow[0] : ''
      };
    });
  return ContentService.createTextOutput(JSON.stringify(members)).setMimeType(ContentService.MimeType.JSON);
}

// ‚úÖ ‡πÅ‡∏•‡∏Å‡πÅ‡∏ï‡πâ‡∏° Party Point ‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏• (‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏≤‡∏Å Reward Catalog)
function redeemPartyPoint() {
  const ui = SpreadsheetApp.getUi();
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const partySheet = ss.getSheetByName("Party");
  const partyLogSheet = ss.getSheetByName("Party Log");
  const rewardSheet = ss.getSheetByName("Reward Catalog");

  // 0. ‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô
  const adminPrompt = ui.prompt("‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô", "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å log)", ui.ButtonSet.OK_CANCEL);
  if (adminPrompt.getSelectedButton() !== ui.Button.OK || !adminPrompt.getResponseText().trim()) return;
  const admin = adminPrompt.getResponseText().trim();

  // 1. ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏≤‡∏£‡πå‡∏ï‡∏µ‡πâ (dropdown ‡πÅ‡∏ö‡∏ö‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏•‡∏Ç)
  const partyData = partySheet.getDataRange().getValues();
  const partyNames = partyData.slice(1).map(row => row[0]);
  if (partyNames.length === 0) return ui.alert("‚ùå ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏≤‡∏£‡πå‡∏ï‡∏µ‡πâ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö");
  const partyList = partyNames.map((p, i) => `${i + 1}. ${p}`).join("\n");
  const partyPrompt = ui.prompt("‡πÅ‡∏•‡∏Å‡πÅ‡∏ï‡πâ‡∏°", `‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏≤‡∏£‡πå‡∏ï‡∏µ‡πâ‡πÇ‡∏î‡∏¢‡∏û‡∏¥‡∏°‡∏û‡πå‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç:\n${partyList}`, ui.ButtonSet.OK_CANCEL);
  if (partyPrompt.getSelectedButton() !== ui.Button.OK) return;
  const partyIndex = Number(partyPrompt.getResponseText().trim()) - 1;
  if (isNaN(partyIndex) || partyIndex < 0 || partyIndex >= partyNames.length) return ui.alert("‚ùå ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏≤‡∏£‡πå‡∏ï‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á");
  const partyName = partyNames[partyIndex];

  // 2. ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏à‡∏≤‡∏Å Reward Catalog (dropdown ‡πÅ‡∏ö‡∏ö‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏•‡∏Ç)
  const rewardData = rewardSheet.getDataRange().getValues();
  if (rewardData.length < 2) return ui.alert("‚ùå ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡πÉ‡∏ô Reward Catalog");
  const rewardList = rewardData.slice(1).map((row, i) => `${i + 1}. ${row[0]} (${row[1]} ‡πÅ‡∏ï‡πâ‡∏°)`);
  const rewardPrompt = ui.prompt("‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•", `‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡πÇ‡∏î‡∏¢‡∏û‡∏¥‡∏°‡∏û‡πå‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç:\n${rewardList.join("\n")}`, ui.ButtonSet.OK_CANCEL);
  if (rewardPrompt.getSelectedButton() !== ui.Button.OK) return;
  const rewardIndex = Number(rewardPrompt.getResponseText().trim()) - 1;
  if (isNaN(rewardIndex) || rewardIndex < 0 || rewardIndex >= rewardList.length) return ui.alert("‚ùå ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á");
  const [rewardName, requiredPoint] = rewardData[rewardIndex + 1];
  const points = Number(requiredPoint);
  const currentPoint = Number(partyData[partyIndex + 1][2]);
  if (points > currentPoint) return ui.alert("‚ùå ‡πÅ‡∏ï‡πâ‡∏°‡∏õ‡∏≤‡∏£‡πå‡∏ï‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏û‡∏≠");

  // 3. ‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡πà‡∏≠‡∏ô‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô
  const summary = `‡∏õ‡∏≤‡∏£‡πå‡∏ï‡∏µ‡πâ: ${partyName}\n‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•: ${rewardName}\n‡πÅ‡∏ï‡πâ‡∏°‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ: ${points}\n‡πÅ‡∏ï‡πâ‡∏°‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠: ${currentPoint - points}\n‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô: ${admin}\n\n‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`;
  const confirm = ui.alert("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡∏Å‡πÅ‡∏ï‡πâ‡∏°", summary, ui.ButtonSet.YES_NO);
  if (confirm !== ui.Button.YES) return;

  // 4. ‡∏´‡∏±‡∏Å‡πÅ‡∏ï‡πâ‡∏°‡πÅ‡∏•‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å log
  partySheet.getRange(partyIndex + 2, 3).setValue(currentPoint - points);
  partyLogSheet.appendRow([new Date(), partyName, "", `‡πÅ‡∏•‡∏Å‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•: ${rewardName}`, -points, `‡πÅ‡∏•‡∏Å‡πÅ‡∏ï‡πâ‡∏°‡πÇ‡∏î‡∏¢ ${admin}`]);
  logAdminAction("‡πÅ‡∏•‡∏Å‡πÅ‡∏ï‡πâ‡∏° Party Point", `‡∏õ‡∏≤‡∏£‡πå‡∏ï‡∏µ‡πâ ${partyName} ‡πÅ‡∏•‡∏Å ${rewardName} (${points} ‡πÅ‡∏ï‡πâ‡∏°) ‡πÇ‡∏î‡∏¢ ${admin}`, admin);
  ui.alert(`‚úÖ ‡πÅ‡∏•‡∏Å‡πÅ‡∏ï‡πâ‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏õ‡∏≤‡∏£‡πå‡∏ï‡∏µ‡πâ ${partyName} ‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ${currentPoint - points} ‡πÅ‡∏ï‡πâ‡∏°`);
}

// ‚úÖ ‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏õ‡∏≤‡∏£‡πå‡∏ï‡∏µ‡πâ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
function getPartyList() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const partySheet = ss.getSheetByName("Party");
  const trackerSheet = ss.getSheetByName("Party Tracker");
  if (!partySheet || !trackerSheet) {
    return ContentService.createTextOutput(JSON.stringify([])).setMimeType(ContentService.MimeType.JSON);
  }
  const partyData = partySheet.getDataRange().getValues();
  const trackerData = trackerSheet.getDataRange().getValues();
  const parties = [];
  for (let i = 1; i < partyData.length; i++) {
    const partyName = String(partyData[i][0] || '').trim();
    if (!partyName) continue;
    const memberCount = trackerData.filter(row => String(row[0] || '').trim() === partyName).length;
    parties.push({ name: partyName, memberCount });
  }
  return ContentService.createTextOutput(JSON.stringify(parties)).setMimeType(ContentService.MimeType.JSON);
}

// ‚úÖ ‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏ó‡πâ‡∏≤ Party vs Party
function submitPartyChallenge(e) {
  let data = {};
  if (e && e.postData && e.postData.contents) {
    const contentType = e.postData.type || "";
    if (contentType.indexOf("application/json") !== -1) {
      try {
        data = JSON.parse(e.postData.contents);
      } catch (err) {
        return ContentService.createTextOutput("‚ùå JSON parse error: " + err.message).setMimeType(ContentService.MimeType.TEXT);
      }
    } else {
      data = e.parameter || {};
    }
  } else if (e && e.parameter) {
    data = e.parameter;
  } else {
    return ContentService.createTextOutput("‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á‡∏°‡∏≤").setMimeType(ContentService.MimeType.TEXT);
  }

  // ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏ä‡πá‡∏Å‡∏Å‡πà‡∏≠‡∏ô‡πÉ‡∏ä‡πâ normalizePhone
  if (!data.phone) {
    return ContentService.createTextOutput("‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö phone ‡πÉ‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: " + JSON.stringify(data)).setMimeType(ContentService.MimeType.TEXT);
  }

  // ‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢‡πÅ‡∏ô‡πà‡∏ô‡∏≠‡∏ô
  const phone = normalizePhone(data.phone);
  const codename = getCodenameFromPhone(phone);
  const size = data.size;
  const type = data.type;
  const mode = data.mode;
  const targetParty = data.targetParty;
  const wager = data.wager;
  const title = data.title;

  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const partySheet = ss.getSheetByName("Party");
  const partyData = partySheet.getDataRange().getValues();
  // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏õ‡∏≤‡∏£‡πå‡∏ï‡∏µ‡πâ‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡∏à‡∏£‡∏¥‡∏á
  const partyExists = partyData.some(row => row[0] === targetParty);
  if (!partyExists) {
    return ContentService.createTextOutput("‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏õ‡∏≤‡∏£‡πå‡∏ï‡∏µ‡πâ‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢").setMimeType(ContentService.MimeType.TEXT);
  }
  const challengeSheet = ss.getSheetByName("Party Challenge");
  const now = Utilities.formatDate(new Date(), Session.getScriptTimeZone(), "dd/MM/yyyy HH:mm:ss");
  const values = [
    now, // ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà-‡πÄ‡∏ß‡∏•‡∏≤
    getPartyNameByPhone(phone), // ‡∏õ‡∏≤‡∏£‡πå‡∏ï‡∏µ‡πâ‡∏ú‡∏π‡πâ‡∏ó‡πâ‡∏≤ (return string)
    targetParty, // ‡∏õ‡∏≤‡∏£‡πå‡∏ï‡∏µ‡πâ‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢
    `Party vs Party (${size})`, // ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó
    `${type} ${mode}`, // ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö
    wager, // ‡πÄ‡∏î‡∏¥‡∏°‡∏û‡∏±‡∏ô
    title || "-", // ‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏≥‡∏ó‡πâ‡∏≤
    "‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥", // ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
    "", // ‡∏ú‡∏π‡πâ‡∏ä‡∏ô‡∏∞
    "", // ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ
    "Web" // ‡∏ú‡∏π‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
  ];
  try {
    challengeSheet.appendRow(values);
    return ContentService.createTextOutput("‚úÖ ‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏ó‡πâ‡∏≤ Party vs Party ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥").setMimeType(ContentService.MimeType.TEXT);
  } catch (err) {
    return ContentService.createTextOutput("‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + err.message).setMimeType(ContentService.MimeType.TEXT);
  }
}

// ‚úÖ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡∏õ‡∏≤‡∏£‡πå‡∏ï‡∏µ‡πâ
function verifyPartyLeader(e) {
  // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö GET request ‡πÅ‡∏ö‡∏ö‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ö Trainer Challenge
  const phone = normalizePhone(e.parameter.phone);
  const fullname = (e.parameter.fullname || '').trim();
  
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const trackerSheet = ss.getSheetByName("Party Tracker");
  const dbSheet = ss.getSheetByName("Member Database");
  
  if (!trackerSheet || !dbSheet) {
    return ContentService.createTextOutput("error").setMimeType(ContentService.MimeType.TEXT);
  }
  
  const trackerData = trackerSheet.getDataRange().getValues();
  const dbData = dbSheet.getDataRange().getValues();
  
  // ‡∏´‡∏≤ row ‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡∏õ‡∏≤‡∏£‡πå‡∏ï‡∏µ‡πâ
  const leaderRow = trackerData.find(row => normalizePhone(row[2]) === phone && row[3] === "‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡∏õ‡∏≤‡∏£‡πå‡∏ï‡∏µ‡πâ");
  if (!leaderRow) {
    return ContentService.createTextOutput("not_leader").setMimeType(ContentService.MimeType.TEXT);
  }
  
  // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•‡∏à‡∏≤‡∏Å Member Database (‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå 2)
  const dbRow = dbData.find(row => normalizePhone(row[3]) === phone);
  if (!dbRow || (dbRow[1] || '').trim() !== fullname) {
    return ContentService.createTextOutput("name_mismatch").setMimeType(ContentService.MimeType.TEXT);
  }
  
  // ‡∏Ñ‡∏∑‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡∏õ‡∏≤‡∏£‡πå‡∏ï‡∏µ‡πâ‡πÅ‡∏•‡∏∞‡∏ä‡∏∑‡πà‡∏≠‡∏õ‡∏≤‡∏£‡πå‡∏ï‡∏µ‡πâ (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô Trainer Challenge)
  const partyName = leaderRow[0];
  const codename = leaderRow[1];
  
  return ContentService.createTextOutput(`${codename}|${partyName}`).setMimeType(ContentService.MimeType.TEXT);
}

// ‚úÖ ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏Ñ‡∏≥‡∏ó‡πâ‡∏≤ Party vs Party (‡πÄ‡∏°‡∏ô‡∏π‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô)
function approvePartyChallenge() {
  const ui = SpreadsheetApp.getUi();
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName("Party Challenge");
  const data = sheet.getDataRange().getValues();

  const adminPrompt = ui.prompt("‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô", "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å log)", ui.ButtonSet.OK_CANCEL);
  if (adminPrompt.getSelectedButton() !== ui.Button.OK || !adminPrompt.getResponseText().trim()) return;
  const admin = adminPrompt.getResponseText().trim();

  // ‡∏´‡∏≤‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ (‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå H = ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞)
  const pending = [];
  for (let i = 1; i < data.length; i++) {
    if (data[i][7] === "‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥") {
      pending.push({ index: i + 1, title: data[i][6], party: data[i][1], target: data[i][2] });
    }
  }

  if (pending.length === 0) {
    ui.alert("‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏≥‡∏ó‡πâ‡∏≤ Party vs Party ‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥");
    return;
  }

  const list = pending.map((p, i) => `${i + 1}. ${p.party} vs ${p.target} - ${p.title}`).join("\n");
  const prompt = ui.prompt("‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏Ñ‡∏≥‡∏ó‡πâ‡∏≤ Party vs Party", `‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏≥‡∏ó‡πâ‡∏≤‡πÇ‡∏î‡∏¢‡∏û‡∏¥‡∏°‡∏û‡πå‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç:\n\n${list}`, ui.ButtonSet.OK_CANCEL);
  if (prompt.getSelectedButton() !== ui.Button.OK) return;
  const choice = Number(prompt.getResponseText().trim()) - 1;
  if (isNaN(choice) || choice < 0 || choice >= pending.length) {
    ui.alert("‚ùå ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á");
    return;
  }

  const row = pending[choice].index;
  const challengeTitle = pending[choice].title;
  const party = pending[choice].party;
  const target = pending[choice].target;
  sheet.getRange(row, 8).setValue("‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥"); // ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå H = ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞

  logAdminAction("‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ Party Challenge", `‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏Ñ‡∏≥‡∏ó‡πâ‡∏≤ ${party} vs ${target}: '${challengeTitle}'`, admin);
  ui.alert(`‚úÖ ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏Ñ‡∏≥‡∏ó‡πâ‡∏≤ Party vs Party ‡∏Ç‡∏≠‡∏á ${party} vs ${target} ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß`);
}

// ‚úÖ ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö: ‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ Party Challenge ‡∏ó‡∏µ‡πà‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ '‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥' ‡∏´‡∏£‡∏∑‡∏≠ '‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏î‡∏ß‡∏•' (public test)
function partyChallengeListPublic() {
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName("Party Challenge");
  const data = sheet.getDataRange().getValues();
  const headers = data[0];
  const results = [];
  for (let i = 1; i < data.length; i++) {
    const row = data[i];
    if (row[headers.indexOf("‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞")] === "‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥" || row[headers.indexOf("‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞")] === "‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏î‡∏ß‡∏•") {
      const item = {};
      headers.forEach((key, idx) => item[key] = row[idx]);
      results.push(item);
    }
  }
  return ContentService.createTextOutput(JSON.stringify(results)).setMimeType(ContentService.MimeType.JSON);
}

function logToDebugSheet(...args) {
  try {
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const sheet = ss.getSheetByName("Debug Log");
    if (!sheet) return;
    const now = Utilities.formatDate(new Date(), Session.getScriptTimeZone(), "yyyy-MM-dd HH:mm:ss");
    sheet.appendRow([now, ...args.map(x => typeof x === 'object' ? JSON.stringify(x) : x)]);
  } catch (err) {}
}

function acceptPartyChallenge(e) {
  let phone, fullname, id;
  logToDebugSheet('acceptPartyChallenge: raw e', e);
  if (e.postData && e.postData.contents) {
    logToDebugSheet('acceptPartyChallenge: found postData');
    const data = JSON.parse(e.postData.contents);
    phone = normalizePhone(data.phone);
    fullname = (data.fullname || '').trim();
    id = data.id;
    logToDebugSheet('acceptPartyChallenge: from postData', phone, fullname, id);
  } else if (e.parameter) {
    logToDebugSheet('acceptPartyChallenge: found parameter');
    phone = normalizePhone(e.parameter.phone);
    fullname = (e.parameter.fullname || '').trim();
    id = e.parameter.id;
    logToDebugSheet('acceptPartyChallenge: from parameter', phone, fullname, id);
  }
  if (!phone || !fullname || !id) {
    logToDebugSheet('acceptPartyChallenge: missing data', phone, fullname, id);
    return ContentService.createTextOutput("‚ùå ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô").setMimeType(ContentService.MimeType.TEXT);
  }

  const codename = getCodenameByPhone(phone);
  logToDebugSheet('acceptPartyChallenge: codename', codename);

  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const challengeSheet = ss.getSheetByName("Party Challenge");
  const data = challengeSheet.getDataRange().getValues();
  const headers = data[0];
  logToDebugSheet('acceptPartyChallenge: headers', headers);

  const titleCol = headers.indexOf("‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏≥‡∏ó‡πâ‡∏≤");
  const statusCol = headers.indexOf("‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞");
  logToDebugSheet('acceptPartyChallenge: titleCol', titleCol, 'statusCol', statusCol);

  let foundRow = -1;
  for (let i = 1; i < data.length; i++) {
    if (data[i][titleCol] === id) {
      foundRow = i + 1;
      break;
    }
  }
  logToDebugSheet('acceptPartyChallenge: foundRow', foundRow);
  if (foundRow === -1) {
    logToDebugSheet('acceptPartyChallenge: ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ñ‡∏≥‡∏ó‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏£‡∏∞‡∏ö‡∏∏');
    return ContentService.createTextOutput("‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ñ‡∏≥‡∏ó‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏£‡∏∞‡∏ö‡∏∏").setMimeType(ContentService.MimeType.TEXT);
  }

  try {
    challengeSheet.getRange(foundRow, statusCol + 1).setValue("‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏î‡∏ß‡∏•");
    logToDebugSheet('acceptPartyChallenge: updated status to ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏î‡∏ß‡∏•');
  } catch (err) {
    logToDebugSheet('acceptPartyChallenge: setValue error', err && err.message ? err.message : err);
    return ContentService.createTextOutput("‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏Ç‡∏ì‡∏∞‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ä‡∏µ‡∏ó: " + (err && err.message ? err.message : err)).setMimeType(ContentService.MimeType.TEXT);
  }

  return ContentService.createTextOutput("‚úÖ ‡∏£‡∏±‡∏ö‡∏Ñ‡∏≥‡∏ó‡πâ‡∏≤ Party vs Party ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏î‡∏ß‡∏• !!").setMimeType(ContentService.MimeType.TEXT);
}

// üÜï ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏• Party vs Party
function recordPartyChallengeResult() {
  const ui = SpreadsheetApp.getUi();
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const sheet = ss.getSheetByName("Party Challenge");
  const partySheet = ss.getSheetByName("Party");
  const logSheet = ss.getSheetByName("Party Log");
  const data = sheet.getDataRange().getValues();
  const headers = data[0];

  const adminPrompt = ui.prompt("‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô", "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å log)", ui.ButtonSet.OK_CANCEL);
  if (adminPrompt.getSelectedButton() !== ui.Button.OK || !adminPrompt.getResponseText().trim()) return;
  const admin = adminPrompt.getResponseText().trim();

  // ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å challenge ‡∏ó‡∏µ‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏î‡∏ß‡∏•
  const statusCol = headers.indexOf("‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞");
  const partyCol = headers.indexOf("‡∏õ‡∏≤‡∏£‡πå‡∏ï‡∏µ‡πâ‡∏ú‡∏π‡πâ‡∏ó‡πâ‡∏≤");
  const targetCol = headers.indexOf("‡∏õ‡∏≤‡∏£‡πå‡∏ï‡∏µ‡πâ‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢");
  const typeCol = headers.indexOf("‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó");
  const titleCol = headers.indexOf("‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏≥‡∏ó‡πâ‡∏≤");
  const wagerCol = headers.indexOf("‡πÄ‡∏î‡∏¥‡∏°‡∏û‡∏±‡∏ô");

  const readyRows = data.slice(1).filter(r => r[statusCol] === "‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏î‡∏ß‡∏•");
  if (readyRows.length === 0) return ui.alert("‚ùå ‡πÑ‡∏°‡πà‡∏°‡∏µ Party Challenge ‡∏ó‡∏µ‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏î‡∏ß‡∏•");

  const challengeOptions = readyRows.map((r, i) => `${i + 1}. ${r[partyCol]} vs ${r[targetCol]} | ${r[titleCol]}`);
  const pickPrompt = ui.prompt("‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Party Challenge", challengeOptions.join("\n") + "\n\n‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£:", ui.ButtonSet.OK_CANCEL);
  if (pickPrompt.getSelectedButton() !== ui.Button.OK) return;
  const idx = Number(pickPrompt.getResponseText().trim()) - 1;
  if (isNaN(idx) || idx < 0 || idx >= readyRows.length) return ui.alert("‚ùå ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á");

  // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• challenge
  const row = readyRows[idx];
  const rowIndex = data.findIndex(r => r[titleCol] === row[titleCol]);
  const partyA = row[partyCol];
  const partyB = row[targetCol];
  const type = row[typeCol];
  const wager = row[wagerCol];
  const sizeMatch = String(type).match(/(\d+)v\d+/);
  const partyPointPerTeam = sizeMatch ? Number(sizeMatch[1]) : 1;

  // ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏π‡πâ‡∏ä‡∏ô‡∏∞
  const winnerPrompt = ui.prompt("üèÜ ‡πÉ‡∏Ñ‡∏£‡∏Ñ‡∏∑‡∏≠‡∏ú‡∏π‡πâ‡∏ä‡∏ô‡∏∞", `1. ${partyA}\n2. ${partyB}\n\n‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡∏õ‡∏≤‡∏£‡πå‡∏ï‡∏µ‡πâ‡∏ó‡∏µ‡πà‡∏ä‡∏ô‡∏∞:`, ui.ButtonSet.OK_CANCEL);
  if (winnerPrompt.getSelectedButton() !== ui.Button.OK) return;
  const winner = winnerPrompt.getResponseText().trim();
  if (![partyA, partyB].includes(winner)) return ui.alert("‚ùå ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏õ‡∏≤‡∏£‡πå‡∏ï‡∏µ‡πâ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á");
  const loser = winner === partyA ? partyB : partyA;

  // ‡∏Å‡∏£‡∏≠‡∏Å Party Point ‡πÄ‡∏î‡∏¥‡∏°‡∏û‡∏±‡∏ô (optional)
  const wagerPrompt = ui.prompt("üéÅ Party Point ‡∏ó‡∏µ‡πà‡πÄ‡∏î‡∏¥‡∏°‡∏û‡∏±‡∏ô (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)", "‡πÄ‡∏ä‡πà‡∏ô 5 (‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÉ‡∏™‡πà‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ú‡∏•‡πÄ‡∏î‡∏¥‡∏°‡∏û‡∏±‡∏ô)", ui.ButtonSet.OK_CANCEL);
  if (wagerPrompt.getSelectedButton() !== ui.Button.OK) return;
  const wagerPoint = wagerPrompt.getResponseText().trim() ? Number(wagerPrompt.getResponseText().trim()) : 0;

  // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
  sheet.getRange(rowIndex + 1, statusCol + 1).setValue("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏•‡πÅ‡∏•‡πâ‡∏ß");
  sheet.getRange(rowIndex + 1, headers.indexOf("‡∏ú‡∏π‡πâ‡∏ä‡∏ô‡∏∞") + 1).setValue(winner);

  // ‡πÉ‡∏´‡πâ Party Point ‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏≠‡∏á‡∏ó‡∏µ‡∏°‡∏ï‡∏≤‡∏°‡∏Ç‡∏ô‡∏≤‡∏î
  function addPartyPoint(partyName, amount, note) {
    const partyData = partySheet.getDataRange().getValues();
    const idx = partyData.findIndex(r => r[0] === partyName);
    if (idx === -1) return;
    const current = Number(partyData[idx][2]) || 0;
    partySheet.getRange(idx + 1, 3).setValue(current + amount);
    logSheet.appendRow([new Date(), partyName, winner, note, amount, `‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏• Party Challenge (${admin})`]);
  }
  addPartyPoint(partyA, partyPointPerTeam, `‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏° Party Challenge`);
  addPartyPoint(partyB, partyPointPerTeam, `‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏° Party Challenge`);

  // ‚úÖ ‡πÉ‡∏´‡πâ EXP ‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏° Party Challenge
  function giveExpToPartyMembers(partyName, expAmount, note) {
    const dashSheet = ss.getSheetByName("Member Dashboard");
    const expLogSheet = ss.getSheetByName("EXP Log");
    const dashData = dashSheet.getDataRange().getValues();
    
    // ‡∏´‡∏≤‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô‡∏õ‡∏≤‡∏£‡πå‡∏ï‡∏µ‡πâ
    const partyMembers = dashData.slice(1).filter(row => row[5] === partyName);
    
    partyMembers.forEach(member => {
      const phone = normalizePhone(member[1]);
      const codename = member[2];
      
      // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å EXP Log
      expLogSheet.appendRow([phone, codename, new Date(), note, expAmount]);
      expLogSheet.getRange(expLogSheet.getLastRow(), 1).setNumberFormat("@");
    });
  }
  
  // ‡πÉ‡∏´‡πâ EXP ‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏≠‡∏á‡∏ó‡∏µ‡∏°
  giveExpToPartyMembers(partyA, 1, `‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏° Party Challenge`);
  giveExpToPartyMembers(partyB, 1, `‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏° Party Challenge`);
  
  // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï ranks ‡πÅ‡∏•‡∏∞ leaderboard
  updateRanks();
  updateLeaderboard();

  // ‡πÄ‡∏î‡∏¥‡∏°‡∏û‡∏±‡∏ô Party Point (‡∏ù‡∏±‡πà‡∏á‡πÅ‡∏û‡πâ‡∏•‡∏ö, ‡∏ù‡∏±‡πà‡∏á‡∏ä‡∏ô‡∏∞‡∏ö‡∏ß‡∏Å, ‡∏´‡πâ‡∏≤‡∏°‡∏ï‡∏¥‡∏î‡∏•‡∏ö)
  if (wagerPoint && wagerPoint > 0) {
    const partyData = partySheet.getDataRange().getValues();
    const loserIdx = partyData.findIndex(r => r[0] === loser);
    const winnerIdx = partyData.findIndex(r => r[0] === winner);
    let loserCurrent = loserIdx !== -1 ? Number(partyData[loserIdx][2]) : 0;
    let winnerCurrent = winnerIdx !== -1 ? Number(partyData[winnerIdx][2]) : 0;
    const canLose = Math.max(0, loserCurrent - wagerPoint);
    const actualLost = loserCurrent - canLose; // ‡πÅ‡∏ï‡πâ‡∏°‡∏ó‡∏µ‡πà‡∏•‡∏ö‡πÑ‡∏î‡πâ‡∏à‡∏£‡∏¥‡∏á
    // ‡∏•‡∏ö‡∏ù‡∏±‡πà‡∏á‡πÅ‡∏û‡πâ
    partySheet.getRange(loserIdx + 1, 3).setValue(canLose);
    logSheet.appendRow([new Date(), loser, winner, `‡πÄ‡∏™‡∏µ‡∏¢ Party Point ‡πÄ‡∏î‡∏¥‡∏°‡∏û‡∏±‡∏ô`, -actualLost, `‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏• Party Challenge (${admin})`]);
    // ‡∏ö‡∏ß‡∏Å‡∏ù‡∏±‡πà‡∏á‡∏ä‡∏ô‡∏∞
    partySheet.getRange(winnerIdx + 1, 3).setValue(winnerCurrent + actualLost);
    logSheet.appendRow([new Date(), winner, winner, `‡πÑ‡∏î‡πâ Party Point ‡πÄ‡∏î‡∏¥‡∏°‡∏û‡∏±‡∏ô`, actualLost, `‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏• Party Challenge (${admin})`]);
  }

  logAdminAction("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏• Party Challenge", `‡∏ú‡∏•: ${winner} ‡∏ä‡∏ô‡∏∞ ${loser} | EXP: +1 ‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏≠‡∏á‡∏ó‡∏µ‡∏° | Party Point: +${partyPointPerTeam} | ‡πÄ‡∏î‡∏¥‡∏°‡∏û‡∏±‡∏ô: ${wagerPoint || 0}` , admin);
  ui.alert(`‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${winner} ‡∏ä‡∏ô‡∏∞\n+1 EXP ‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏≠‡∏á‡∏ó‡∏µ‡∏°\n+${partyPointPerTeam} Party Point ‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏≠‡∏á‡∏ó‡∏µ‡∏°${wagerPoint ? `\n‡πÄ‡∏î‡∏¥‡∏°‡∏û‡∏±‡∏ô Party Point: ${wagerPoint}` : ""}`);
}

function getMemberDashboardData() {
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName("Member Dashboard");
  if (!sheet) {
    return ContentService.createTextOutput(JSON.stringify({ error: "‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ä‡∏µ‡∏ó Member Dashboard" }))
      .setMimeType(ContentService.MimeType.JSON);
  }
  const data = sheet.getDataRange().getValues();
  const headers = data[0];
  const result = data.slice(1).map(row => {
    const obj = {};
    headers.forEach((h, i) => obj[h] = row[i]);
    return {
      nickname: obj["‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô"] || row[0],
      phone: obj["Phone"] || row[1],
      codename: obj["Codename"] || row[2],
      rank: obj["Rank"] || row[3],
      exp: obj["EXP"] || row[4],
      party: obj["Party"] || row[5]
    };
  });
  return ContentService.createTextOutput(JSON.stringify(result))
    .setMimeType(ContentService.MimeType.JSON);
}

function getGymStandingData() {
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName("Gym Standing");
  if (!sheet) {
    return ContentService.createTextOutput(JSON.stringify({ error: "‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ä‡∏µ‡∏ó Gym Standing" }))
      .setMimeType(ContentService.MimeType.JSON);
  }
  const data = sheet.getDataRange().getValues();
  const headers = data[0];
  const result = data.slice(1).map(row => {
    const obj = {};
    headers.forEach((h, i) => obj[h] = row[i]);
    return obj;
  });
  return ContentService.createTextOutput(JSON.stringify(result))
    .setMimeType(ContentService.MimeType.JSON);
}

// üîç ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡∏ï‡∏Å‡∏´‡∏•‡πà‡∏ô (Member Database ‚Üí Member Dashboard)
function checkMissingMembers() {
  const ui = SpreadsheetApp.getUi();
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const formSheet = ss.getSheetByName("Member Database");
  const dashSheet = ss.getSheetByName("Member Dashboard");
  
  if (!formSheet || !dashSheet) {
    return ui.alert("‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ä‡∏µ‡∏ó Member Database ‡∏´‡∏£‡∏∑‡∏≠ Member Dashboard");
  }
  
  const formData = formSheet.getDataRange().getValues();
  const dashData = dashSheet.getDataRange().getValues();
  
  // ‡∏î‡∏∂‡∏á‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏à‡∏≤‡∏Å Member Dashboard
  const dashPhones = dashData.slice(1).map(row => normalizePhone(row[1]));
  
  // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡∏ï‡∏Å‡∏´‡∏•‡πà‡∏ô
  const missingMembers = [];
  
  for (let i = 1; i < formData.length; i++) {
    const formRow = formData[i];
    const formPhone = normalizePhone(formRow[3]); // ‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡πÉ‡∏ô‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ó‡∏µ‡πà 4
    
    // ‡∏Ç‡πâ‡∏≤‡∏°‡∏ñ‡πâ‡∏≤‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏ß‡πà‡∏≤‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
    if (!formPhone || formPhone.length !== 10) continue;
    
    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡πÉ‡∏ô Member Dashboard ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
    if (!dashPhones.includes(formPhone)) {
      missingMembers.push({
        row: i + 1,
        fullName: formRow[1],
        nickname: formRow[2],
        phone: formPhone,
        codename: formRow[4],
        memberType: formRow[5],
        referrer: normalizePhone(formRow[6] || ""),
        timestamp: formRow[0]
      });
    }
  }
  
  if (missingMembers.length === 0) {
    return ui.alert("‚úÖ ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡∏ï‡∏Å‡∏´‡∏•‡πà‡∏ô");
  }
  
  // ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡∏ï‡∏Å‡∏´‡∏•‡πà‡∏ô
  let message = `üîç ‡∏û‡∏ö‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡∏ï‡∏Å‡∏´‡∏•‡πà‡∏ô ${missingMembers.length} ‡∏Ñ‡∏ô:\n\n`;
  missingMembers.forEach((member, index) => {
    message += `${index + 1}. ${member.nickname} (${member.codename})\n`;
    message += `   ‡πÄ‡∏ö‡∏≠‡∏£‡πå: ${member.phone}\n`;
    message += `   ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó: ${member.memberType}\n`;
    message += `   ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏°‡∏±‡∏Ñ‡∏£: ${member.timestamp}\n\n`;
  });
  
  message += "‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡πÄ‡∏´‡∏•‡πà‡∏≤‡∏ô‡∏µ‡πâ‡πÄ‡∏Ç‡πâ‡∏≤ Member Dashboard ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?";
  
  const response = ui.alert("‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡∏ï‡∏Å‡∏´‡∏•‡πà‡∏ô", message, ui.ButtonSet.YES_NO);
  
  if (response === ui.Button.YES) {
    addMissingMembers(missingMembers);
  }
}

// ‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡∏ï‡∏Å‡∏´‡∏•‡πà‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤ Member Dashboard
function addMissingMembers(missingMembers) {
  const ui = SpreadsheetApp.getUi();
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const dashSheet = ss.getSheetByName("Member Dashboard");
  const dbSheet = ss.getSheetByName("Member Database");
  
  let successCount = 0;
  let errorCount = 0;
  let errorMessages = [];
  
  missingMembers.forEach(member => {
    try {
      // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ã‡πâ‡∏≥‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á
      const dashData = dashSheet.getDataRange().getValues();
      const dashPhones = dashData.slice(1).map(row => normalizePhone(row[1]));
      const dashCodenames = dashData.slice(1).map(row => String(row[2]).toLowerCase().trim());
      
      if (dashPhones.includes(member.phone)) {
        errorMessages.push(`${member.nickname}: ‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏ã‡πâ‡∏≥`);
        errorCount++;
        return;
      }
      
      if (dashCodenames.includes(member.codename.toLowerCase())) {
        errorMessages.push(`${member.nickname}: Codename ‡∏ã‡πâ‡∏≥`);
        errorCount++;
        return;
      }
      
      // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì EXP ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
      let initialExp = 0;
      if (member.memberType.includes("Premium")) {
        initialExp = 3;
        if (member.referrer && dashPhones.includes(member.referrer)) {
          initialExp += 1;
          addExpToPhone(member.referrer, 2);
          logExp(member.referrer, "‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏™‡∏°‡∏±‡∏Ñ‡∏£ Premium (+2 EXP)", 2);
        }
      }
      
      // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏Ç‡πâ‡∏≤ Member Dashboard
      const newRow = [member.nickname, member.phone, member.codename, "Rookie", initialExp, ""];
      const newRowIndex = dashSheet.getLastRow() + 1;
      dashSheet.getRange(newRowIndex, 1, 1, newRow.length).setValues([newRow]);
      dashSheet.getRange(newRowIndex, 2).setNumberFormat("@");
      
      // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å EXP Log
      logExp(member.phone, "‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å (‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏à‡∏≤‡∏Å‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡∏ï‡∏Å‡∏´‡∏•‡πà‡∏ô)", initialExp);
      
      // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Member Database (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
      if (dbSheet) {
        const dbData = dbSheet.getDataRange().getValues();
        const dbRow = dbData.findIndex(row => normalizePhone(row[3]) === member.phone);
        if (dbRow !== -1) {
          dbSheet.getRange(dbRow + 1, 4).setNumberFormat("@");
        }
      }
      
      successCount++;
      
    } catch (error) {
      errorMessages.push(`${member.nickname}: ${error.message}`);
      errorCount++;
    }
  });
  
  // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏£‡∏∞‡∏ö‡∏ö
  updateRanks();
  updateLeaderboard();
  
  // ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå
  let resultMessage = `‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${successCount} ‡∏Ñ‡∏ô\n`;
  if (errorCount > 0) {
    resultMessage += `‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${errorCount} ‡∏Ñ‡∏ô\n\n`;
    resultMessage += "‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î:\n";
    errorMessages.forEach(msg => {
      resultMessage += `‚Ä¢ ${msg}\n`;
    });
  }
  
  ui.alert("‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡∏ï‡∏Å‡∏´‡∏•‡πà‡∏ô", resultMessage);
}

// üîî ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡∏ï‡∏Å‡∏´‡∏•‡πà‡∏ô‡∏ú‡πà‡∏≤‡∏ô‡∏≠‡∏µ‡πÄ‡∏°‡∏•
function notifyMissingMembers() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const formSheet = ss.getSheetByName("Member Database");
  const dashSheet = ss.getSheetByName("Member Dashboard");
  
  if (!formSheet || !dashSheet) {
    Logger.log("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ä‡∏µ‡∏ó Member Database ‡∏´‡∏£‡∏∑‡∏≠ Member Dashboard");
    return;
  }
  
  const formData = formSheet.getDataRange().getValues();
  const dashData = dashSheet.getDataRange().getValues();
  const dashPhones = dashData.slice(1).map(row => normalizePhone(row[1]));
  
  // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡∏ï‡∏Å‡∏´‡∏•‡πà‡∏ô
  const missingMembers = [];
  
  for (let i = 1; i < formData.length; i++) {
    const formRow = formData[i];
    const formPhone = normalizePhone(formRow[3]);
    
    if (formPhone && formPhone.length === 10 && !dashPhones.includes(formPhone)) {
      missingMembers.push({
        fullName: formRow[1],
        nickname: formRow[2],
        phone: formPhone,
        codename: formRow[4],
        memberType: formRow[5],
        timestamp: formRow[0]
      });
    }
  }
  
  if (missingMembers.length > 0) {
    // ‡∏™‡πà‡∏á‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
    try {
      const adminEmail = Session.getActiveUser().getEmail();
      const subject = `‚ö†Ô∏è ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô: ‡∏û‡∏ö‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡∏ï‡∏Å‡∏´‡∏•‡πà‡∏ô ${missingMembers.length} ‡∏Ñ‡∏ô`;
      
      let body = `
        <h2>üîç ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô: ‡∏û‡∏ö‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏ú‡πà‡∏≤‡∏ô Google Form ‡πÅ‡∏ï‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ñ‡∏π‡∏Å‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏Ç‡πâ‡∏≤ Member Dashboard</h2>
        
        <p><strong>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡∏ï‡∏Å‡∏´‡∏•‡πà‡∏ô:</strong> ${missingMembers.length} ‡∏Ñ‡∏ô</p>
        
        <h3>üìã ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡∏ï‡∏Å‡∏´‡∏•‡πà‡∏ô:</h3>
        <table border="1" style="border-collapse: collapse; width: 100%;">
          <tr style="background-color: #f0f0f0;">
            <th style="padding: 8px;">‡∏•‡∏≥‡∏î‡∏±‡∏ö</th>
            <th style="padding: 8px;">‡∏ä‡∏∑‡πà‡∏≠</th>
            <th style="padding: 8px;">Nickname</th>
            <th style="padding: 8px;">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£</th>
            <th style="padding: 8px;">Codename</th>
            <th style="padding: 8px;">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</th>
            <th style="padding: 8px;">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏°‡∏±‡∏Ñ‡∏£</th>
          </tr>
      `;
      
      missingMembers.forEach((member, index) => {
        body += `
          <tr>
            <td style="padding: 8px;">${index + 1}</td>
            <td style="padding: 8px;">${member.fullName}</td>
            <td style="padding: 8px;">${member.nickname}</td>
            <td style="padding: 8px;">${member.phone}</td>
            <td style="padding: 8px;">${member.codename}</td>
            <td style="padding: 8px;">${member.memberType}</td>
            <td style="padding: 8px;">${member.timestamp}</td>
          </tr>
        `;
      });
      
      body += `
        </table>
        
        <h3>üîß ‡∏ß‡∏¥‡∏ò‡∏µ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç:</h3>
        <ol>
          <li>‡πÄ‡∏õ‡∏¥‡∏î Google Apps Script</li>
          <li>‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô <code>checkMissingMembers()</code></li>
          <li>‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡∏ï‡∏Å‡∏´‡∏•‡πà‡∏ô</li>
          <li>‡∏Å‡∏î "‡πÉ‡∏ä‡πà" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡∏ï‡∏Å‡∏´‡∏•‡πà‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤ Member Dashboard</li>
        </ol>
        
        <p><strong>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö:</strong> ${new Date().toLocaleString('th-TH')}</p>
        
        <hr>
        <p style="color: #666; font-size: 12px;">
          ‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡∏™‡πà‡∏á‡πÇ‡∏î‡∏¢‡∏£‡∏∞‡∏ö‡∏ö‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏≤‡∏°‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏Ç‡πâ‡∏≤‡∏á‡∏ï‡πâ‡∏ô
        </p>
      `;
      
      MailApp.sendEmail({
        to: adminEmail,
        subject: subject,
        htmlBody: body
      });
      
      Logger.log(`‡∏™‡πà‡∏á‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ‡∏û‡∏ö‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡∏ï‡∏Å‡∏´‡∏•‡πà‡∏ô ${missingMembers.length} ‡∏Ñ‡∏ô`);
      
    } catch (error) {
      Logger.log("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡πà‡∏á‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÑ‡∏î‡πâ: " + error.message);
    }
  } else {
    Logger.log("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡∏ï‡∏Å‡∏´‡∏•‡πà‡∏ô");
  }
}

// ‚è∞ ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Trigger ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡∏ï‡∏Å‡∏´‡∏•‡πà‡∏ô‡∏ó‡∏∏‡∏Å‡∏ß‡∏±‡∏ô
function setupMissingMembersTrigger() {
  // ‡∏•‡∏ö trigger ‡πÄ‡∏î‡∏¥‡∏° (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
  const triggers = ScriptApp.getProjectTriggers();
  triggers.forEach(trigger => {
    if (trigger.getHandlerFunction() === 'notifyMissingMembers') {
      ScriptApp.deleteTrigger(trigger);
    }
  });
  
  // ‡∏™‡∏£‡πâ‡∏≤‡∏á trigger ‡πÉ‡∏´‡∏°‡πà - ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ó‡∏∏‡∏Å‡∏ß‡∏±‡∏ô‡πÄ‡∏ß‡∏•‡∏≤ 9:00 ‡∏ô.
  ScriptApp.newTrigger('notifyMissingMembers')
    .timeBased()
    .everyDays(1)
    .atHour(9)
    .create();
  
  Logger.log("‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Trigger ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡∏ï‡∏Å‡∏´‡∏•‡πà‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (‡∏ó‡∏∏‡∏Å‡∏ß‡∏±‡∏ô‡πÄ‡∏ß‡∏•‡∏≤ 9:00 ‡∏ô.)");
}
