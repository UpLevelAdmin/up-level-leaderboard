function doGet(e) {
  var dates = [
    "‡∏ß‡∏±‡∏ô‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£‡∏ó‡∏µ‡πà 3 ‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå 2569",
    "‡∏ß‡∏±‡∏ô‡∏®‡∏∏‡∏Å‡∏£‡πå‡∏ó‡∏µ‡πà 6 ‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå 2569",
    "‡∏ß‡∏±‡∏ô‡πÄ‡∏™‡∏≤‡∏£‡πå‡∏ó‡∏µ‡πà 7 ‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå 2569",
    "‡∏ß‡∏±‡∏ô‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£‡∏ó‡∏µ‡πà 10 ‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå 2569",
    "‡∏ß‡∏±‡∏ô‡∏®‡∏∏‡∏Å‡∏£‡πå‡∏ó‡∏µ‡πà 13 ‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå 2569",
    "‡∏ß‡∏±‡∏ô‡πÄ‡∏™‡∏≤‡∏£‡πå‡∏ó‡∏µ‡πà 14 ‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå 2569",
    "‡∏ß‡∏±‡∏ô‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£‡∏ó‡∏µ‡πà 17 ‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå 2569",
    "‡∏ß‡∏±‡∏ô‡∏®‡∏∏‡∏Å‡∏£‡πå‡∏ó‡∏µ‡πà 20 ‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå 2569",
    "‡∏ß‡∏±‡∏ô‡πÄ‡∏™‡∏≤‡∏£‡πå‡∏ó‡∏µ‡πà 21 ‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå 2569",
    "‡∏ß‡∏±‡∏ô‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£‡∏ó‡∏µ‡πà 24 ‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå 2569",
    "‡∏ß‡∏±‡∏ô‡∏®‡∏∏‡∏Å‡∏£‡πå‡∏ó‡∏µ‡πà 27 ‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå 2569",
    "‡∏ß‡∏±‡∏ô‡πÄ‡∏™‡∏≤‡∏£‡πå‡∏ó‡∏µ‡πà 28 ‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå 2569"
  ];

  var pastelColors = [
    { bg: "#E3F2FD", border: "#42A5F5" },
    { bg: "#FFFDE7", border: "#FDD835" },
    { bg: "#F1F8E9", border: "#7CB342" },
    { bg: "#FCE4EC", border: "#EC407A" },
    { bg: "#E8EAF6", border: "#5C6BC0" },
    { bg: "#FFF3E0", border: "#FFB74D" },
    { bg: "#E0F2F1", border: "#26A69A" }
  ];

  var logoUrl = "https://i.postimg.cc/wjzpnxjB/Up-Level-01-1.png";
  var sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName("Form Responses 1");
  if (!sheet) {
    if (e && e.parameter && e.parameter.type === "json") {
      return ContentService.createTextOutput(JSON.stringify({error: "‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ä‡∏µ‡∏ó‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•"})).setMimeType(ContentService.MimeType.JSON);
    } else {
      return HtmlService.createHtmlOutput("‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ä‡∏µ‡∏ó‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: Form Responses 1");
    }
  }

  var data = sheet.getDataRange().getValues();
  var groupedData = {};
  
  // ‡∏™‡∏£‡πâ‡∏≤‡∏á groupedData ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡∏Å‡∏ï‡∏¥
  dates.forEach(date => {
    groupedData[date] = [];
  });
  
  // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏µ‡πà‡∏≠‡∏≤‡∏à‡πÅ‡∏ï‡∏Å‡∏ï‡πà‡∏≤‡∏á‡∏Å‡∏±‡∏ô (‡πÄ‡∏ä‡πà‡∏ô 2569 vs 2026)
  var alternativeDates = [
    "‡∏ß‡∏±‡∏ô‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£‡∏ó‡∏µ‡πà 3 ‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå 2026",
    "‡∏ß‡∏±‡∏ô‡∏®‡∏∏‡∏Å‡∏£‡πå‡∏ó‡∏µ‡πà 6 ‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå 2026",
    "‡∏ß‡∏±‡∏ô‡πÄ‡∏™‡∏≤‡∏£‡πå‡∏ó‡∏µ‡πà 7 ‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå 2026",
    "‡∏ß‡∏±‡∏ô‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£‡∏ó‡∏µ‡πà 10 ‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå 2026",
    "‡∏ß‡∏±‡∏ô‡πÄ‡∏™‡∏≤‡∏£‡πå‡∏ó‡∏µ‡πà 14 ‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå 2026"
  ];
  
  alternativeDates.forEach(date => {
    groupedData[date] = [];
  });

  var unmatched = [];

  for (var i = 1; i < data.length; i++) {
    // ‡πÅ‡∏õ‡∏•‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏õ‡πá‡∏ô String
    var rawDate = String(data[i][1]);
    
    // Normalization:
    // 1. ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô Non-breaking space ‡πÄ‡∏õ‡πá‡∏ô space ‡∏ò‡∏£‡∏£‡∏°‡∏î‡∏≤
    // 2. ‡∏¢‡∏∏‡∏ö‡∏£‡∏ß‡∏°‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á‡∏´‡∏•‡∏≤‡∏¢‡∏≠‡∏±‡∏ô‡πÉ‡∏´‡πâ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏≠‡∏±‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß (\s+ -> ' ')
    // 3. ‡∏ï‡∏±‡∏î‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏á
    var date = rawDate.replace(/\u00A0/g, ' ').replace(/\s+/g, ' ').trim();

    var nickname = data[i][3];
    var level = data[i][6];
    var phone = data[i][5];
    var hasSlip = (data[i][8] && String(data[i][8]).trim() !== "") ? true : false;
    
    var matched = false;

    // Column J is at index 9: data[i][9]
    var sheetStatus = (data[i][9]) ? String(data[i][9]).trim() : "";

    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏î‡πÉ‡∏ô groupedData
    if (groupedData[date]) {
      groupedData[date].push({ nickname: nickname, level: level, phone: phone, paid: hasSlip, status: sheetStatus });
      matched = true;
    } else {
      // ‡∏•‡∏≠‡∏á‡πÅ‡∏õ‡∏•‡∏á‡∏õ‡∏µ 2569 ‡πÄ‡∏õ‡πá‡∏ô 2026 ‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏•‡∏±‡∏ö‡∏Å‡∏±‡∏ô
      var convertedDate = date.replace('2569', '2026');
      var convertedDate2 = date.replace('2026', '2569');
      
      if (groupedData[convertedDate]) {
        groupedData[convertedDate].push({ nickname: nickname, level: level, phone: phone, paid: hasSlip, status: sheetStatus });
        matched = true;
      } else if (groupedData[convertedDate2]) {
        groupedData[convertedDate2].push({ nickname: nickname, level: level, phone: phone, paid: hasSlip, status: sheetStatus });
        matched = true;
      }
    }
    
    if (!matched && date) {
        unmatched.push({
            row: i + 1,
            rawDate: rawDate,
            processedDate: date,
            nickname: nickname
        });
    }
  }
  
  // Debug: ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡∏∂‡πâ‡∏ô
  console.log("Debug - groupedData keys:", Object.keys(groupedData));
  
  if (e && e.parameter && e.parameter.type === "json") {
    // ‡∏™‡∏£‡πâ‡∏≤‡∏á groupedData ‡∏ó‡∏µ‡πà‡∏£‡∏ß‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏≠‡∏á‡πÅ‡∏´‡∏•‡πà‡∏á
    var finalGroupedData = {};
    dates.forEach(function(date) {
      var players = groupedData[date] || [];
      
      // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á "‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°" ‡∏Å‡∏±‡∏ö "2569"
      var dateNoSpace = date.replace("‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå 2569", "‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå2569");
      var playersNoSpace = groupedData[dateNoSpace] || [];
      
      // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏µ‡πà‡πÅ‡∏ï‡∏Å‡∏ï‡πà‡∏≤‡∏á‡∏Å‡∏±‡∏ô (2569 vs 2026)
      var alternativeDate = date.replace('2569', '2026');
      var altPlayers = groupedData[alternativeDate] || [];
      
      finalGroupedData[date] = players.concat(playersNoSpace, altPlayers);
    });
    
    return ContentService.createTextOutput(JSON.stringify({
        dates: dates, 
        groupedData: finalGroupedData,
        unmatched: unmatched // ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà matched ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏î‡πâ‡∏ß‡∏¢‡πÄ‡∏û‡∏∑‡πà‡∏≠ debug
    })).setMimeType(ContentService.MimeType.JSON);
  }

  var html = `
    <!DOCTYPE html>
    <html lang="th">
    <head>
      <meta charset="UTF-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <title>‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏™‡∏°‡∏±‡∏Ñ‡∏£ Gym Battle ‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå 2569</title>
      <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&display=swap" rel="stylesheet">
      <style>
        body {
          font-family: 'Kanit', sans-serif;
          background: #f9f9f9;
          margin: 0;
          padding: 20px;
        }
        .container {
          max-width: 800px;
          margin: auto;
          background: white;
          padding: 20px;
          border-radius: 10px;
          box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }
        .logo {
          display: flex;
          justify-content: center;
          margin-bottom: 20px;
        }
        .logo img {
          max-width: 150px;
        }
        h2 {
          color: #33691E;
          text-align: center;
        }
        .date-header {
          padding: 10px;
          margin-top: 25px;
          font-size: 1.1em;
          font-weight: bold;
        }
        table {
          width: 100%;
          border-collapse: collapse;
          margin-top: 10px;
        }
        th, td {
          padding: 8px;
          text-align: center;
          border-bottom: 1px solid #ddd;
        }
        tr:hover {
          background: #f1f1f1;
        }
      </style>
    </head>
    <body>
      <div class="container">
        <div class="logo">
          <img src="${logoUrl}" alt="Up Level Logo">
        </div>
        <h2>‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏™‡∏°‡∏±‡∏Ñ‡∏£ Gym Battle ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå 2569</h2>
  `;

  dates.forEach(function(date, index) {
    // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πâ
    var players = groupedData[date] || [];
    
    var bgColor = pastelColors[index % pastelColors.length].bg;
    var borderColor = pastelColors[index % pastelColors.length].border;

    html += `
      <div class="date-header" style="background-color: ${bgColor}; border-left: 6px solid ${borderColor};">
        ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ${date} (‡∏à‡∏≥‡∏ô‡∏ß‡∏ô ${players.length} ‡∏Ñ‡∏ô)
      </div>
      <table>
        <thead>
          <tr style="background-color: ${borderColor}; color: white;">
            <th>‡∏•‡∏≥‡∏î‡∏±‡∏ö</th>
            <th>‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô</th>
            <th>‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡πà‡∏ô</th>
          </tr>
        </thead>
        <tbody>
    `;

    if (players.length === 0) {
      html += `<tr><td colspan="3">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ú‡∏π‡πâ‡∏™‡∏°‡∏±‡∏Ñ‡∏£</td></tr>`;
    } else {
      players.forEach((player, idx) => {
        html += `<tr><td>${idx + 1}</td><td>${player.nickname}</td><td>${player.level}</td></tr>`;
      });
    }
    html += `</tbody></table>`;
  });

  html += `</div></body></html>`;
  return HtmlService.createHtmlOutput(html);
}

// ===== ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô Telegram =====

// ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏´‡∏•‡πà‡∏≤‡∏ô‡∏µ‡πâ
const BOT_TOKEN = "8124787979:AAEWOqfiEACRxkrtZSWdTNuvGQr7uff_UoI";
const CHAT_ID = "-4911555842"; // Group Chat ID

const TELEGRAM_API_URL = `https://api.telegram.org/bot${BOT_TOKEN}`;

// ... (Previous code remains the same)

// ===== ‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏•‡∏¥‡∏õ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ =====
const SLIPOK_API_KEY = "SLIPOKE2TSLQJ"; // API Key ‡∏à‡∏£‡∏¥‡∏á‡∏à‡∏≤‡∏Å functions/index.js
const BRANCH_ID = "58927"; // Branch ID ‡∏à‡∏£‡∏¥‡∏á

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏î‡∏∂‡∏á ID ‡∏à‡∏≤‡∏Å‡∏•‡∏¥‡∏á‡∏Å‡πå Google Drive ‡πÉ‡∏´‡πâ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏ó‡∏∏‡∏Å‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö
function getFileIdFromUrl(url) {
  var id = "";
  // ‡∏•‡∏≠‡∏á‡∏´‡∏≤‡πÅ‡∏ö‡∏ö ?id=...
  if (url.indexOf('?id=') > 0) {
    id = url.split('?id=')[1].split('&')[0];
  } else {
    // ‡∏•‡∏≠‡∏á‡∏´‡∏≤‡πÅ‡∏ö‡∏ö /d/ID/ ‡∏´‡∏£‡∏∑‡∏≠ Pattern ID ‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ (25+ ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£)
    var parts = url.match(/[-\w]{25,}/);
    if (parts && parts.length > 0) {
      id = parts[0];
    }
  }
  return id;
}

function verifySlipDirectly(fileUrl) {
  if (!fileUrl) return null;
  
  try {
    const fileId = getFileIdFromUrl(fileUrl);
    if (!fileId) {
      console.error("‚ùå ‡πÅ‡∏Å‡∏∞ File ID ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ: " + fileUrl);
      return null;
    }

    const file = DriveApp.getFileById(fileId);
    const blob = file.getBlob();
    
    // Optional: ‡∏ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏£‡∏π‡∏õ‡πÄ‡∏õ‡πá‡∏ô Base64 (‡∏£‡∏∞‡∏ß‡∏±‡∏á‡πÇ‡∏Ñ‡∏ß‡∏ï‡πâ‡∏≤ Firestore)
    // const base64Image = Utilities.base64Encode(blob.getBytes());
    
    const options = {
      method: "post",
      headers: {
        "x-authorization": SLIPOK_API_KEY,
        "Content-Type": "application/json"
      },
      payload: JSON.stringify({
        files: Utilities.base64Encode(blob.getBytes()),
        log: true
      }),
      muteHttpExceptions: true
    };
    
    const response = UrlFetchApp.fetch(`https://api.slipok.com/api/line/apikey/${BRANCH_ID}`, options);
    const result = JSON.parse(response.getContentText());
    
    // üí° ‡∏Å‡∏£‡∏ì‡∏µ‡∏™‡∏•‡∏¥‡∏õ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á (success: true)
    if (result.success) {
      return { success: true, data: result.data };
    }

    // üí° ‡∏Å‡∏£‡∏ì‡∏µ‡∏™‡∏•‡∏¥‡∏õ‡∏ã‡πâ‡∏≥ (success: false ‡πÅ‡∏ï‡πà‡∏°‡∏µ data) - ‡∏ñ‡∏∑‡∏≠‡∏ß‡πà‡∏≤‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏•‡∏¥‡∏õ‡∏à‡∏£‡∏¥‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏Ñ‡∏¢‡∏™‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß
    // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏à‡∏≤‡∏Å code 1004 ‡∏´‡∏£‡∏∑‡∏≠ 1012 ‡∏´‡∏£‡∏∑‡∏≠‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° '‡πÉ‡∏ä‡πâ‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß' / 'used' / '‡∏™‡∏•‡∏¥‡∏õ‡∏ã‡πâ‡∏≥'
    if (result.data && (result.code === 1004 || result.code === 1012 || result.message?.includes('‡πÉ‡∏ä‡πâ‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß') || result.message?.includes('used') || result.message?.includes('‡∏™‡∏•‡∏¥‡∏õ‡∏ã‡πâ‡∏≥'))) {
      console.log("‚ö†Ô∏è ‡∏™‡∏•‡∏¥‡∏õ‡∏ã‡πâ‡∏≥‡πÅ‡∏ï‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á (Duplicate Valid): " + fileUrl);
      return { success: true, data: result.data };
    }
    
    console.error(`‚ùå SlipOK Failed: ${result.message} (Code: ${result.code}) for ${fileUrl}`);

    return null;
  } catch (e) {
    console.error("Verify Error: " + e.toString() + " | URL: " + fileUrl);
    return null;
  }
}

// ... (Existing code)

/**
 * ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏õ‡πá‡∏ô Public (Anyone with the link) ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
 */
function setFilePublic(fileUrl) {
  if (!fileUrl) return;
  try {
    const fileId = getFileIdFromUrl(fileUrl);
    if (fileId) {
      const file = DriveApp.getFileById(fileId);
      // ‡πÉ‡∏ä‡πâ setSharing ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå Public Link ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
      file.setSharing(DriveApp.Access.ANYONE_WITH_LINK, DriveApp.Permission.VIEW);
      console.log("üîì Set Public Access for: " + fileId);
    }
  } catch (e) {
    console.warn("‚ö†Ô∏è Failed to set public access: " + e.toString());
  }
}

/**
 * ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏•‡∏¥‡∏õ‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏™ ‡πÅ‡∏•‡∏∞‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤‡∏•‡∏á‡πÄ‡∏ß‡πá‡∏ö
 * ‡∏Å‡∏î‡∏£‡∏±‡∏ô‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠ Sync ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
 */
function batchVerifyExistingSlips() {
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName("Form Responses 1");
  if (!sheet) {
    console.error("‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡∏ä‡∏µ‡∏ó 'Form Responses 1'");
    return;
  }
  
  const data = sheet.getDataRange().getValues();
  console.log(`üöÄ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞ Sync ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ${data.length - 1} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£...`);

  for (let i = 1; i < data.length; i++) {
    const nickname = data[i][3];
    const phone = data[i][5];
    const slipUrl = data[i][8];
    
    if (!slipUrl || !String(slipUrl).includes("http")) {
      // ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏™‡∏•‡∏¥‡∏õ ‡∏™‡πà‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏£‡∏≠‡∏ä‡∏≥‡∏£‡∏∞‡πÑ‡∏õ
      syncToFirebasePayment({
        phoneNumber: phone,
        customerName: nickname,
        amount: 0,
        transRef: "NO_SLIP",
        senderName: "",
        transferDate: "",
        status: 'awaiting_payment',
        source: 'legacy_batch',
        slipUrl: ""
      });
      sheet.getRange(i + 1, 10).setValue("‚ùå ‡∏£‡∏≠‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô");
      continue;
    }

    // ‚úÖ ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏õ‡πá‡∏ô Public ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
    setFilePublic(slipUrl);

    // console.log(`üîç [${i}/${data.length-1}] ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à/Sync ‡∏Ñ‡∏∏‡∏ì ${nickname}...`);
    
    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏±‡∏ö SlipOK (‡∏´‡∏£‡∏∑‡∏≠‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ñ‡πâ‡∏≤‡πÄ‡∏Ñ‡∏¢‡∏ï‡∏£‡∏ß‡∏à‡πÅ‡∏•‡πâ‡∏ß)
    const result = verifySlipDirectly(slipUrl);
    
    if (result && result.success) {
      const slip = result.data;
      
      const payload = {
        phoneNumber: phone,
        customerName: nickname,
        amount: slip.amount,
        transRef: slip.transRef,
        senderName: slip.sender?.name || "",
        transferDate: slip.transTimestamp || "",
        status: 'verified',
        source: 'legacy_batch',
        slipUrl: slipUrl // ‚úÖ Explicitly checking this
      };

      console.log(`Preparing to send: ${nickname}, Slip: ${payload.slipUrl}`);

      syncToFirebasePayment(payload);
      
      // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ä‡∏µ‡∏ó‡∏ß‡πà‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏ú‡πà‡∏≤‡∏ô
      sheet.getRange(i + 1, 10).setValue("‚úÖ ‡∏ä‡∏≥‡∏£‡∏∞‡πÅ‡∏•‡πâ‡∏ß (Auto)");
      console.log(`‚úÖ [${i}/${data.length-1}] Sync ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢: ${nickname} (‡∏ø${slip.amount})`);
    } else {
      console.warn(`‚ö†Ô∏è [${i}/${data.length-1}] ‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô: ${nickname}`);
      // ‡∏Å‡∏£‡∏ì‡∏µ‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô‡∏£‡∏≠‡∏°‡∏∑‡∏≠‡∏ï‡∏£‡∏ß‡∏à
      sheet.getRange(i + 1, 10).setValue("‚è≥ ‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö (‡∏†‡∏≤‡∏û‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤)");
      
      syncToFirebasePayment({
        phoneNumber: phone,
        customerName: nickname,
        amount: 0,
        transRef: "MANUAL_CHECK_NEEDED",
        senderName: "Unknown",
        status: 'manual_check',
        source: 'legacy_batch',
        slipUrl: slipUrl
      });
    }
    
    // ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏¢‡∏¥‡∏á API ‡∏ñ‡∏µ‡πà‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ
    Utilities.sleep(500); 
  }
  console.log("üèÅ Completed!");
}

function onFormSubmit(e) {
  try {
    const responses = e.values;
    const nickname = responses[3];
    const phone = responses[5];
    const slipUrl = responses[8];
    const selectedDate = responses[1];
    const level = responses[6];
    const timestamp = responses[0];
    
    let verificationStatus = "‚ö†Ô∏è ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÅ‡∏ô‡∏ö‡∏™‡∏•‡∏¥‡∏õ";
    let isSlipVerified = false;
    let slipData = { amount: 0, transRef: "" };

    if (slipUrl) {
      // ‚úÖ ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏õ‡πá‡∏ô Public ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ñ‡∏ô‡∏™‡πà‡∏á‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°
      setFilePublic(slipUrl);

      const result = verifySlipDirectly(slipUrl);
      if (result && result.success) {
        // ‚úÖ ‡∏ï‡∏£‡∏ß‡∏à‡∏ú‡πà‡∏≤‡∏ô
        isSlipVerified = true;
        verificationStatus = "‚úÖ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡πâ‡∏ß (Auto)";
        slipData = result.data;
        
        syncToFirebasePayment({
          phoneNumber: phone,
          customerName: nickname,
          amount: slipData.amount,
          transRef: slipData.transRef,
          senderName: slipData.sender?.name || "",
          transferDate: slipData.transTimestamp || "",
          status: 'verified',
          source: 'legacy_sheet',
          slipUrl: slipUrl
        });
      } else {
        // ‚ùå ‡∏ï‡∏£‡∏ß‡∏à‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô ‡∏´‡∏£‡∏∑‡∏≠ ‡∏™‡∏•‡∏¥‡∏õ‡∏î‡∏π‡πÑ‡∏°‡πà‡∏≠‡∏≠‡∏Å
        verificationStatus = "‚ö†Ô∏è ‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ (Manual Check)";
        console.warn(`Manual Check Needed for ${nickname}: ${slipUrl}`);
        
        // ‡∏™‡πà‡∏á‡πÄ‡∏Ç‡πâ‡∏≤ Firebase ‡∏î‡πâ‡∏ß‡∏¢‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ manual_check ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ Admin ‡πÑ‡∏õ‡∏Å‡∏î Approve ‡πÉ‡∏ô‡πÄ‡∏ß‡πá‡∏ö‡πÑ‡∏î‡πâ
        syncToFirebasePayment({
          phoneNumber: phone,
          customerName: nickname,
          amount: 0, // ‡πÑ‡∏°‡πà‡∏£‡∏π‡πâ‡∏¢‡∏≠‡∏î
          transRef: "MANUAL_CHECK", // ‡πÑ‡∏°‡πà‡∏£‡∏π‡πâ ref
          senderName: "",
          transferDate: "",
          status: 'manual_check',
          source: 'legacy_sheet',
          slipUrl: slipUrl
        });
      }
    } else {
       // ‡∏™‡πÅ‡∏õ‡∏°‡πÅ‡∏Å‡πâ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÅ‡∏ô‡∏ö‡∏™‡∏•‡∏¥‡∏õ ‡∏™‡πà‡∏á status ‡∏ß‡πà‡∏≤ awaiting_payment ‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ
       // ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏°‡∏±‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≠‡∏ä‡∏≥‡∏£‡∏∞
       syncToFirebasePayment({
          phoneNumber: phone,
          customerName: nickname,
          amount: 0,
          transRef: "NO_SLIP",
          senderName: "",
          transferDate: "",
          status: 'awaiting_payment',
          source: 'legacy_sheet',
          slipUrl: ""
        });
        
        // ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ "‚ùå ‡∏£‡∏≠‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô" ‡∏•‡∏á‡πÉ‡∏ô‡∏ä‡∏µ‡∏ó (Column J = ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ó‡∏µ‡πà 10)
        try {
          if (e && e.range) {
             const row = e.range.getRow();
             const sheet = e.range.getSheet();
             sheet.getRange(row, 10).setValue("‚ùå ‡∏£‡∏≠‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô");
          }
        } catch(err) {
           console.log("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏•‡∏á‡∏ä‡∏µ‡∏ó‡πÑ‡∏î‡πâ:", err);
        }
    }
    // ----------------------------

    // ‡∏™‡πà‡∏ß‡∏ô‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô Telegram
    
    // ‡∏ô‡∏±‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πâ
    const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName("Form Responses 1");
    let countForDate = 0;
    
    if (sheet) {
      const data = sheet.getDataRange().getValues();
      for (let i = 1; i < data.length; i++) {
        // ‡∏´‡∏≤ date ‡∏à‡∏≤‡∏Å e.values[1] (Timestamp ‡∏Ñ‡∏∑‡∏≠ 0, Date ‡∏Ñ‡∏∑‡∏≠ 1)
        if (data[i][1] === responses[1]) {
          countForDate++;
        }
      }
    }
    
    // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
    let message = `üèüÔ∏è *‡∏°‡∏µ‡∏Ñ‡∏ô‡∏™‡∏°‡∏±‡∏Ñ‡∏£ Gym Battle ‡πÉ‡∏´‡∏°‡πà!*

üë§ *‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô:* ${nickname}
üì± *‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£:* ${phone}
üéÆ *‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡πà‡∏ô:* ${level}
üìÖ *‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å:* ${selectedDate}
‚è∞ *‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏™‡∏°‡∏±‡∏Ñ‡∏£:* ${timestamp}
üí∞ *‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏™‡∏•‡∏¥‡∏õ:* ${verificationStatus}

üìä *‡∏£‡∏ß‡∏°‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${selectedDate}: ${countForDate} ‡∏Ñ‡∏ô*

---`;

    // ‡∏ñ‡πâ‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô ‡πÉ‡∏´‡πâ‡πÅ‡∏ô‡∏ö‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏™‡∏•‡∏¥‡∏õ‡πÉ‡∏´‡πâ‡∏Å‡∏î‡∏î‡∏π‡∏á‡πà‡∏≤‡∏¢‡πÜ
    if (slipUrl && !isSlipVerified) {
       message += `\n\nüìé [‡∏Å‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏™‡∏•‡∏¥‡∏õ‡∏ó‡∏µ‡πà‡πÅ‡∏ô‡∏ö‡∏°‡∏≤](${slipUrl})`;
       message += `\n‚ö†Ô∏è *‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö*`;
    }

    message += `\n\nüìä [‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î](https://uplevelguild.netlify.app/gymbattle)`;
    
    // ‡∏™‡πà‡∏á‡πÑ‡∏õ‡∏¢‡∏±‡∏á Telegram
    const payload = {
      chat_id: CHAT_ID,
      text: message,
      parse_mode: "Markdown",
      disable_web_page_preview: false // ‡πÉ‡∏´‡πâ‡πÇ‡∏ä‡∏ß‡πå preview ‡∏£‡∏π‡∏õ‡∏™‡∏•‡∏¥‡∏õ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏•‡∏¥‡∏á‡∏Å‡πå
    };
    
    try {
      UrlFetchApp.fetch(`${TELEGRAM_API_URL}/sendMessage`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        payload: JSON.stringify(payload)
      });
      console.log("‚úÖ ‡∏™‡πà‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÑ‡∏õ‡∏¢‡∏±‡∏á Telegram ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
    } catch (e) {
      console.warn("‚ö†Ô∏è ‡∏™‡πà‡∏á‡πÅ‡∏ö‡∏ö Markdown ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡∏•‡∏≠‡∏á‡∏™‡πà‡∏á‡πÅ‡∏ö‡∏ö‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ò‡∏£‡∏£‡∏°‡∏î‡∏≤...", e);
      
      // Fallback message
      payload.parse_mode = undefined; 
      payload.text = `üèüÔ∏è ‡∏°‡∏µ‡∏Ñ‡∏ô‡∏™‡∏°‡∏±‡∏Ñ‡∏£ Gym Battle ‡πÉ‡∏´‡∏°‡πà!

üë§ ‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô: ${nickname}
üì± ‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£: ${phone}
üéÆ ‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡πà‡∏ô: ${level}
üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å: ${selectedDate}
üí∞ ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏™‡∏•‡∏¥‡∏õ: ${verificationStatus}

üìé ‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏™‡∏•‡∏¥‡∏õ: ${slipUrl || '-'}

üìä ‡∏£‡∏ß‡∏°‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${selectedDate}: ${countForDate} ‡∏Ñ‡∏ô

---
üìä ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: https://uplevelguild.netlify.app/gymbattle`;

      UrlFetchApp.fetch(`${TELEGRAM_API_URL}/sendMessage`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        payload: JSON.stringify(payload)
      });
      console.log("‚úÖ ‡∏™‡πà‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÅ‡∏ö‡∏ö‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ò‡∏£‡∏£‡∏°‡∏î‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
    }
  } catch (error) {
    console.error("‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î:", error);
  }
}

/**
 * ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡πÑ‡∏õ‡∏¢‡∏±‡∏á Telegram
 */
function testTelegramNotification() {
    const testData = {
      values: [
        new Date().toLocaleString('th-TH'),
        "‡∏ß‡∏±‡∏ô‡∏®‡∏∏‡∏Å‡∏£‡πå‡∏ó‡∏µ‡πà 6 ‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå 2569",
        "",
        "‡∏ú‡∏π‡πâ‡∏ó‡∏î‡∏™‡∏≠‡∏ö",
        "",
        "0812345678",
        "Gold"
      ]
    };
  
  onFormSubmit(testData);
  console.log("üß™ ‡∏™‡πà‡∏á‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡πÑ‡∏õ‡∏¢‡∏±‡∏á Telegram ‡πÅ‡∏•‡πâ‡∏ß");
}

/**
 * ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏´‡∏≤ Chat ID ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
 * ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡πâ‡∏ß‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÉ‡∏´‡πâ‡∏ö‡∏≠‡∏ó ‡∏à‡∏∞‡πÑ‡∏î‡πâ Chat ID
 */
function getChatId() {
  try {
    const response = UrlFetchApp.fetch(`${TELEGRAM_API_URL}/getUpdates`);
    const data = JSON.parse(response.getContentText());
    
    if (data.ok && data.result.length > 0) {
      const lastMessage = data.result[data.result.length - 1];
      const chatId = lastMessage.message.chat.id;
      const username = lastMessage.message.from.username || lastMessage.message.from.first_name;
      
      console.log(`Chat ID ‡∏Ç‡∏≠‡∏á ${username}: ${chatId}`);
      return chatId;
    } else {
      console.log("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÉ‡∏´‡∏°‡πà ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÉ‡∏´‡πâ‡∏ö‡∏≠‡∏ó‡∏Å‡πà‡∏≠‡∏ô");
      return null;
    }
  } catch (error) {
    console.error("‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏´‡∏≤ Chat ID:", error);
    return null;
  }
}

/**
 * ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡πà‡∏á‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô
 */
function sendDailySummary() {
  try {
    const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName("Form Responses 1");
    if (!sheet) {
      console.log("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ä‡∏µ‡∏ó‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•");
      return;
    }
    
    const data = sheet.getDataRange().getValues();
    const today = new Date();
    const todayStr = today.toLocaleDateString('th-TH');
    
    let todayCount = 0;
    let todayRegistrations = [];
    
    for (let i = 1; i < data.length; i++) {
      const rowDate = new Date(data[i][0]);
      if (rowDate.toLocaleDateString('th-TH') === todayStr) {
        todayCount++;
        todayRegistrations.push({
          nickname: data[i][3],
          phone: data[i][5],
          level: data[i][6],
          selectedDate: data[i][1]
        });
      }
    }
    
    let message = `üìä *‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏π‡πâ‡∏™‡∏°‡∏±‡∏Ñ‡∏£ Gym Battle ‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô*

üìÖ *‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:* ${todayStr}
üë• *‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ú‡∏π‡πâ‡∏™‡∏°‡∏±‡∏Ñ‡∏£:* ${todayCount} ‡∏Ñ‡∏ô

`;
    
    if (todayRegistrations.length > 0) {
      message += `üìã *‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏™‡∏°‡∏±‡∏Ñ‡∏£:*\n`;
      todayRegistrations.forEach((reg, index) => {
        message += `${index + 1}. ${reg.nickname} (${reg.level}) - ${reg.selectedDate}\n`;
      });
    } else {
      message += `üìù ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ú‡∏π‡πâ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ`;
    }
    
    message += `\n---\nüìä [‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î](https://uplevelguild.netlify.app/gymbattle)`;
    
    const payload = {
      chat_id: CHAT_ID,
      text: message,
      parse_mode: "Markdown",
      disable_web_page_preview: true
    };
    
    UrlFetchApp.fetch(`${TELEGRAM_API_URL}/sendMessage`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      payload: JSON.stringify(payload)
    });
    
    console.log(`‚úÖ ‡∏™‡πà‡∏á‡∏™‡∏£‡∏∏‡∏õ‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô‡πÑ‡∏õ‡∏¢‡∏±‡∏á Telegram ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à - ${todayCount} ‡∏Ñ‡∏ô`);
    
  } catch (error) {
    console.error("‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏™‡∏£‡∏∏‡∏õ:", error);
  }
}

/**
 * ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ó‡∏î‡∏™‡∏≠‡∏ö API
 */
function testAPI() {
  try {
    var result = doGet({parameter: {type: "json"}});
    console.log("API Test Result:", result.getContent());
  } catch (error) {
    console.error("API Test Error:", error);
  }
}
/**
 * ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ Firestore Payment
 */
// ----------------------------------------------------------------------------
// üîß Firestore Direct Sync (No Webhook required/‡πÑ‡∏°‡πà‡∏û‡∏∂‡πà‡∏á Webhook)
// ----------------------------------------------------------------------------

function syncToFirebasePayment(paymentData) {
  // Config
  const PROJECT_ID = "up-level-guild";
  const COLLECTION = "public_payments";
  const API_KEY = "AIzaSyAKxWv3FI7HrdrRlnJhsQbJ-97Pb_sdiOQ"; // Public API Key from slip-check.html
  
  const url = `https://firestore.googleapis.com/v1/projects/${PROJECT_ID}/databases/(default)/documents/${COLLECTION}?key=${API_KEY}`;
  
  if (!paymentData.slipUrl) {
     console.warn("‚ö†Ô∏è Warning: sending payment without slipUrl for " + paymentData.customerName);
  }

  // ‚úÖ ‡πÅ‡∏õ‡∏•‡∏á‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏£‡∏π‡∏õ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô Direct Link (‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏°‡∏≤‡∏Å‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ç‡∏∂‡πâ‡∏ô‡πÄ‡∏ß‡πá‡∏ö)
  paymentData.slipUrl = convertDriveUrlToDirectLink(paymentData.slipUrl);

  // ‡πÅ‡∏õ‡∏•‡∏á Data ‡πÉ‡∏´‡πâ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏ï‡∏£‡∏∞‡∏Å‡∏π‡∏• Firestore JSON (‡∏°‡∏µ type ‡∏Å‡∏≥‡∏Å‡∏±‡∏ö)
  const firestorePayload = {
    fields: createFirestoreObject(paymentData)
  };
  
  // ‡πÄ‡∏û‡∏¥‡πà‡∏° Timestamp
  firestorePayload.fields.createdAt = { timestampValue: new Date().toISOString() };
  firestorePayload.fields.updatedAt = { timestampValue: new Date().toISOString() };

  const options = {
    method: "post",
    contentType: "application/json",
    payload: JSON.stringify(firestorePayload),
    muteHttpExceptions: true
  };
  
  try {
    const response = UrlFetchApp.fetch(url, options);
    const code = response.getResponseCode();
    const content = response.getContentText();
    
    if (code === 200) {
      console.log("‚úÖ Synced to Firestore (Direct) for " + paymentData.phoneNumber);
    } else {
      console.error(`‚ùå Firestore Error (${code}): ${content}`);
    }
  } catch (e) {
    console.error("Sync Firestore Error: " + e.toString());
  }
}

// Helper: ‡πÅ‡∏õ‡∏•‡∏á JSON ‡∏ò‡∏£‡∏£‡∏°‡∏î‡∏≤ ‡πÄ‡∏õ‡πá‡∏ô Firestore Format
function createFirestoreObject(obj) {
  const fields = {};
  for (const key in obj) {
    const value = obj[key];
    if (value === null || value === undefined) {
      fields[key] = { nullValue: null };
    } else if (typeof value === 'boolean') {
      fields[key] = { booleanValue: value };
    } else if (typeof value === 'number') {
      if (Number.isInteger(value)) {
        fields[key] = { integerValue: value.toString() }; 
      } else {
        fields[key] = { doubleValue: value };
      }
    } else if (value instanceof Date) {
      fields[key] = { timestampValue: value.toISOString() };
    } else {
      fields[key] = { stringValue: String(value) };
    }
  }
  return fields;
}

// Helper: ‡πÅ‡∏õ‡∏•‡∏á Google Drive Link ‡πÄ‡∏õ‡πá‡∏ô Direct Link (‡∏£‡∏π‡∏õ‡∏Ç‡∏∂‡πâ‡∏ô‡∏ä‡∏±‡∏ß‡∏£‡πå‡∏Å‡∏ß‡πà‡∏≤)
function convertDriveUrlToDirectLink(url) {
  if (!url) return "";
  try {
    const id = getFileIdFromUrl(url);
    if (id) {
       // Format ‡∏ô‡∏µ‡πâ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏£‡πá‡∏ß‡∏Å‡∏ß‡πà‡∏≤‡πÅ‡∏•‡∏∞‡πÑ‡∏°‡πà‡∏ï‡∏¥‡∏î Redirect
       return `https://lh3.googleusercontent.com/d/${id}`;
    }
  } catch (e) {
    console.warn("Convert URL Failed: " + e.toString());
  }
  return url;
}

/**
 * üîì ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Ñ‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå (‡πÅ‡∏Å‡πâ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏£‡∏π‡∏õ‡πÑ‡∏°‡πà‡∏Ç‡∏∂‡πâ‡∏ô)
 * ‡∏ß‡∏¥‡∏ò‡∏µ‡πÉ‡∏ä‡πâ:
 * 1. ‡πÑ‡∏õ‡∏ó‡∏µ‡πà Google Drive ‡πÄ‡∏õ‡∏¥‡∏î‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡πá‡∏ö‡∏£‡∏π‡∏õ‡∏™‡∏•‡∏¥‡∏õ
 * 2. ‡∏Å‡πä‡∏≠‡∏õ‡∏õ‡∏µ‡πâ ID ‡∏à‡∏≤‡∏Å URL (‡∏™‡πà‡∏ß‡∏ô‡∏´‡∏•‡∏±‡∏á /folders/...) ‡πÄ‡∏ä‡πà‡∏ô 1A2B3C...
 * 3. ‡∏ô‡∏≥‡∏°‡∏≤‡∏ß‡∏≤‡∏á‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà "YOUR_FOLDER_ID_HERE" ‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á
 * 4. ‡∏Å‡∏î Run
 */
/**
 * üîì Unlock multiple folders function
 */
/**
 * üîì ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥: ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÅ‡∏•‡∏∞‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Ñ‡∏ó‡∏∏‡∏Å‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ñ‡∏≥‡∏ß‡πà‡∏≤ "(File responses)"
 * ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏™‡πà ID ‡πÄ‡∏≠‡∏á! ‡πÅ‡∏Ñ‡πà‡∏Å‡∏î Run ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ô‡∏µ‡πâ
 */
function unlockAllFileResponseFolders() {
  console.log("üîç ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ñ‡∏≥‡∏ß‡πà‡∏≤ '(File responses)' ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î...");
  
  // ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏á‡∏ó‡πâ‡∏≤‡∏¢‡∏î‡πâ‡∏ß‡∏¢ "(File responses)" ‡πÅ‡∏•‡∏∞‡πÑ‡∏°‡πà‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏ñ‡∏±‡∏á‡∏Ç‡∏¢‡∏∞
  const folders = DriveApp.searchFolders("title contains '(File responses)' and trashed = false");
  let folderCount = 0;

  while (folders.hasNext()) {
    const folder = folders.next();
    folderCount++;
    console.log(`üìÇ [${folderCount}] ‡∏û‡∏ö‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå: ${folder.getName()}`);
    
    try {
      processFolder(folder);
    } catch (e) {
      console.error(`‚ùå Error Unlock Folder ${folder.getName()}: ${e.toString()}`);
    }
  }

  if (folderCount === 0) {
    console.log("‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ó‡∏µ‡πà‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏Ñ‡∏≥‡∏ß‡πà‡∏≤ '(File responses)' ‡πÄ‡∏•‡∏¢");
  } else {
    console.log(`‚úÖ ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô! ‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÑ‡∏õ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ${folderCount} ‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå`);
  }
}

function processFolder(folder) {
    // ‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Ñ‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏ô‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ô‡∏µ‡πâ
    const files = folder.getFiles();
    let fileCount = 0;
    while (files.hasNext()) {
        const file = files.next();
        // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Public
        try {
          file.setSharing(DriveApp.Access.ANYONE_WITH_LINK, DriveApp.Permission.VIEW);
          fileCount++;
        } catch(e) {
          // ‡∏ö‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå‡∏≠‡∏≤‡∏à error ‡∏Ç‡πâ‡∏≤‡∏°‡πÑ‡∏õ
        }
    }
    
    // Recursive: ‡∏´‡∏≤‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏¢‡πà‡∏≠‡∏¢‡∏Ç‡πâ‡∏≤‡∏á‡πÉ‡∏ô‡∏î‡πâ‡∏ß‡∏¢ (‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏°‡∏µ)
    const subfolders = folder.getFolders();
    while (subfolders.hasNext()) {
        processFolder(subfolders.next());
    }
    
    if (fileCount > 0) console.log(`   üîì ‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Ñ‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏ô "${folder.getName()}" ‡πÑ‡∏õ ${fileCount} ‡πÑ‡∏ü‡∏•‡πå`);
}

/**
 * üöÄ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏î‡∏∂‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏à‡∏≤‡∏Å "‡∏ó‡∏∏‡∏Å‡∏ä‡∏µ‡∏ó" ‡∏•‡∏á‡πÄ‡∏ß‡πá‡∏ö (Sync All History)
 */
/**
 * üöÄ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏î‡∏∂‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏à‡∏≤‡∏Å "‡∏´‡∏•‡∏≤‡∏¢‡πÑ‡∏ü‡∏•‡πå" ‡∏•‡∏á‡πÄ‡∏ß‡πá‡∏ö (Sync Multiple Spreadsheets)
 * ‡∏ß‡∏¥‡∏ò‡∏µ‡πÉ‡∏ä‡πâ: ‡πÄ‡∏≠‡∏≤ ID ‡∏Ç‡∏≠‡∏á Google Sheet ‡πÑ‡∏ü‡∏•‡πå‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‡∏°‡∏≤‡πÉ‡∏™‡πà‡πÉ‡∏ô array ‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á
 */
/**
 * üöÄ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏î‡∏∂‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏à‡∏≤‡∏Å "‡∏ó‡∏∏‡∏Å‡πÑ‡∏ü‡∏•‡πå" ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ (Auto Search Files)
 * ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏´‡∏≤ ID ‡πÄ‡∏≠‡∏á! ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ñ‡∏≥‡∏ß‡πà‡∏≤ "(Responses)" ‡∏´‡∏£‡∏∑‡∏≠ "(‡∏Å‡∏≤‡∏£‡∏ï‡∏≠‡∏ö‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°)" ‡πÉ‡∏´‡πâ‡πÄ‡∏≠‡∏á
 */
/**
 * üöÄ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏î‡∏∂‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏à‡∏≤‡∏Å "‡∏ó‡∏∏‡∏Å‡πÑ‡∏ü‡∏•‡πå" ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ (Auto Search Files) + ‡∏£‡∏∞‡∏ö‡∏ö Checkpoint üö©
 * - ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏à‡∏≥‡∏ß‡πà‡∏≤‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏´‡∏ô‡∏ó‡∏≥‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß ‡∏à‡∏∞‡πÑ‡∏î‡πâ‡πÑ‡∏°‡πà‡∏ó‡∏≥‡∏ã‡πâ‡∏≥
 * - ‡∏Å‡∏î‡∏¢‡πâ‡∏≥‡πÜ ‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢ ‡∏°‡∏±‡∏ô‡∏à‡∏∞‡∏ó‡∏≥‡∏ï‡πà‡∏≠‡∏à‡∏≤‡∏Å‡πÄ‡∏î‡∏¥‡∏°‡∏à‡∏ô‡∏à‡∏ö
 */
/**
 * üöÄ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏î‡∏∂‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏à‡∏≤‡∏Å "‡∏ó‡∏∏‡∏Å‡πÑ‡∏ü‡∏•‡πå" ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ (Auto Search Files) + ‡∏£‡∏∞‡∏ö‡∏ö Checkpoint üö©
 */
function syncAllHistoryToWeb() {
  const props = PropertiesService.getScriptProperties();
  const processedFiles = JSON.parse(props.getProperty('PROCESSED_FILES') || '[]');
  
  console.log(`üìù ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô: ‡∏ó‡∏≥‡πÄ‡∏™‡∏£‡πá‡∏à‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß ${processedFiles.length} ‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏±‡πà‡∏ß‡πÇ‡∏•‡∏Å`);
  console.log("üí° ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥: ‡∏ñ‡πâ‡∏≤‡∏≠‡∏¢‡∏≤‡∏Å‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ‡πÉ‡∏´‡πâ‡∏Å‡∏î Run ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô 'clearSyncHistory' ‡∏Å‡πà‡∏≠‡∏ô‡∏ô‡∏∞‡∏Ñ‡∏£‡∏±‡∏ö");
  console.log("üîç ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÑ‡∏ü‡∏•‡πå Google Sheet ‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô Form Response ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î...");
  
  const files = DriveApp.searchFiles("mimeType = 'application/vnd.google-apps.spreadsheet' and (title contains '(Responses)' or title contains '(‡∏Å‡∏≤‡∏£‡∏ï‡∏≠‡∏ö‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°)') and trashed = false");
  
  let successCount = 0;
  let skipCount = 0;

  while (files.hasNext()) {
    const file = files.next();
    const fileId = file.getId();

    if (processedFiles.includes(fileId)) {
      skipCount++;
      continue;
    }

    console.log(`üìÇ [NEW] ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡πÑ‡∏ü‡∏•‡πå: ${file.getName()}`);

    try {
      const ss = SpreadsheetApp.openById(fileId);
      const sheets = ss.getSheets();
      let syncedInFile = 0;
      let hasError = false;

      sheets.forEach(sheet => {
          try {
            const count = processSheet(sheet);
            syncedInFile += count;
          } catch (err) {
            console.error(`   ‚ùå Error ‡∏ä‡∏µ‡∏ó ${sheet.getName()}: ${err.toString()}`);
            hasError = true;
          }
      });

      // ‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Checkpoint ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ñ‡πâ‡∏≤‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 0) ‡∏´‡∏£‡∏∑‡∏≠‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ Error
      // ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á: ‡∏ñ‡πâ‡∏≤‡∏™‡πà‡∏á‡πÑ‡∏î‡πâ 0 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ‡πÅ‡∏™‡∏î‡∏á‡∏ß‡πà‡∏≤‡∏≠‡∏≤‡∏à‡∏à‡∏∞ Mapping ‡∏ú‡∏¥‡∏î ‡∏≠‡∏¢‡πà‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏á‡∏à‡∏≥‡∏ß‡πà‡∏≤‡πÄ‡∏™‡∏£‡πá‡∏à
      if (!hasError && syncedInFile > 0) {
        processedFiles.push(fileId);
        props.setProperty('PROCESSED_FILES', JSON.stringify(processedFiles));
        console.log(`‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Checkpoint ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${file.getName()} (‡∏™‡πà‡∏á‡πÑ‡∏õ ${syncedInFile} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)`);
        successCount++;
      } else {
         console.log(`‚ö†Ô∏è ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Checkpoint ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÑ‡∏ü‡∏•‡πå‡∏ô‡∏µ‡πâ (‡∏™‡πà‡∏á‡πÑ‡∏î‡πâ ${syncedInFile} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ‡∏´‡∏£‡∏∑‡∏≠‡∏°‡∏µ Error)`);
      }

    } catch (e) {
      console.error(`‚ùå ‡πÄ‡∏õ‡∏¥‡∏î‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ: ${e.toString()}`);
    }
  }

  console.log("-----------------------------------");
  console.log(`‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏£‡∏≠‡∏ö‡∏ô‡∏µ‡πâ:`);
  console.log(`‚úÖ ‡∏ó‡∏≥‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${successCount} ‡πÑ‡∏ü‡∏•‡πå`);
  console.log(`‚è© ‡∏Ç‡πâ‡∏≤‡∏°‡∏Ç‡∏≠‡∏á‡πÄ‡∏î‡∏¥‡∏°: ${skipCount} ‡πÑ‡∏ü‡∏•‡πå`);
  
  if (successCount === 0 && skipCount > 0) {
    console.log("‚ú® ‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏´‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡∏£‡∏±‡∏ö (‡∏Ñ‡∏£‡∏ö‡∏´‡∏°‡∏î‡πÅ‡∏•‡πâ‡∏ß)");
  }
}

/**
 * üóëÔ∏è ‡∏•‡πâ‡∏≤‡∏á Checkpoint (‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏≠‡∏¢‡∏≤‡∏Å‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏à‡∏≤‡∏Å‡∏®‡∏π‡∏ô‡∏¢‡πå)
 */
function clearSyncHistory() {
  PropertiesService.getScriptProperties().deleteProperty('PROCESSED_FILES');
  console.log("üßπ ‡∏•‡πâ‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏à‡∏≥‡πÅ‡∏•‡πâ‡∏ß! ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏∞‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà‡∏ï‡πâ‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö");
}

/**
 * üóëÔ∏è ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Pending (manual_check) ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å Firestore 
 * (‡πÉ‡∏ä‡πâ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡πâ‡∏≤‡∏á‡∏ö‡∏≤‡∏á ‡πÅ‡∏•‡πâ‡∏ß Sync ‡πÉ‡∏´‡∏°‡πà ‡πÇ‡∏î‡∏¢‡πÑ‡∏°‡πà‡∏•‡∏ö history ‡∏î‡∏µ‡πÜ ‡∏ó‡∏¥‡πâ‡∏á)
 */
function clearAllPendingFromFirestore() {
  const PROJECT_ID = "up-level-guild";
  const COLLECTION = "public_payments";
  const API_KEY = "AIzaSyAKxWv3FI7HrdrRlnJhsQbJ-97Pb_sdiOQ";
  
  console.log("üîç ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏£‡∏∞‡∏ö‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡∏Å‡∏ß‡∏≤‡∏î‡∏•‡πâ‡∏≤‡∏á Pending (Manual Check)...");
  
  let totalDeleted = 0;
  let hasMore = true;

  while(hasMore) {
    const listUrl = `https://firestore.googleapis.com/v1/projects/${PROJECT_ID}/databases/(default)/documents/${COLLECTION}?key=${API_KEY}&pageSize=300`;
    
    try {
      const response = UrlFetchApp.fetch(listUrl);
      const data = JSON.parse(response.getContentText());
      
      if (!data.documents || data.documents.length === 0) {
        console.log("‚ú® ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÅ‡∏•‡πâ‡∏ß (‡πÄ‡∏Å‡∏•‡∏µ‡πâ‡∏¢‡∏á‡πÄ‡∏Å‡∏•‡∏≤!)");
        break;
      }
      
      const deleteRequests = [];
      data.documents.forEach(doc => {
        const docPath = doc.name; 
        const status = doc.fields.status?.stringValue;
        
        // ÔøΩÔ∏è Safe Guard: ‡∏•‡∏ö‡πÄ‡∏â‡∏û‡∏≤‡∏∞ manual_check ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
        if (status === 'manual_check') {
          deleteRequests.push({
            url: `https://firestore.googleapis.com/v1/${docPath}?key=${API_KEY}`,
            method: 'delete',
            muteHttpExceptions: true
          });
        }
      });

      if (deleteRequests.length === 0) {
         console.log("‚ú® ‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠ manual_check ‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡πÅ‡∏•‡πâ‡∏ß Break loop");
         break;
      }

      console.log(`üî• ‡πÄ‡∏à‡∏≠‡∏•‡πá‡∏≠‡∏ï‡πÉ‡∏´‡∏°‡πà ${deleteRequests.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£... ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡∏ö...`);
      
      // Batch Delete
      const CHUNK_SIZE = 50;
      for (let i = 0; i < deleteRequests.length; i += CHUNK_SIZE) {
          const chunk = deleteRequests.slice(i, i + CHUNK_SIZE);
          UrlFetchApp.fetchAll(chunk);
      }
      
      totalDeleted += deleteRequests.length;
      console.log(`   üí• ‡∏•‡∏ö‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß‡∏£‡∏ß‡∏°: ${totalDeleted} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£... (‡∏ß‡∏ô‡∏´‡∏≤‡∏ï‡πà‡∏≠)`);
      
    } catch (e) {
      console.error("‚ùå Error Loop: " + e.toString());
      break; 
    }
  }
  
  console.log(`‚úÖ ‡∏à‡∏ö‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏•‡πâ‡∏≤‡∏á‡∏ö‡∏≤‡∏á Pending! ‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ${totalDeleted} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`);
}

/**
 * üß® Master Function: ‡∏Å‡∏î‡∏ó‡∏µ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß ‡∏•‡πâ‡∏≤‡∏á‡∏ó‡∏∏‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÅ‡∏•‡πâ‡∏ß Sync ‡πÉ‡∏´‡∏°‡πà‡∏´‡∏°‡∏î!
 * (‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏î‡∏ó‡∏µ‡∏•‡∏∞‡∏≠‡∏±‡∏ô‡πÅ‡∏•‡πâ‡∏ß)
 */
function masterResetAndSync() {
  console.log("üß® START MASTER RESET & SYNC...");
  
  try {
    console.log("Step 1: ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Pending ‡πÉ‡∏ô Firestore...");
    clearAllPendingFromFirestore();
  } catch(e) { console.error("Step 1 Failed:", e); }

  try {
    console.log("Step 2: ‡∏•‡πâ‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏à‡∏≥ (Checkpoint)...");
    clearSyncHistory();
  } catch(e) { console.error("Step 2 Failed:", e); }

  console.log("Step 3: ‡πÄ‡∏£‡∏¥‡πà‡∏° Sync ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î...");
  syncAllHistoryToWeb();
  
  console.log("üèÅ MASTER FINISHED!");
}

function processSheet(sheet) {
  const data = sheet.getDataRange().getValues();
  if (data.length < 2) return 0;

  const header = data[0];
  // console.log("   Headers: " + JSON.stringify(header)); // Debug ‡∏î‡∏π Header

  let colPhone = -1, colName = -1, colSlip = -1, colTimestamp = 0;

  // üîç Smart Search Columns
  header.forEach((h, i) => {
    const text = String(h).toLowerCase();
    // ‡∏´‡∏≤ Phone
    if (text.includes("‡πÄ‡∏ö‡∏≠‡∏£‡πå") || text.includes("phone") || text.includes("tel") || text.includes("mobile") || text.includes("‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠")) colPhone = i;
    // ‡∏´‡∏≤ Name
    else if (text.includes("‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô") || text.includes("name") || text.includes("‡∏ä‡∏∑‡πà‡∏≠") || text.includes("first") || text.includes("nick")) colName = i;
    // ‡∏´‡∏≤ Slip
    else if (text.includes("‡∏™‡∏•‡∏¥‡∏õ") || text.includes("slip") || text.includes("‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô") || text.includes("upload") || text.includes("file") || text.includes("‡πÑ‡∏ü‡∏•‡πå") || text.includes("‡∏£‡∏π‡∏õ")) colSlip = i;
    // ‡∏´‡∏≤ Timestamp
    else if (text.includes("timestamp") || text.includes("‡πÄ‡∏ß‡∏•‡∏≤") || text.includes("date")) colTimestamp = i;
  });

  // Fallback
  if (colName === -1) colName = 3;
  if (colPhone === -1) colPhone = 5;
  if (colSlip === -1) colSlip = 8;
  
  let count = 0;
  for (let i = 1; i < data.length; i++) {
    const row = data[i];
    
    // ‚è≥ 1. ‡∏Å‡∏£‡∏≠‡∏á‡∏õ‡∏µ 2026 (‡∏õ‡∏µ 69) ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
    const rowDate = row[colTimestamp];
    if (rowDate instanceof Date) {
       if (rowDate.getFullYear() < 2026) {
          // ‡∏Ç‡πâ‡∏≤‡∏°‡∏Ç‡∏≠‡∏á‡πÄ‡∏Å‡πà‡∏≤
          continue;
       }
    }

    if (!row[colName]) continue; 

    // üõ°Ô∏è ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô Mapping ‡∏ú‡∏¥‡∏î (‡πÄ‡∏≠‡∏≤ Link ‡∏´‡∏£‡∏∑‡∏≠ ‡πÄ‡∏ö‡∏≠‡∏£‡πå ‡∏°‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏ä‡∏∑‡πà‡∏≠)
    const rawName = String(row[colName]);
    if (rawName.includes("http") || rawName.includes("www") || /^\d+$/.test(rawName)) {
       // ‡∏ñ‡πâ‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡πá‡∏ô Link ‡∏´‡∏£‡∏∑‡∏≠ ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏•‡πâ‡∏ß‡∏ô -> ‡∏™‡∏±‡∏ô‡∏ô‡∏¥‡∏©‡∏ê‡∏≤‡∏ô‡∏ß‡πà‡∏≤ Map ‡∏ú‡∏¥‡∏î
       // console.log(`   ‚è© ‡∏Ç‡πâ‡∏≤‡∏° row ${i+1}: ‡∏ä‡∏∑‡πà‡∏≠‡∏î‡∏π‡πÅ‡∏õ‡∏•‡∏Å‡πÜ (${rawName})`);
       continue;
    }

    const nickname = rawName;
    const phone = (colPhone >= 0 && row[colPhone]) ? String(row[colPhone]) : "No Phone";
    const slipUrl = (colSlip >= 0 && colSlip < row.length) ? String(row[colSlip]) : "";
    
    // ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏™‡∏•‡∏¥‡∏õ‡πÅ‡∏•‡∏∞‡πÄ‡∏õ‡πá‡∏ô‡∏•‡∏¥‡∏á‡∏Å‡πå ‡∏ñ‡∏∂‡∏á‡∏à‡∏∞‡∏™‡πà‡∏á
    if (slipUrl && slipUrl.includes("http")) {
        
        // 1. üîì ‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Ñ‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô Public ‡∏Å‡πà‡∏≠‡∏ô
        setFilePublic(slipUrl);

        // 2. üîç ‡∏™‡πà‡∏á‡πÑ‡∏õ‡∏ï‡∏£‡∏ß‡∏à‡∏Å‡∏±‡∏ö SlipOK
        let slipData = { amount: 0, transRef: `HISTORY_${sheet.getName().replace(/\s/g, '_')}_ROW${i+1}` }; // Default Ref
        let status = 'manual_check';
        let transferDate = "";
        let senderName = "";

        // ‡∏•‡∏≠‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏•‡∏¥‡∏õ (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏Ñ‡∏¢‡∏ï‡∏£‡∏ß‡∏à - ‡πÅ‡∏ï‡πà‡πÉ‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πâ‡πÄ‡∏£‡∏≤‡∏ñ‡∏∑‡∏≠‡∏ß‡πà‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡πÉ‡∏´‡∏°‡πà‡∏´‡∏°‡∏î)
        const checkResult = verifySlipDirectly(slipUrl);
        
        if (checkResult && checkResult.success) {
           // ‚úÖ SlipOK ‡∏ö‡∏≠‡∏Å‡∏ß‡πà‡∏≤‡∏ú‡πà‡∏≤‡∏ô
           console.log(`      ‚úÖ SlipOK Approved: ${nickname} (‡∏ø${checkResult.data.amount})`);
           status = 'verified';
           slipData = checkResult.data;
           transferDate = slipData.transTimestamp || "";
           senderName = slipData.sender?.name || "";
        } else {
           // ‚ùå SlipOK ‡∏ö‡∏≠‡∏Å‡∏ß‡πà‡∏≤‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô ‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏π‡∏õ‡∏î‡∏π‡πÑ‡∏°‡πà‡∏≠‡∏≠‡∏Å ‡∏´‡∏£‡∏∑‡∏≠‡πÇ‡∏Ñ‡∏ß‡∏ï‡πâ‡∏≤‡πÄ‡∏ï‡πá‡∏°
           // console.log(`      ‚ö†Ô∏è SlipOK Manual Check needed for: ${nickname}`);
        }

       // 3. üöÄ ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Ç‡πâ‡∏≤ Firestore
        syncToFirebasePayment({
          phoneNumber: phone,
          customerName: nickname,
          amount: slipData.amount || 0, 
          transRef: slipData.transRef || `HISTORY_MANUAL_${i+1}`, 
          senderName: senderName,
          transferDate: transferDate,
          status: status, // verified ‡∏´‡∏£‡∏∑‡∏≠ manual_check
          source: 'sync_history_all',
          slipUrl: slipUrl
        });
        
        count++;
        // ‡∏û‡∏±‡∏Å‡∏´‡∏≤‡∏¢‡πÉ‡∏à‡∏´‡∏ô‡πà‡∏≠‡∏¢ ‡πÄ‡∏î‡∏µ‡πã‡∏¢‡∏ß SlipOK/Firestore ‡∏î‡πà‡∏≤
        if (count % 3 === 0) Utilities.sleep(800); 
    } else {
       // ‡∏™‡πÅ‡∏õ‡∏°‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏•‡∏¥‡∏õ ‡πÉ‡∏´‡πâ‡∏Ç‡∏∂‡πâ‡∏ô‡∏£‡∏≠‡∏ä‡∏≥‡∏£‡∏∞
       syncToFirebasePayment({
          phoneNumber: phone,
          customerName: nickname,
          amount: 0, 
          transRef: `NO_SLIP_${i+1}`, 
          senderName: "",
          transferDate: "",
          status: 'awaiting_payment',
          source: 'sync_history_all',
          slipUrl: ""
        });
        count++;
    }
  }
  
  if (count > 0) {
    console.log(`   ‚úÖ ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏ä‡∏µ‡∏ó "${sheet.getName()}" ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ${count} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`);
  } else {
    // console.log(`   ‚ö†Ô∏è ‡∏ä‡∏µ‡∏ó "${sheet.getName()}" ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏•‡∏¥‡∏õ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á (Mapping: N=${colName},P=${colPhone},S=${colSlip})`);
  }
  
  return count;
}
