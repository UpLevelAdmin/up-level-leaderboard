<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UpLevel Icon Mapper (Reverse Mode)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            background-color: #0f172a;
            color: white;
            font-family: monospace;
        }

        .grid-overlay {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            grid-template-rows: repeat(3, 1fr);
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        .grid-cell {
            border: 1px dashed rgba(255, 255, 255, 0.15);
            display: flex;
            flex-col;
            items-center;
            justify-center;
            cursor: pointer;
            transition: all 0.1s;
            position: relative;
        }

        .grid-cell:hover {
            background-color: rgba(59, 130, 246, 0.4);
            border: 1px solid white;
        }

        .cell-label {
            position: absolute;
            bottom: 2px;
            right: 2px;
            font-size: 10px;
            font-weight: bold;
            background: rgba(0, 0, 0, 0.8);
            padding: 1px 3px;
            border-radius: 4px;
            color: #4ade80;
            pointer-events: none;
        }

        .cell-number {
            position: absolute;
            top: 2px;
            left: 2px;
            font-size: 10px;
            opacity: 0.5;
            pointer-events: none;
        }

        /* Modal Styles */
        .modal-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(4px);
            z-index: 999;
            display: flex;
            align-items: center;
            justify-content: center;
        }
    </style>
</head>

<body class="pb-32 px-6 pt-6">

    <div class="flex justify-between items-center mb-6 bg-slate-800 p-4 rounded-xl border border-slate-700">
        <div>
            <h1 class="text-2xl font-bold text-blue-400 flex items-center gap-2">‚ö°Ô∏è UpLevel Mapper <span
                    class="text-xs bg-blue-900 text-blue-200 px-2 py-1 rounded">Auto-Sync Active</span></h1>
            <p class="text-xs text-slate-400 mt-1">Changes are saved automatically. Click 'Copy JSON' to export for file
                update.</p>
            <p id="dataStatus" class="text-xs text-yellow-400 mt-1 animate-pulse">‚è≥ Loading Pokemon Database...</p>
        </div>
        <div class="flex gap-3">
            <button onclick="manualSave()"
                class="bg-blue-600 hover:bg-blue-500 text-white font-bold py-2 px-4 rounded-lg shadow-lg text-sm">
                üíæ Force Save
            </button>
            <button onclick="clearStorage()"
                class="bg-rose-900/50 hover:bg-rose-900 text-rose-200 font-bold py-2 px-4 rounded-lg shadow-lg text-sm border border-rose-800">
                üóëÔ∏è Reset Progress
            </button>
            <button onclick="generateFullJson()"
                class="bg-emerald-600 hover:bg-emerald-500 text-white font-bold py-2 px-6 rounded-lg shadow-lg flex gap-2">
                <span>ÔøΩ</span> Copy JSON
            </button>
        </div>
    </div>

    <!-- MAIN GRID CONTAINER -->
    <div id="gridContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6"></div>

    <!-- MODAL FOR SEARCHING -->
    <div id="searchModal" class="modal-bg hidden">
        <div class="bg-slate-800 border border-slate-600 rounded-2xl p-6 w-[500px] max-w-full shadow-2xl relative">
            <button onclick="closeModal()" class="absolute top-4 right-4 text-gray-400 hover:text-white">‚úï</button>

            <h2 class="text-xl font-bold mb-4 flex items-center gap-2">
                <span>üîç</span> Identify Icon
                <span id="modalTargetInfo"
                    class="text-xs bg-slate-700 px-2 py-1 rounded text-gray-300 font-mono"></span>
            </h2>

            <div class="flex gap-4 mb-4">
                <div
                    class="w-24 h-24 bg-slate-900 rounded-lg border border-slate-700 flex items-center justify-center overflow-hidden">
                    <img id="modalGridImg" src="" class="w-full h-full object-contain">
                </div>
                <div class="flex-1">
                    <input type="text" id="modalSearchInput" placeholder="Search Pokemon (Name/ID)..."
                        class="w-full bg-slate-900 border border-slate-600 p-3 rounded-lg text-white focus:border-blue-500 outline-none mb-2"
                        oninput="handleModalSearch(this.value)">
                    <div class="text-xs text-gray-500">e.g. "Charizard", "‡∏•‡∏¥‡∏ã‡∏≤‡∏£‡πå‡∏î‡∏≠‡∏ô", "6"</div>
                </div>
            </div>

            <!-- Pre-mapped info -->
            <div id="currentMappingInfo" class="mb-2 text-sm text-yellow-500 hidden">Currently mapped to: <b
                    id="currentMapName"></b></div>

            <div id="modalSearchResults" class="max-h-[300px] overflow-y-auto space-y-1 pr-1 custom-scrollbar"></div>
        </div>
    </div>

    <script>
        // --- DATA & STATE ---
        const gridFiles = [
            "uplevel_meta_grid_9x9_v10_ogerpon_friends_1766058805609.png", "uplevel_meta_grid_9x9_v11_support_squad_1766058998402.png", "uplevel_meta_grid_9x9_v12_lost_ancient_1766059018877.png", "uplevel_meta_grid_9x9_v13_final_bosses_1766059039877.png", "uplevel_meta_grid_9x9_v14_limitless_rogues_1766059227418.png", "uplevel_meta_grid_9x9_v15_specialists_niche_1766059261104.png", "uplevel_meta_grid_9x9_v16_critical_must_haves_1766059534519.png", "uplevel_meta_grid_9x9_v17_fun_strategies_1766059552155.png", "uplevel_meta_grid_9x9_v18_megas_hitters_1766059569762.png", "uplevel_meta_grid_9x9_v19_megas_partners_1766059817950.png", "uplevel_meta_grid_9x9_v1_1766044286836.png", "uplevel_meta_grid_9x9_v20_legends_dark_1766059837213.png", "uplevel_meta_grid_9x9_v21_final_cut_eevee_scyther_1766059857202.png", "uplevel_meta_grid_9x9_v22_stellar_meta_1766108848277.png", "uplevel_meta_grid_9x9_v23_paradox_completion_1766109537133.png", "uplevel_meta_grid_9x9_v24_missing_support_legends_1766116351619.png", "uplevel_meta_grid_9x9_v25_rogue_challenge_1766116569136.png", "uplevel_meta_grid_9x9_v26_superstars_mascots_1766116796241.png", "uplevel_meta_grid_9x9_v27_eevee_party_1766120234263.png", "uplevel_meta_grid_9x9_v2_retry_1766044407433.png", "uplevel_meta_grid_9x9_v3_legends_1766044931614.png", "uplevel_meta_grid_9x9_v4_starters_g1_1766045007452.png", "uplevel_meta_grid_9x9_v5_support_meta_1766045420785.png", "uplevel_meta_grid_9x9_v7_city_winners_final_1766058385610.png", "uplevel_meta_grid_9x9_v8_gym_rogues_1766058502448.png", "uplevel_meta_grid_9x9_v9_cute_engines_1766058673382.png"
        ];

        // STARTING MANIFEST (Will be updated by user)
        let manifest = {
            "952": "source-grids/uplevel_meta_grid_9x9_v15_specialists_niche_1766059261104_pieces/1.png",
            "40": "source-grids/uplevel_meta_grid_9x9_v15_specialists_niche_1766059261104_pieces/2.png",
            "65": "source-grids/uplevel_meta_grid_9x9_v15_specialists_niche_1766059261104_pieces/3.png",
            "6": "source-grids/uplevel_meta_grid_9x9_v4_starters_g1_1766045007452_pieces/6.png", // Example
            // ... (This accepts existing data) ...
        };

        // Load saved updates from storage
        try {
            const savedUpdates = localStorage.getItem('uplevel_manifest_updates');
            if (savedUpdates) {
                const parsed = JSON.parse(savedUpdates);
                Object.assign(manifest, parsed);
                console.log('Restored', Object.keys(parsed).length, 'mappings from storage');
            }
        } catch (e) { console.error('Failed to load storage', e); }

        // Load saved updates from storage
        try {
            const savedUpdates = localStorage.getItem('uplevel_manifest_updates');
            if (savedUpdates) {
                const parsed = JSON.parse(savedUpdates);
                Object.assign(manifest, parsed);
                console.log('Restored', Object.keys(parsed).length, 'mappings from storage');
            }
        } catch (e) { console.error('Failed to load storage', e); }

        // Reverse Manifest for quick lookup:  "path/file.png" -> "POKEMON_ID"
        let reverseManifest = {};
        function buildReverseManifest() {
            reverseManifest = {};
            for (let [id, path] of Object.entries(manifest)) {
                reverseManifest[path] = id;
            }
        }
        buildReverseManifest();

        let pokemonData = [];

        // ... existing code ...

        function assignPokemon(p) {
            if (!activeCell) return;

            // Update main manifest
            manifest[p.id] = activeCell.path;

            // Save to LocalStorage for persistence & Sync
            localStorage.setItem('uplevel_manifest_updates', JSON.stringify(manifest));

            // Update reverse lookup
            reverseManifest[activeCell.path] = p.id;

            // Re-render UI to show new label
            renderGrids();
            closeModal();

            // Notification
            const notif = document.createElement('div');
            notif.className = 'fixed bottom-4 right-4 bg-emerald-500 text-white px-4 py-2 rounded shadow-lg z-50 animate-bounce font-bold';
            notif.innerText = `Mapped: ${p.thaiName || p.name}`;
            document.body.appendChild(notif);
            setTimeout(() => notif.remove(), 2000);
        }

        // ... existing code ...

        function assignPokemon(p) {
            if (!activeCell) return;

            // Update main manifest
            manifest[p.id] = activeCell.path;

            // Save to LocalStorage for persistence & Sync
            localStorage.setItem('uplevel_manifest_updates', JSON.stringify(manifest));

            // Update reverse lookup
            reverseManifest[activeCell.path] = p.id;

            // Re-render UI to show new label
            renderGrids();
            closeModal();

            // Notification
            const notif = document.createElement('div');
            notif.className = 'fixed bottom-4 right-4 bg-emerald-500 text-white px-4 py-2 rounded shadow-lg z-50 animate-bounce font-bold';
            notif.innerText = `Mapped: ${p.thaiName || p.name}`;
            document.body.appendChild(notif);
            setTimeout(() => notif.remove(), 2000);
        }
        let thaiNames = [];
        let activeCell = null; // Store { path, element } being edited

        // --- LOAD DATA ---
        async function loadData() {
            const statusEl = document.getElementById('dataStatus');
            try {
                // Fetch ALL forms including Megas (IDs go up to 10000+)
                const res1 = await fetch('https://pokeapi.co/api/v2/pokemon?limit=10000');
                const data1 = await res1.json();
                try {
                    const resThai = await fetch('https://raw.githubusercontent.com/sindresorhus/pokemon/main/data/th.json');
                    thaiNames = await resThai.json();
                } catch (e) { }

                pokemonData = data1.results.map((p, idx) => {
                    const id = p.url.split('/').filter(Boolean).pop();

                    // Simple name formatting for Megas
                    let displayName = p.name;
                    let thName = '';

                    if (id <= 1025 && id <= thaiNames.length) {
                        thName = thaiNames[id - 1];
                    } else if (p.name.includes('-mega')) {
                        const baseId = p.name.split('-')[0]; // simple guess
                        // Try to match base name to thai? Too complex for now, just show Mega
                        displayName = p.name.replace('-', ' ').toUpperCase();
                        thName = "‡∏£‡πà‡∏≤‡∏á‡πÄ‡∏°‡∏Å‡πâ‡∏≤";
                    }

                    return { name: displayName, id: id, thaiName: thName, rawName: p.name };
                });
                console.log('Loaded Pokemon Data:', pokemonData.length);

                if (statusEl) {
                    statusEl.innerText = `‚úÖ Ready! Database loaded (${pokemonData.length} species)`;
                    statusEl.className = "text-xs text-emerald-400 mt-1 font-bold";
                    statusEl.classList.remove('animate-pulse');
                }

                renderGrids();
            } catch (e) {
                console.error(e);
                if (statusEl) {
                    statusEl.innerText = `‚ùå Error loading data: ${e.message}. Check console/internet.`;
                    statusEl.className = "text-xs text-red-400 mt-1 font-bold";
                }
            }
        }
        loadData();

        // --- RENDER GRIDS ---
        function renderGrids() {
            const container = document.getElementById('gridContainer');
            container.innerHTML = '';
            const gridPath = 'assets/uplevel-icons/source-grids/';

            gridFiles.forEach(file => {
                const piecesFolder = "source-grids/" + file.replace('.png', '_pieces');

                let cellsHtml = '';
                for (let i = 1; i <= 9; i++) {
                    const fullPath = `${piecesFolder}/${i}.png`;
                    const mappedId = reverseManifest[fullPath];

                    let label = '';
                    if (mappedId) {
                        const p = pokemonData.find(pd => pd.id === mappedId);
                        label = `<div class="cell-label">${p ? (p.thaiName || p.name) : mappedId}</div>`;
                    } else {
                        label = `<div class="cell-label text-gray-500 opacity-50 text-[8px]">?</div>`;
                    }

                    cellsHtml += `
                        <div class="grid-cell" onclick="openAssignModal('${fullPath}', ${i}, '${file}')">
                            <span class="cell-number">${i}</span>
                            ${label}
                        </div>`;
                }

                const niceName = file.replace('uplevel_meta_grid_9x9_', '').split('_').slice(0, 3).join(' ').toUpperCase();
                const card = document.createElement('div');
                card.className = 'bg-slate-800 rounded-xl p-2 border border-slate-700 relative';
                card.innerHTML = `
                    <div class="text-[10px] font-bold text-gray-400 mb-1 px-1 truncate" title="${file}">${niceName}</div>
                    <div class="relative aspect-square bg-slate-900 rounded-lg overflow-hidden border border-slate-700">
                        <img src="${gridPath}${file}" class="w-full h-full object-contain opacity-60">
                        <div class="grid-overlay">${cellsHtml}</div>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        // --- MODAL LOGIC ---
        function openAssignModal(path, slotNum, fileName) {
            activeCell = { path: path };
            const modal = document.getElementById('searchModal');
            document.getElementById('modalGridImg').src = `assets/uplevel-icons/${path}`; // Assuming asset path structure
            document.getElementById('modalTargetInfo').innerText = `Slot ${slotNum} : ${fileName.substr(0, 15)}...`;
            document.getElementById('modalSearchInput').value = '';
            document.getElementById('modalSearchResults').innerHTML = '';

            // Show current mapping if exists
            const currentId = reverseManifest[path];
            const currentInfo = document.getElementById('currentMappingInfo');
            if (currentId) {
                const p = pokemonData.find(pd => pd.id === currentId);
                const name = p ? `${p.thaiName} (${p.name})` : `ID ${currentId}`;
                document.getElementById('currentMapName').innerText = name;
                currentInfo.classList.remove('hidden');
            } else {
                currentInfo.classList.add('hidden');
            }

            modal.classList.remove('hidden');
            setTimeout(() => document.getElementById('modalSearchInput').focus(), 100);
        }

        function closeModal() {
            document.getElementById('searchModal').classList.add('hidden');
            activeCell = null;
        }

        let searchTimeout;
        function handleModalSearch(val) {
            clearTimeout(searchTimeout);
            const results = document.getElementById('modalSearchResults');
            if (!val || val.length < 2) { results.innerHTML = ''; return; }

            searchTimeout = setTimeout(() => {
                val = val.toLowerCase().trim();

                // Enhanced Search Logic
                const matches = pokemonData.filter(p => {
                    // Match ID
                    if (p.id.toString() === val) return true;

                    // Match Name (EN or TH)
                    if (p.name.includes(val)) return true;
                    if (p.thaiName && p.thaiName.includes(val)) return true;

                    // Special case: "mega" keyword
                    if (val === 'mega' || val === '‡πÄ‡∏°‡∏Å‡πâ‡∏≤') {
                        return p.name.includes('-mega');
                    }

                    return false;
                }).slice(0, 20); // Increase limit to show more results

                results.innerHTML = '';
                if (matches.length === 0) {
                    results.innerHTML = '<div class="p-2 text-gray-500 text-xs">No matches found. Try English Name (e.g. Charizard)</div>';
                }

                matches.forEach(p => {
                    const div = document.createElement('div');
                    div.className = 'flex items-center gap-3 p-2 bg-slate-700/50 hover:bg-slate-600 rounded cursor-pointer border border-transparent hover:border-blue-400';

                    // Highlight Mega
                    const isMega = p.name.includes('-mega');
                    const badges = isMega ? '<span class="ml-2 text-[10px] bg-purple-500 text-white px-1 rounded">MEGA</span>' : '';

                    div.innerHTML = `
                        <img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/${p.id}.png" class="w-10 h-10 bg-slate-800 rounded-md">
                        <div>
                            <div class="font-bold text-sm flex items-center">${p.thaiName || p.displayName || p.name} ${badges}</div>
                            <div class="text-xs text-blue-300 font-mono">ID: ${p.id} <span class="text-gray-500">(${p.name})</span></div>
                        </div>
                    `;
                    div.onclick = () => assignPokemon(p);
                    results.appendChild(div);
                });
            }, 200);
        }

        function assignPokemon(p) {
            if (!activeCell) return;

            // Remove old mapping for this path if exists (to avoid duplicates or stale data in UI)
            // But actually we support multiple IDs pointing to same file? Ideally no.
            // Let's just update manifest
            manifest[p.id] = activeCell.path;

            // Update reverse lookup
            reverseManifest[activeCell.path] = p.id;

            // Re-render UI to show new label
            renderGrids();
            closeModal();

            // Optional: Auto-save logic or Toast
        }

        function manualSave() {
            localStorage.setItem('uplevel_manifest_updates', JSON.stringify(manifest));
            buildReverseManifest();
            renderGrids();
            alert('Progress Saved & Synced to Scorecard!');
        }

        function clearStorage() {
            if (confirm('Are you sure you want to RESET all your mapping progress? This cannot be undone.')) {
                localStorage.removeItem('uplevel_manifest_updates');
                location.reload();
            }
        }

        function generateFullJson() {
            const jsonStr = JSON.stringify(manifest, null, 4);
            navigator.clipboard.writeText(`manifest: ${jsonStr}`).then(() => {
                alert('Full JSON copied to clipboard! Paste it into scorecard.html');
            });
        }

    </script>
</body>

</html>